function getIEVersion(){return(!("Microsoft Internet Explorer"!=window.navigator.appName&&window.navigator.appName.indexOf("MSAppHost")<0)||0<window.navigator.appVersion.indexOf("Trident")&&11<=document.documentMode)&&(null==document.documentMode?"CSS1Compat"==document.compatMode?7:6:document.documentMode)}DEBUG={enable:!1,clear:function(){DEBUG.enable&&(document.getElementById("DEBUG").value="")},print:function(t){DEBUG.enable&&(document.getElementById("DEBUG").value+=t+"\n")}},scilligence={_base:function(){}},oln=scilligence,scil=scilligence,scilligence.overwrite=scilligence.apply=function(t,e,i){if(i&&scilligence.apply(t,i),t&&e&&"object"==typeof e)for(var s in e)t[s]=e[s];return t},scilligence.apply(scilligence,{extend:function(){function n(t){for(var e in t)this[e]=t[e]}var r=Object.prototype.constructor;return function(e,t,i){"object"==typeof t&&(i=t,t=e,e=i.constructor!=r?i.constructor:function(){t.apply(this,arguments)});var s=function(){},l=t.prototype;s.prototype=l;s=e.prototype=new s;return((s.constructor=e).superclass=l).constructor==r&&(l.constructor=t),e.override=function(t){scilligence.override(e,t)},s.superclass=s.supr=function(){return l},s.override=n,scilligence.override(e,i),e.extend=function(t){return scilligence.extend(e,t)},e}}(),override:function(t,e){e&&(t=t.prototype,scilligence.apply(t,e),null!=document.all&&e.hasOwnProperty("toString")&&(t.toString=e.toString))},clone:function(t){if(null==t)return null;if(null!=t.length)return t.concat([]);var e={};return scil.apply(e,t),e},cloneArray:function(t){if(null==t)return null;if(null!=t.length){for(var e=[],i=0;i<t.length;++i)"object"==typeof t[i]?e[i]=scil.clone(t[i]):e[i]=t[i];return e}var s={};return scil.apply(s,t),s},byId:function(t){return document.getElementById(t)},connect:function(e,t,i){null!=e&&null!=t&&""!=t&&null!=i&&(null!=e.addEventListener?e.addEventListener(t.substr(2),function(t){i(t,e)}):null!=e.attachEvent?e.attachEvent(t,function(t){i(t,e)}):dojo.connect(e,t,function(t){i(t,e)}))}}),scilligence.ready=dojo.ready,scilligence.onload=dojo.addOnLoad;var __ieversion=getIEVersion(),__ieAppVersion=__ieversion?window.postMessage?window.performance?9:8:7:null,silverlight;function _isHtml5(){return __ieversion?9<=__ieversion:null!=document.doctype&&null!=document.doctype.name&&"html"==document.doctype.name.toLowerCase()}function getAndroidVersion(){var t=window.navigator.userAgent,e=t.indexOf("Android");return!(e<0)&&(e=(t=t.substr(e+8)).indexOf(";"),0<(e=(t=t.substr(0,e)).indexOf("."))&&(t=t.substr(0,e)),!!isNaN(t)||parseFloat(t))}function getiOSVersion(){var t=window.navigator.userAgent,e=t.indexOf("iPad");return e<0&&(e=t.indexOf("iPhone")),!(e<0)&&((e=t.indexOf("OS",e+4))<0||(e=(t=t.substr(e+3)).indexOf("_"),0<(e=(t=t.substr(0,e)).indexOf("."))&&(t=t.substr(0,e)),!!isNaN(t)||parseInt(t)))}__ieversion&&(silverlight="undefined"!=typeof JSDraw2_disablesilverlight&&JSDraw2_disablesilverlight?"":"silverlight,",dojo.version.major<=1&&dojo.version.minor<7?dojo.config.gfxRenderer=silverlight+"vml":__ieversion<9&&(dojo.config.gfxRenderer=silverlight+"vml,svg")),dojo.require("dojo.io.script"),dojo.require("dojo.io.iframe"),dojo.require("dojox.gfx"),dojo.require("dojox.gfx.utils"),dojo.require("dojo.window"),"undefined"==typeof __JSDraw2_TouchMol&&(dojo.require("dojox.charting.Chart2D"),dojo.require("dojox.charting.axis2d.Default"),dojo.require("dojox.charting.plot2d.Default"),dojo.require("dojox.charting.themes.Wetland")),dojo.version.major<=1&&dojo.version.minor<=6||dojo.require("dojox.storage.LocalStorageProvider"),dojo.version.major<=1&&dojo.version.minor<7&&scil.onload(function(){dojox.gfx.Text.prototype._renderShape=function(t){var e=this.shape;t.save(),t.fillStyle=e.fillStyle,t.strokeStyle=e.fillStyle,t.font=e.fontStyle,t.textAlign=e.align,t.fillText(e.text,e.x,e.y),t.restore(),t.stroke()}}),scilligence.suggestInstallSilverlight=function(){"vml"==dojox.gfx.renderer&&confirm("JSDraw2.Editor runs much faster with Silverlight in IE 6,7,8.  Do you want to install Silvelight now?")&&window.open("http://www.silverlight.net/downloads")},scilligence.Utils={__xcode:10,isIE:__ieversion,isIE8Lower:__ieversion&&__ieversion<9,nativemode:0<=window.navigator.appName.indexOf("MSAppHost"),isHtml5:_isHtml5(),isFirefox:0<=navigator.userAgent.indexOf("Firefox"),isOpera:0<=navigator.userAgent.indexOf("Opera"),isChrome:0<=navigator.userAgent.indexOf("Chrome"),isLinux:0<=navigator.userAgent.indexOf("Linux"),isUbuntu:0<=navigator.userAgent.indexOf("Ubuntu"),isIpad:getiOSVersion(),isAndroid:getAndroidVersion(),isTouch:0<=navigator.userAgent.indexOf("iPad")||0<=navigator.userAgent.indexOf("iPhone")||0<=navigator.userAgent.indexOf("Android"),isSilverlight:null,lastTouchTm:0,buttonWidth:160,getTopWindow:function(){for(var t=window;null!=t.parent&&t.parent!=t;)t=t.parent;return t},isRightButton:function(t){if(null!=t)return t.which?3==t.which:"button"in t&&2==t.button},isTouchDblClick:function(t){var e=(new Date).getTime(),i=e-scil.Utils.lastTouchTm;return scil.Utils.lastTouchTm=e,1==t.touches.length&&i<=500},hasAnsestor:function(t,e){if(null==e||null==t)return!1;for(;null!=t;){if(t.parentNode==e)return!0;t=t.parentNode}return!1},round:function(t,e){if(null==t||isNaN(t))return null;e=Math.pow(10,e);return Math.round(t*e)/e},roundToSignificantDigits:function(t,e){if(0==t||isNaN(t))return t;var i=Math.pow(10,Math.floor(this.log10(Math.abs(t)))+1);return i*this.round(t/i,e)},log10:function(t){return Math.log(t)/Math.LN10},roundStr:function(t,e,i){if(null==t||isNaN(t))return"";if(0==t)return"0";var s=Math.pow(10,e),l=Math.round(t*s)/s+"";if("0"==l&&0!=t||0<e&&(Math.abs(t)<1/s||t<1&&l.length<(t+"").length)){s=Math.floor(this.log10(t));if(s<1){s=this.roundStr(t*Math.pow(10,-s),e,i)+"e"+s;return parseFloat(s)==parseFloat(l)?l:s}}if(0==i||e<=0)return l;i=l.indexOf(".");i<0&&(i=(l+=".").length-1);for(var n=l.length-1-i;n<e;++n)l+="0";return l},num2str:function(t,e,i,s){return null==t||!isFinite(t)||isNaN(t)?"":null==i?this.roundStr(t,e,s):"%"==i?this.roundStr(100*t,e,s)+i:("L"!=i&&"l"!=i||(i=i.toUpperCase()),1e3<=Math.abs(t)?this.roundStr(t/1e3,e,s)+" "+this._convertUnit(i,1e3):1<=Math.abs(t)?this.roundStr(t,e,s)+" "+this._convertUnit(i,1):(t*=1e3,1<=Math.abs(t)?this.roundStr(t,e,s)+" "+this._convertUnit(i,.001):(t*=1e3,this.roundStr(t,e,s)+" "+this._convertUnit(i,1e-6))))},_convertUnit:function(t,e){switch(e){case 1:return"g/L"==t?"mg/mL":"U/L"==t?"mU/mL":t;case 1e3:return"g/L"==t?"g/mL":"U/L"==t?"U/mL":"k"+t;case.001:return"g/L"==t||"mg/mL"==t?"mg/L":"U/L"==t||"mU/mL"==t?"mU/L":"m"+t;case 1e-6:return"g/L"==t||"mg/mL"==t?"ug/L":"U/L"==t||"mU/mL"==t?"uU/L":"u"+t}},disabledcontextmenus:[],disableContextMenu:function(t,e){null!=t&&scil.Utils.indexOf(this.disabledcontextmenus,t)<0&&this.disabledcontextmenus.push(t),null==e&&(e=document),e.body.__contextmenudisabled||(e.body.__contextmenudisabled=!0,e.body.oncontextmenu=function(t){null==t&&(t=event);for(var e=t.target||t.srcElement,i=scil.Utils.disabledcontextmenus,s=0;s<i.length;++s)if(e==i[s]||scil.Utils.isChildOf(e,i[s]))return!1;if(null!=e.parentNode&&null!=JSDraw2.Editor.get(e.parentNode.id)||null!=e.firstChild&&null!=e.firstChild.getAttribute&&"1"==e.firstChild.getAttribute("jspopupmenu"))return null!=t.preventDefault&&t.preventDefault(),!1;if(scil.ContextMenu.isFromContextMenu(e))return null!=t.preventDefault&&t.preventDefault(),!1;var l=scil.Utils.getParent(e,"div");return null!=l&&null!=JSDraw2.Editor.get(l.id)?(null!=t.preventDefault&&t.preventDefault(),!1):void 0})},serviceAvailable:function(){return"undefined"!=typeof JSDrawServices&&void 0!==JSDrawServices.url&&null!=JSDrawServices.url},eval:function(s){if(""==s||"string"!=typeof s)return null;try{return eval("var s="+s),s}catch(e){}return null},isTrue:function(t){return"1"==(t=(t+"").toLowerCase())||"true"==t||"yes"==t||"on"==t},isFalse:function(t){return"0"==(t=(t+"").toLowerCase())||"false"==t||"no"==t||"off"==t},isAttTrue:function(t,e){e=t.getAttribute(e)+"";return""==e||this.isTrue(e)},isAttFalse:function(t,e){e=t.getAttribute(e)+"";return"0"==e||"false"==e.toLowerCase()},formatStr:function(t,e,i){i=null==t?"":t.toFixed(i)+"";return scil.Utils.padLeft(i,e," ")},uuid:function(){var t,e,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),s=[];i.length;for(s[8]=s[13]=s[18]=s[23]="-",s[14]="4",t=0;t<36;t++)s[t]||(e=0|16*Math.random(),s[t]=i[19==t?3&e|8:e]);return s.join("").toLowerCase()},padLeft:function(t,e,i){for(var s="",l=(t+"").length;l<e;++l)s+=null==i?" ":i;return s+t},padRight:function(t,e,i){for(var s="",l=t.length;l<e;++l)s+=null==i?" ":i;return t+s},endswith:function(t,e,i){if(null==t||null==e||t.length<e.length)return!1;t=t.substr(t.length-e.length,e.length);return i?t==e:t.toLowerCase()==e.toLowerCase()},startswith:function(t,e,i){if(null==t||null==e||t.length<e.length)return!1;t=t.substr(0,e.length);return i?t==e:t.toLowerCase()==e.toLowerCase()},trim:function(t){return null==t?null:t.replace(/^[\s|\t\r\n]+|[\s|\t\r\n]+$/g,"")},ltrim:function(t){return null==t?null:t.replace(/^[\s|\t\r\n]+/,"")},rtrim:function(t){return null==t?null:t.replace(/[\s|\t\r\n]+$/,"")},isFixedPosition:function(t){for(;null!=t;){if(null!=t.style&&"fixed"==t.style.position)return!0;t=t.parentNode}return!1},getOffset:function(t,e){for(var i=scil.Utils.scrollOffset(),s=new JSDraw2.Point(0,0);null!=t;)(0<t.offsetLeft||0<t.offsetTop)&&s.offset(t.offsetLeft,t.offsetTop),this.isIE&&(0<t.scrollLeft||0<t.scrollTop)&&s.offset(t.scrollLeft,t.scrollTop),scil.Utils.isIE&&(0<t.scrollTop||0<t.scrollLeft)&&s.offset(-t.scrollLeft,-t.scrollTop),t=t.offsetParent;return 0!=e&&s.offset(-i.x,-i.y),s},getScrollOffset:function(t){for(var e=new JSDraw2.Point(0,0);null!=t;)(0<t.scrollLeft||0<t.scrollTop)&&e.offset(t.scrollLeft,t.scrollTop),t=t.offsetParent;return e},scrollOffset:function(){var t=document.compatMode&&"BackCompat"!=document.compatMode?document.documentElement:document.body,e=scil.Utils.isIE?t.scrollLeft:pageXOffset,t=scil.Utils.isIE?t.scrollTop:pageYOffset;return new JSDraw2.Point(e,t)},scriptUrl:function(){if(null!=this._scripturl)return this._scripturl;if(null!=JSDraw2.defaultoptions.imagebase&&(this._scripturl=JSDraw2.defaultoptions.imagebase),null!=this._scripturl)return this._scripturl;for(var t=document.getElementsByTagName("script"),e=0;e<t.length;e++){var i=t[e];if("SCRIPT"==i.tagName){var s=i.getAttribute("src");if(null!=s&&0!=s.length){var l=(n=s.lastIndexOf("/"))<0?"":scil.Utils.trim(s.substr(0,n+1)),i=scil.Utils.trim(n<0?s:s.substr(n+1)).toLowerCase();if(0<(n=i.indexOf("?"))&&(i=i.substr(0,n)),this.startswith(i,"scilligence.jsdraw2.")&&this.endswith(i,".js")){if(scil.Utils.startswith(l,"http://")||scil.Utils.startswith(l,"https://")||scil.Utils.startswith(l,"//"))return this._scripturl=l;if(scil.Utils.startswith(l,"/"))return this._scripturl=document.location.protocol+"//"+document.location.host+l;var n,s=document.location+"";return 0<(n=s.indexOf("?"))&&(s=s.substr(0,n)),n=s.lastIndexOf("/"),this._scripturl=s.substr(0,n+1)+l}if("jsdraw.core.js"==i)return this._scripturl=l+"../"}}}return null},_imgBase:function(){return scil.Utils.scriptUrl()},imgSrc:function(t,e){t=scil.Utils._imgBase()+t;return e&&(t="url("+t+")"),t},imgTag:function(t,e,i){return"<img"+(null==i?"":" "+i)+" src='"+this.imgSrc("img/"+t)+"'>"+(null==e?"":e)},styleRect:function(t){return new JSDraw2.Rect(scil.Utils.parsePixel(t.style.left),scil.Utils.parsePixel(t.style.top),scil.Utils.parsePixel(t.style.width),scil.Utils.parsePixel(t.style.height))},parsePixel:function(t){return null!=t&&scil.Utils.endswith(t,"px")?(t=t.substr(0,t.length-2),isNaN(t)?null:parseInt(t)):null},cloneArray:function(t){var e=[];return this.mergeArray(e,t),e},mergeArray:function(t,e){for(var i=0;i<e.length;++i)t.push(e[i])},fingArrayIndex:function(t,e){for(var i=0;i<t.length;++i)if(t[i]==e)return i;return-1},getFunctionName:function(t){if("function"==typeof t){t=(t+"").match(/function\s*([\w\$]*)\s*\(/);if(null!==t)return t[1]}return null},splitCsvRow:function(t){if(null!=t&&"\r"!=t&&""!=t){"\r"==t.substr(t.length-1)&&(t=t.substr(0,t.length-1));for(var e=[],i=!1,s="",l=0;l<t.length;++l){var n,r=t.substr(l,1);'"'==r?i?l<t.length-1?'"'==(n=t.substr(l+1,1))?(s+=r,++l):","==n?(e.push(s),s="",i=!1,++l):s+=r:i=!1:""==s?i=!0:s+=r:","==r&&(i?s+=r:(e.push(s),s=""))}return e.push(s),e}},escCsvValue:function(t){return null==t?"":("string"!=typeof t&&(t+=""),(0<=t.indexOf(",")||0<=t.indexOf('"')||0<=t.indexOf("\r")||0<=t.indexOf("\n"))&&(t='"'+t.replace(/[\"]/g,'""').replace(/\r\n/g,"")+'"'),t)},unescXmlValue:function(t){return null==t?"":t.replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&#xA;/gi,"\n").replace(/&apos;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/gi,"&")},escXmlValue:function(t,e){return null==t?"":("string"!=typeof t&&(t+=""),e&&(t=scil.Utils.trim(t)),t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r/g,"&#xD;").replace(/\n/g,"&#xA;").replace(/'/g,"&apos;").replace(/"/g,"&quot;"))},escUrlData:function(t){if(null==t)return t;for(var e="",i=0;i<t.length;++i){var s=t.charCodeAt(i),l=t.substr(i,1);e+=255<s?l:"+"==l?"%2b":escape(l)}return e},escFileName:function(t){if(null==t)return t;for(var e="",i=0;i<t.length;++i){var s=t.substr(i,1);255<t.charCodeAt(i)||/[a-z|0-9|_| |\-|\(|\)|\{|\}|\[|\]|\.]/gi.test(s)?e+=s:e+="_"}return e},getFirstChild:function(t,e){if(null==t)return null;for(var i=0;i<t.childNodes.length;++i)if(t.childNodes[i].tagName==e)return t.childNodes[i];return null},parseXml:function(t){t=this.parseXml2(t);return null!=t&&t.succeeded?t.doc:null},parseXml2:function(t){if(null==t)return null;if((t=this.trim(t)).length<10||"<"!=t.substr(0,1)||">"!=t.substr(t.length-1,1))return null;var e=!1,i=null,s=null;try{window.DOMParser?s=(new DOMParser).parseFromString(t,"text/xml"):((s=new ActiveXObject("Microsoft.XMLDOM")).async="false",s.loadXML(t)),e=!0}catch(t){i=t.message}return{succeeded:e,error:i,doc:s}},xquery:function(t,e,i){if(null==t||null==e||""==e)return null;for(var s=null,l=e.split("/"),n=0;n<l.length;++n)if(""!=(r=l[n])){var r,o=r.replace(/[\[]@[a-z]+[0-9|a-z]{0,9}='[^\']+'[\]]$/,""),a=null,h=null,u=(r=r.substr(o.length+2,r.length-(o.length+3))).indexOf("=");0<u&&(a=r.substr(0,u),u+=2,h=r.substr(u,r.length-u-1));for(var c=null,d=0;d<t.childNodes.length;++d){var p=t.childNodes[d];if(p.tagName==o&&(null!=a&&p.getAttribute(a)!=h||(c=p)),null!=c){if(n!=l.length-1){c=p;break}if(i)return c;null==s?s=[c]:s.push(c)}}if(null!=s)return s;if(null==c)return null;t=c}return null},parseJson:function(t){return this.eval(t)},containsWord:function(t,e,i){if(null==t||null==e||""==t||""==e)return!1;i&&(e=e.toLowerCase());for(var s=t.toLowerCase().split(/\W+/),l=0;l<s.length;++l)if(s[l]==e)return!0;return!1},alert2:function(t,e,i,s,l){var n,r,o,a;null==scil.Utils.alertdlg&&(n=scil.Utils.createTable(),o=scil.Utils.createElement(n,"tr"),r=scil.Utils.createElement(scil.Utils.createElement(o,"td",null,{verticalAlign:"top"}),"img",null,{height:"50px",width:"50px"}),a=scil.Utils.createElement(o,"td",null,{textAlign:"center"}),o=scil.Utils.createElement(a,"div",null,{padding:"10px",textAlign:"left",maxWidth:"800px",maxHeight:"400px",overflow:"auto",color:"#000"}),a=scil.Utils.createElement(a,"button",scil.Utils.imgTag("tick.gif",this.res("OK")),{width:"80px"}),scil.Utils.alertdlg=new JSDraw2.Dialog("Attention",n.parentNode),scil.Utils.alertdlg.msg=o,scil.Utils.alertdlg.img=r,dojo.connect(a,"onclick",function(t){var e=scil.Utils.alertdlg;null!=e.callback&&e.callback(),e.hide(),t.preventDefault()})),null==s||""==s?s=scil.Utils.imgSrc("img/information.gif"):scil.Utils.startswith(s,"http:")||(s=scil.Utils.imgSrc("img/"+s+".gif")),scil.Utils.alertdlg.show(e),scil.Utils.alertdlg.callback=i,scil.Utils.alertdlg.msg.innerHTML=null==t?"":"<div style='margin:0;max-width:800px;'>"+t+"</div>",scil.Utils.alertdlg.img.src=s,scil.Utils.alertdlg.moveCenter()},confirm:function(t,e,i,s,l){var n,r,o,a,h;null==scil.Utils.confirmdlg&&(n=scil.Utils.createTable(),a=scil.Utils.createElement(n,"tr"),scil.Utils.createElement(a,"td","<img style='width:50px;height:50px;' src='"+scil.Utils.imgSrc("img/question.gif")+"'>",{verticalAlign:"top"}),h=scil.Utils.createElement(a,"td",null,{textAlign:"center"}),r=scil.Utils.createElement(h,"div",null,{padding:"10px",textAlign:"left",maxHeight:"360px",color:"black"}),o=scil.Utils.createElement(h,"button",this.res("Yes"),{width:"80px"}),a=scil.Utils.createElement(h,"button",this.res("No"),{width:"80px"}),h=scil.Utils.createElement(h,"button",this.res("Cancel"),{width:"80px"}),scil.Utils.confirmdlg=new JSDraw2.Dialog(this.res("Attention"),n.parentNode),scil.Utils.confirmdlg.msg=r,scil.Utils.confirmdlg.cancel=h,dojo.connect(o,"onclick",function(t){var e=scil.Utils.confirmdlg;e.hide(),t.preventDefault(),null!=e.callback&&e.callback(!0)}),dojo.connect(a,"onclick",function(t){var e=scil.Utils.confirmdlg;e.hide(),t.preventDefault(),null!=e.callback&&e.callback(!1)}),dojo.connect(h,"onclick",function(t){var e=scil.Utils.confirmdlg;e.hide(),t.preventDefault(),null!=e.callback&&e.callback("cancel")})),scil.Utils.confirmdlg.show(),scil.Utils.confirmdlg.callback=e,scil.Utils.confirmdlg.cancel.style.display=i?"":"none",scil.Utils.confirmdlg.msg.innerHTML=null==t?"":"<pre style='margin:0'>"+t+"</pre>",scil.Utils.confirmdlg.hide(!0),scil.Utils.confirmdlg.show(s,null,null,null,l)},confirmYes:function(t,e,i){scil.Utils.confirm(t,function(t){t&&e()},null,null,i)},prompt2:function(t){return this.prompt(t.caption,t.message,t.defaultvalue,t.button,t.callback,t.iconurl,t.zindex,t.multiline,t.autosuggesturl,t.owner,t.maxlength,t.height)},prompt:function(t,e,i,s,l,n,r,o,a,h,u,c){var d,p,f,m,g,w,b,S,v;null==scil.Utils.promptdlg&&(d=scil.Utils.createTable(),w=scil.Utils.createElement(d,"tr"),p=scil.Utils.createElement(scil.Utils.createElement(w,"td"),"div",null,{width:"50px"}),f=scil.Utils.createElement(w,"td"),m=scil.Utils.createElement(f,"div",null,{color:"black"}),b=scil.Utils.createElement(f,"div"),(g=scil.Utils.createElement(b,"input",null,{width:"360px",display:"none"})).setAttribute("x-webkit-speech","on"),w=scil.Utils.createElement(b,"textarea",null,{width:"360px",display:"none"}),b=scil.Utils.createElement(f,"div",null,{textAlign:"center",paddingTop:"5px"}),b=scil.Utils.createElement(b,"button",s,{width:scil.Utils.buttonWidth+"px"}),(v=scil.Utils.promptdlg=new JSDraw2.Dialog(this.res("Message"),d.parentNode)).icon=p,v.msg=m,v.input=g,v.textarea=w,v.button=b,S=function(t){var e=v;e.hide(),null!=e.callback&&e.callback(("none"==e.input.style.display?e.textarea:e.input).value,"none"==e.input.style.display?e.textarea:e.input),null!=t.preventDefault&&t.preventDefault()},dojo.connect(v.input,"onkeydown",function(t){13==t.keyCode&&S(t)}),dojo.connect(b,"onclick",S),v.auto=new scil.AutoComplete(g,null)),(v=scil.Utils.promptdlg).input.style.display=o?"none":"",v.textarea.style.display=o?"":"none",v.input.setAttribute("maxlength",0<u?u:""),0<c?(v.input.style.height=c+"px",v.textarea.style.height=c+"px"):(v.input.style.height="",v.textarea.style.height=""),v.auto.url=a,v.auto.disabled=null==a||""==a,v.show(t,r),null==n?v.icon.innerHTML="&nbsp;":(v.icon.innerHTML="<img style='width:50px;height:50px;' src='"+n+"'>",v.icon.style.display=""),v.msg.innerHTML=null==e?"":e,v.button.innerHTML=null==s?this.res("OK"):this.res(s),(o?v.textarea:v.input).value=null==i?"":i,v.callback=l,v.hide(!0),v.show2({owner:h}),(o?v.textarea:v.input).select(),(o?v.textarea:v.input).focus()},createCookie:function(t,e,i,s){if(!s){var l=null==dojox.storage||null==dojox.storage.LocalStorageProvider?null:new dojox.storage.LocalStorageProvider;if(null!=l&&l.isAvailable())return l.initialize(),void l.put(t,e)}s="";i&&((l=new Date).setTime(l.getTime()+24*i*60*60*1e3),s="; expires="+l.toGMTString()),document.cookie=t+"="+escape(e)+s+"; path=/"},readCookie:function(t,e){if(!e){e=null==dojox.storage||null==dojox.storage.LocalStorageProvider?null:new dojox.storage.LocalStorageProvider;if(null!=e&&e.isAvailable())return e.initialize(),e.get(t)}for(var i=t+"=",s=document.cookie.split(";"),l=0;l<s.length;l++){for(var n=s[l];" "==n.charAt(0);)n=n.substring(1,n.length);if(0==n.indexOf(i))return unescape(n.substring(i.length,n.length))}return null},eraseCookie:function(t){if(null!=dojox.storage&&null!=dojox.storage.LocalStorageProvider){var e=new dojox.storage.LocalStorageProvider;if(e.isAvailable())return e.initialize(),e.remove(t)}createCookie(t,"",-1)},formatFilesize:function(t){return 0<t?t/1e3<1?t+"Bytes":(t/=1e3)/1e3<1?Math.round(10*t)/10+"KB":(t/=1e3)/1e3<1?Math.round(10*t)/10+"MB":(t/=1e3)/1e3<1?Math.round(10*t)/10+"GB":(t/=1024,Math.round(10*t)/10+"TB"):""},today:function(){return scil.Utils.trunc2date(new Date)},trunc2date:function(t){return null==t?null:new Date(t.getFullYear(),t.getMonth(),t.getDate())},time:function(t){if(null==t)return new Date;var e=null;if("string"==typeof t)if(/^[0-9]+$/.test(t))t=parseInt(t);else{var i=t.split("-");if(3==i.length){var s=parseInt(i[0]),l=3==i[1].length?this._parseMonth(i[1]):parseInt(i[1])-1,i=parseInt(i[2]);if(0<s&&0<=l&&l<12&&0<i&&i<=31)return new Date(s,l,i)}}null==e&&(e=new Date(t));t=e.getTimezoneOffset();return isNaN(t)&&(t=0),new Date(e.getTime()+6e4*t)},_months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],_weekdays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],weekday:function(t){return this._weekdays[t.getDay()]},_parseMonth:function(t){return null==t||3!=t.length?-1:(t=t.substr(0,1).toUpperCase()+t.substr(1).toLowerCase(),scil.Utils.indexOf(this._months,t))},formatTime:function(t,e){if(0==t)return"";null==t&&(t=new Date),"object"!=typeof t&&(t=scil.Utils.time(t)),0<JSDraw2.timezoneoffet&&(t=new Date(t.getTime()+60*JSDraw2.timezoneoffet*60*1e3));var i=e;scil.Utils.isNullOrEmpty(i)&&(i="yyyy-mmm-dd");var s=0<=(i=i.replace("yyyy",t.getFullYear()).replace("yy",(t.getFullYear()+"").substr(2)).replace("mmm",scil.Utils._months[t.getMonth()]).replace("mm",scil.Utils.padLeft(t.getMonth()+1,2,"0")).replace("dd",scil.Utils.padLeft(t.getDate(),2,"0"))).indexOf("hh"),e=t.getHours(),i=i.replace("hh",this.padLeft(e%12,2,"0")).replace("HH",this.padLeft(e,2,"0")).replace("MM",this.padLeft(t.getMinutes(),2,"0")).replace("SS",this.padLeft(t.getSeconds(),2,"0")).replace("ss",this.padLeft(t.getSeconds(),2,"0"));return s&&(i+=12<=e?"PM":"AM"),i},dateStr:function(t,e,i){if(scil.Utils.isNullOrEmpty(t)||0==t)return"";var s=typeof t;if("object"!=s&&"number"!=s&&"string"!=s)return"";var l=t;if("object"!=s&&null==(l=scil.Utils.time(l)))return"";var n=(scil.Utils.today().getTime()-scil.Utils.trunc2date(l).getTime())/1e3/60/60/24,s=null;return e||(0==n?s=JSDraw2.Language.res("Today"):1==n&&(s=JSDraw2.Language.res("Yesterday"))),null==s&&(scil.Utils.isNullOrEmpty(i)&&(i=JSDraw2.defaultoptions.dateformat,scil.Utils.isNullOrEmpty(i)&&(i="yyyy-mmm-dd")),"string"==typeof t&&(l=new Date(l)),s=scil.Utils.formatTime(l,i)),s},timeStr:function(t,e,i){if(scil.Utils.isNullOrEmpty(t)||0==t)return"";if("string"==typeof t)return"new"==t?"<span style='color:red'>"+JSDraw2.Language.res("New")+"</span>":t;if(null==t)return"";"object"!=typeof t&&(t=scil.Utils.time(t));i=null!=i?i:JSDraw2.defaultoptions.timeformat;return scil.Utils.isNullOrEmpty(i)&&(i="HH:MM"),scil.Utils.dateStr(t,e)+" "+scil.Utils.formatTime(t,i)},createButton:function(t,i,e){if("string"==typeof t&&(t=dojo.byId(t)),null!=i){if("string"!=typeof i){var s=(null==e?scil.Lang:e).res(i.caption||i.label),l=scil.Lang.res(i.title);null==i.src&&null!=i.iconurl&&(i.src=i.iconurl),null==i.title&&null!=i.tooltips&&(i.title=i.tooltips);var n=null;"b"==i.type?(e=scil.Utils.createTable(t,0,0,{float:null==i.float?"left":i.float,textAlign:"center",margin:0,borderRadius:"2px"}),n=e.parentNode,null!=i.id&&n.setAttribute("id",i.id),scil.Utils.createElement(scil.Utils.createElement(e,"tr"),"td","<img src='"+i.src+"'"+(0<i.imgheight?" height='"+i.imgheight+"'":"")+">",{padding:"3px 12px 0 12px"}),scil.Utils.createElement(scil.Utils.createElement(e,"tr"),"td",s,{color:"#fff",fontSize:"60%"})):n=null==s&&null!=(i.src||i.icon)?this.createElement(t,"img",null,{width:i.width,cursor:"pointer",verticalAlign:"middle"},{src:i.src||i.icon,title:i.title,id:i.id}):(null!=i.src&&(s="<img style='vertical-align:middle' src='"+i.src+"'"+(0<i.imgheight?" height='"+i.imgheight+"'":"")+">"+s),"a"==i.type?this.createElement(t,null!=i.tagname?i.tagname:""==s||null==s?"span":"u",s,{width:i.width,cursor:"pointer",background:i.background,whiteSpace:"nowrap"},{title:l,id:i.id}):this.createElement(t,"button",s,{width:i.width,background:i.background,padding:i.padding},{title:l,id:i.id})),null!=i.items&&("IMG"!=n.tagName&&"U"!=n.tagName||((l=this.createElement(t,"span",null)).appendChild(n),n=l));var r=(null==i.highlightcolor?JSDraw2.Skin.menu:i).highlightcolor,o=null==i.color?"b"==i.type?"":JSDraw2.Skin.menu.color:i.color;return n.style.color=o,"b"==i.type?(scil.connect(n,"onmouseover",function(){n.style.background=r}),scil.connect(n,"onmouseout",function(){n.style.background=o})):(scil.connect(n,"onmouseover",function(){n.style.color=r}),scil.connect(n,"onmouseout",function(){n.style.color=o})),null!=i.items?(null==i.callback&&(i.callback=function(t){if(null!=i.onclick)i.onclick(t);else for(var e=0;e<i.items.length;++e)i.items[e].label==t&&null!=i.items[e].url&&(null==i.items[e].target?window.location=i.items[e].url:window.open(i.items[e].url,i.items[e].target))}),new scil.DropdownButton(n,i)):null!=i.onclick?dojo.connect(n,"onclick",function(t){i.onclick(t)}):i.url&&dojo.connect(n,"onclick",function(){null==i.target?window.location=i.url:window.open(i.url,i.target)}),null!=i.key&&n.setAttribute("key",i.key),n}this.createElement(t,"span",i)}},createElement:function(t,e,i,s,l,n){"string"==typeof t&&(t=scil.byId(t)),null!=l&&null!=l.title&&(l.title=this.res(l.title));var r,o=null;if("checkbox"==(e=e.toLowerCase())||"radio"==e||"password"==e||"hidden"==e||"file"==e||"image"==e?scil.Utils.isIE8Lower?(r=null!=l&&null!=l.name?" name='"+l.name+"'":"",o=document.createElement("<input type='"+e+"'"+r+">")):(o=document.createElement("input")).type=e:o=document.createElement(e),null!=t&&t.appendChild(o),null!=i&&("radio"==e||"checkbox"==e?this.createElement(t,"span",i):o.innerHTML=i),null!=s)for(var a in s){var h=s[a];null!=h&&("width"!=a&&"height"!=a&&"padding"!=a&&"margin"!=a||"number"!=typeof h||(h+="px"),o.style[a]=h)}if(null!=l)for(var a in l)null!=l[a]&&o.setAttribute(a,l[a]);return null!=n&&dojo.connect(o,"onclick",function(t){n(t,o)}),o},createTable:function(t,e,i,s,l){s=this.createElement(t,"table",null,s);return null!=e&&(s.cellSpacing=e),null!=i&&(s.cellPadding=i),0<=l&&(s.border=l),this.createElement(s,"tbody")},createTable2:function(t,e,i){i=this.createElement(t,"table",null,e,i);return this.createElement(i,"tbody")},createTR:function(t,e){return scil.Utils.createElement(t,"tr",e)},createTD:function(t,e){return"TR"!=t.tagName&&(t=this.createTR(t)),scil.Utils.createElement(t,"td",e)},createCenterBox:function(t,e){e=this.createTable(t,0,0,null,e);e.parentNode.setAttribute("align","center");e=this.createElement(e,"tr");return this.createElement(e,"td",null,{textAlign:"left"})},createSelect:function(t,e,i,s,l){l=this.createElement(t,"select",null,l);return this.listOptions(l,e,i,!1,s),l},listOptions:function(t,e,i,s,l){if(null!=s&&this.removeAll(t),null!=e)if(null!=e.length){l&&e.sort();for(var n=0;n<e.length;++n){var r=e[n],o=this.createElement(t,"option",r,null,{value:r});r==i&&o.setAttribute("selected","selected")}}else{var a={},h=[];for(c in e)a[e[c]]=c,h.push(e[c]);l&&h.sort();for(n=0;n<h.length;++n){var u=h[n],c=a[u],o=this.createElement(t,"option",u,null,{value:c});c==i&&o.setAttribute("selected","selected")}}},selectOption:function(t,e,i){if(null!=t){for(var s=0;s<t.options.length;++s){var l=t.options[s];if(this.isEqualStr(l.value,e+"",i)||"boolean"==typeof e&&(1==e&&scil.Utils.isTrue(l.value)||0==e&&scil.Utils.isFalse(l.value)))return void(t.selectedIndex=s)}t.selectedIndex=-1}},isEqualStr:function(t,e,i){return null==t&&null==e||null!=t&&null!=e&&(i?t.toLowerCase()==e.toLowerCase():t==e)},removeAll:function(t){if(null!=t&&null!=t.childNodes)for(var e=t.childNodes.length-1;0<=e;--e)t.removeChild(t.childNodes[e])},getParent:function(t,e){for(e=e.toUpperCase();null!=t;){if(null!=t.tagName&&t.tagName.toUpperCase()==e)return t;t=t.parentNode}return t},testParent:function(t,e){if(null==t||null==e)return!1;for(;null!=t;){if(t.parentNode==e)return!0;t=t.parentNode}return!1},firstElement:function(t,e){if(null==t)return null;for(var i=0;i<t.childNodes.length;++i){var s=t.childNodes[i];if(null==e&&"#text"!=s.nodeName||null!=e&&s.nodeName==e)return s}return null},arrayContainsArray:function(t,e){for(var i=0;i<e.length;++i)if(this.indexOf(t,e[i])<0)return!1;return!0},indexOf:function(t,e,i){if(null==t)return-1;i&&"string"==typeof e?e=e.toLowerCase():"string"!=typeof e&&(i=!1);for(var s=0;s<t.length;++s){var l=t[s];if(i&&(l=l.toLowerCase()),l==e)return s}return-1},delFromArray:function(t,e){for(var i=0,s=t.length-1;0<=s;--s)t[s]==e&&(t.splice(s,1),++i);return i},post:function(t,e,i){for(var s in null==this.form&&(this.form=scil.Utils.createElement(document.body,"form",null,{display:"none"})),scil.Utils.removeAll(this.form),e){var l=scil.Utils.createElement(this.form,"textarea");l.name=s,l.value=e[s]}this.form.target=i,this.form.method="post",this.form.action=t,this.form.submit()},postIframe:function(t,e){null==this.postform&&(this.postform=scil.Utils.createElement(document.body,"form",null,{display:"none"})),dojo.io.iframe.send({url:t,form:this.form,method:"POST",content:e,timeoutSeconds:5,preventCache:!0,handleAs:"text",error:function(t){},handle:function(t){}})},alert:function(t){scil.Utils.isNullOrEmpty(t)||(1e3<t.length&&(t=t.substr(0,1e3)+"..."),scil.Utils.nativemode?this.alert2(t,"JSDraw2.Editor Message"):alert(t))},download:function(t,e){var i;0<t.indexOf("?")?t+="&__tm="+(new Date).getTime():t+="?__tm="+(new Date).getTime(),scil.Utils.startswith(t,"http://")?(i={url:t,callbackParamName:"callback",load:e,error:function(t){alert(t)}},dojo.io.script.get(i)):(e={url:t,handleAs:"text",load:e,error:function(t){}},dojo.xhrGet(e))},ajax:function(t,e,i,s){null==s&&(s={});var l={url:t,sync:s.sync,handleAs:"text",content:scil.Utils.stupidTomcatBug(i),timeout:s.timeout,error:function(t){s.showprogress&&scil.Progress.hide(),null!=s.onError?s.onError(t):scil.Utils.alert(t.message)},load:function(t){s.showprogress&&scil.Progress.hide(),scil.Utils.ajaxCallback(t,e,s.onError,s.ignoresucceedcheck),null!=scil.User&&null!=scil.User.onAjax&&scil.User.onAjax()}};switch(s.showprogress&&scil.Progress.show(null==s.caption?"Loading ...":s.caption,!1,null==s.message?"Communicating with the server ...":s.message,!1),null!=scil.Utils.onajaxcall&&scil.Utils.onajaxcall(l,s),null!=s.headers&&(l.headers=s.headers),s.verb){case"delete":case"del":dojo.xhrDelete(l);break;case"put":dojo.xhrPut(l);break;case"get":dojo.xhrGet(l);break;default:dojo.xhrPost(l)}},stupidTomcatBug:function(t){return t},ajaxwait:function(t,e){var i=null;return this.ajax(t,function(t){i=t},e,{sync:!0}),i},jsonp:function(e,i,t,s){null==s&&(s={}),null==t?t={wrapper:"jsonp"}:t.wrapper="jsonp",scil.Utils.startswith(e,"//")&&(l=(window.location+"").toLowerCase(),e=scil.Utils.startswith(l,"https:")?"https:"+e:"http:"+e);var l=e.indexOf("?");e+=l<0?"?":"&",e+="__jsdraw_timestamp__="+(new Date).getTime(),s.showprogress&&scil.Progress.show(null==s.caption?"Loading ...":s.caption,!1,null==s.message?"Communicating with the server ...":s.message,!1),null!=s.xdomainurl?scil.Utils.postXdomainData(s.xdomainurl,function(t){scil.Utils.jsonp(e,function(t){s.showprogress&&scil.Progress.hide(),null!=i&&i(t)},{_xfilename:t})},t):(t={url:e,callbackParamName:"callback",content:scil.Utils.stupidTomcatBug(t),error:function(t){s.showprogress&&scil.Progress.hide(),null!=s.onError?s.onError(t):scil.Utils.alert(t.message)},load:function(t){s.showprogress&&scil.Progress.hide(),scil.Utils.ajaxCallback(t,i,s.onError,s.ignoresucceedcheck)}},null!=scil.Utils.onjsonpcall&&scil.Utils.onjsonpcall(t),dojo.io.script.get(t))},getZindex:function(t){for(;null!=t;){if(null!=t.style&&""!=t.style.zIndex&&null!=t.style.zIndex)return parseInt(t.style.zIndex);t=t.parentNode}return 1},onAjaxCallback:null,ajaxCallback:function(data,callback,onError,ignoresucceedcheck){var ret=null;switch(typeof data){case"string":try{eval("var o="+data),ret=o}catch(e){return void scil.Utils.alert("Error when parsing Ajax results:\n"+e.message+"\n"+data)}break;case"object":ret=data;break;default:scil.Utils.alert("Unknown return format")}null!=scil.Utils.onAjaxCallback&&scil.Utils.onAjaxCallback(ret)||(1==ignoresucceedcheck?null!=callback&&callback(ret):ret.succeed?null!=callback&&callback(ret.ret):null!=scil.User&&null!=scil.User.needLogin&&scil.User.needLogin(ret)||(null!=onError?onError(ret):"None"==ret.errcode?scil.Utils.alert(ret.error):scil.Utils.alert("["+(null==ret.errcode?"ERROR":ret.errcode)+"]: "+ret.error)))},ajaxUploadFile:function(t,e,i,s){var l;null==i&&(i={}),e.toLowerCase().indexOf("wrapper=textarea")<0&&(l=e.indexOf("?"),e+=0<l?"&wrapper=textarea":"?wrapper=textarea"),null==scil.Utils.___ajaxUploadFile&&(dojo.config.dojoBlankHtmlUrl=scil.Utils.imgSrc("blank.html"),dojo.io.iframe.send({url:dojo.config.dojoBlankHtmlUrl,form:t,method:"get",content:i,timeoutSeconds:60,preventCache:!0,handleAs:"text"}),scil.Utils.___ajaxUploadFile),dojo.io.iframe.send({url:e,form:t,method:"post",content:i,timeoutSeconds:60,preventCache:!0,handleAs:"text",error:function(t){scil.Progress.hide(),scil.Utils.alert(t.message)},handle:function(t){scil.Progress.hide(),scil.Utils.ajaxCallback(t,s)}}),scil.Progress.show("Uploading",!1,"Communicating with the server ...",!1)},ajaxPostFile:function(t,e,i,s){var l;null==i&&(i={}),e.toLowerCase().indexOf("wrapper=textarea")<0&&(l=e.indexOf("?"),e+=0<l?"&wrapper=textarea":"?wrapper=textarea"),dojo.io.iframe.send({url:e,form:t,method:"post",content:i,timeoutSeconds:5,preventCache:!0,handleAs:"text",handle:function(t){null!=s&&s(t)}})},res:function(t){return JSDraw2.Language.res(t)},UploadFileDlg:scilligence.extend(scilligence._base,{callback:null,url:null,params:null,msg:null,checkfiles:null,dlg:null,btn:null,tbody:null,files:[],constructor:function(t){var e=JsUtils.createElement(null,"div","<form method='post' enctype='multipart/form-data'></form>");this.form=e.firstChild,this.tbody=JsUtils.createTable(this.form,null,null,{margin:"6px",width:"350px"},{align:"center"});var i=JsUtils.createElement(this.tbody,"tr");this.msg=JsUtils.createElement(i,"td"),this.msg.colSpan=2,null!=t&&1==t&&(t=5);var s=1;t&&scil.Utils.isIE&&scil.Utils.isIE<10&&(s=1<t?t:5);var l={size:26,name:"file"};t&&1==s&&(l.multiple="multiple");for(var n,r,o=0;o<s;++o)i=JsUtils.createElement(this.tbody,"tr"),JsUtils.createElement(i,"td",scil.Utils.res("File")+":"),this.files[o]=JsUtils.createElement(JsUtils.createElement(i,"td"),"file",null,null,l);null!=scil.MobileData&&(n=this,i=JsUtils.createElement(this.tbody,"tr"),JsUtils.createElement(i,"td","<div style='white-space:nowrap'>"+scil.Utils.res("From Mobile")+":</div>",null,{valign:"top"}),r=JsUtils.createElement(i,"td"),this.mobileimages=JsUtils.createElement(r,"hidden",null,null,{name:"mobileimages"}),scil.Utils.createButton(r,{label:"Show",type:"a",onclick:function(){n.showImageList()}}),this.imagelistdiv=JsUtils.createElement(r,"div",null,{display:"none"}),this.imagelist=scil.MobileData.createImageList(this.imagelistdiv,t)),i=JsUtils.createElement(this.tbody,"tr",null,{display:"none"}),JsUtils.createElement(i,"td","Password:"),JsUtils.createElement(JsUtils.createElement(i,"td"),"password",null,null,{name:"jsdraw.upload.password"}),this.passwordRow=i,JsUtils.createElement(JsUtils.createElement(this.tbody,"tr"),"td","&nbsp;"),i=JsUtils.createElement(this.tbody,"tr"),JsUtils.createElement(i,"td"),this.btn=JsUtils.createElement(scil.Utils.createElement(i,"td"),"button","<img src='"+scil.App.imgSmall("submit.png")+"' />"+scil.Utils.res("Upload")),this.dlg=new JSDraw2.Dialog("Upload File",e)},showImageList:function(){"none"==this.imagelistdiv.style.display?(this.imagelistdiv.style.display="",scil.MobileData.listImages(this.imagelist,this.params)):this.imagelistdiv.style.display="none"},show:function(t,e,i,s,l,n,r,o){this.dlg.show(t),this.postonly=r,this.checkfiles=o,null!=this.imagelistdiv&&(this.imagelistdiv.style.display="none",this.imagelist.clear());var a=this;null!=this.btn&&(dojo.connect(this.btn,"onclick",function(t){a.show2(),t.preventDefault()}),this.btn=null),this.callback=function(t){null!=s&&s(t),a.dlg.hide()},this.url=i,this.params=l,this.form.reset(),this.passwordRow.style.display=n?"":"none",this.msg.innerHTML=e},show2:function(){if(null!=this.mobileimages&&(this.mobileimages.value=scil.MobileData.getSelectedImages(this.imagelist)),this.postonly){var t=this.files[0].value,e=t.lastIndexOf("\\");0<e&&(t=t.substr(e+1));var e=(new Date).getTime(),i=null==this.params?{}:scil.clone(this.params);i._xfilename=e+"_"+t;var s=this;scil.Utils.ajaxPostFile(this.form,this.url,i,function(){s.callback(i._xfilename)})}else{s=this;if(this.checkfiles){for(var l=[],n=this.files[0].files,r=0;r<n.length;++r)l.push(n[r].name);this.checkfiles(l,function(t){var e=scil.clone(s.params);e.overwrite=t,scil.Utils.ajaxUploadFile(s.form,s.url,e,s.callback)})}else scil.Utils.ajaxUploadFile(s.form,s.url,s.params,s.callback)}}}),postXdomainData:function(t,e,i){var s=(new Date).getTime(),l=scil.clone(i);null==l&&(l={}),l._xfilename=s,null==this.xdomainform&&(this.xdomainform=scil.Utils.createElement(document.body,"form",null,{display:"none"})),scil.Utils.ajaxPostFile(this.xdomainform,t,l,function(){null!=e&&e(l._xfilename)})},uploadfileDlg:null,uploadfileDlg2:null,uploadFile:function(t,e,i,s,l,n,r,o,a,h){r?(null==this.uploadfileDlg2&&(this.uploadfileDlg2=new scil.Utils.UploadFileDlg(!0)),this.uploadfileDlg2.show(t,e,i,s,l,o,a,h),this.uploadfileDlg2.check=n):(null==this.uploadfileDlg&&(this.uploadfileDlg=new scil.Utils.UploadFileDlg),this.uploadfileDlg.show(t,e,i,s,l,o,a,h),this.uploadfileDlg.check=n)},uploadFile2:function(){var t=this.uploadfileDlg,e=t.params;scil.Utils.ajaxUploadFile(this.uploadfileDlg.form,t.url,null==e?{}:e,t.callback)},ie2touches:function(t){for(var e=t.getPointerList(),i=[],s=0;s<e.length;++s)i.push({pointerId:e[s].pointerId,clientX:e[s].clientX,clientY:e[s].clientY,target:t.target,button:t.button});return i.sort(function(t,e){return t.pointerId-e.pointerId}),t.touches=i,t},getScreenSize:function(t){null==t&&(t=window);var e=t.document.documentElement||t.document.body,t=t.document.parentWindow||t.document.defaultView;return{w:t.innerWidth||e.clientWidth,h:t.innerHeight||e.clientHeight}},json2str:function(t,e,i){var s=i?'"':"'";if(null==t)return"null";if("number"==typeof t)return t;if("boolean"==typeof t)return t?"true":"false";if("string"==typeof t){var l=t.replace(/\r/g,"\\r").replace(/\n/g,"\\n");return s+(l='"'==s?l.replace(/\"/g,'\\"'):l.replace(/\'/g,"\\'"))+s}if("object"!=typeof t)return"null";if(null!=t.length){for(var l=e?"[ ":"[",n=0;n<t.length;++n)l+=(0<n?e?", ":",":"")+this.json2str(t[n],e,i);return l+=e?" ]":"]"}var r,l=e?"{ ":"{",o=0;for(r in t)null!=r&&""!=r&&null!=t[r]&&"_"!=r.substr(0,1)&&(1<++o&&("}"==l.substr(l.length-1,1)?l+=e?",\r\n":",":l+=e?", ":","),!i&&/^[a-z|_]+[0-9|a-z|_]{0,1000}$/.test(r)?l+=r:l+=s+r+s,l+=(e?": ":":")+this.json2str(t[r],e,i));return l+=e?" }":"}"},getMaxZindex:function(){var t=this.getMaxZindex2("div"),e=this.getMaxZindex2("iframe"),i=this.getMaxZindex2("table");return Math.max(Math.max(t,e),i)},getMaxZindex2:function(t){for(var e,i="mce-fullscreen"==document.body.className?101:1,s=document.getElementsByTagName(t),l=0;l<s.length;++l)null!=s[l].style&&"none"!=s[l].style.display&&(null==(e=s[l].style.zIndex)||""==e||i<(e=parseInt(e))&&(i=e));return i},isAllParentVisible:function(t){if(null==t)return!1;for(;null!=t&&null!=t.style;){if("none"==t.style.display)return!1;t=t.parentNode}return!0},xml2Json:function(t,e){if(null==t)return null;var i=t.getElementsByTagName(e);if(null==i||0==i.length)return null;for(var s=[],l=0;l<i.length;++l){for(var n=i[l],r={_e:n},o=0;o<n.attributes.length;++o){var a=n.attributes[o];r[a.name]=a.value}s.push(r)}return s},jsonList2Xml:function(t,e){if(null==t)return"";for(var i="",s=0;s<t.length;++s)i+=this.json2Xml(t[s],e);return i},json2Xml:function(t,e,i){if(null==t)return"";var s,l="<"+e;for(s in t){var n=t[s];null==n||"string"==typeof n&&""==n||"object"!=(n=typeof n)&&"function"!=n&&(l+=" "+s+'="'+scil.Utils.escXmlValue(t[s])+'"')}return l+=null!=i&&""!=i?">"+i+"</"+e+">":"/>"},joinArray:function(t,e){if(null==t&&null==e)return null;if(null==t)return e;if(null==e)return t;var i=[];if("string"==typeof t||null==t.length)i.push(t);else for(var s=0;s<t.length;++s)i.push(t[s]);if("string"==typeof e||null==e.length)i.push(e);else for(s=0;s<e.length;++s)i.push(e[s]);return i},getInnerXml:function(t){if(null!=t){if(null!=t.documentElement&&(t=t.documentElement),t.innerXML)return t.innerXML;if(t.xml)return t.xml;if("undefined"==typeof XMLSerializer)return null;for(var e="",i=0;i<t.childNodes.length;++i)e+=(new XMLSerializer).serializeToString(t.childNodes[i]);return e}},getInnerText:function(t){if(null!=t)return null!=t&&null!=t.documentElement&&(t=t.documentElement),scil.Utils.trim(t.innerText||t.textContent||t.text)},getChildXmlElements:function(t,e){if(null!=t&&null!=t.documentElement&&(t=t.documentElement),null==t)return null;for(var i=[],s=0;s<t.childNodes.length;++s)t.childNodes[s].tagName==e&&i.push(t.childNodes[s]);return i},num2letter:function(t,e){for(var i="";0<t;){var s=(t-1)%26,i=String.fromCharCode(s+(e?97:65))+i;t=(t-s-1)/26}return i},isImg:function(t){return"gif"==t||"png"==t||"jpg"==t||"jpeg"==t||"tif"==t||"tiff"==t||"bmp"==t},isOfficeFile:function(t){return"doc"==t||"docx"==t||"rtf"==t||"ppt"==t||"pptx"==t||"xls"==t||"xlsx"==t},isPDF:function(t){return"pdf"==t},isSpectraFile:function(t){return"jdx"==t},isChemFile:function(t){return"cdx"==t||"cdxml"==t||"jsd"==t||"jsdraw"==t||"mol"==t||"sdf"==t||"mol2"==t||"cml"==t||"skc"==t||"tgf"==t||"mrv"==t||"rxn"==t||"rdf"==t||"helm"==t||"xhelm"==t},getFileExt:function(t){if(null==t)return null;var e=null==t?-1:t.lastIndexOf(".");return e<=0?null:t.substr(e+1)},isChildOf:function(t,e){if(null==e||null==t)return!1;for(;null!=t;){if(t.parentNode==e)return!0;t=t.parentNode}return!1},getElements:function(t,e,i){var s=[];if(null!=t&&null!=t.childNodes)for(var l=0;l<t.childNodes.length;++l){var n=t.childNodes[l];(n.tagName==e||i&&null!=n.tagName&&null!=e&&n.tagName.toLowerCase()==e.toLowerCase())&&s.push(n)}return s},getFirstElement:function(t,e){if(null!=t&&null!=t.childNodes)for(var i=0;i<t.childNodes.length;++i){var s=t.childNodes[i];if(null==e&&null!=s.tagName||null!=e&&s.tagName==e)return s}return null},parseIndex:function(t){if(null==t)return null;var e=t.replace(/[0-9]+$/,"");return e==t?{prefix:e,index:null}:{prefix:e,index:parseInt(t.substr(e.length))}},removeArrayItem:function(t,e){e=scil.Utils.indexOf(t,e);return!(e<0)&&(t.splice(e,1),!0)},removeArrayItems:function(t,e){for(var i=0,s=0;s<e.length;++s)this.removeArrayItem(t,e[s])&&++i;return i},moveToScreen:function(t,e,i,s){var l=dojo.window.getBox();t+i.offsetWidth>l.l+l.w&&(t=null!=s?s-i.offsetWidth:l.l+l.w-i.offsetWidth),t<0&&(t=0),e+i.offsetHeight>l.t+l.h&&(e=l.t+l.h-i.offsetHeight),e<0&&(e=0),i.style.left=t+"px",i.style.top=e+"px"},unselectable:function(t){t.onselectstart=function(){return!1},t.setAttribute("unselectable","on"),dojo.style(t,{webkitTouchCallout:"none",webkiUserDelect:"none",khtmlUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",userSelect:"none"})},letter2num:function(t){if(scil.Utils.isNullOrEmpty(t))return 0;var e=0;t=t.toUpperCase();for(var i=0;i<t.length;++i){var s=t.charCodeAt(i);65<=s&&s<=90&&(e=26*e+(s-65+1))}return e},connect:function(t,e,i){return dojo.connect(t,e,i)},array2str:function(t,e){if(null==t||0==t.length)return"";var i="";null==e&&(e=",");for(var s=0;s<t.length;++s)0<s&&(i+=e),null!=t[s]&&(i+=t[s]);return i},isDictEmpty:function(t){if(null==t)return!0;for(var e in t)return!1;return!0},getDictValues:function(t,e){if(null==t)return null;for(var i in null==e?e=[]:1==e&&(e=[""]),t)e.push(t[i]);return e},getDictKeys:function(t,e){if(null==t)return null;for(var i in null==e?e=[]:1==e&&(e=[""]),t)e.push(i);return e},getDictKeyByValue:function(t,e){if(null==t)return null;for(var i in t)if(t[i]==e)return i;return null},setEnv:function(t){null!=t&&""!=t&&(document.body.style.backgroundImage=scil.Utils.imgSrc("img/"+t+".gif",!0),document.body.style.backgroundRepeat="no-repeat")},sound:function(t){this.isIE&&this.isIE<9||(null==this.__sound&&(this.__sound=this.createElement(document.body,"audio",null,{display:"none"})),this.__sound.src!=t&&(this.__sound.src=t),this.__sound.play())},escapeHtml:function(t){return null==t?"":t.replace(/>/g,"&gt;").replace(/</g,"&lt;")},textWidth:function(t){if(null==t||null==t.length)return 0;for(var e=0,i=0;i<t.length;++i)255<t.charCodeAt(i)?e+=2:++e;return e},areListEq:function(t,e){if(t==e)return!0;if(null==t&&null!=e||null!=t&&null==e||t.length!=e.length)return!1;for(var i=0;i<t.length;++i)if(t[i]!=e[i])return!1;return!0},areDictEq:function(t,e){if(t==e)return!0;if(null==t||null==e)return!1;for(var i in t){var s=t[i],l=e[i];if(!(s==l||null==s&&""==l||""==s&&null==l))return!1}return!0},splitStr:function(t,e){if(null==t)return null;for(var i=[],s=t.split(e),l=0;l<s.length;++l)i.push(this.trim(s[l]));return i},isEmptyStr:function(t){return this.isNullOrEmpty(t)},regFindAllMatches:function(t,e,i){var s=[];if(null==t)return s;0<i?t=t.substr(i):i=0;for(var l=0;null!=(r=e.exec(t));){var n=r.index,r=r+"";s.push({start:l+n+i,str:r}),l+=n+r.length,t=t.substr(n+r.length)}return s},isNumber:function(t,e){if("number"==typeof t)return!0;if(scil.Utils.isNullOrEmpty(t))return!1;var i,s=t.indexOf(".");return 0<s&&(0<(i=t.indexOf(","))&&i<s&&(t=t.replace(/[,]/g,""))),e?new RegExp("^[>|<|≥|≤]?[ ]{0,50}[-]?[0-9]+([.][0-9]{0,50})?([e|E][-|+][0-9]+)?([ ]{0,50}[±][0-9]{0,50}([.][0-9]{0,50})?)?$").test(t+""):!isNaN(t)},htmlDecode:function(t){if(scil.Utils.isNullOrEmpty(t))return t;var e=document.createElement("div");return e.innerHTML=t,0===e.childNodes.length?"":e.childNodes[0].nodeValue},html2Text:function(t){if(this.isNullOrEmpty(t))return t;var e=document.createElement("div");return e.innerHTML=t,0===e.childNodes.length?"":this.getInnerText(e)},parseNumber:function(t){t=null==t?NaN:parseFloat(t);return isNaN(t)?null:t},isNullOrEmpty:function(t){return null==t||"string"==typeof t&&""==t},isNaN:function(t){return null==t||isNaN(t)},getOuterXml:function(t){return null==t?null:null!=t.xml?t.xml:(new XMLSerializer).serializeToString(t)},addCss:function(t){var e=document.createElement("style");e.type="text/css",e.styleSheet?e.styleSheet.cssText=t:e.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(e)},insertAfterDict:function(t,e,i){var s,l=!1,n={};for(s in t)s==i?l=!0:l&&(n[s]=t[s],delete t[s]);for(s in e)t[s]=e[s];for(s in n)t[s]=n[s]},insertBeforeDict:function(t,e,i){var s,l=!1,n={};for(s in t)s!=i&&!l||(l=!0,n[s]=t[s],delete t[s]);for(s in e)t[s]=e[s];for(s in n)t[s]=n[s]},disableSelection:function(t){null!=t&&scil.apply(t.style,{webkitTouchCallout:"none",webkitUserSelect:"none",mozUserSelect:"none",msUserSelect:"none",userSelect:"none"})},getLastBarcode:function(e,t,i,s){scil.Utils.jsonp(null!=s?s:"JSDraw/Service.aspx?cmd=mobile.getlast",function(t){e(t)},{category:t,useremail:i})},beep:function(t){var e;"undefined"!=typeof Audio&&(null==this._beepobj&&(this._beepobj=new Audio("data:audio/wav;base64,UklGRtoEAABXQVZFZm10IBAAAAABAAEAESsAABErAAABAAgAZGF0YbUEAAB9dXFpa3F4fYSLkZiUjoeCe3RuaWtze36GjJOZkYyGgHpybGhvc3uBiI2UmZCKhX93cWxob3Z9g4mQlZaPioN8dm9qanF4f4OLkZeUjoiBe3RvaWxzeICGi5OYlIuFgXlybWltdHuBiI6Ul5CLhn14cmlqcHV8g4mOl5ePiYR8dnBoa3F3foWKkZaVjoiBenVwZ2xyeoCFjZKXlIyGgHpza2lvdHmCh4+Tl5KKhX54cWtpb3Z9gYmPlpePiYN9dnBoa3F4foOLkZeWjYmAfHRvZ25yeX+FjZKXlIyFgXlza2lvc3uAh46Vl5CLhX93cWtqb3V9g4iQlZePioJ9dnFoa3F4foSKkZaUj4eBfHVuaWtzeX+GjJKYk4yGgHl0bWdudXt/iI2VmJCMhX53cWtqb3Z8g4iQlZaPioN8dnFoa3B4foSKkZeVjoiCe3RuaWxzeX+Gi5OXk42Gf3tzbGhtdXuBh4yVl5GMhH54cmtpcHV8g4mOlpaRiYN9dm9raXF4fYSLkJaWjoeCenZuaGxzeICFjJOXk4yHf3pzbWltdHqBiI2Ul5GNhH54cmtpbnd7gomQlZePi4J9dnBqanF3fYOLkJiUj4eBfHVuaWtzeX+FjJKYk4yHgHpzbGltc3uBh42Vl5GLhX92c2ppcXV8gomPlZiOioJ+dnFpaXF5fYOKkZeWjYiDenVuaWtzeIGFjJKXk42GgHl1bWhtdHt/h42Vl5KLhH93c2tob3V9g4iPlZePi4N8d3Bpa3F3foSJkZaWj4eCfHNvaGtyen+FjJGYlIuIgHl0bGhuc3uBh42Ul5KMg4B4cmtocXR8g4mPlZWRioJ9d29ram93foSJkZeUjomCe3VvaG1yd3+Hi5KYlI2GgHpzbmdtdHqBiIyVlpKLhH95cmppb3V8g4iOlpeQiYN+dnFqaXJ2fYSLj5iUj4iCfHRuaWxzeH+FjJGYk42Hf3tzbWhudHqAho6TmZGLhX94c2ppbnZ8gomOlpePi4J+dnBqanB3foOKkJeWjoiBfHRwaGxyeH+Gi5KYk46GgXpzbWdudHqAh46TmJGMhX54cmtpb3V8g4ePlZiPioR9dnFpa3B2foOKkZaVj4iBfHZuaWxyeX6EjZGYlI2GgXlzbmhuc3qBho2Ul5KLhX95cWtpcHV8gYiPlZePi4R8d3FpanB3foOKkJiVjomBe3ZuamtyeICFipOWlI6FgXp1a2psc3uAh46SmJKLhX94c2tocHR9goiOlZeRioN9d3BqaXF3foKLkJWVj4mBfHVvaWtyeH+Gi5KXloyHgHl0bmhuc3qAh42Tl5KMhX55cmtocHZ7goiOlZePioR8eHBqanF2fYSJkJiVj4iCfHZuaGxzeH2Hi5KXlY2FgHtzbWltc3qAh42UlpKMhX94c2tqbnZ6gomOlpaRi4N9d3FpanF2fYSKkJWWjomCe3ZvaWtxeX6Fi5KYk42HgXp0bmhtc3uAhoyUmJKLhYB4c2tocHR9gYiOlpeQioN9d3JqanB3fISJkJeVj4iBfnRwaWpyeX6FjJGXlI6GgHp1bGlucnqBhoyUmJKMhH94c21nb3V8gYmOlZeQi4N+d3FqaXB3fQA=")),this._beepobj.play(),t&&(e=this,setTimeout(function(){e._beepobj.play()},300)))},textareaSelect:function(t,e,i){void 0!==t.selectionStart&&(t.focus(),t.selectionStart=e,t.selectionEnd=i),document.selection&&document.selection.createRange&&(t.focus(),t.select(),(t=document.selection.createRange()).collapse(!0),t.moveEnd("character",i),t.moveStart("character",e),t.select())},fireEvent:function(t,e,i,s,l){var n;document.createEvent?(n=document.createEvent("HTMLEvents")).initEvent(e,null==i||i,null==s||s):(n=document.createEventObject()).eventType=e,null!=l&&scil.apply(n,l),n.eventName=e,document.createEvent?t.dispatchEvent(n):t.fireEvent("on"+n.eventType,n)},sum:function(t){return scil.Math.sum(t)},avg:function(t){return scil.Math.avg(t)},stdev:function(t){return scil.Math.stdev(t)}},scil.form={},JsUtils=scil.Utils,scil.Utils.padleft=scil.Utils.padLeft,scil.Utils.padright=scil.Utils.padRight,JSDraw2={},scilligence.JSDraw2=JSDraw2,scilligence.JSDraw3=JSDraw3=JSDraw2,JSDraw2.speedup={fontsize:4,gap:0,disableundo:!1,minbondlength:1},JSDraw2.version="JSDraw V5.3.1",JSDraw2.kFileVersion="5.0",JSDraw2.defaultoptions={},JSDraw2.password={encrypt:!0},JSDraw2.TEXTKEYWORDS=["°C","rt","reflux","hr","min","sec","psi","atm","overnight","microwave","Δ"],JSDraw2.MOLECULETYPES=["SmallMolecule","Polymer","Peptide","DNA","RNA","ADC","ChemicalReagent"],JSDraw2.CHIRALITIES=["Achiral","Absolute","Racemic","Diastereomeric","Enatiomer R","Enatiomer S"],JSDraw2.BONDTYPES={UNKNOWN:0,SINGLE:1,DOUBLE:2,TRIPLE:3,DELOCALIZED:4,WEDGE:5,HASH:6,WIGGLY:7,EITHER:8,SINGLEORDOUBLE:9,SINGLEORAROMATIC:10,DOUBLEORAROMATIC:11,QUADRUPLE:12,DUMMY:13,BOLD:14,BOLDHASH:15,PEPTIDE:21,NUCLEOTIDE:22,DISULFIDE:23,AMIDE:24},JSDraw2.RXNCENTER={NOTCENTER:-1,CENTER:1,BREAK:4,CHANGE:8,BREAKANDCHANGE:12},JSDraw2.ALIGN={RIGHT:0,BOTTOM:1,LEFT:2,TOP:3},JSDraw2.BIO={AA:"AA",ANTIBODY:"ANTIBODY",PROTEIN:"PROTEIN",GENE:"GENE",DNA:"DNA",RNA:"RNA",BASE_DNA:"BASEDNA",BASE_RNA:"BASERNA"},JSDraw2.ANTIBODY={IgG:"IgG",Fab:"Fab",ScFv:"ScFv"},JSDraw2.DNATable={GCT:"A",GCC:"A",GCA:"A",GCG:"A",CGT:"R",CGC:"R",CGA:"R",CGG:"R",AGA:"R",AGG:"R",AAT:"",AAC:"N",GAT:"D",GAC:"D",TGT:"C",TGC:"C",CAA:"Q",CAG:"Q",GAA:"E",GAG:"E",GGT:"G",GGC:"G",GGA:"G",GGG:"G",CAT:"H",CAC:"H",ATT:"I",ATC:"I",ATA:"I",TTA:"L",TTG:"L",CTT:"L",CTC:"L",CTA:"L",CTG:"L",AAA:"K",AAG:"K",ATG:"[",TTT:"F",TTC:"F",CCT:"P",CCC:"P",CCA:"P",CCG:"P",TCT:"S",TCC:"S",TCA:"S",TCG:"S",AGT:"S",AGC:"S",ACT:"T",ACC:"T",ACA:"T",ACG:"T",TGG:"W",TAT:"Y",TAC:"Y",GTT:"V",GTC:"V",GTA:"V",GTG:"V",TAA:"]",TGA:"]",TAG:"]"},JSDraw2.RNATable={GCU:"A",GCC:"A",GCA:"A",GCG:"A",CGU:"R",CGC:"R",CGA:"R",CGG:"R",AGA:"R",AGG:"R",AAU:"N",AAC:"N",GAU:"D",GAC:"D",UGU:"C",UGC:"C",CAA:"Q",CAG:"Q",GAA:"E",GAG:"E",GGU:"G",GGC:"G",GGA:"G",GGG:"G",CAU:"H",CAC:"H",AUU:"I",AUC:"I",AUA:"I",AUG:"M",UUA:"L",UUG:"L",CUU:"L",CUC:"L",CUA:"L",CUG:"L",AAA:"K",AAG:"K",UUU:"F",UUC:"F",CCU:"P",CCC:"P",CCA:"P",CCG:"P",UCU:"S",UCC:"S",UCA:"S",UCG:"S",AGU:"S",AGC:"S",ACU:"T",ACC:"T",ACA:"T",ACG:"T",UGG:"W",UAU:"Y",UAC:"Y",GUU:"V",GUC:"V",GUA:"V",GUG:"V",UAA:"]",UGA:"]",UAG:"]"},JSDraw2.needPro=function(){scil.Utils.alert("This is a JSDraw Pro feature.")},JSDraw2.Security={kEdition:"Lite",error:null,valid:!0,_check:function(){}},scil.apply(JSDraw2,{Text:{cast:function(t){return null}},Shape:{cast:function(t){return null}},Bracket:{cast:function(t){return null}},AssayCurve:{cast:function(t){return null}},Arrow:{cast:function(t){return null}},TLC:{cast:function(t){return null}},Spectrum:{cast:function(t){return null}},Plus:{cast:function(t){return null}},Group:{cast:function(t){return null}},RGroup:{cast:function(t){return null}}}),JSDraw2.PT={commonUsed:{C:"C",N:"N",O:"O",S:"S",P:"P",F:"F",Cl:"L",Br:"B",I:"I",H:"H,D,T",Si:null,R:"R"},getCommonUsedElements:function(t){var e=[];if("menu"==t){for(var i in JSDraw2.PT.commonUsed)e.push({caption:i,shortcut:JSDraw2.PT.commonUsed[i]});e.push("-")}else for(var i in this.commonUsed)e.push(i);return e},"*":{a:0},X:{a:0},R:{a:0},H:{a:1,c:"909090",m:1.0079,em:1.0078,e:1,v:[1],iso:{1:1.0078,2:2.0141,3:3.0161}},Be:{a:4,c:"C2FF00",m:9.0122,em:9.0122,v:[0,2],iso:{9:9.0122}},B:{a:5,c:"FFB5B5",m:10.811,em:11.0093,e:3,v:[3],iso:{10:10.0129,11:11.0093}},C:{a:6,c:"000000",m:12.0107,em:12,e:4,v:[4],iso:{12:12,13:13.0034}},N:{a:7,c:"3050F8",m:14.0067,em:14.0031,e:5,v:[3],iso:{14:14.0031,15:15.0001}},O:{a:8,c:"FF0D0D",m:15.9994,em:15.9949,e:6,v:[2],iso:{16:15.9949,17:16.9991,18:17.9992}},F:{a:9,c:"90E050",m:18.9984,em:18.9984,e:7,v:[1],iso:{19:18.9984}},Na:{a:11,c:"AB5CF2",m:22.9898,em:22.9898,v:[0,1],iso:{23:22.9898}},Si:{a:14,c:"F0C8A0",m:28.0855,em:27.9769,e:4,v:[4],iso:{28:27.9769,29:28.9765,30:29.9738}},P:{a:15,c:"FF8000",m:30.9738,em:30.9738,e:5,v:[3,5],iso:{31:30.9738}},S:{a:16,c:"C0C000",m:32.065,em:31.9721,e:6,v:[2,4,6],iso:{32:31.9721,33:32.9715,34:33.9679,36:35.9671}},Cl:{a:17,c:"1FF01F",m:35.453,em:34.9689,e:7,v:[1,3,5,7],iso:{35:34.9689,37:36.9659}},K:{a:19,c:"8F40D4",m:39.0983,em:38.9637,v:[0,1],iso:{39:38.9637,40:39.964,41:40.9618}},Ca:{a:20,c:"3DFF00",m:40.078,em:39.9626,v:[0,2],iso:{40:39.9626,42:41.9586,43:42.9588,44:43.9555,46:45.9537,48:47.9525}},Ge:{a:32,c:"668F8F",m:72.64,em:73.9212,v:[4,2],iso:{70:69.9243,72:71.9221,73:72.9235,74:73.9212,76:75.9214}},As:{a:33,c:"BD80E3",m:74.9216,em:74.9216,e:5,v:[3,5],iso:{75:74.9216}},Se:{a:34,c:"FFA100",m:78.96,em:79.9165,e:6,v:[2,4,6],iso:{74:73.9225,76:75.9192,77:76.9199,78:77.9173,80:79.9165,82:81.9167}},Br:{a:35,c:"A62929",m:79.904,em:78.9183,e:7,v:[1,3,5,7],iso:{79:78.9183,81:80.9163}},I:{a:53,c:"940094",m:126.904,em:126.904,e:7,v:[1,3,5,7],iso:{127:126.904}},isElectronAcceptor:function(t){t=t.a;return 6<=t&&t<=9||15<=t&&t<=17||33<=t&&t<=35||50<=t&&t<=53||83<=t&&t<=85},showQueryAtoms:function(t,e){for(var i=t.getElementsByTagName("button"),s=0;s<i.length;++s)"1"==i[s].getAttribute("r")&&(i[s].style.display=e?"":"none")},makeAtomList:function(t,e){if(null==t||""==t)return null;for(var i=[],s=t.split(","),l=0;l<s.length;++l){var n=scilligence.Utils.trim(s[l]);this.isValidAtomList(n)&&i.push(n)}return 0==i.length?null:{atoms:i,t:!scilligence.Utils.isFalse(e)}},isMetal:function(t){return!1},isValidAtomList:function(t){var e=JSDraw2.PT[t];return null!=e&&0<e.a||"*"==t||"A"==t||"a"==t||"c"==t||this.isArAtom(t.toUpperCase())},isArAtom:function(t){return"C"==t||"N"==t||"S"==t||"P"==t||"O"==t}},JSDraw2.Atom=scil.extend(scil._base,{constructor:function(t,e,i){this.T="ATOM",this.p=t,this.charge=0,this.isotope=null,this.radical=null,this.group=null,this.alias=null,this.superatom=null,this.attachpoints=[],this.rgroup=null,this.bio=i,this.locked=!1,this.hidden=null,(this._rect=null)==i?null==e||0==e.length?this.elem="C":"D"==e?(this.elem="H",this.isotope=2):"T"==e?(this.elem="H",this.isotope=3):this.elem=e:this.elem=e,this.color=null,this.hcount=null,this.selected=!1,this.f=null,this.bonds=null,this.id=null,this.atommapid=null,this.query=null,this.hasError=null,this.hs=null,this.val=null,this.tag=null},clone:function(t){var e=new JSDraw2.Atom(this.p.clone(),this.elem,dojo.clone(this.bio));return e.charge=this.charge,e.isotope=this.isotope,e.radical=this.radical,e.hcount=this.hcount,e.id=this.id,e.color=this.color,e.tag=this.tag,e.alias=this.alias,e.superatom=null==this.superatom?null:this.superatom.clone(),e.attachpoints=scil.clone(this.attachpoints),e.rgroup=null==this.rgroup?null:this.rgroup.clone(t),e.atommapid=this.atommapid,e.hasError=this.hasError,e.hs=this.hs,e.val=this.val,null!=this.query&&(e.query=scil.clone(this.query)),null!=this.bio&&(e.bio=scil.clone(this.bio)),e.locked=this.locked,e.hidden=this.hidden,e.ratio=this.ratio,e.selected=this.selected,e},biotype:function(){return null==this.bio?null:this.bio.type},isMarkedStereo:function(){var t=this.bonds;if(null==t||3!=t.length&&4!=t.length)return!1;for(var e=0;e<t.length;++e)if(t[e].a1==this&&(t[e].type==JSDraw2.BONDTYPES.WEDGE||t[e].type==JSDraw2.BONDTYPES.HASH))return!0;return!1},updateRGroup:function(){null!=this.rgroup&&(this.rgroup.text=(null==this.alias||""==this.alias?this.elem:this.alias)+"=")},getLabel:function(){return null!=this.alias&&""!=this.alias?this.alias:this.elem},html:function(t,e){var i="<a i='"+this.id+"' e='"+scil.Utils.escXmlValue(this.elem)+"' p='"+this.p.toString(t)+"'";if(null==this.bio){if(0!=this.charge&&(i+=" c='"+this.charge+"'"),1<=this.radical&&this.radical<=3&&(i+=" rad='"+this.radical+"'"),0<this.isotope&&(i+=" iso='"+this.isotope+"'"),null!=this.tag&&""!=this.tag&&(i+=" tag='"+scil.Utils.escXmlValue(this.tag)+"'"),null!=this.alias&&""!=this.alias&&(i+=" alias='"+scil.Utils.escXmlValue(this.alias)+"'"),null!=this.color&&(i+=" clr='"+this.color+"'"),0<this.atommapid&&(i+=" ami='"+this.atommapid+"'"),this.locked&&(i+=" locked='1'"),0<this.attachpoints.length){for(var s="",l=0;l<this.attachpoints.length;++l)s+=(0<l?",":"")+this.attachpoints[l];i+=" apo='"+s+"'"}0<this.hs&&(i+=" hs='"+this.hs+"'"),0<this.val&&(i+=" val='"+this.val+"'"),null!=this.group&&(i+=" g='"+this.group.id+"'"),null!=this.query&&(null!=this.query.sub&&(i+=" sub='"+this.query.sub+"'"),null!=this.query.uns&&(i+=" uns='"+(this.query.uns?1:0)+"'"),null!=this.query.rbc&&(i+=" rbc='"+this.query.rbc+"'"),null!=this.query.als&&null!=this.query.t&&(i+=" als='"+this.query.als.join(",")+"'",i+=" als_t='"+(0==this.query.t?0:1)+"'"))}else i+=" bio='"+this.bio.type+"'",scil.Utils.isNullOrEmpty(this.bio.subtype)||(i+=" subtype='"+this.bio.subtype+"'"),scil.Utils.isNullOrEmpty(this.bio.sequences)||(i+=" seq='"+scil.Utils.escXmlValue(this.bio.sequences)+"'"),0<this.bio.id&&(i+=" bioid='"+scil.Utils.escXmlValue(this.bio.id)+"'"),scil.Utils.isNullOrEmpty(this.bio.annotation)||(i+=" ann='"+scil.Utils.escXmlValue(this.bio.annotation)+"'"),"?"!=this.elem||scil.Utils.isNullOrEmpty(this.bio.ambiguity)||(i+=" amb='"+scil.Utils.escXmlValue(this.bio.ambiguity)+"'"),this.biotype()!=org.helm.webeditor.HELM.BLOB||scil.Utils.isNullOrEmpty(this.bio.blobtype)||(i+=" blobtype='"+scil.Utils.escXmlValue(this.bio.blobtype)+"'");if(null==this.rgroup&&null==this.superatom)i+="/>";else{if(i+=">\n",null!=this.rgroup){i+="<rgroup>\n",i+=this.rgroup.html(t)+"\n";for(var n=0;n<this.rgroup.mols.length;++n){var r=this.rgroup.mols[n]._getXml(null,null,null,null,e,!0);null!=r&&(i+=r)}i+="</rgroup>"}null!=this.superatom&&(i+="<superatom>\n",i+=this.superatom._getXml(null,null,null,null,e,!0),i+="</superatom>"),i+="</a>"}return i},readHtml:function(t){var e=t.getAttribute("c");null!=e&&(this.charge=parseInt(e)),null!=(o=t.getAttribute("clr"))&&(this.color=o);e=t.getAttribute("rad");null!=e&&""!=e&&(this.radical=parseInt(e));e=t.getAttribute("iso");null!=e&&""!=e&&(this.isotope=parseInt(e));e=t.getAttribute("hs");null!=e&&""!=e&&(this.hs=parseInt(e));e=t.getAttribute("val");null!=e&&""!=e&&(this.val=parseInt(e));e=t.getAttribute("tag");null!=e&&""!=e&&(this.tag=e);e=t.getAttribute("alias");null!=e&&""!=e&&(this.alias=e);e=t.getAttribute("ami");if(null==e||isNaN(e)||(this.atommapid=parseInt(e)),null!=(l=t.getAttribute("apo"))&&""!=l)for(var i=l.split(","),s=0;s<i.length;++s){var l,n=i[s];0<(l=isNaN(n)?0:parseInt(n))&&this.attachpoints.push(l)}e=t.getAttribute("rbc");null!=e&&(null==this.query&&(this.query={}),this.query.rbc=parseInt(e));e=t.getAttribute("sub");null!=e&&(null==this.query&&(this.query={}),this.query.sub="*"==e?"*":parseInt(e));e=t.getAttribute("uns");"1"!=e&&"0"!=e||(null==this.query&&(this.query={}),this.query.uns="1"==e);e=JSDraw2.PT.makeAtomList(t.getAttribute("als"),t.getAttribute("als_t"));if(null!=e&&(null==this.query&&(this.query={}),this.query.als=e.atoms,this.query.t=e.t),null!=this.bio&&(this.bio.subtype=t.getAttribute("subtype"),this.bio.sequences=t.getAttribute("seq"),bioid=parseInt(t.getAttribute("bioid")),0<bioid&&(this.bio.id=bioid),a=t.getAttribute("ann"),scil.Utils.isNullOrEmpty(a)||(this.bio.annotation=a),r=t.getAttribute("amb"),"?"!=this.elem||scil.Utils.isNullOrEmpty(r)||(this.bio.ambiguity=r),a=t.getAttribute("blobtype"),this.biotype()!=org.helm.webeditor.HELM.BLOB||scil.Utils.isNullOrEmpty(a)||(this.bio.blobtype=a)),null!=this.elem){var r=scil.Utils.getFirstElement(t,"rgroup");if(r){var o,a=scil.Utils.getFirstElement(r,"i");if(null!=a)if((o=new JSDraw2.RGroup).readHtml(a,null)){(this.rgroup=o).position=JSDraw2.Point.fromString(t.getAttribute("p"));for(var h,u=scil.Utils.getElements(r,"div"),s=0;s<u.length;++s)null!=(h=new JSDraw2.Mol).setXml(u[s])&&o.mols.push(h)}}}null==this.alias&&null==this.bio||null!=(t=null==(t=scil.Utils.getFirstElement(t,"superatom"))?null:scil.Utils.getFirstElement(t,"div"))&&null!=(h=new JSDraw2.Mol).setXml(t)&&(1==h.atoms.length&&h.atoms[0].elem==this.alias?(this.elem=this.alias,this.alias=null):this.superatom=h)},toggle:function(t,e){return null!=this._rect?this._rect.contains(t):this.p.distTo(t)<=e},drawCur:function(t,e,i,s){var l=null==this._rect?this.p:this._rect.center();if(t.createCircle({cx:l.x,cy:l.y,r:e}).setFill(i),"@"==this.elem&&null!=s)for(var n=s.getAllBonds(this),r=0;r<n.length;++r){var o=n[r];o.type==JSDraw2.BONDTYPES.DUMMY&&o.otherAtom(this).drawCur(t,.75*e,i)}},needShowAtomLabel:function(){return"C"!=this.elem||0!=this.charge||null!=this.isotope||4==this.hcount},showLabel:function(){return"C"!=a.elem||0!=a.charge||null!=a.isotope||4==a.hcount},drawBio:function(t,e,i,s){var l,n,r,o=this,a=this.biotype(),h=o.p.clone();a==JSDraw2.BIO.ANTIBODY?(s="#00f",n=o.bio.subtype==JSDraw2.ANTIBODY.ScFv?"#bbb":s,r=o.bio.subtype==JSDraw2.ANTIBODY.ScFv||o.bio.subtype==JSDraw2.ANTIBODY.Fab?"#bbb":s,t.createCircle({cx:h.x,cy:h.y,r:i}).setFill("white").setStroke({color:s,width:e/2}),i/=2,h.offset(0,-e),JSDraw2.Drawer.drawLine(t,new JSDraw2.Point(h.x-e,h.y),new JSDraw2.Point(h.x-e-i,h.y-i),n,e),JSDraw2.Drawer.drawLine(t,new JSDraw2.Point(h.x+e,h.y),new JSDraw2.Point(h.x+e+i,h.y-i),s,e),JSDraw2.Drawer.drawLine(t,new JSDraw2.Point(h.x-2*e,h.y+i/1.5),new JSDraw2.Point(h.x-2*e-i,h.y-i+i/1.5),n,e),JSDraw2.Drawer.drawLine(t,new JSDraw2.Point(h.x+2*e,h.y+i/1.5),new JSDraw2.Point(h.x+2*e+i,h.y-i+i/1.5),s,e),JSDraw2.Drawer.drawLine(t,new JSDraw2.Point(h.x-e,h.y),new JSDraw2.Point(h.x-e,h.y+2*i),r,e),JSDraw2.Drawer.drawLine(t,new JSDraw2.Point(h.x+e,h.y),new JSDraw2.Point(h.x+e,h.y+2*i),r,e)):a==JSDraw2.BIO.PROTEIN?(l=[{offset:0,color:"#4ea1fc"},{offset:e/20,color:"#0072e5"},{offset:e/10,color:"#003b80"}],t.createCircle({cx:this.p.x,cy:this.p.y,r:i}).setFill({type:"radial",cx:this.p.x+i/4,cy:this.p.y+i/4,colors:l})):a==JSDraw2.BIO.GENE||a==JSDraw2.BIO.DNA||a==JSDraw2.BIO.RNA?(s="#00f",n=o.bio.subtype==JSDraw2.ANTIBODY.ScFv?"#bbb":s,r=o.bio.subtype==JSDraw2.ANTIBODY.ScFv||o.bio.subtype==JSDraw2.ANTIBODY.Fab?"#bbb":s,t.createCircle({cx:h.x,cy:h.y,r:i}).setFill("white").setStroke({color:s,width:e/2}),this.drawEllipse(t,h.x+i/6,h.y+i/3,i/6,i/2,s,-20),this.drawEllipse(t,h.x+i/6,h.y-i/3,i/6,i/2,s,20),this.drawEllipse(t,h.x-i/6,h.y+i/3,i/6,i/2,s,20),this.drawEllipse(t,h.x-i/6,h.y-i/3,i/6,i/2,s,-20)):org.helm.webeditor.isHelmNode(o)?org.helm.webeditor.Interface.drawMonomer(t,o,h,i,e,s):(null==s&&(s=o.bio.type==JSDraw2.BIO.AA?"#00F":o.bio.type==JSDraw2.BIO.BASE_RNA?"#278925":"#FFAA00"),this.drawDiamond(t,h.x,h.y,.55*i,s,e),h.offset(0,-1),JSDraw2.Drawer.drawLabel(t,h,o.elem,s,i*(1<o.elem.length?2/o.elem.length:1),null,null,null,!1))},drawDiamond:function(t,e,i,s,l,n){t.createRect({x:e-s,y:i-s,width:2*s,height:2*s}).setTransform([dojox.gfx.matrix.rotategAt(45,e,i)]).setFill("white").setStroke({color:l,width:n/2})},drawEllipse:function(t,e,i,s,l,n,r){t.createEllipse({cx:e,cy:i,rx:s,ry:l}).setFill(n).setTransform([dojox.gfx.matrix.rotategAt(r,e,i)])},hasLabel:function(t,e){var i=this;return null==i.bio&&("C"!=i.elem||0!=i.charge||null!=i.radical||"C"==i.elem&&("all"==e||"terminal"==e&&1==t.getNeighborAtoms(i).length)||null!=i.isotope||4==i.hcount||0<i.hs||0<i.val||null!=i.alias&&""!=i.alias||null!=i.query&&(null!=i.query.sub||null!=i.query.uns||null!=i.query.rbc||null!=i.query.als&&null!=i.query.t))},hasErr:function(){var t=this,e=t.bio?null:JSDraw2.PT[t.elem];return!t.bio&&(null==e||0<=e.a&&t.hasError)&&"3'"!=t.elem&&"5'"!=t.elem},draw:function(t,e,i,s,l){var n=this;this._rect=null;var r=n.bio?null:JSDraw2.PT[n.elem],o=l&&this.hasErr(),a=n.color;if(null==n.bio){var h=a;if(null==a&&(h=a=t.monocolor?"black":null==r||null==r.c?"#000":"#"+r.c,o&&(h=null==r||null==r.c?"#000":"#fff")),0<n.attachpoints.length&&this.drawApo(n,i,t,e,s,a),null!=n.alias&&""!=n.alias)this._rect=JSDraw2.Atom.drawAlias(i.calcHDir(n,4*e,!0),t,n.p,n.alias,o?"red":h,s);else{var u=n.elem,l=n.isotope;"H"==u?2==l?(u="D",l=null):3==l&&(u="T",l=null):null!=n.query&&(d=r="",null!=n.query.als&&(r=(0==n.query.t?"!":"")+"["+n.query.als.join(",")+"]"),null!=n.query.rbc&&(d+=(""==d?"":",")+"r"+n.query.rbc),null!=n.query.sub&&(d+=(""==d?"":",")+"s"+n.query.sub),n.query.uns&&(d+=(""==d?"":",")+"u"),""==r&&""==d||(u=(""==r?u:r)+(""==d?"":"("+d+")")));var c,d=0,p=0;if(o||this._haslabel){var f=JSDraw2.Drawer.drawLabel(t,n.p,u,h,s,!!o&&"#f00"),m=null,g=null,w=null,b=null,S="";switch(0!=n.charge&&(S+=(1==Math.abs(n.charge)?"":Math.abs(n.charge)+"")+(0<n.charge?"+":"-")),n.radical){case 1:S+=":";break;case 2:S+="^";break;case 3:S+="^^"}""!=S&&(m=JSDraw2.Drawer.drawLabel(t,n.p,S,a,s/1.2,!1)),null!=l&&(b=JSDraw2.Drawer.drawLabel(t,n.p,l+"",a,s/1.1,!1)),null==n.query&&0<n.hcount&&(this._haslabel||"C"!=u||0!=n.charge||4==n.hcount)&&(g=JSDraw2.Drawer.drawLabel(t,n.p,"H",a,s,!1),w=1==n.hcount?null:JSDraw2.Drawer.drawLabel(t,n.p,n.hcount+"",a,s/1.4,!1));var v=f.getTextWidth();if(null!=m||null!=g||null!=w||null!=b){var u=scil.Utils.isOpera?Math.round(s/4):0,y=null==g?0:g.getTextWidth()+u,D=null==w?0:w.getTextWidth()+u,x=null==m?0:m.getTextWidth()+u,E=null==b?0:b.getTextWidth()+u;switch(i.calcHDir(n,4*e)){case JSDraw2.ALIGN.RIGHT:null!=b&&b.setTransform([dojox.gfx.matrix.translate(-(v/2+E/2),-4)]),null!=g&&g.setTransform([dojox.gfx.matrix.translate(v/2+y/2,0)]),null!=w&&w.setTransform([dojox.gfx.matrix.translate(v/2+y+D/2+0,4)]),null!=m&&m.setTransform([dojox.gfx.matrix.translate(v/2+y+D+x/2+0,-4)]),d=v/2+y+D+x+0;break;case JSDraw2.ALIGN.LEFT:null!=b&&b.setTransform([dojox.gfx.matrix.translate(-(v/2+E/2),-4)]),null!=w&&w.setTransform([dojox.gfx.matrix.translate(-(v/2+E+D/2+0),4)]),null!=g&&g.setTransform([dojox.gfx.matrix.translate(-(v/2+E+D+y/2+0),0)]),null!=m&&m.setTransform([dojox.gfx.matrix.translate(-(v/2+E+D+y+x/2+0),-4)]),d=v/2;break;case JSDraw2.ALIGN.BOTTOM:null!=b&&b.setTransform([dojox.gfx.matrix.translate(-(v/2+E/2),-4)]),null!=g&&g.setTransform([dojox.gfx.matrix.translate(0,s)]),null!=w&&w.setTransform([dojox.gfx.matrix.translate(y/2+D/2,s+4)]),null!=m&&m.setTransform([dojox.gfx.matrix.translate((null==g?v/2:y/2+D)+x/2+0,(null==g?0:s)-4)]),d=(null==g?v/2:y/2+D)+x+0;break;case JSDraw2.ALIGN.TOP:null!=b&&b.setTransform([dojox.gfx.matrix.translate(-(v/2+E/2),-4)]),null!=g&&g.setTransform([dojox.gfx.matrix.translate(0,-s)]),null!=w&&w.setTransform([dojox.gfx.matrix.translate(y/2+D/2,4-s)]),null!=m&&m.setTransform([dojox.gfx.matrix.translate((null==g?v/2:y/2+D)+x/2+0,(null==g?0:-s)-4)]),d=(null==g?v/2:y/2+D)+x+0,p=(null==g?0:-s)-4}}else d=v/2}null!=n.atommapid&&(c=n.p.clone(),d+=(f=JSDraw2.Drawer.drawText(t,c.offset(d,p-s-2),"("+n.atommapid+")","#f55",s/1.4)).getTextWidth()),0<n.val&&(c=n.p.clone(),d+=(f=JSDraw2.Drawer.drawText(t,c.offset(d,p-s-2),"("+(15==n.val?0:n.val)+")","#000",s/1.2)).getTextWidth()),null!=n.tag&&""!=n.tag&&(c=n.p.clone(),d+=(f=JSDraw2.Drawer.drawText(t,c.offset(d,p-s-2),"<"+n.tag+">","#000",s/1.2)).getTextWidth())}n.locked&&t.createCircle({cx:n.p.x,cy:n.p.y,r:.6*s}).setStroke({color:"#0ff",width:e})}else this.drawBio(t,e,s,a)},drawApo:function(t,e,i,s,l,n){for(var r=t.attachpoints,o=0;o<r.length;++o){var a=r[o],h=1.5*l,u=e.guessBond(t,h,o);null==u&&(u=t.p.clone()).offset(h,0);var c=t.p.clone();t._haslabel&&c.shrink(u,.6*l),JSDraw2.Drawer.drawLine(i,c,u,n,s/2,99==a?2:0),99==a||98==a?(h=new JSDraw2.Point(c.x-u.x,c.y-u.y).rotate(90).setLength(l),c=u.clone().offset(h.x,h.y),h=u.clone().offset(-h.x,-h.y),99==a?JSDraw2.Drawer.drawBasis(i,c,h,n,s/2):JSDraw2.Drawer.drawCurves(i,c,h,n,s/2)):(this.drawDiamond(i,u.x,u.y,.3*l,n,s/3),JSDraw2.Drawer.drawText(i,u.offset(.2*-l,.6*-l),a+"",n,.7*l))}},drawSelect:function(t){var e=null==this._rect?this.p:this._rect.center();t.draw(this,e)}}),JSDraw2.Atom.cast=function(t){return null!=t&&"ATOM"==t.T?t:null},scil.apply(JSDraw2.Atom,{match:function(t,e){if(!scil.Utils.areListEq(t.attachpoints,e.attachpoints))return!1;var i=t.elem,s=e.elem,l=JSDraw2.Atom.match2(i,s);if(l)return!0;if(t.isotope!=e.isotype||t.charge!=e.charge)return!1;if(null!=t.bio||null!=e.bio)return null!=t.bio&&null!=e.bio&&(t.bio.type==e.bio.type&&i==s);if("L"!=i&&"L"!=s)return!1;var n=[],r=[],o=!0,a=!0;if("L"==i){if(null!=t.query&&null!=t.query.als){for(var h=0;h<t.query.als.length;++h)n.push(t.query.als[h]);0==t.query.t&&(o=!1)}}else list.push(i);if("L"==s){if(null!=e.query&&null!=e.query.als){for(h=0;h<e.query.als.length;++h)r.push(e.query.als[h]);0==e.query.t&&(a=!1)}}else r.push(s);for(h=0;h<n.length;++h)for(var u=0;u<r.length;++u)if(JSDraw2.Atom.match(n[h],r[u])&&o==a)return!0;return o!=a},match2:function(t,e){return t==e||"*"==t||"A"==t||"*"==e||"A"==e||"X"==t&&("F"==e||"Cl"==e||"Br"==e||"I"==e)||"X"==e&&("F"==t||"Cl"==t||"Br"==t||"I"==t)||"Q"==t&&"H"!=e&&"C"!=e||"Q"==e&&"H"!=t&&"C"!=t},drawAlias:function(t,e,i,s,l,n){return JSDraw2.Drawer.drawFormula(e,i,t==JSDraw2.ALIGN.LEFT,s,l,n)},isValidChiral:function(t){return null!=t&&/^R|S|(abs)|(\&[0-9]+)|(and[0-9]+)|(or[0-9]+)$/.test(t)},isStereo:function(t){return null!=t&&/^((abs)|(or[0-9]+)|(and[0-9]+))$/.test(t)}}),JSDraw2.BA=scilligence.extend(scilligence._base,{constructor:function(t,e,i){this.b=t,this.a=e,this.ringclosure=i,this.next=[],this.f=null,this.parent=null,this.depth=null},find:function(t){var e=new JSDraw2.Stack;for(e.push(this);0<e.length();){var i=e.pop();if(i.a==t)return i;for(var s=0;s<i.next.length;++s)e.push(i.next[s])}return null},list:function(t,e){var i=new JSDraw2.Stack;i.push(this);for(var s="depthfirst"==e;0<i.length();){var l=s?i.pop():i.popHead();t.push(l);for(var n=0;n<l.next.length;++n)i.push(l.next[n])}},startAtom:function(){return null==this.b?null:this.b.otherAtom(this.a)},addNext:function(t){this.next.push(t),t.parent=this,t.depth=this.depth+1},stereo:function(){var t=this.a.bonds;if(null==this.b||!this.a.isMarkedStereo())return null;var e=[],i=[],s=this.a,l=this.b.otherAtom(s).p.angleTo(s.p);DEBUG.print(s.elem),DEBUG.print(l);for(var n=0;n<t.length;++n)if(t[n]!=this.b){var r=t[n].otherAtom(s),o=r.p.angleTo(s.p),a=o-l;DEBUG.print(r.elem+", "+o+", "+a),a<0&&(a+=360);for(var h=e.length,u=0;u<e.length;++u)if(a<e[u]){h=u;break}for(var c=null,u=0;u<this.next.length;++u)if(this.next[u].b==t[n]){c=this.next[u];break}if(null==c&&null!=this.a.ringclosures)for(u=0;u<this.a.ringclosures.length;++u)if(this.a.ringclosures[u].next.b==t[n]){c=this.a.ringclosures[u].next,this.a.ringclosures.splice(u,1);break}if(null==c)return null;e.splice(h,0,a),i.splice(h,0,c)}this.next=i;for(n=0;n<i.length;++n)DEBUG.print(i[n].a.elem+", "+e[n]);var d="";this.b.type==JSDraw2.BONDTYPES.WEDGE&&this.b.a1==this.a?d+="U":this.b.type==JSDraw2.BONDTYPES.HASH&&this.b.a1==this.a?d+="D":d+="-";for(n=0;n<i.length;++n)i[n].b.type==JSDraw2.BONDTYPES.WEDGE&&i[n].b.a1==this.a?d+="U":i[n].b.type==JSDraw2.BONDTYPES.HASH&&i[n].b.a1==this.a?d+="D":d+="-";switch(DEBUG.print(d),d){case"D--":case"DD-":case"DDD":case"--D":case"-D-":case"-DD":case"D---":case"-U--":case"--D-":case"---U":case"DU--":case"-DU-":case"--DU":case"U--D":return"@";case"U--":case"UU-":case"UUU":case"--U":case"-U-":case"-UU":case"U---":case"-D--":case"--U-":case"---D":case"UD--":case"-UD-":case"--UD":case"D--U":return"@@"}return null},renderSmiles:function(){var t="";if(null!=this.b){var e="";switch(null!=this.b.ring&&(e=this.b.ring?"@":"!@"),this.b.type){case JSDraw2.BONDTYPES.DOUBLE:t+=e+"=";break;case JSDraw2.BONDTYPES.TRIPLE:t+=e+"#";break;case JSDraw2.BONDTYPES.SINGLEORDOUBLE:t+=e+"-,"+e+"=";break;case JSDraw2.BONDTYPES.SINGLEORAROMATIC:t+=e+"-,"+e+":";break;case JSDraw2.BONDTYPES.DOUBLEORAROMATIC:t+=e+"=,"+e+":";break;case JSDraw2.BONDTYPES.UNKNOWN:t+=e+"~";break;case JSDraw2.BONDTYPES.DUMMY:t+=e+"..";break;default:null!=this.b.ring&&(t+=e+"-")}}if(null==this.ringclosure){var i=this.stereo(),s=JSDraw2.PT.isArAtom(this.a.elem);if("5'"!=this.a.elem&&"3'"!=this.a.elem)if(this.a.bio)t+="[["+this.a.elem+"]]";else if(!s&&"Cl"!=this.a.elem&&"F"!=this.a.elem&&"Br"!=this.a.elem&&"I"!=this.a.elem&&"B"!=this.a.elem||0!=this.a.charge||null!=this.a.isotope||null!=i||null!=this.a.query||this.a.locked){if(t+="[",null!=this.a.query&&null!=this.a.query.als)for(var l=0;l<this.a.query.als.length;++l)0<l&&(t+=","),0==this.a.query.t&&(t+="!"),t+=this.a.query.als[l];else null!=this.a.isotope&&(t+=this.a.isotope),t+=this.a.elem;0!=this.a.charge&&(1<this.a.hcount&&(t+="H"+this.a.hcount),1==this.a.charge?t+="+":-1==this.a.charge?t+="-":t+=(0<this.a.charge?"+":"-")+Math.abs(this.a.charge)),null!=i&&(t+=i+(1==this.a.hcount?"H":"")),null!=this.a.query&&null!=this.a.query.rbc&&(t+=";R"+this.a.query.rbc),null!=this.a.query&&null!=this.a.query.sub&&(t+=";X"+this.a.query.sub),this.a.locked&&(t+=";0"),t+="]"}else this.a.aromatic&&s?t+=this.a.elem.toLowerCase():t+=this.a.elem;if(null!=this.a.ringclosures)for(var n=this.a.ringclosures,l=0;l<n.length;++l)t+=(n[l].ri<10?"":"%")+n[l].ri}else t+=(this.ringclosure<10?"":"%")+this.ringclosure;if(0<this.next.length){for(var r=0;r<this.next.length-1;++r){var o=this.next[r].renderSmiles();null!=o&&0!=o.length&&(/^[0-9|\=|\#]+$/.test(o)?t+=o:t+="("+o+")")}t+=this.next[this.next.length-1].renderSmiles()}return t}}),JSDraw2.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(t){if(null==t)return null;var e,i,s,l,n,r,o="",a=0;for(t=JSDraw2.Base64._utf8_encode(t);a<t.length;)s=(r=t.charCodeAt(a++))>>2,l=(3&r)<<4|(e=t.charCodeAt(a++))>>4,n=(15&e)<<2|(i=t.charCodeAt(a++))>>6,r=63&i,isNaN(e)?n=r=64:isNaN(i)&&(r=64),o=o+this._keyStr.charAt(s)+this._keyStr.charAt(l)+this._keyStr.charAt(n)+this._keyStr.charAt(r);return o},decode:function(t){if(null==t)return null;var e,i,s,l,n,r="",o=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");o<t.length;)e=this._keyStr.indexOf(t.charAt(o++))<<2|(s=this._keyStr.indexOf(t.charAt(o++)))>>4,i=(15&s)<<4|(l=this._keyStr.indexOf(t.charAt(o++)))>>2,s=(3&l)<<6|(n=this._keyStr.indexOf(t.charAt(o++))),r+=String.fromCharCode(e),64!=l&&(r+=String.fromCharCode(i)),64!=n&&(r+=String.fromCharCode(s));return r=JSDraw2.Base64._utf8_decode(r)},_utf8_encode:function(t){t=t.replace(/\r\n/g,"\n");for(var e="",i=0;i<t.length;i++){var s=t.charCodeAt(i);s<128?e+=String.fromCharCode(s):(127<s&&s<2048?e+=String.fromCharCode(s>>6|192):(e+=String.fromCharCode(s>>12|224),e+=String.fromCharCode(s>>6&63|128)),e+=String.fromCharCode(63&s|128))}return e},_utf8_decode:function(t){for(var e="",i=0,s=c1=c2=0;i<t.length;)(s=t.charCodeAt(i))<128?(e+=String.fromCharCode(s),i++):191<s&&s<224?(c2=t.charCodeAt(i+1),e+=String.fromCharCode((31&s)<<6|63&c2),i+=2):(c2=t.charCodeAt(i+1),c3=t.charCodeAt(i+2),e+=String.fromCharCode((15&s)<<12|(63&c2)<<6|63&c3),i+=3);return e}},JSDraw2.Bond=scilligence.extend(scilligence._base,{constructor:function(t,e,i){this.T="BOND",this.a1=t,this.a2=e,this.apo1=null,this.apo2=null,this.color=null,this.ring=null,this.order=null,this.rcenter=null,this.selected=!1,this.tag=null,this.f=null,this.r1=null,this.r2=null,this.ratio1=null,this.ratio2=null,this.type=null==i?JSDraw2.BONDTYPES.SINGLE:i},clone:function(){var t=new JSDraw2.Bond(this.a1,this.a2,this.type);return t.id=this.id,t.color=this.color,t.order=this.order,t.apo1=this.apo1,t.apo2=this.apo2,t.ring=this.ring,t.rcenter=this.rcenter,t._parent=this.parent,t.r1=this.r1,t.r2=this.r2,t.ratio1=this.ratio1,t.ratio2=this.ratio2,t.z=this.z,t.tag=this.tag,t.selected=this.selected,t},replaceAtom:function(t,e){if(this.a1==t)this.a1=e;else{if(this.a2!=t)return!1;this.a2=e}return!0},isBio:function(){return this.type==JSDraw2.BONDTYPES.PEPTIDE||this.type==JSDraw2.BONDTYPES.NUCLEOTIDE},bondLength:function(){return this.a1.p.distTo(this.a2.p)},center:function(){return new JSDraw2.Point((this.a1.p.x+this.a2.p.x)/2,(this.a1.p.y+this.a2.p.y)/2)},angle:function(){return this.vector().angle()},vector:function(){return new JSDraw2.Point(this.a2.p.x-this.a1.p.x,this.a2.p.y-this.a1.p.y)},otherAtom:function(t){return this.a1==t?this.a2:this.a2==t?this.a1:null},reverse:function(){var t=this.a1;this.a1=this.a2,this.a2=t;t=this.apo1;this.apo1=this.apo2,this.apo2=t},valence:function(){switch(this.type){case JSDraw2.BONDTYPES.SINGLE:case JSDraw2.BONDTYPES.WEDGE:case JSDraw2.BONDTYPES.HASH:case JSDraw2.BONDTYPES.WIGGLY:case JSDraw2.BONDTYPES.PEPTIDE:case JSDraw2.BONDTYPES.NUCLEOTIDE:case JSDraw2.BONDTYPES.DISULFIDE:case JSDraw2.BONDTYPES.AMIDE:case JSDraw2.BONDTYPES.BOLD:case JSDraw2.BONDTYPES.BOLDHASH:return 1;case JSDraw2.BONDTYPES.DELOCALIZED:return 1.5;case JSDraw2.BONDTYPES.DOUBLE:case JSDraw2.BONDTYPES.EITHER:return 2;case JSDraw2.BONDTYPES.TRIPLE:return 3;case JSDraw2.BONDTYPES.UNKNOWN:case JSDraw2.BONDTYPES.DUMMY:return 0;default:return null}},_centerDoubleBond:function(t,e){var i=t.getNeighborAtoms(e.a1,e.a2),e=t.getNeighborAtoms(e.a2,e.a1);return 0==i.length&&2==e.length||0==e.length&&2==i.length},_shirftDirection:function(t,e){var i,s=null,l=null,n=t.getNeighborAtoms(e.a1,e.a2,!0);return 1==n.length&&(s=n[0]),null==s&&(1==(i=t.getNeighborAtoms(e.a2,e.a1,!0)).length&&(l=i[0]),null==l&&2<=n.length&&2<=i.length&&(t._hasDoubleBonds(n[0])?s=n[0]:t._hasDoubleBonds(n[1])&&(s=n[1]),t._hasDoubleBonds(i[0])?l=i[0]:t._hasDoubleBonds(i[1])&&(l=i[1]))),null!=s?e.p1.angleAsOrigin(e.p2,s.p)<=180:null!=l?e.p2.angleAsOrigin(l.p,e.p1)<=180:void 0},html:function(){var t="<b i='"+this.id+"' a1='"+this.a1.id+"' a2='"+this.a2.id+"' t='"+this.type+"'";return null!=this.ring&&(t+=" ring='"+(this.ring?1:0)+"'"),null!=this.rcenter&&(t+=" rcenter='"+this.rcenter+"'"),null!=this.color&&(t+=" clr='"+this.color+"'"),scil.Utils.isNullOrEmpty(this.r1)||(t+=" r1='"+this.r1+"'"),scil.Utils.isNullOrEmpty(this.r2)||(t+=" r2='"+this.r2+"'"),0<this.apo1&&null!=this.a1.superatom&&(t+=" apo1='"+this.apo1+"'"),0<this.apo2&&null!=this.a2.superatom&&(t+=" apo2='"+this.apo2+"'"),null!=this.tag&&(t+=" tag='"+scil.Utils.escXmlValue(this.tag)+"'"),t+="/>"},readHtml:function(t){var e=t.getAttribute("clr");null!=e&&(this.color=e);t=t.getAttribute("tag");null!=t&&""!=t&&(this.tag=t)},toggle:function(t,e){return t.onLine(this.a1.p,this.a2.p,e/5)},drawCur:function(t,e,i){var s=this.center();t.createCircle({cx:s.x,cy:s.y,r:e}).setFill(i)},_drawBond:function(t,e,i,s,l,n,r,o,a){null==l||0==l?JSDraw2.Drawer.drawLine(t,e.p1,e.p2,i,s,r,a):(n=0==n?new JSDraw2.Point(0,0):e.vector().scale(1/Math.abs(n)),o=e.vector().rotate(0<l?90:-90).setLength(null==o?2*s:o),JSDraw2.Drawer.drawLine(t,e.p1.clone().offset(n.x+o.x,n.y+o.y),e.p2.clone().offset(-n.x+o.x,-n.y+o.y),i,s,r,a))},getRColor:function(t,e){if(!scil.Utils.isNullOrEmpty(this.color))return t;switch(e){case 1:return"#641E16";case 2:return"#0000ff";case 3:return"#aaaaaa"}return"black"},splitPosR:function(t){if(!scil.Utils.isNullOrEmpty(t)){var e="?"==t?"?:?":t+"",i=e.indexOf(":");if(0<=i){t=e.substr(0,i),i=e.substr(i+1);return{pos:""==t?"?":t,r:""==i?"?":i}}}return{pos:"?",r:"?"}},_fmtBondAnn:function(){var t="",e="",i=this.splitPosR(this.r1),s=this.splitPosR(this.r2);"?"==i.pos&&"?"==s.pos||(t+=(""==t?"":"; ")+"Pos: "+i.pos,e+=(""==e?"":"; ")+"Pos: "+s.pos),"?"==i.r&&"?"==s.r||(t+=(""==t?"":"; ")+"R#: "+i.r,e+=(""==e?"":"; ")+"R#: "+s.r);var l=null==org.helm.webeditor.defaultbondratio?"":org.helm.webeditor.defaultbondratio,i=scil.Utils.isNullOrEmpty(this.ratio1)?l:this.ratio1,s=scil.Utils.isNullOrEmpty(this.ratio2)?l:this.ratio2;return i==l&&s==l||(t+=(""==t?"":"; ")+"Ratio: "+i,e+=(""==e?"":"; ")+"Ratio: "+s),{ba1:t,ba2:e}},drawBondAnnotation:function(t,e,i){var s,l,n,r=this._fmtBondAnn(),o=r.ba1,a=r.ba2;""==o&&""==a||(s=(i.p1.x-i.p2.x)/90,l=(i.p1.y-i.p2.y)/90,r=(n=new JSDraw2.Point((i.p1.x+i.p2.x)/2,(i.p1.y+i.p2.y)/2)).clone(),Math.abs(i.a1.p.x-i.a2.p.x)<e?(n.offset(e*s+.2*e,e*l-.5*e),r.offset(-e*s+.2*e,-e*l-.5*e),scil.Utils.isNullOrEmpty(o)||JSDraw2.Drawer.drawText(t,n,o,"green",e),scil.Utils.isNullOrEmpty(a)||JSDraw2.Drawer.drawText(t,r,a,"green",e)):(Math.abs(i.a1.p.y-i.a2.p.y)<e?(n.offset(e*s,e*l-.9*e),r.offset(-e*s,-e*l+.6*e)):(n.offset(e*s,e*l),r.offset(-e*s,-e*l)),scil.Utils.isNullOrEmpty(o)||JSDraw2.Drawer.drawLabel(t,n,o,"green",e,null,null,null,!1),scil.Utils.isNullOrEmpty(a)||JSDraw2.Drawer.drawLabel(t,r,a,"green",e,null,null,null,!1)))},draw:function(t,e,i,s,l){if(this.type!=JSDraw2.BONDTYPES.DUMMY){if(!this.a1.p.equalsTo(this.a2.p)){var n=new JSDraw2.Bond.B(this);l||(n.a1._haslabel&&n.p1.shrink(n.p2,.6*s),n.a2._haslabel&&n.p2.shrink(n.p1,.6*s));var r=scil.Utils.isNullOrEmpty(this.color)?"black":this.color;if(l||n.type==JSDraw2.BONDTYPES.PEPTIDE||n.type==JSDraw2.BONDTYPES.AMIDE)JSDraw2.Drawer.drawLine(t,n.p1,n.p2,r,e);else if(n.type!=JSDraw2.BONDTYPES.DISULFIDE)if(n.type!=JSDraw2.BONDTYPES.NUCLEOTIDE)if(0<this.r1||0<this.r2){var o=new JSDraw2.Point((n.p1.x+n.p2.x)/2,(n.p1.y+n.p2.y)/2),a=this.getRColor(this.color,this.r1),h=this.getRColor(this.color,this.r2);this.z?(u=new JSDraw2.Point(n.p1.x,o.y),c=new JSDraw2.Point(n.p2.x,o.y),JSDraw2.Drawer.drawLine(t,n.p1,u,a,e,null,"butt"),JSDraw2.Drawer.drawLine(t,u,o,a,e,null,"butt"),JSDraw2.Drawer.drawLine(t,o,c,h,e,null,"butt"),JSDraw2.Drawer.drawLine(t,c,n.p2,h,e,null,"butt")):(JSDraw2.Drawer.drawLine(t,n.p1,o,a,e,null,"butt"),JSDraw2.Drawer.drawLine(t,o,n.p2,h,e,null,"butt"),(1==this.r1&&2==this.r2||2==this.r1&&1==this.r2)&&(JSDraw2.Bond.showHelmAnnotation(this.a1,this.a2,this.r1),JSDraw2.Bond.showHelmAnnotation(this.a2,this.a1,this.r2)))}else{l||this.drawBondAnnotation(t,s,n);var u,c,s=8;if(n.type!=JSDraw2.BONDTYPES.DOUBLE&&n.type!=JSDraw2.BONDTYPES.DELOCALIZED&&n.type!=JSDraw2.BONDTYPES.EITHER&&n.type!=JSDraw2.BONDTYPES.DOUBLEORAROMATIC||(s=this._shirftDirection(i,n)?8:-8),n.type==JSDraw2.BONDTYPES.DOUBLE&&this._centerDoubleBond(i,n)?(this._drawBond(t,n,r,e,-s,0,null,e),this._drawBond(t,n,r,e,s,0,null,e)):n.type!=JSDraw2.BONDTYPES.SINGLE&&n.type!=JSDraw2.BONDTYPES.BOLD&&n.type!=JSDraw2.BONDTYPES.DOUBLE&&n.type!=JSDraw2.BONDTYPES.TRIPLE&&n.type!=JSDraw2.BONDTYPES.DELOCALIZED||(this._drawBond(t,n,r,n.type==JSDraw2.BONDTYPES.BOLD?3*e:e,null,null,null,null,n.type==JSDraw2.BONDTYPES.BOLD?"butt":"round"),n.type!=JSDraw2.BONDTYPES.DOUBLE&&n.type!=JSDraw2.BONDTYPES.TRIPLE||this._drawBond(t,n,r,e,s,s),n.type==JSDraw2.BONDTYPES.TRIPLE&&this._drawBond(t,n,r,e,-s,-s),n.type==JSDraw2.BONDTYPES.DELOCALIZED&&this._drawBond(t,n,r,e,s,s,4)),n.type==JSDraw2.BONDTYPES.WEDGE&&(f=n.vector().rotate(90).setLength(2*e),t.createPolyline([n.p1.x,n.p1.y,n.p2.x+f.x,n.p2.y+f.y,n.p2.x-f.x,n.p2.y-f.y]).setStroke({width:2}).setFill(r)),n.type==JSDraw2.BONDTYPES.HASH||n.type==JSDraw2.BONDTYPES.BOLDHASH)for(var i=n.bondLength(),d=Math.floor(i/(2*e)),p=n.vector().scale(1/d),f=n.vector().rotate(90),m=1;m<=d;++m){var g=n.p1.clone().offset(p.x*m,p.y*m),w=2*e;n.type==JSDraw2.BONDTYPES.HASH?w*=m/d:w*=.6;w=f.clone().setLength(w);JSDraw2.Drawer.drawLine(t,g.clone().offset(w.x,w.y),g.clone().offset(-w.x,-w.y),r,e)}n.type==JSDraw2.BONDTYPES.WIGGLY&&JSDraw2.Drawer.drawCurves(t,n.p1,n.p2,r,e),n.type==JSDraw2.BONDTYPES.EITHER&&(p=n.vector().scale(1/Math.abs(s)),f=n.vector().rotate(0<s?90:-90).setLength(2*e),u=n.p1.clone().offset(p.x+f.x,p.y+f.y),c=n.p2.clone().offset(-p.x+f.x,-p.y+f.y),JSDraw2.Drawer.drawLine(t,n.p1,c,r,e),JSDraw2.Drawer.drawLine(t,n.p2,u,r,e)),n.type==JSDraw2.BONDTYPES.DOUBLEORAROMATIC&&(this._drawBond(t,n,r,e),this._drawBond(t,n,r,e,s,s,2)),n.type!=JSDraw2.BONDTYPES.SINGLEORDOUBLE&&n.type!=JSDraw2.BONDTYPES.SINGLEORAROMATIC||(this._drawBond(t,n,r,e,0,0,2),this._drawBond(t,n,r,e,s/2,s/2,null,1.5*e),this._drawBond(t,n,r,e,-s/2,-s/2,n.type==JSDraw2.BONDTYPES.SINGLEORAROMATIC?2:null,1.5*e)),n.type==JSDraw2.BONDTYPES.UNKNOWN&&this._drawBond(t,n,r,e,null,null,1.2*e),null!=n.b.ring&&(g=this.center(),t.createCircle({cx:g.x,cy:g.y,r:3*e}).setStroke({color:r,width:e/2,style:n.b.ring?"Solid":"Dash"})),null!=n.b.rcenter&&(g=this.center(),p=n.vector().rotate(90).setLength(3*e),f=n.vector().setLength(e*(n.b.rcenter==JSDraw2.RXNCENTER.BREAKANDCHANGE?1.5:1)),n.b.rcenter==JSDraw2.RXNCENTER.CENTER?(JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x+f.x,p.y+f.y),g.clone().offset(-p.x+f.x,-p.y+f.y),r,e/2),JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x-f.x,p.y-f.y),g.clone().offset(-p.x-f.x,-p.y-f.y),r,e/2),p=n.vector().rotate(90).setLength(1.6*e),f=n.vector().setLength(2*e),JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x+f.x,p.y+f.y),g.clone().offset(p.x-f.x,p.y-f.y),r,e/2),JSDraw2.Drawer.drawLine(t,g.clone().offset(-p.x+f.x,-p.y+f.y),g.clone().offset(-p.x-f.x,-p.y-f.y),r,e/2)):n.b.rcenter==JSDraw2.RXNCENTER.NOTCENTER?(JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x+f.x,p.y+f.y),g.clone().offset(-p.x-f.x,-p.y-f.y),r,e/2),JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x-f.x,p.y-f.y),g.clone().offset(-p.x+f.x,-p.y+f.y),r,e/2)):n.b.rcenter==JSDraw2.RXNCENTER.BREAK?(JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x+f.x,p.y+f.y),g.clone().offset(-p.x+f.x,-p.y+f.y),r,e/2),JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x-f.x,p.y-f.y),g.clone().offset(-p.x-f.x,-p.y-f.y),r,e/2)):n.b.rcenter==JSDraw2.RXNCENTER.CHANGE?JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x,p.y),g.clone().offset(-p.x,-p.y),r,e/2):n.b.rcenter==JSDraw2.RXNCENTER.BREAKANDCHANGE&&(JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x,p.y),g.clone().offset(-p.x,-p.y),r,e/2),JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x+f.x,p.y+f.y),g.clone().offset(-p.x+f.x,-p.y+f.y),r,e/2),JSDraw2.Drawer.drawLine(t,g.clone().offset(p.x-f.x,p.y-f.y),g.clone().offset(-p.x-f.x,-p.y-f.y),r,e/2)))}else JSDraw2.Drawer.drawLine(t,n.p1,n.p2,r,e);else JSDraw2.Drawer.drawLine(t,n.p1,n.p2,r,e)}}else"@"!=this.a1.elem&&"@"!=this.a2.elem||this.a1.p.equalsTo(this.a2.p)||JSDraw2.Drawer.drawLine(t,this.a1.p,this.a2.p,"#eee",e/2)},drawSelect:function(t){t.draw(this,this.center())}}),scil.apply(JSDraw2.Bond,{cast:function(t){return null!=t&&"BOND"==t.T?t:null},B:scilligence.extend(scilligence._base,{constructor:function(t){this.b=t,this.a1=t.a1,this.a2=t.a2,this.type=t.type,this.p1=t.a1.p.clone(),this.p2=t.a2.p.clone()},vector:function(){return new JSDraw2.Point(this.p2.x-this.p1.x,this.p2.y-this.p1.y)},bondLength:function(){return this.p1.distTo(this.p2)}}),showHelmAnnotation:function(t,e,i){null==t.bio||scil.Utils.isNullOrEmpty(t.bio.annotation)||(2==i&&t.p.x>e.p.x||1==i&&t.p.x<e.p.x?t.bio.annotationshowright=!0:t.bio.annotationshowright=null)}}),JSDraw2.JSDrawIO={downloaddlg:null,jsdsavedlg:null,jsdFiles:{jsdraw:"JSDraw2 XML",mol:"Mol File",rxn:"Reaction File",inchi:"InChI",helm:"HELM",xhelm:"xHELM",smiles:"SMILES",cml:"Chemical Markup Language",cdxml:"ChemDraw CDXML",cdx:"ChemDraw CDX",png:"PNG Picture"},jsdFiles2:{jsd:"JSDraw XML",png:"PNG Picture"},jsdFiles3:{helm:"HELM",xhelm:"xHELM"},jsssavedlg:null,jssFiles:{sdf:"SDF File",csv:"CSV File",jssdf:"Xml File",json:"Json File"},callWebservice:function(t,e,i){null==JSDrawServices.url||""==JSDrawServices.url?scil.Utils.alert("JSDraw web service is not available"):scil.Utils.ajax(JSDrawServices.url+"?cmd="+t,i,e)},needCrossdomain:function(){if(JSDrawServices.xdomain){var t=window.location+"",e=t.indexOf("://"),e=t.indexOf("/",e+3),e=t.substr(0,e+1);if(!scil.Utils.startswith(JSDrawServices.url.toLowerCase(),e.toLowerCase()))return!0}return!1},jsdFileOpen:function(e){var i,t,s="Lite"==JSDraw2.Security.kEdition?this.res("Please select a HELM file")+" (*.helm, *.xhelm):":this.res("Please select a chemistry file")+" (*.mol, *.rxn, *.cdx, *.skc, *.helm, *.xhelm, *.smiles etc.):";this.needCrossdomain()?(i=JSDrawServices.url+"?cmd=",scil.Utils.uploadFile("<img src='"+scil.App.imgSmall("open.png")+"'>"+this.res("Import File"),s,i+"xdomain.post",function(t){scil.Utils.jsonp(i+"openjsd",function(t){JSDraw2.JSDrawIO.jsdFileOpen2(e,t)},{_xfilename:t})},null,null,null,null,!0)):(null==this.jsdFileOpenDlg&&(s={note:{type:"html",template:"<div style='white-space:nowrap'>"+s+"</div>"},file:{type:"postfile",attributes:{name:"file"}},importas:"Lite"==JSDraw2.Security.kEdition?null:{type:"select",items:{"":"",reactant:"Import as Reactant",product:"Import as Product"}}},(t=this).jsdFileOpenDlg=scil.Form.createDlgForm("Load File",s,{src:scil.App.imgSmall("open.png"),label:"Load File",onclick:function(){t.jsdFileOpen1()}},{usepostform:!0,hidelabel:!0})),this.jsdFileOpenDlg.show(),this.jsdFileOpenDlg.jsd=e,this.jsdFileOpenDlg.form.postform.reset())},jsdFileOpen1:function(){var i=this;this.jsdFileOpenDlg.form.post(JSDrawServices.url+"?cmd=openjsd",null,function(t){var e=null==i.jsdFileOpenDlg.form.fields.importas?null:i.jsdFileOpenDlg.form.fields.importas.value;i.jsdFileOpen2(i.jsdFileOpenDlg.jsd,t,e),i.jsdFileOpenDlg.hide()})},jsdFileOpen2:function(t,e,i){var s=null!=e.base64?JSDraw2.Base64.decode(e.base64):e.contents;if("reactant"==i||"product"==i){var l=new JSDraw2.Mol;if("molfile"==e.format?l.setMolfile(s):"rxn"==e.format?l.setRxnfile(s):l.setXml(s),0<l.atoms.length){var n=l.parseRxn(!0),r=!1;if(null==n)t.pasteMol(l,null,i)&&(r=!0);else if(null==n.arrow&&0==n.products.length)for(var o=0;o<n.reactants.length;++o)t.pasteMol(n.reactants[o],null,i)&&(r=!0);else if("reactant"==i&&null!=n.reactants)for(o=0;o<n.reactants.length;++o)t.pasteMol(n.reactants[o],null,i)&&(r=!0);else if("product"==i&&null!=n.products)for(o=0;o<n.products.length;++o)t.pasteMol(n.products[o],null,i)&&(r=!0);r?t.refresh(!0):scil.Utils.alert("No structure imported")}}else"molfile"==e.format||scil.Utils.endswith(e.filename,".mol")?t.setMolfile(s):"rxn"==e.format||scil.Utils.endswith(e.filename,".rxn")?t.setRxnfile(s):"xhelm"==e.format||scil.Utils.endswith(e.filename,".xhelm")?t.setXHelm(s):"helm"==e.format||scil.Utils.endswith(e.filename,".helm")?t.setHelm(s):t.setXml(s)},jsdFileSave:function(t){var e,i,s;null==JSDraw2.JSDrawIO.jsdsavedlg&&(e=scil.Utils.createElement(null,"div",this.res("Please select the file format to be saved: "),{width:"420px",margin:"10px"}),i=scil.Utils.createElement(e,"select"),scil.Utils.createElement(i,"option"),"Lite"==JSDraw2.Security.kEdition?t.options.helmtoolbar?scil.Utils.listOptions(i,JSDraw2.JSDrawIO.jsdFiles3,null,!1):scil.Utils.listOptions(i,JSDraw2.JSDrawIO.jsdFiles,null,!1):t.options.tlcplate?scil.Utils.listOptions(i,JSDraw2.JSDrawIO.jsdFiles2,null,!1):scil.Utils.listOptions(i,JSDraw2.JSDrawIO.jsdFiles,null,!1),s=scil.Utils.createElement(e,"div",null,{marginTop:"20px",textAlign:"center"}),scil.Utils.createButton(s,{src:scil.App.imgSmall("submit.png"),label:"Save File",onclick:function(t){JSDraw2.JSDrawIO.jsdFileSave2(),t.preventDefault()}}),scil.Utils.createButton(s,"&nbsp;"),scil.Utils.createButton(s,{src:scil.App.imgSmall("cancel.png"),label:"Cancel",onclick:function(t){JSDraw2.JSDrawIO.jsdsavedlg.hide(),t.preventDefault()}}),JSDraw2.JSDrawIO.jsdsavedlg=new JSDraw2.Dialog("<img src='"+scil.App.imgSmall("save.png")+"'>"+this.res("Save File"),e),JSDraw2.JSDrawIO.jsdsavedlg.sel=i),JSDraw2.JSDrawIO.jsdsavedlg.jsd=t,JSDraw2.JSDrawIO.jsdsavedlg.show(),JSDraw2.JSDrawIO.jsdsavedlg.sel.selectedIndex=0},jsdFileSave2:function(){this.jsdFileSave3(JSDraw2.JSDrawIO.jsdsavedlg.sel.value,JSDraw2.JSDrawIO.jsdsavedlg.jsd),this.jsdsavedlg.hide()},jsdFileSave3:function(t,e){var i="helm"==t?e.getHelm():"xhelm"==t?e.getXHelm():e.getXml(),s=new Date,i={client:"jsdraw",wrapper:"none",filename:("Lite"==JSDraw2.Security.kEdition&&e.options.helmtoolbar?"HELM":"JSDraw")+s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+"."+t,contents:i};scil.Utils.post(JSDrawServices.url+"?cmd=savefile",i,"_blank")},cleanup:function(l){var n=l.m.clone(!0);null!=n&&0==n.atoms.length&&(n=null);var t=(null!=n?n:l).getSmiles();if(null!=t&&""!=t){var e=JSDrawServices.url;if(null!=e){var i=window.location,s=i.protocol+"//"+i.host+"/",i=null;scil.Utils.startswith(e.toLowerCase(),s.toLowerCase())?(i=scil.Utils.ajax,t=(null!=n?n:l).getXml()):i=scil.Utils.jsonp;var r=[];if(null!=n)for(var o=0;o<l.m.bonds.length;++o){var a=l.m.bonds[o];a.a1.selected!=a.a2.selected&&r.push(a)}var h=this;i(e+"?cmd=cleanup",function(t){var e,i,s;null!=n?null==(e=h._data2Mol(t))||e.isEmpty()||(e.setBondLength(l.bondlength),h._connectOpenBonds(l.m,e,r,l.bondlength)||(i=n.rect().center(),s=e.rect().center(),e.offset(i.x-s.x,i.y-s.y)),l.pushundo(),l.delSelected(),e.setSelected(!0),l.m.mergeMol(e),l.refresh(!0)):h._setMolData(l,t,null,!0)},{input:t,inputformat:"jsdraw"})}else scil.Utils.alert("JSDraw Web Service is not configured yet.")}},_connectOpenBonds:function(t,e,i,s){if(0==i.length)return!1;if(1<i.length){for(var l=0;l<i.length;++l){var n=(o=i[l]).a1.selected?o.a1:o.a2,r=o.a1.selected?o.a2:o.a1;null!=(a=e.getObjectById(n.id))&&((u=o.clone()).replaceAtom(n,a),e.addBond(u))}return!1}var o,a,h,n=(o=i[0]).a1.selected?o.a1:o.a2,r=o.a1.selected?o.a2:o.a1;if(null==(a=e.getObjectById(n.id)))return!1;o.selected?(l=scil.Utils.indexOf(t.bonds,o),t.bonds.splice(l,1),h=t.guessBond(r,s),t.bonds.splice(l,0,o)):h=n.p,e.offset(h.x-a.p.x,h.y-a.p.y);var u,t=e.guessBond(a,s),s=r.p.angleTo(h),t=t.angleTo(h);return e.rotate(h,s-t),(u=o.clone()).replaceAtom(n,a),e.addBond(u),!0},_data2Mol:function(t){var e=new JSDraw2.Mol;return e="string"==typeof t?e.setXml(t):e.setXml(t.output)},_setMolData:function(t,e,i,s){e=this._data2Mol(e);null==e||e.isEmpty()||(t.pushundo(),null!=t.setXml(e.getXml())&&t.refresh(!0))},name2structure:function(i){var t=null!=JSDrawServices.n2s&&null!=JSDrawServices.url.msg?JSDrawServices.n2s.msg:this.res("Please type chemical name, CAS, SMILES etc.")+":";scil.Utils.prompt2({caption:"<img src='"+scil.Utils.imgSrc("img/n2s.gif")+"'>"+this.res("Name to Structure"),message:t,button:this.res("Convert"),callback:function(e){var t;null!=JSDrawServices.id2s&&null!=JSDrawServices.id2s.url&&null!=JSDrawServices.id2s.regex&&null!=e.match(JSDrawServices.id2s.regex)?t=JSDrawServices.id2s.url:null!=JSDrawServices.n2s&&null!=JSDrawServices.n2s.url&&(t=JSDrawServices.n2s.url),null!=t?scil.Utils.jsonp(t,function(t){JSDraw2.JSDrawIO._setMolData(i,t,e)},{q:e,fmt:"jsdraw"},{showprogress:!0}):scil.Utils.alert("Name-to-structure is not configured yet.")},autosuggesturl:null!=JSDrawServices.n2s?JSDrawServices.n2s.suggest:null,iconurl:scil.Utils.imgSrc("img/name2s.gif"),owner:i})},res:function(t){return JSDraw2.Language.res(t)},jssFileOpen:function(e){var t={msg:"Appending Mode"};e.options.appendingmode&&(t.checked=!0,t.disabled=!0);var i,s=null==e.options.structurecolumn?"":e.options.structurecolumn;scil.Utils.uploadFile("<img src='"+scil.Utils.imgSrc("img/open.gif")+"'>"+this.res("Open File"),this.res("Please select a file")+" (*.sdf,*.rdf,*.xls,*.csv,*.smiles):",JSDrawServices.url+"?cmd=openjss",function(t){JSDraw2.JSDrawIO.jssFileOpen2(e,t)},{structurecolumn:s},t),this.needCrossdomain()?(i=JSDrawServices.url+"?cmd=",scil.Utils.uploadFile("<img src='"+scil.Utils.imgSrc("img/open.gif")+"'>"+this.res("Open File"),this.res("Please select a file")+" (*.sdf,*.rdf,*.xls,*.csv,*.smiles)",i+"xdomain.post",function(t){scil.Utils.jsonp(i+"openjss",function(t){JSDraw2.JSDrawIO.jssFileOpen2(jsd,t)},{_xfilename:t,structurecolumn:s})},null,null,null,null,!0)):scil.Utils.uploadFile("<img src='"+scil.Utils.imgSrc("img/open.gif")+"'>"+this.res("Open File"),this.res("Please select a file")+" (*.sdf,*.rdf,*.xls,*.csv,*.smiles):",JSDrawServices.url+"?cmd=openjss",function(t){JSDraw2.JSDrawIO.jssFileOpen2(e,t)},{structurecolumn:s},t)},jssFileOpen2:function(t,e,i){var s=scil.Utils.uploadfileDlg.check.checked;scil.Utils.endswith(e.filename,".rdf")?t.setRdf(null!=e.base64?JSDraw2.Base64.decode(e.base64):e.contents,null,null,!s):t.setXml(null!=e.base64?JSDraw2.Base64.decode(e.base64):e.contents,null,!s,s)},jssFileSave:function(t){var e,i,s;null==JSDraw2.JSDrawIO.jsssavedlg&&(e=scil.Utils.createElement(null,"div",this.res("Please select a file type")+":",{width:"350px",margin:"10px"}),i=scil.Utils.createElement(e,"select"),scil.Utils.createElement(i,"option"),scil.Utils.listOptions(i,JSDraw2.JSDrawIO.jssFiles,null,!1),s=scil.Utils.createElement(e,"div",null,{marginTop:"20px",textAlign:"center"}),s=scil.Utils.createElement(s,"button","<img src='"+scil.App.imgSmall("submit.png")+"'>"+this.res("Save")),dojo.connect(s,"onclick",function(t){JSDraw2.JSDrawIO.jssFileSave2(),t.preventDefault()}),JSDraw2.JSDrawIO.jsssavedlg=new JSDraw2.Dialog("<img src='"+scil.App.imgSmall("save.png")+"'>"+this.res("Save File"),e),JSDraw2.JSDrawIO.jsssavedlg.sel=i),JSDraw2.JSDrawIO.jsssavedlg.jss=t,JSDraw2.JSDrawIO.jsssavedlg.show(),JSDraw2.JSDrawIO.jsssavedlg.sel.selectedIndex=0},jssFileSave2:function(){var t=JSDraw2.JSDrawIO.jsssavedlg.sel.value,e=new Date,i={client:"jssdf",wrapper:"none",filename:"JSDrawTable"+e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()+"."+t};switch(t){case"sdf":i.contents=JSDraw2.JSDrawIO.jsssavedlg.jss.getSdf();break;case"jssdf":i.contents=JSDraw2.JSDrawIO.jsssavedlg.jss.getXml();break;case"json":i.contents=scil.Utils.json2str(JSDraw2.JSDrawIO.jsssavedlg.jss.getJson());break;case"csv":i.contents=JSDraw2.JSDrawIO.jsssavedlg.jss.getCsv()}scil.Utils.post(JSDrawServices.url+"?cmd=savefile",i,"_blank"),JSDraw2.JSDrawIO.jsssavedlg.hide()}},JSDraw2.Mol=scil.extend(scil._base,{constructor:function(t){this.T="MOL",this.name=null,this.atoms=[],this.bonds=[],this.graphics=[],this.stats=null,this.showimplicithydrogens=0!=t,this.props=null},_addAtom:function(t,e){this.atoms.push(t),t._parent=null!=e?e:this},_addBond:function(t,e){this.bonds.push(t),t._parent=null!=e?e:this},_addGraphics:function(t,e){this.graphics.push(t),t._parent=null!=e?e:this},resetIds:function(t){for(var e=new JSDraw2.IDGenerator(t?this._getMaxID():0),i=0;i<this.atoms.length;++i)(s=this.atoms[i]).id=e.next(s.id),s.atomid=i+1;for(i=0;i<this.bonds.length;++i)(s=this.bonds[i]).id=e.next(s.id),s.bondid=i+1;for(i=0;i<this.graphics.length;++i)(s=this.graphics[i]).id=e.next(s.id),s.graphicsid=i+1;for(var s,i=0;i<this.atoms.length;++i)null!=(s=this.atoms[i]).rgroup&&(s.rgroup.id=e.next(s.rgroup.id))},_getMaxID:function(){for(var t=0,e=0;e<this.atoms.length;++e)(i=this.atoms[e]).id>t&&(t=i.id);for(e=0;e<this.bonds.length;++e)(i=this.bonds[e]).id>t&&(t=i.id);for(e=0;e<this.graphics.length;++e)(i=this.graphics[e]).id>t&&(t=i.id);for(var i,e=0;e<this.atoms.length;++e)null!=(i=this.atoms[e]).rgroup&&i.rgroup.id>t&&(t=i.rgroup.id);return t},getObjectById:function(t){for(var e=0;e<this.atoms.length;++e)if(this.atoms[e].id==t)return this.atoms[e];for(e=0;e<this.bonds.length;++e)if(this.bonds[e].id==t)return this.bonds[e];for(e=0;e<this.graphics.length;++e)if(this.graphics[e].id==t)return this.graphics[e]},clone:function(t){var e=new JSDraw2.Mol;e.bondlength=this.bondlength,e.name=this.name,e.chiral=this.chiral,e.props=scil.clone(this.props),e.showimplicithydrogens=this.showimplicithydrogens,e.mw=this.mw,e.attachpoints=this.attachpoints;var i=[];this.resetIds(!0);for(var s=0;s<this.atoms.length;++s){var l,n=this.atoms[s];t&&!n.selected||(l=n.clone(t),t&&(l.atommapid=null),e._addAtom(l),i[n.id]=l)}for(s=0;s<this.bonds.length;++s){var r=this.bonds[s];(!t||r.selected&&r.a1.selected&&r.a2.selected)&&(a=r.clone(),e._addBond(a),i[r.id]=a)}for(s=0;s<this.graphics.length;++s){var o=this.graphics[s];t&&!o.selected||(h=o.clone(i),e._addGraphics(h),i[o.id]=h)}for(var a,s=0;s<this.bonds.length;++s)null!=(a=i[(r=this.bonds[s]).id])&&(a.a1=i[r.a1.id],a.a2=i[r.a2.id],null==a.a1||r.a2);for(var h,s=0;s<this.graphics.length;++s)if(null!=(h=i[(o=this.graphics[s]).id]))if(null!=JSDraw2.Group.cast(o)){for(var u=0;u<this.atoms.length;++u)(n=this.atoms[u]).group==o&&(i[n.id].group=h);null!=o.a&&(h.a=i[o.a.id]),null!=o.group&&(h.group=i[o.group.id])}else null!=JSDraw2.Bracket.cast(o)?h.atoms=this._getMappedArray(o.atoms,i):null!=JSDraw2.Text.cast(o)?h.anchors=this._getMappedArray(o.anchors,i):null!=JSDraw2.Shape.cast(o)&&(h.froms=this._getMappedArray(o.froms,i),null!=h.reject&&(h.reject=i[h.reject.id]));return e._setParent(e),e},_getMappedArray:function(t,e){for(var i=[],s=0;s<t.length;++s){var l=t[s];null!=l&&null!=e[l.id]&&i.push(e[l.id])}return i},guessBond:function(t,e,i){var s=t.p.clone(),l=this.getAllBonds(t);switch(l.length+(0<i?i:0)){case 0:s.offset(1,0);break;case 1:s=l[0].otherAtom(t).p.clone().rotateAround(t.p,120);break;case 2:var n=l[0].otherAtom(t).p,r=l[1].otherAtom(t).p,o=t.p.angleAsOrigin(n,r);Math.abs(o-180)<=1?(s=n.clone()).rotateAround(t.p,90):(s.x=(n.x+r.x)/2,s.y=(n.y+r.y)/2,s.rotateAround(t.p,180));break;case 3:var n=l[0].otherAtom(t).p,r=l[1].otherAtom(t).p,a=l[2].otherAtom(t).p,h=s.angleAsOrigin(n,r),u=s.angleAsOrigin(r,a),o=s.angleAsOrigin(a,n);180<h&&(h=360-h),180<u&&(u=360-u),180<o&&(o=360-o),(s=(u<h&&o<h?a:h<u&&o<u?n:r).clone()).rotateAround(t.p,180);break;default:return null}return s.setLength(e,t.p),s},getMaxRIndex:function(t){null==t&&(t=0);for(var e=0;e<this.atoms.length;++e){var i=this.atoms[e];if("R"==i.elem){var s=scil.Utils.parseIndex(i.alias);if(null!=s&&null!=s.index&&(s.index>t&&(t=s.index),null!=i.rgroup))for(var l=0;l<i.rgroup.mols.length;++l)t<(s=i.rgroup.mols[l].getMaxRIndex(t))&&(t=s)}}return t},setColor:function(t,e){for(var i=0,s=0;s<this.atoms.length;++s){var l=this.atoms[s];if(l.color==t||e&&!l.selected||(l.color=t,++i),null!=l.rgroup){l.rgroup.color==t||e&&!l.rgroup.selected||(l.rgroup.color=t,++i);for(var n=0;n<l.rgroup.mols.length;++n)i+=l.rgroup.mols[n].setColor(t,e)}}for(s=0;s<this.bonds.length;++s){var r=this.bonds[s];r.color==t||e&&!r.selected||(r.color=t,++i)}for(s=0;s<this.graphics.length;++s){var o=this.graphics[s];o.color==t||e&&!o.selected||(o.color=t,++i)}return i},clear:function(){this.name=null,this.chiral=null,this.atoms=[],this.bonds=[],this.graphics=[]},isEmpty:function(){return 0==this.atoms.length&&0==this.bonds.length&&0==this.graphics.length},setSelected:function(t){null==t&&(t=!1);for(var e=0,i=0;i<this.atoms.length;++i){var s=this.atoms[i];if(s.selected!=t&&(s.selected=t,++e),null!=s.rgroup){s.rgroup.selected!=t&&(s.rgroup.selected=t,++e);for(var l=0;l<s.rgroup.mols.length;++l)e+=s.rgroup.mols[l].setSelected(t)}}for(i=0;i<this.bonds.length;++i){var n=this.bonds[i];n.selected!=t&&(n.selected=t,++e)}for(i=0;i<this.graphics.length;++i){var r=this.graphics[i];r.selected!=t&&(r.selected=t,++e)}return e},lassoSelect:function(t,e,i,s,l,n){for(var r=0;r<this.atoms.length;++r){var o=this.atoms[r];if(o.p.inTriangle(e,i,s)&&t.lasso.hit(o),null!=o.rgroup){(u=o.rgroup).rect().center().inTriangle(e,i,s)&&t.lasso.hit(u);for(var a=0;a<o.rgroup.mols.length;++a)o.rgroup.mols[a].lassoSelect(t,e,i,s,l,n)}}for(r=0;r<this.bonds.length;++r){var h=this.bonds[r];h.center().inTriangle(e,i,s)&&t.lasso.hit(h)}for(var u,r=0;r<this.graphics.length;++r)(u=this.graphics[r]).rect().center().inTriangle(e,i,s)&&t.lasso.hit(u);t.lasso.endHits(e,i)},getSelectedAtomInMol:function(){for(var t=[],e=0;e<this.atoms.length;++e){var i=this.atoms[e];if(i.selected)t.push(i);else if(null!=i.rgroup)for(var s=0;s<i.rgroup.mols.length;++s){var l=i.rgroup.mols[s].getSelectedAtomInMol();if(0<l.length)return l}}return t},bracketSelect:function(t){for(var e=[],i=0;i<this.atoms.length;++i){var s=this.atoms[i];t.contains(s.p)&&e.push(s)}for(var l=[],n=scil.clone(this.bonds),i=this.bonds.length-1;0<=i;--i){var r=this.bonds[i],o=0<=scil.Utils.indexOf(e,r.a1),a=0<=scil.Utils.indexOf(e,r.a2);o!=a&&(JSDraw2.Point.intersect(r.a1.p,r.a2.p,t.topleft(),t.bottomleft())||JSDraw2.Point.intersect(r.a1.p,r.a2.p,t.topright(),t.bottomright()))&&(l.push({b:r,a:a?r.a1:r.a2}),n.splice(i,1))}if(2==l.length||1==l.length){var h=this.bonds;this.bonds=n;var u=this.splitFragments();if(this.bonds=h,1<u.length)for(i=0;i<u.length;++i)if(scil.Utils.arrayContainsArray(u[i].atoms,e)&&(1==l.length&&scil.Utils.indexOf(u[i].atoms,l[0].a)<0||2==l.length&&scil.Utils.indexOf(u[i].atoms,l[0].a)<0&&scil.Utils.indexOf(u[i].atoms,l[1].a)<0)){e=u[i].atoms;break}}for(i=0;i<e.length;++i)e[i].selected=!0;return e},selectInRect:function(t){for(var e=0,i=0;i<this.atoms.length;++i){var s=this.atoms[i];if(t.contains(s.p)&&(s.selected=!0,++e),null!=s.rgroup){null!=(o=(r=s.rgroup).rect())&&t.contains(o.center())&&(r.selected=!0,++e);for(var l=0;l<s.rgroup.mols.length;++l)e+=s.rgroup.mols[l].selectInRect(t)}}for(i=0;i<this.bonds.length;++i){var n=this.bonds[i];t.contains(n.center())&&(n.selected=!0,++e)}for(var r,o,i=0;i<this.graphics.length;++i)null!=(o=(r=this.graphics[i]).rect())&&t.contains(o.center())&&(r.selected=!0,++e);return e},hasAtom:function(t){for(var e=0;e<this.atoms.length;++e)if(this.atoms[e]==t)return!0;return!1},hasGraphics:function(t){for(var e=0;e<this.graphics.length;++e)if(this.graphics[e]==t)return!0;return!1},hasBond:function(t){for(var e=0;e<this.bonds.length;++e)if(this.bonds[e]==t)return!0;return!1},calcHCount:function(t){for(var e=0;e<this.atoms.length;++e){var i=this.atoms[e];if(!t&&null!=i.hcount||this.setHCount(i),null!=i.rgroup)for(var s=0;s<i.rgroup.mols.length;++s)i.rgroup.mols[s].calcHCount(t)}},setHCount:function(t){if(t.hcount=null,0!=this.showimplicithydrogens&&!t.bio){var e=!1,i=null;if("R"!=t.elem&&null!=t.alias&&""!=t.alias){if(null==t.superatom)"#"!=t.elem&&(e=!0);else if(null!=t.superatom)if((n=this.getNeighborBonds(t,!0)).length>t.superatom.attachpoints)0<t.superatom.atoms.length&&(e=!0);else for(var s=0;s<n.length;++s)if(1!=n[s].valence()){e=!0;break}}else if(0<t.hs)i=t.hs-1;else{var l=JSDraw2.PT[t.elem];if(null!=l&&null!=l.v&&null!=l.e){for(var n=this.getNeighborBonds(t),r=0,o=0,s=0;s<n.length;++s){var a=n[s].valence();if(null==a)return;r+=1.5==a?2<++o?1:1.5:n[s].valence()}2!=n.length||"O"!=t.elem&&"S"!=t.elem||n[0].type!=JSDraw2.BONDTYPES.DELOCALIZED||n[1].type!=JSDraw2.BONDTYPES.DELOCALIZED||--r;var h=0,u=l.e<=4?0:l.e%4,c=l.e<=4?l.e:4-l.e%4;if(0<t.charge){if(0<u){if(!(u>=t.charge))return;h=t.charge}else if(0<c){if(!(c>=t.charge))return;h-=t.charge}}else if(t.charge<0&&0<c){if(!(c>-t.charge))return;h="B"==t.elem||"P"==t.elem||"Si"==t.elem?-t.charge:t.charge}if(1==t.radical||3==t.radical?r+=2:2==t.radical&&++r,null!=t.attachpoints)for(s=0;s<t.attachpoints.length;++s)99!=t.attachpoints[s]&&++r;r=Math.ceil(r),e=!0;for(s=0;s<l.v.length;++s)if(r<=l.v[s]+h){i=l.v[s]+h-r,e=!1;break}}}return t.hasError=e,t.hcount=i}},hasError:function(){for(var t=0;t<this.atoms.length;++t)if(this.atoms[t].hasError)return!0;return!1},hasGenericAtom:function(){for(var t=0;t<this.atoms.length;++t){var e=this.atoms[t];if("R"==e.elem&&null==e.bio||null!=e.superatom&&0==e.superatom.atoms.length)return!0}return!1},findBond:function(t,e){for(var i=0;i<this.bonds.length;++i){var s=this.bonds[i];if(s.a1==t&&s.a2==e||s.a1==e&&s.a2==t)return s}return null},moveCenter:function(t,e){var i;this.isEmpty()||(i=this.center(),this.offset(0<t?t/2-i.x:0,0<e?e/2-i.y:0))},cleanupRxn:function(t){var e=this.parseRxn(!0);if(null==e||1==e.reactants.length&&0==e.products.length&&null==e.arrow)return!1;var i=this.medBondLength();return 0<i||(i=0<t?t:JSDraw2.Editor.BONDLENGTH),this._layoutRxn(e,i)},_layoutRxn:function(t,e){for(var i=[],s=0;s<this.graphics.length;++s)"PLUS"==this.graphics[s].T&&i.push(this.graphics[s]);for(var l=null,n=null,s=0;s<t.reactants.length;++s)0==(a=t.reactants[s].rect()).width&&a.inflate(e,0),0==a.height&&a.inflate(0,e),null==l?(l=a.right(),n=a.center().y):(l+=e,0<i.length?(g=i.pop()).p=new JSDraw2.Point(l,n):(g=new JSDraw2.Plus(new JSDraw2.Point(l,n)),this._addGraphics(g)),l+=e,t.reactants[s].offset(l-a.left,n-a.center().y),l+=a.width);var r=t.arrow;if(null!=r){var o=r.p2.angleTo(r.p1);r.p2.rotateAround(r.p1,-o);var a=r.rect();null==l?(l=a.right(),n=a.center().y):(l+=e,r.offset(l-a.left,n-a.center().y),l+=a.width);var h=0;if(null!=t.above)for(s=0;s<t.above.length;++s)h<(u=t.above[s]._rect.width)&&(h=u);if(null!=t.below)for(var u,s=0;s<t.below.length;++s)h<(u=t.below[s]._rect.width)&&(h=u);0<h&&h+e>a.width&&(c=h+e-a.width,r.p2.offset(c,0),l+=c);var c=e/10,d=r.rect().center();if(null!=t.above)for(var p=d.y-2*c,s=t.above.length-1;0<=s;--s)(f=t.above[s]).offset(d.x-f._rect.center().x,p-f._rect.bottom()),p=f._rect.top-c;if(null!=t.below)for(var f,m=d.y+2*c,s=0;s<t.below.length;++s)(f=t.below[s]).offset(d.x-f._rect.center().x,m-f._rect.top),m=f._rect.bottom()+c}for(var g,s=0;s<t.products.length;++s)0==(a=t.products[s].rect()).width&&a.inflate(e,0),0==a.height&&a.inflate(0,e),null==l?(l=a.right(),n=a.center().y):(0<s&&(l+=e,0<i.length?(g=i.pop()).p=new JSDraw2.Point(l,n):(g=new JSDraw2.Plus(new JSDraw2.Point(l,n)),this._addGraphics(g))),l+=e,t.products[s].offset(l-a.left,n-a.center().y),l+=a.width);for(s=0;s<i.length;++s)this.delObject(i[s]);return!0},center:function(){return this.rect().center()},getGroupRect:function(t,e){for(var i=null,s=0;s<this.atoms.length;++s){var l=this.atoms[s];l.group!=t||l.hidden||(l=l.p,null==i?i=new JSDraw2.Rect(l.x,l.y,0,0):i.unionPoint(l))}for(s=0;s<this.graphics.length;++s){var n=this.graphics[s];n.group==t&&(n=null!=JSDraw2.Group.cast(n)?this.getGroupRect(n,e):n.rect(),null==i?i=n.clone():i.union(n))}return null!=i&&0<t.gap&&i.inflate(t.gap*e/15,t.gap*e/15),i},getSelectedRect:function(){for(var t,e=null,i=0;i<this.atoms.length;++i)this.atoms[i].selected&&(t=this.atoms[i].p,null==e?e=new JSDraw2.Rect(t.x,t.y,0,0):e.unionPoint(t));return e},rect:function(t){if(0==this.atoms.length){if(0==this.graphics.length)return null;for(var e=this.graphics[0].rect(),i=1;i<this.graphics.length;++i)e.union(this.graphics[i].rect());return e}for(var s,l=null,n=null,r=null,o=null,i=0;i<this.atoms.length;++i)(h=this.atoms[i]).hidden||(s=h.p,null!=l?(s.x<l?l=s.x:s.x>r&&(r=s.x),s.y<n?n=s.y:s.y>o&&(o=s.y)):(l=r=s.x,n=o=s.y));for(e=new JSDraw2.Rect(l,n,r-l,o-n),i=0;i<this.graphics.length;++i){var a=this.graphics[i];null==JSDraw2.Group.cast(a)&&e.union(a.rect())}if(!t)for(var h,i=0;i<this.atoms.length;++i)if(null!=(h=this.atoms[i]).rgroup){e.union(h.rgroup.rect());for(var u=0;u<h.rgroup.mols.length;++u)e.union(h.rgroup.mols[u].rect())}return e},offset:function(t,e,i){for(var s=0;s<this.atoms.length;++s){var l=this.atoms[s];if(1==i&&!l.selected||l.p.offset(t,e),null!=l.rgroup){1==i&&!l.rgroup.selected||l.rgroup.offset(t,e);for(var n=0;n<l.rgroup.mols.length;++n)l.rgroup.mols[n].offset(t,e,i)}}for(s=0;s<this.graphics.length;++s){var r=this.graphics[s];if(1!=i||r.selected)this.graphics[s].offset(t,e);else if(i&&!r.selected){var o=JSDraw2.Text.cast(r);if(null!=o&&0<o.anchors.length){for(var a=!0,n=0;n<o.anchors.length;++n)if(!o.anchors[n].selected){a=!1;break}a&&(o.selected=!0,o.offset(t,e))}}}},rotate:function(t,e){for(var i=0;i<this.atoms.length;++i)this.atoms[i].p.rotateAround(t,e)},delObject:function(t){if(null!=t){var e=JSDraw2.Atom.cast(t);if(null!=e)return this.delAtom(e);e=JSDraw2.Bond.cast(t);return null!=e?this.delBond(e):this.delGraphics(t)}},delGraphics:function(t){var e=JSDraw2.Group.cast(t);if(null!=e){for(var i=0;i<this.atoms.length;++i)this.atoms[i].group==e&&(this.atoms[i].group=null);for(i=0;i<this.graphics.length;++i)this.graphics[i].group==e&&(this.graphics[i].group=null)}for(i=0;i<this.graphics.length;++i)if(this.graphics[i]==t)return this.graphics.splice(i,1),this.objectRemoved(t),!0;return!1},delAtom:function(t,e){var i=[];if(i.push(t),0!=e)for(var s=this.bonds.length-1;0<=s;--s){var l=this.bonds[s];l.a1!=t&&l.a2!=t||(this.bonds.splice(s,1),this.objectRemoved(l),i.push(l.otherAtom(t)),null!=t.atommapid&&this.clearAtomMap(t.atommapid))}for(var n=0,s=0;s<i.length;++s){var r=i[s];t!=r&&r.bio||this.delLoneAtom(i[s])&&++n}return 0<n},delBond:function(t,e){for(var i=0;i<this.bonds.length;++i)if(this.bonds[i]==t)return this.bonds.splice(i,1),0!=e&&(t.a1.bio||this.delLoneAtom(t.a1),t.a2.bio||this.delLoneAtom(t.a2)),this.objectRemoved(t),!0;return!1},delLoneAtom:function(t){if(!this.isLoneAtom(t))return this.setHCount(t),!1;for(var e=0;e<this.atoms.length;++e)if(this.atoms[e]==t)return this.atoms.splice(e,1),null!=t.atommapid&&this.clearAtomMap(t.atommapid),this.objectRemoved(t),!0;return!1},objectRemoved:function(t){for(var e=0;e<this.graphics.length;++e){var i=this.graphics[e];null!=i.removeObject&&i.removeObject(t)}},hasSelected:function(){for(var t=0;t<this.atoms.length;++t){var e=this.atoms[t];if(this.atoms[t].selected)return!0;if(null!=e.rgroup){if(e.rgroup.selected)return!0;for(var i=0;i<e.rgroup.mols.length;++i)if(e.rgroup.mols[i].hasSelected())return!0}}for(t=0;t<this.bonds.length;++t)if(this.bonds[t].selected)return!0;for(t=0;t<this.graphics.length;++t)if(this.graphics[t].selected)return!0;return!1},delSelected:function(){for(var t=0,e=scil.clone(this.atoms),i=0;i<e.length;++i){var s=e[i];if(s.selected&&(this.delAtom(e[i]),++t),null!=s.rgroup)if(s.rgroup.selected)s.rgroup=null,++t;else for(var l=0;l<s.rgroup.mols.length;++l)t+=s.rgroup.mols[l].delSelected()}for(var n=scil.clone(this.bonds),i=0;i<n.length;++i)n[i].selected&&(this.delBond(n[i]),++t);for(var r=scil.clone(this.graphics),i=0;i<r.length;++i)r[i].selected&&(this.delObject(r[i]),++t);return t},setBondLength:function(t){t/=this.medBondLength();if(isNaN(t))return!1;this.scale(t)},getSketchType:function(){for(var t=0;t<this.atoms.length;++t)if(null!=this.atoms[t].bio)return"biologics";return this.isRxn()?"reaction":"molecule"},mergeMol:function(t,e,i){for(var s=0;s<t.atoms.length;++s)this.addAtom(t.atoms[s]),null!=i&&(t.atoms[s].group=i);for(s=0;s<t.bonds.length;++s){var l=t.bonds[s];null==this.findBond(l.a1,l.a2)&&this.addBond(l,!1)}for(s=0;s<t.graphics.length;++s)this.addGraphics(t.graphics[s]);this._setParent(this)},replaceAtom:function(t,e){for(var i=0;i<this.atoms.length;++i)if(this.atoms[i]==t){this.atoms[i]=e;break}for(i=0;i<this.bonds.length;++i){var s=this.bonds[i];s.a1==t&&(s.a1=e),s.a2==t&&(s.a2=e)}this.setHCount(e)},replaceBond:function(t,e){for(var i=0;i<this.bonds.length;++i)if(this.bonds[i]==t){this.bonds[i]=e;break}this.replaceAtom(t.a1,e.a1),this.replaceAtom(t.a2,e.a2)},addGraphics:function(t){return this.hasGraphics(t)?null:(this._addGraphics(t),t)},addAtom:function(t){return this.hasAtom(t)?null:(this._addAtom(t),t)},addBond:function(t,e,i){if(this.hasBond(t))return null;if(t.a1.mol!=t.a2.mol){if(!i)return scil.Utils.alert("Cannot create this bond"),null;this._addBond2RGroupMol(t)}return this._addBond(t),0!=e&&t.type!=JSDraw2.BONDTYPES.DUMMY&&(t.a1.charge=t.a2.charge=0),"Me"==t.a1.alias&&(t.a1.alias=null),"Me"==t.a2.alias&&(t.a2.alias=null),this.setHCount(t.a1),this.setHCount(t.a2),t},_addBond2RGroupMol:function(t){var e=t.a1._parent||t.a2._parent;null==e||t.a1._parent==t._parent&&t.a2._parent==t.a1._parent||(null==t.a1._parent&&(e.addAtom(t.a1),t.a1._parent=e),null==t.a2._parent&&(e.addAtom(t.a2),t.a2._parent=e),e.addBond(t),t._parent=e)},setAtomAlias:function(t,e,i){if(null==e||""==e)return this.setAtomType(t,e);if(t.alias==e)return!1;var s="*";if(null==(n=JSDraw2.SuperAtoms.get(e))){var l=e.replace(/^[\+|\-]/,"").replace(/[\+|\-]$/,"");if(null!=JSDraw2.PT[l]||/^R[0-9]+$/.test(e))return this.setAtomType(t,e);l=JSDraw2.SuperAtoms.guessOne(e);if(null!=l)e=l,n=JSDraw2.SuperAtoms.get(e);else{var n,l=this.getNeighborBonds(t),r=null==l||0==l.length||1==l.length&&l[0].type==JSDraw2.BONDTYPES.DUMMY;if(null!=(n=JSDraw2.FormulaParser.parse(e,r,l.length))&&0==n.atoms.length)return this.setAtomType(t,n.atoms[0].elem);r&&null!=JSDraw2.FormulaParser.parseSalt(e)&&(s="#")}}return t.isotope=null,t.query=null,t.hcount=null,t.radical=null,t.charge=0,t.alias=e,null!=n?(null!=(r=JSDraw2.SuperAtoms._getFirstAttachAtom(n))&&JSDraw2.SuperAtoms._alignMol(t._parent,t,n,r,null!=i?i:this.medBondLength(1.56)),t.superatom=n,t.rgroup=null,t.elem=s):(scil.Utils.isNullOrEmpty(e)||(t.elem=s),"R"==t.elem?t.updateRGroup():t.rgroup,t.superatom=null),this.setHCount(t),!0},setAttachPoint:function(t,e){return 0<e&&(1!=t.attachpoints.length||t.attachpoints[0]!=e)&&(t.attachpoints=[e],t._parent.setHCount(t),!0)},setAtomType:function(t,e,i){if("antibody"==e||"protein"==e||"gene"==e||"dna"==e||"rna"==e){if(t.biotype()==JSDraw2.BIO.ANTIBODY||t.biotype()==JSDraw2.BIO.PROTEIN||t.biotype()==JSDraw2.BIO.GENE||t.biotype()==JSDraw2.BIO.DNA||t.biotype()==JSDraw2.BIO.RNA)return!1;switch(e){case"antibody":t.bio={type:JSDraw2.BIO.ANTIBODY};break;case"protein":t.bio={type:JSDraw2.BIO.PROTEIN};break;case"gene":t.bio={type:JSDraw2.BIO.GENE};break;case"dna":t.bio={type:JSDraw2.BIO.DNA};break;case"rna":t.bio={type:JSDraw2.BIO.RNA}}return t.elem="X",t.isotope=null,t.query=null,t.hcount=null,t.radical=null,!(t.charge=0)}var s=null;if(1<e.length&&/[\+|\-][0-9]?$/.test(e)&&(n=e.replace(/[\+|\-][0-9]?$/,""),r=e.substr(n.length),e=n,s="+"==r?1:"-"==r?-1:parseInt(r)),t.elem==e&&"H"==e&&null==t.isotope||t.bio)return!1;var l=null,n="D"==e||"T"==e?"H":e;if(/^R[0-9]+$/.test(e)&&(n="R",l=e),null==JSDraw2.PT[n])return!1;var r=t.elem;if("R"!=(t.elem=n)&&(t.rgroup=null),t.alias=l,t.superatom=null,t.isotope="D"==e?2:"T"==e?3:null,t.query=null,0<s||s<0?t.charge=s:i&&(t.charge=0),"@"==r){t.alias=null,t.bio=null;for(var o=this.getAllBonds(t),a=0;a<o.length;++a){var h=o[a];h.type==JSDraw2.BONDTYPES.DUMMY&&scil.Utils.removeArrayItem(this.bonds,h)}}return t._parent.setHCount(t),"R"==n&&t.updateRGroup(),!0},setAtomCharge:function(t,e){return null!=e&&!isNaN(e)&&!t.bio&&(e=Math.round(e),t.charge!=e&&(t.charge=e,t._parent.setHCount(t),!0))},setBondType:function(t,e){return t.a1.biotype()!=JSDraw2.BIO.AA||t.a2.biotype()!=JSDraw2.BIO.AA?!(e<JSDraw2.BONDTYPES.UNKNOWN&&e>JSDraw2.BONDTYPES.DOUBLEORAROMATIC||t.a1.bio||t.a2.bio)&&(t.type=e,t._parent.setHCount(t.a1),t._parent.setHCount(t.a2),!0):t.type==JSDraw2.BONDTYPES.DISULFIDE&&e==JSDraw2.BONDTYPES.PEPTIDE||t.type==JSDraw2.BONDTYPES.PEPTIDE&&e==JSDraw2.BONDTYPES.DISULFIDE?(t.type=e,!0):void 0},isLoneAtom:function(t){for(var e=0;e<this.bonds.length;++e){var i=this.bonds[e];if(i.a1==t||i.a2==t)return!1}return!0},medBondLength:function(t){if(0==this.bonds.length)return t;var e=Math.floor(this.bonds.length/10);0==e&&(e=1);for(var i=[],s=0;s<this.bonds.length;s+=e){var l=this.bonds[s];i.push(l.a1.p.distTo(l.a2.p))}if(0==i.length)return 1.5;if(1==i.length)return i[0]<=0?1.5:i[0];i.sort();t=i[Math.round(i.length/2)];return t<=0?1.5:t},_hasDoubleBonds:function(t){for(var e=0;e<this.bonds.length;++e){var i=this.bonds[e];if(i.type==JSDraw2.BONDTYPES.DOUBLE&&(i.a1==t||i.a2==t))return!0}return!1},getNeighborAtoms:function(t,e,i){for(var s=[],l=0;l<this.bonds.length;++l){var n=this.bonds[l];i&&n.type==JSDraw2.BONDTYPES.DUMMY||(n.a1==t?n.a2!=e&&s.push(n.a2):n.a2==t&&n.a1!=e&&s.push(n.a1))}return s},getNeighborBonds:function(t,e){for(var i=[],s=0;s<this.bonds.length;++s){var l=this.bonds[s];l.a1!=t&&l.a2!=t||e&&(l.type==JSDraw2.BONDTYPES.DUMMY||l.type==JSDraw2.BONDTYPES.UNKNOWN)||i.push(l)}return i},removeHydrogens:function(){for(var t=[],e=0;e<this.atoms.length;++e)"H"==(s=this.atoms[e]).elem&&null==s.isotope&&t.push(e);for(var i=t.length-1;0<=i;--i){for(var s=this.atoms[t[i]],e=this.bonds.length-1;0<=e;--e){var l=this.bonds[e];l.a1!=s&&l.a2!=s||this.bonds.splice(e,1)}this.atoms.splice(t[i],1)}return t.length},draw:function(t,e,i,s,l,n,r,o){if(null==e&&(e=2),null==i&&(i=14),s)for(var a=0;a<this.graphics.length;++a)"TEXT"==this.graphics[a].T&&this.graphics[a].draw(t,e,this,i);else{for(a=0;a<this.atoms.length;++a)(d=this.atoms[a])._outside=d.p.x<-JSDraw2.speedup.gap||d.p.x>l.x+JSDraw2.speedup.gap||d.p.y<-JSDraw2.speedup.gap||d.p.y>l.y+JSDraw2.speedup.gap,d._haslabel=d.hasLabel(this,r);for(var h=[],a=0;a<this.bonds.length;++a){var u=this.bonds[a];u.a1._outside&&u.a2._outside&&!u.a1.hidden&&!u.a2.hidden||o&&u.selected||(this.moveHiddenAtomToGroupBorder(u.a1,u.a2)||this.moveHiddenAtomToGroupBorder(u.a2,u.a1)?u.draw(t,e,this,i,o):h.push(u))}for(a=0;a<this.graphics.length;++a)this.graphics[a].draw(t,e,this,i);for(a=0;a<h.length;++a)h[a].draw(t,e,this,i,o);var c=2*e;if(o)for(a=0;a<this.atoms.length;++a)!(d=this.atoms[a])._outside&&d.hasErr()&&(m=new JSDraw2.Rect(d.p.x-4,d.p.y-4,8,8),JSDraw2.Drawer.drawRect(t,m,"red",e).setFill("red"));else for(var d,a=0;a<this.atoms.length;++a)if(!(d=this.atoms[a])._outside){for(var p=a+1;p<this.atoms.length;++p){var f=this.atoms[p];if(Math.abs(d.p.x-f.p.x)<c&&Math.abs(d.p.y-f.p.y)<c){var m=new JSDraw2.Rect(d.p.x-i/2,d.p.y-i/2,i,i);JSDraw2.Drawer.drawRect(t,m,"red",e);break}}if(d.draw(t,e,this,i,n),null!=d.rgroup){null!=d.rgroup.text&&d.rgroup.draw(t,e,this,i);for(var g=0;g<d.rgroup.mols.length;++g)d.rgroup.mols[g].draw(t,e,i,s,l,n)}}this.drawSelect(new JSDraw2.Lasso(t,e*(o?5:1),!1),o);var w=null;"and"==this.chiral?w="[AND Enantiomer]":"or"==this.chiral?w="[OR Enantiomer]":1==this.chiral&&(w="Chiral"),null!=w&&JSDraw2.Drawer.drawText(t,new JSDraw2.Point(l.x-4*i,+i),w,"gray",i,"right")}},moveHiddenAtomToGroupBorder:function(t,e){if(!t.hidden)return!1;var i=this._findGroup(t);if(null==i)return!1;var s=i.rect();if(e.hidden){i=this._findGroup(e);if(null==i)return!1;var l,i=i.rect();s.left>=i.left&&s.left<=i.right()||s.right()>=i.left&&s.right()<=i.right()||i.left>=s.left&&i.left<=s.right()||i.right()>=s.left&&i.right()<=s.right()?(l=(Math.max(s.left,i.left)+Math.min(s.right(),i.right()))/2,t.p.x=e.p.x=l,t.p.y=s.bottom()<i.top?s.bottom():s.top,e.p.y=i.top>s.bottom()?i.top:i.bottom()):s.top>=i.top&&s.top<=i.bottom()||s.bottom()>=i.top&&s.bottom()<=i.bottom()||i.top>=s.top&&i.top<=s.bottom()||i.bottom()>=s.top&&i.bottom()<=s.bottom()?(l=(Math.max(s.top,i.top)+Math.min(s.bottom(),i.bottom()))/2,t.p.y=e.p.y=l,t.p.x=s.right()<i.left?s.right():s.left,e.p.x=i.left>s.right()?i.left:i.right()):s.right()<i.left?s.bottom()<i.top?(t.p=s.bottomright(),e.p=i.topleft()):(t.p=s.topright(),e.p=i.bottomleft()):s.bottom()<i.top?(t.p=s.bottomleft(),e.p=i.topright()):(t.p=s.topleft(),e.p=i.bottomright()),t._outside=!1,e._outside=!1}else{e=e.p;e.x<s.left?t.p.x=s.left:e.x>s.right()?t.p.x=s.right():t.p.x=e.x,e.y<s.top?t.p.y=s.top:e.y>s.bottom()?t.p.y=s.bottom():t.p.y=e.y,t._outside=!1}return!0},_findGroup:function(t){for(var e=0;e<this.graphics.length;++e){var i=JSDraw2.Group.cast(this.graphics[e]);if(null!=i&&i.a==t)return i}return null},drawSelect:function(t,e){for(var i=0;i<this.graphics.length;++i)this.graphics[i].selected&&this.graphics[i].drawSelect(t);for(i=0;i<this.atoms.length;++i)this.atoms[i].__drawselect=!1;for(i=0;i<this.bonds.length;++i){var s=this.bonds[i];s.selected&&(s.drawSelect(t),e&&(s.a1.__drawselect=!0,s.a2.__drawselect=!0))}for(i=0;i<this.atoms.length;++i){var l=this.atoms[i];if(l.selected&&!l.__drawselect&&l.drawSelect(t),null!=l.rgroup)for(var n=0;n<l.rgroup.mols.length;++n)l.rgroup.mols[n].drawSelect(t,e)}},setZOrder:function(t,e){var i=scil.Utils.indexOf(this.graphics,t);return!(i<0||1==this.graphics.length)&&(0==e?e!=i&&(this.graphics.splice(i,1),this.graphics.splice(0,0,t)):-1==e&&i!=this.graphics.length-1&&(this.graphics.splice(i,1),this.graphics.push(t)),!0)},calcHDir:function(t,e,i){var s=this.getNeighborAtoms(t);if(0==s.length&&0==t.charge)return i?JSDraw2.ALIGN.RIGHT:JSDraw2.ALIGN.LEFT;for(var l=!1,n=!1,r=!1,o=!1,a=0;a<s.length;++a){var h=s[a],u=h.p.x-t.p.x,h=h.p.y-t.p.y;e<u?l=!0:u<-e&&(r=!0),e<h?n=!0:h<-e&&(o=!0)}return l?r?n?o?JSDraw2.ALIGN.RIGHT:JSDraw2.ALIGN.TOP:JSDraw2.ALIGN.BOTTOM:JSDraw2.ALIGN.LEFT:JSDraw2.ALIGN.RIGHT},setMolfile:function(t,e){e=this.setMolfile2(t,e);return null!=e&&this.guessSuperAtoms(),e},guessSuperAtoms:function(){return 0},setMolfile2:function(t,e){if(null!=t&&4<t.length){if("$RXN"==t.substr(0,4))return this.setRxnfile(t);if("$MDL"==t.substr(0,4))return this.setRgfile(t)}if(this.clear(),null==t||0==t.length)return null;for(var i=null,i=0<=t.indexOf("\n")?t.split("\n"):t.split("|"),s=0;s<=Math.min(3,i.length-1);++s){if(0<i[s].toUpperCase().indexOf(" V2000"))return this.setMolV2000(i,s,e),3==s&&(this.name=scil.Utils.trim(i[0])),this;if(0<i[s].toUpperCase().indexOf(" V3000"))return this.setMolV3000(i,s+1,e),s+1==3&&(this.name=scil.Utils.trim(i[0])),this}return null},setMolV2000:function(t,e,i,s){var l=parseFloat(t[e].substr(0,3)),n=parseFloat(t[e].substr(3,3)),r=t[e].substr(12,3);if(JSDraw2.defaultoptions.and_enantiomer||(this.chiral="  1"==r),isNaN(l)||isNaN(n))return null;for(var o=++e;o<l+e;o++){var a=t[o],h=parseFloat(a.substr(0,10)),u=-parseFloat(a.substr(10,10)),c=scil.Utils.trim(a.substr(31,3)),d=39<=a.length?parseInt(a.substr(36,3)):0,p=i&&63<=a.length?parseInt(a.substr(60,3)):0,f=45<=a.length?parseInt(a.substr(42,3)):0,m=51<=a.length?parseInt(a.substr(48,3)):0;if(isNaN(h)||isNaN(u)||isNaN(d))return null;var g=null;switch(/^R[0-9]+$/.test(c)&&(g=c,c="R"),(O=new JSDraw2.Atom(new JSDraw2.Point(h,u),"R#"==c?"R":c)).alias=g,0<p&&(O.atommapid=p),0<f&&f<=5&&(O.hs=f),0<m&&m<=15&&(O.val=m),this._addAtom(O),d){case 1:O.charge=3;break;case 2:O.charge=2;break;case 3:O.charge=1;break;case 5:O.charge=-1;break;case 6:O.charge=-2;break;case 7:O.charge=-3}}for(o=e+=l;o<n+e;o++){var w=t[o],a=parseFloat(w.substr(0,3))-1,c=parseFloat(w.substr(3,3))-1,b=parseInt(w.substr(6,3)),S=parseInt(w.substr(9,3)),v=18<=w.length?parseInt(w.substr(15,3)):null,y=21<=w.length?w.substr(18,3):null;if(isNaN(a)||isNaN(c)||isNaN(b))return null;var D=this.atoms[a],w=this.atoms[c];switch(b){case 0:tt=JSDraw2.BONDTYPES.UNKNOWN;break;case 1:switch(S){case 1:tt=JSDraw2.BONDTYPES.WEDGE;break;case 4:tt=JSDraw2.BONDTYPES.WIGGLY;break;case 6:tt=JSDraw2.BONDTYPES.HASH;break;default:tt=JSDraw2.BONDTYPES.SINGLE}break;case 2:tt=3==S?JSDraw2.BONDTYPES.EITHER:JSDraw2.BONDTYPES.DOUBLE;break;case 3:tt=JSDraw2.BONDTYPES.TRIPLE;break;case 4:tt=JSDraw2.BONDTYPES.DELOCALIZED;break;case 5:tt=JSDraw2.BONDTYPES.SINGLEORDOUBLE;break;case 6:tt=JSDraw2.BONDTYPES.SINGLEORAROMATIC;break;case 7:tt=JSDraw2.BONDTYPES.DOUBLEORAROMATIC;break;case 8:tt=JSDraw2.BONDTYPES.UNKNOWN;break;case 9:tt=JSDraw2.BONDTYPES.DUMMY}w=new JSDraw2.Bond(D,w,tt);1==v?w.ring=!0:2==v&&(w.ring=!1),i&&this.readRxnCenter(w,y),this._addBond(w)}for(var x=[],o=e+=n;o<t.length;++o){var E=6<=(a=scil.Utils.rtrim(t[o])).length?a.substr(0,6):null,A=6<=a.length?a.substr(0,3):null;if("M  ISO"==E)for(var J=parseInt(a.substr(6,3)),k=0;k<J;++k){var T=parseInt(a.substr(10+8*k,3)),U=parseInt(a.substr(14+8*k,3));if(isNaN(T)||isNaN(U))return null;this.atoms[T-1].isotope=U}else if("M  RAD"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){T=parseInt(a.substr(10+8*k,3)),U=parseInt(a.substr(14+8*k,3));if(isNaN(T)||isNaN(U))return null;1<=U&&U<=3&&(this.atoms[T-1].radical=U)}else if("M  CHG"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){T=parseInt(a.substr(10+8*k,3)),U=parseInt(a.substr(14+8*k,3));if(isNaN(T)||isNaN(U))return null;this.atoms[T-1].charge=U}else if("M  ALS"==E){for(var T=parseInt(a.substr(7,3)),J=parseInt(a.substr(10,3)),C="F"==a.substr(14,1),N=[],k=0;k<J;++k){var B=scil.Utils.trim(a.substr(16+4*k,4));JSDraw2.PT.isValidAtomList(B)&&N.push(B)}null==(O=this.atoms[T-1]).query&&(O.query={}),O.query.t=C,O.query.als=N}else if("M  SUB"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){T=a.substr(9+8*k+1,3),U=parseInt(a.substr(9+8*k+5,3));null==(O=this.atoms[T-1]).query&&(O.query={}),-1==U?O.query.sub=0:-2==U?O.query.sub="*":O.query.v=U}else if("M  UNS"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){T=a.substr(9+8*k+1,3),U=parseInt(a.substr(9+8*k+5,3));null==(O=this.atoms[T-1]).query&&(O.query={}),O.query.uns=1==U}else if("M  RBC"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){var T=a.substr(9+8*k+1,3),U=parseInt(a.substr(9+8*k+5,3)),O=this.atoms[T-1];(-1==U||0<U)&&(null==O.query&&(O.query={}),O.query.rbc=-1==U?0:U)}else if("M  RGP"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){var T=parseInt(a.substr(10+8*k,3)),j=parseInt(a.substr(14+8*k,3));if(isNaN(T)||isNaN(j))return null;"R"==this.atoms[T-1].elem&&(null!=(O=this.atoms[T-1]).alias&&""!=O.alias||(O.alias="R"+j),null!=s&&(s[j]=O))}else if("M  APO"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){T=parseInt(a.substr(10+8*k,3)),j=parseInt(a.substr(14+8*k,3));isNaN(T)||isNaN(j)||null==this.atoms[T-1]||this.atoms[T-1].attachpoints.push(j)}else if("M  STY"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){var _=parseInt(a.substr(10+8*k,3)),P=a.substr(14+8*k,3),I=null;if("DAT"==P)I=new JSDraw2.Text;else if("SUP"==P)I={type:"SUPERATOM",atoms:[]};else{for(var M in JSDraw2.SGroup.stys)if(JSDraw2.SGroup.stys[M]==P){I=new JSDraw2.Bracket(""==M?null:M,null);break}null==I&&(I=new JSDraw2.Bracket(null,null))}null!=I&&(x[_]=I)}else if("M  SMT"==E){var _=parseInt(a.substr(7,3)),L=a.substr(11);0<L.length&&"^"==L.substr(0,1)&&(L=L.substr(1)),x[_].subscript=L}else if("M  SCL"==E)x[_=parseInt(a.substr(7,3))].cls=a.substr(11);else if("M  SPL"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){var R=parseInt(a.substr(10+8*k,3)),F=parseInt(a.substr(14+8*k,3));null!=JSDraw2.Text.cast(x[R])&&null!=JSDraw2.Bracket.cast(x[F])&&(x[R].anchors=[x[F]])}else if("M  SCN"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){var _=parseInt(a.substr(10+8*k,3)),H=a.substr(14+8*k,2);null!=JSDraw2.Bracket.cast(x[_])&&(x[_].conn=H)}else if("M  SNC"==E)for(J=parseInt(a.substr(6,3)),k=0;k<J;++k){var _=parseInt(a.substr(10+8*k,3)),G=scil.Utils.trim(a.substr(14+8*k,2));null!=JSDraw2.Bracket.cast(x[_])&&("c"==x[_].type?x[_].type="c"+G:"mul"==x[_].type&&(x[_].type=G+""))}else if("M  SAL"==E){if(null!=(Y=x[_=parseInt(a.substr(7,3))]))for(J=parseInt(a.substr(10,3)),k=0;k<J;++k){T=parseInt(a.substr(14+4*k,3));null!=(O=this.atoms[T-1])&&("SUPERATOM"==Y.type||null!=JSDraw2.Bracket.cast(Y)?Y.atoms.push(O):null!=JSDraw2.Text.cast(Y)&&Y.anchors.push(O))}}else if("M  SPA"==E){var Y=x[_=parseInt(a.substr(7,3))];if(null!=JSDraw2.Bracket.cast(Y)&&"mul"==Y.type)for(J=parseInt(a.substr(10,3)),k=0;k<J;++k){T=parseInt(a.substr(14+4*k,3));null!=(O=this.atoms[T-1])&&(null==Y.spa&&(Y.spa=[]),Y.spa.push(O))}}else if("M  SBL"==E)for(Y=x[_=parseInt(a.substr(7,3))],J=parseInt(a.substr(10,3)),k=0;k<J;++k){var z=parseInt(a.substr(14+4*k,3));null!=(tt=this.bonds[z-1])&&null!=JSDraw2.Text.cast(Y)&&Y.anchors.push(tt)}else if("M  SDI"==E){Y=x[_=parseInt(a.substr(7,3))],J=parseInt(a.substr(10,3));null!=Y&&4==J&&(C=new JSDraw2.Point(parseFloat(a.substr(13,10)),-parseFloat(a.substr(23,10))),L=new JSDraw2.Point(parseFloat(a.substr(33,10)),-parseFloat(a.substr(43,10))),C.isValid()&&L.isValid()&&(null==Y._rect?Y._rect=(new JSDraw2.Rect).set(C,L):Y._rect.unionPoint(C).unionPoint(L)))}else if("M  SDT"==E){Y=x[_=parseInt(a.substr(7,3))];null!=JSDraw2.Text.cast(Y)&&(Y.fieldtype=scil.Utils.trim(a.substr(11,30)))}else if("M  SDD"==E){Y=x[_=parseInt(a.substr(7,3))];null!=JSDraw2.Text.cast(Y)&&(Z=new JSDraw2.Point(parseFloat(a.substr(11,10)),-parseFloat(a.substr(21,10)))).isValid()&&(Y._rect=new JSDraw2.Rect(Z.x,Z.y,0,0))}else if("M  SED"==E){Y=x[_=parseInt(a.substr(7,3))];null!=JSDraw2.Text.cast(Y)&&(Y.text=scil.Utils.trim(a.substr(11)))}else if("A  "==A){T=parseInt(a.substr(3,3));++o,this.atoms[T-1].alias=scil.Utils.trim(t[o])}else if("V  "==A){T=parseInt(a.substr(3,3)),U=scil.Utils.trim(a.substr(7));this.atoms[T-1].tag=U}else if("M  END"==E)break}for(var q=[],X=[],W=this.medBondLength(1.56)/2,o=0;o<x.length;++o)if(null!=(Y=x[o])){I=JSDraw2.Bracket.cast(Y);if(null!=Y._rect&&(null!=I||null!=Y.text&&""!=Y.text))this.addGraphics(Y),null!=I?(""!=I.getType()?this.setSgroup(I,"BRACKET_TYPE",I.subscript||I.getType(),I._rect.right()+W/4,I._rect.bottom()-W):X.push(I),null!=I.conn&&""!=I.conn&&this.setSgroup(I,"BRACKET_CONN",I.conn.toLowerCase(),I._rect.right()+W/4,I._rect.top-W/4),JSDraw2.SuperAtoms.collapseRepeat(this,I)):scil.Utils.endswith(Y.fieldtype,"_TYPE")&&"BRACKET_TYPE"!=Y.fieldtype?Y.fieldtype="BRACKET_SUBTYPE":scil.Utils.endswith(Y.fieldtype,"_MOD")&&(Y.fieldtype="BRACKET_MOD");else if("SUPERATOM"==Y.type){var V=new JSDraw2.Atom(null,"C"),K=new JSDraw2.Mol;q.push({a:V,m:K}),K.atoms=Y.atoms;for(k=0;k<K.atoms.length;++k)scil.Utils.removeArrayItem(this.atoms,K.atoms[k]);for(var Z=null,$=0,Q=this.bonds.length-1;0<=Q;--Q){var tt=this.bonds[Q],et=scil.Utils.indexOf(K.atoms,tt.a1),it=scil.Utils.indexOf(K.atoms,tt.a2);0<=et&&0<=it?(K.bonds.splice(0,0,tt),this.bonds.splice(Q,1)):0<=et?(null==Z&&(Z=tt.a1.p.clone()),tt.a1.attachpoints.push(++$),tt.apo1=$,tt.a1=V):0<=it&&(null==Z&&(Z=tt.a2.p.clone()),tt.a2.attachpoints.push(++$),tt.apo2=$,tt.a2=V)}switch(V.p=null!=Z?Z:K.atoms[0].p.clone(),V.superatom=K,V.alias=Y.subscript,Y.cls){case"AminoAcid":case"AA":V.bio={type:JSDraw2.BIO.AA},V.elem=V.alias,V.alias=null;break;case"BASE":case"DNA":V.bio={type:JSDraw2.BIO.BASE_DNA},V.elem=V.alias,V.alias=null;break;case"RNA":V.bio={type:JSDraw2.BIO.BASE_RNA},V.elem=V.alias,V.alias=null}this._addAtom(V)}}for(o=0;o<X.length;++o){var I=X[o],st=this.getSgroupText(I,"BRACKET_TYPE");if(null!=st&&(X[o].type=st.text),null!=I.atoms)for(k=0;k<q.length;++k){O=q[k].a,K=q[k].m;0<scil.Utils.removeArrayItems(I.atoms,K.atoms)&&I.atoms.push(O)}}for(o=0;o<this.atoms.length;++o)"C"==(O=this.atoms[o]).elem&&null!=O.alias&&/^R[0-9]+$/.test(O.alias)&&(g=O.alias,O.alias=null,this.setAtomAlias(O,g));return JSDraw2.defaultoptions.and_enantiomer&&this.hasStereoCenter()&&"  0"==r&&(this.chiral="and"),this},hasRGroup:function(){for(var t=0;t<this.atoms.length;++t)if("R"==this.atoms[t].elem)return!0;return!1},getMolfile:function(t,e,i){return null==e&&this.needV3000()&&(e=!0),e?this.getMolV3000(t):this.getMolV2000(t,i)},needV3000:function(){return 999<this.atoms.length||999<this.bonds.length||this.hasEnhancedStereochemistry()},getRgfile:function(t,e,i){return null},_getRgroups:function(t){null==t&&(t={n:0,list:[]});for(var e=0;e<this.atoms.length;++e){var i=this.atoms[e];i.iR=null,"R"==i.elem&&(null!=i.alias&&0<i.alias.length&&"R"===i.alias[0]?(i.iR=parseInt(i.alias.split("R")[1]),t.n=Math.max(i.iR,t.n)):i.iR=++t.n,null!=i.rgroup&&0<i.rgroup.mols.length&&t.list.push(i))}return t},getSubMol:function(t){for(var e={atoms:scil.clone(t),bonds:[],openbonds:[]},i=0;i<this.bonds.length;++i){var s=this.bonds[i],l=0<=scil.Utils.indexOf(t,s.a1),n=0<=scil.Utils.indexOf(t,s.a2);l&&n?e.bonds.push(s):l?e.openbonds.push({b:s,oa:s.a2}):n&&e.openbonds.push({b:s,oa:s.a1})}return e},expandSuperAtoms:function(t){superatoms=[];for(var e=this.clone(null),i=scil.clone(e.atoms),s=0;s<i.length;++s){var l=i[s];null!=l.superatom?(o=JSDraw2.SuperAtoms.addToMol(e,l,l.superatom),superatoms.push({a:l,m:o}),null!=t&&t.push({a:l,m:o})):"5'"==l.elem?e.setAtomType(l,"H"):"3'"==l.elem&&e.setAtomType(l,"O")}for(s=0;s<e.graphics.length;++s){var n=JSDraw2.Bracket.cast(e.graphics[s]);if(null!=n){if(null!=n.atoms&&null!=superatoms){for(var r=[],o=null,a=0;a<n.atoms.length;++a){for(var h=0;h<superatoms.length;++h)if(n.atoms[a]==superatoms[h].a){o=superatoms[h].m;break}if(null==o)r.push(n.atoms[a]);else for(h=0;h<o.atoms.length;++h)r.push(o.atoms[h])}n.atoms=r}JSDraw2.SuperAtoms.expandRepeat(e,n)}}return e.calcHCount(!0),e},getMolV2000:function(t,e){var i=[],s=this.expandSuperAtoms(i);if(s.chiral=this.chiral,e)for(var l=s.bonds.length-1;0<=l;--l)s.bonds[l].type==JSDraw2.BONDTYPES.DUMMY&&s.bonds.splice(l,1);e=s._getRgroups();if(0<e.list.length)return s.getRgfile(t,e,i);e=(null==s.name?"":s.name)+"\n";return e+=s._getMolHeader(),e+="\n",e+=s._getMolV2000(t,null,i)},allAtoms:function(t){null==t&&(t=[]);for(var e=0;e<this.atoms.length;++e){var i=this.atoms[e];if(t.push(i),null!=i.rgroup)for(var s=0;s<i.rgroup.mols.length;++s)i.rgroup.mols[s].allAtoms(t)}return t},allBonds:function(t){null==t&&(t=[]);for(var e=0;e<this.bonds.length;++e)t.push(this.bonds[e]);for(e=0;e<this.atoms.length;++e){var i=this.atoms[e];if(null!=i.rgroup)for(var s=0;s<i.rgroup.mols.length;++s)i.rgroup.mols[s].allBonds(t)}return t},_getMolTime:function(){var t=new Date,e=t.getFullYear()+"";return scil.Utils.formatStr(t.getMonth()+1,2,0).replace(" ","0")+scil.Utils.formatStr(t.getDate(),2,0).replace(" ","0")+e.substr(2)+scil.Utils.formatStr(t.getHours(),2,0).replace(" ","0")+scil.Utils.formatStr(t.getMinutes(),2,0).replace(" ","0")},_getMolHeader:function(){(new Date).getFullYear();return"   JSDraw2"+this._getMolTime()+"2D\n"},_getMolV2000:function(t,e,i){null!=e&&this._getRgroups(e);var e=0<this.bondlength?this.bondlength:this.medBondLength(),s=0<e?1.56/e:1,l="";l+=scil.Utils.formatStr(this.atoms.length,3,0),l+=scil.Utils.formatStr(this.bonds.length,3,0),l+="  0  0",this.hasStereoCenter()&&"and"!=this.chiral?l+="  1":l+="  0",l+="  0              0 V2000\n";var n="",r="",o="",a="",h="",u="",c="";this.resetIds();for(var d=0;d<this.atoms.length;++d){null!=(y=this.atoms[d]).isotope&&(n+="M  ISO  1"+scil.Utils.formatStr(d+1,4,0)+scil.Utils.formatStr(y.isotope,4,0)+"\n"),1<=y.radical&&y.radical<=3&&(r+="M  RAD  1"+scil.Utils.formatStr(d+1,4,0)+scil.Utils.formatStr(y.radical,4,0)+"\n"),null!=y.tag&&""!=y.tag&&(o+="V  "+scil.Utils.formatStr(d+1,3,0)+" "+y.tag+"\n"),null!=y.alias&&""!=y.alias&&(c+="A  "+scil.Utils.formatStr(d+1,3,0)+"\n"+y.alias+"\n");for(var p=0;p<y.attachpoints.length;++p)u+="M  APO  1"+scil.Utils.formatStr(d+1,4,0)+scil.Utils.formatStr(y.attachpoints[p],4,0)+"\n";if(null!=y.query){if(null!=y.query.als&&0<y.query.als.length){a+="M  ALS "+scil.Utils.formatStr(d+1,3,0)+scil.Utils.formatStr(y.query.als.length,3,0)+(0==y.query.t?" T ":" F ");for(p=0;p<y.query.als.length;++p)a+=scil.Utils.padright(y.query.als[p],4," ");a+="\n"}null!=y.query.rbc&&(a+="M  RBC  1"+scil.Utils.formatStr(d+1,4,0)+scil.Utils.formatStr(0==y.query.rbc?-1:y.query.rbc,4,0)+"\n"),null!=y.query.uns&&(a+="M  UNS  1"+scil.Utils.formatStr(d+1,4,0)+scil.Utils.formatStr(y.query.uns?1:0,4,0)+"\n"),null!=y.query.sub&&(a+="M  SUB  1"+scil.Utils.formatStr(d+1,4,0)+scil.Utils.formatStr(0==y.query.sub?-1:"*"==y.query.sub?-2:y.query.sub,4,0)+"\n")}var f=y.elem;"R"==y.elem?0<y.iR?(f="R#",h+="M  RGP  1"+scil.Utils.formatStr(d+1,4,0)+scil.Utils.formatStr(parseInt(y.iR),4,0)+"\n"):f="R":"H"==f&&(2==y.isotope?f="D":3==y.isotope&&(element="T")),l+=scil.Utils.formatStr(y.p.x*s,10,4),l+=scil.Utils.formatStr(-y.p.y*s,10,4),l+=scil.Utils.formatStr(0,10,4),l+=" ",l+=scil.Utils.padright(f,2," "),l+="  0";var m=0;switch(y.charge){case 1:m=3;break;case 2:m=2;break;case 3:m=1;break;case-1:m=5;break;case-2:m=6;break;case-3:m=7}l+=scil.Utils.formatStr(m,3,0),l+="  0",0<y.hs?l+=scil.Utils.formatStr(y.hs,3,0):l+="  0",l+="  0  0",0<y.val?l+=scil.Utils.formatStr(y.val,3,0):l+="  0",l+="  0  0",t&&0<y.atommapid?l+=scil.Utils.formatStr(y.atommapid,3,0):l+="  0",l+="  0  0\n"}for(d=0;d<this.bonds.length;++d){var g=this.bonds[d];l+=scil.Utils.formatStr(g.a1.id,3,0),l+=scil.Utils.formatStr(g.a2.id,3,0);var w=0,b=0;switch(g.type){case JSDraw2.BONDTYPES.UNKNOWN:w=8;break;case JSDraw2.BONDTYPES.DUMMY:w=9;break;case JSDraw2.BONDTYPES.DOUBLEORAROMATIC:w=7;break;case JSDraw2.BONDTYPES.SINGLEORAROMATIC:w=6;break;case JSDraw2.BONDTYPES.SINGLEORDOUBLE:w=5;break;case JSDraw2.BONDTYPES.SINGLE:case JSDraw2.BONDTYPES.DOUBLE:case JSDraw2.BONDTYPES.TRIPLE:case JSDraw2.BONDTYPES.DELOCALIZED:w=g.type,b=0;break;case JSDraw2.BONDTYPES.PEPTIDE:case JSDraw2.BONDTYPES.NUCLEOTIDE:case JSDraw2.BONDTYPES.DISULFIDE:case JSDraw2.BONDTYPES.AMIDE:w=1,b=0;break;case JSDraw2.BONDTYPES.WEDGE:case JSDraw2.BONDTYPES.BOLD:b=w=1;break;case JSDraw2.BONDTYPES.HASH:case JSDraw2.BONDTYPES.BOLDHASH:w=1,b=6;break;case JSDraw2.BONDTYPES.WIGGLY:w=1,b=4;break;case JSDraw2.BONDTYPES.EITHER:w=2,b=3}l+=scil.Utils.formatStr(w,3,0),l+=scil.Utils.formatStr(b,3,0),l+=scil.Utils.formatStr(0,3,0),null!=g.ring?l+=scil.Utils.formatStr(g.ring?1:2,3,0):l+=scil.Utils.formatStr(0,3,0),l+=scil.Utils.formatStr(null==g.rcenter?0:g.rcenter,3,0),l+="\n"}l+=n,l+=r,l+=o,l+=c,l+=a,l+=h,l+=u;var S=0;if(null!=i)for(d=0;d<i.length;++d){var v,y=i[d].a,D=i[d].m;null!=D&&(++S,l+="M  STY  1 "+(v=scil.Utils.formatStr(S,3,0))+" SUP\n",l+=this.writeList("M  SAL "+v,D.atoms,"id",4,8),l+=this.writeList("M  SBL "+v,D.bonds,"bondid",4,8),l+="M  SMT "+v+" "+(null==y.alias?y.elem:y.alias)+"\n",null!=y.bio&&(l+="M  SCL "+v+" "+y.biotype()+"\n"))}for(var x=[],d=0;d<this.graphics.length;++d)null!=(R=JSDraw2.Text.cast(this.graphics[d]))&&x.push(R);for(var E="",A={k:S},J=[],d=0;d<this.graphics.length;++d){var k=JSDraw2.Bracket.cast(this.graphics[d]);if(null!=k){J.push(k);k._rect;var T=null,U=null;0<k.atoms.length&&(T=this.getExpandedAtoms(null==k.expandedatoms?k.atoms:k.expandedatoms),U=k.getXbonds(this));var p=++A.k,C=null,N={sty:"",spl:"",data:"",id:A},B=k.getType(),O=k.getTypeNum();N.subscript=B;var j=JSDraw2.SGroup.stys[B];null==j&&(j=null!=U&&2==U.length?"SRU":"GEN"),N.sty+=" "+scil.Utils.formatStr(p,3,0)+" "+j;var _=JSDraw2.SGroup.fieldtypes[B];null==_&&(_="BRACKET");for(var P,I=null==j,M=null,L=0;L<x.length;++L)null!=(R=x[L])&&1==R.anchors.length&&R.anchors[0]==k&&("BRACKET_CONN"==R.fieldtype?C=R.text:"BRACKET_TYPE"!=R.fieldtype||R.text!=B&&"mul"!=B||I?(P=R.fieldtype,null!=_&&null!=P&&8<P.length&&"BRACKET_"==P.substr(0,8)&&(P="BRACKET_SUBTYPE"==P?_+"_TYPE":_+P.substr(7)),"SRU"==j?N.subscript=R.text:this.getDataGroup(R.text,P,R._rect.left*s,-R._rect.top*s,p,N)):"BRACKET_TYPE"==R.fieldtype&&"mul"==B&&(M=R.text),x[L]=null);E+="M  STY"+scil.Utils.formatStr(N.sty.length/8,3,0)+N.sty+"\n","ht"!=C&&"hh"!=C&&"eu"!=C||(E+="M  SCN"+scil.Utils.formatStr(1,3,0)+" "+scil.Utils.formatStr(p,3,0)+" "+C.toUpperCase()+" \n"),null!=O&&(E+="M  SNC"+scil.Utils.formatStr(1,3,0)+" "+scil.Utils.formatStr(p,3,0)+" "+scil.Utils.padLeft(O,3," ")+" \n"),""!=N.spl&&(E+="M  SPL"+scil.Utils.formatStr(N.spl.length/8,3,0)+N.spl+"\n"),0<k.atoms.length&&(E+=this.writeList("M  SAL "+scil.Utils.formatStr(p,3,0),T,"id",4,8),E+=this.writeList("M  SBL "+scil.Utils.formatStr(p,3,0),U,"id",4,8),scil.Utils.isNullOrEmpty(N.subscript)||"MUL"==j&&"mul"==N.subscript||(E+="M  SMT   1 "+N.subscript+"\n"),atoms=k.atoms,"n"==k.type&&"SRU"!=j||(E+=this.writeList("M  SPA "+scil.Utils.formatStr(p,3,0),atoms,"id",4,8))),E+="M  SDI "+scil.Utils.formatStr(p,3,0)+"  4",E+=scil.Utils.formatStr(k._rect.left*s,10,4),E+=scil.Utils.formatStr(-k._rect.bottom()*s,10,4),E+=scil.Utils.formatStr(k._rect.left*s,10,4),E+=scil.Utils.formatStr(-k._rect.top*s,10,4),E+="\n",E+="M  SDI "+scil.Utils.formatStr(p,3,0)+"  4",E+=scil.Utils.formatStr(k._rect.right()*s,10,4),E+=scil.Utils.formatStr(-k._rect.top*s,10,4),E+=scil.Utils.formatStr(k._rect.right()*s,10,4),E+=scil.Utils.formatStr(-k._rect.bottom()*s,10,4),E+="\n",null!=M&&""!=M&&(E+="M  SMT "+scil.Utils.formatStr(p,3,0)+" "+M,E+="\n"),E+=N.data}}for(var R,d=0;d<x.length;++d)if(null!=(R=x[d])){p=A.k,N={sty:"",spl:"",data:"",id:A};this.getDataGroup(R.text,R.fieldtype,R._rect.left*s,-R._rect.top*s,null,N),E+="M  STY"+scil.Utils.formatStr(N.sty.length/8,3,0)+N.sty+"\n",A.k==p&&++A.k,p=A.k;for(var F="",H="",L=0;L<R.anchors.length;++L){y=R.anchors[L];null!=JSDraw2.Atom.cast(y)?F+=" "+scil.Utils.formatStr(y.atomid,3,0):null!=JSDraw2.Bond.cast(y)&&(H+=" "+scil.Utils.formatStr(y.bondid,3,0))}""!=F&&(E+="M  SAL "+scil.Utils.formatStr(p,3,0)+scil.Utils.formatStr(F.length/4,3,0)+F+"\n"),""!=H&&(E+="M  SBL "+scil.Utils.formatStr(p,3,0)+scil.Utils.formatStr(H.length/4,3,0)+H+"\n"),E+=N.data}return l+=E,l+="M  END\n"},getExpandedAtoms:function(t){for(var e=[],i=0;i<t.length;++i){var s=t[i];if(null==s.superatom)e.push(s);else for(var l=0;l<s.superatom.atoms.length;++l)e.push(s.superatom.atoms[i])}return e},writeList:function(t,e,i,s,l){if(null==e||0==e.Length)return"";var n="";countlastline=e.length%l,0==countlastline&&(countlastline=l),lines=(e.length-countlastline)/l+1;for(var r=0;r<lines;++r){var o=r+1==lines?countlastline:l;n+=t,n+=scil.Utils.formatStr(o,3);for(var a=0;a<o;++a)n+=scil.Utils.formatStr(e[r*l+a][i],s);n+="\n"}return n},getMolV3000:function(t){var e=this.expandSuperAtoms([]);return e.chiral=this.chiral,e._getMolV3000()},_getMolV3000:function(t){var e=0<this.bondlength?this.bondlength:this.medBondLength(),i=0<e?1.56/e:1;this.resetIds();var s=new Date,e=s.getFullYear()+"",l="";t||(l+=(null==this.name?"":this.name)+"\n",l+="   JSDraw "+scil.Utils.formatStr(s.getMonth()+1,2,0).replace(" ","0")+scil.Utils.formatStr(s.getDate(),2,0).replace(" ","0")+e.substr(2)+scil.Utils.formatStr(s.getHours(),2,0).replace(" ","0")+scil.Utils.formatStr(s.getMinutes(),2,0).replace(" ","0")+"2D\n",l+="\n",l+="  0  0        0               999 V3000\n");e=this.getEnhancedStereochemistry(),s=this.hasStereoCenter()||!scil.Utils.isNullOrEmpty(e);l+="M  V30 BEGIN CTAB\n",l+="M  V30 COUNTS "+this.atoms.length+" "+this.bonds.length+" 0 0 "+(s?1:0)+"\n",l+="M  V30 BEGIN ATOM\n";for(var n=0;n<this.atoms.length;++n){var r=this.atoms[n],o=r.elem;"R"==o?o=0<r.iR?"R#":"R":"H"==o&&(2==r.isotope?o="D":3==r.isotope&&(element="T")),l+="M  V30 "+r.id+" "+o,l+=" "+scil.Utils.formatStr(r.p.x*i,0,4),l+=" "+scil.Utils.formatStr(-r.p.y*i,0,4),l+=" 0 "+(t&&0<r.atommapid?r.atommapid:0),null!=r.charge&&0!=r.charge&&(l+=" CHG="+r.charge),1<=r.radical&&r.radical<=3&&(l+=" RAD="+r.radical),l+="\n"}l+="M  V30 END ATOM\n",l+="M  V30 BEGIN BOND\n";for(n=0;n<this.bonds.length;++n){var a=this.bonds[n],h=0,u=0;switch(a.type){case JSDraw2.BONDTYPES.UNKNOWN:h=8;break;case JSDraw2.BONDTYPES.DUMMY:h=9;break;case JSDraw2.BONDTYPES.DOUBLEORAROMATIC:h=7;break;case JSDraw2.BONDTYPES.SINGLEORAROMATIC:h=6;break;case JSDraw2.BONDTYPES.SINGLEORDOUBLE:h=5;break;case JSDraw2.BONDTYPES.SINGLE:case JSDraw2.BONDTYPES.DOUBLE:case JSDraw2.BONDTYPES.TRIPLE:case JSDraw2.BONDTYPES.DELOCALIZED:h=a.type,u=0;break;case JSDraw2.BONDTYPES.WEDGE:u=h=1;break;case JSDraw2.BONDTYPES.HASH:h=1,u=3;break;case JSDraw2.BONDTYPES.WIGGLY:h=1,u=2;break;case JSDraw2.BONDTYPES.EITHER:u=h=2}l+="M  V30 "+(n+1)+" "+h+" "+a.a1.id+" "+a.a2.id,0<u&&(l+=" CFG="+u),null!=a.ring&&(l+=" TOPO="+(a.ring?1:2)),t&&0<a.rcenter&&(l+=" RXCTR="+a.rcenter),l+="\n"}return l+="M  V30 END BOND\n",l+=e,l+="M  V30 END CTAB\n",l+="M  END\n"},hasStereoCenter:function(){for(var t=0;t<this.bonds.length;++t){var e=this.bonds[t];if(e.type==JSDraw2.BONDTYPES.WEDGE||e.type==JSDraw2.BONDTYPES.HASH)return!0}return!1},hasEnhancedStereochemistry:function(){return!1},getEnhancedStereochemistry:function(){return""},setMolV3000:function(t,e,i,s,l){return this},readV30Collections:function(t,e,i){},readV30Bonds:function(t,e,i,s){},getChiralAtom:function(t){if(null==t||null==t.anchors||1!=t.anchors.length||"CHIRAL"!=t.fieldtype)return null;var e=JSDraw2.Atom.cast(t.anchors[0]);return null!=e&&JSDraw2.Atom.isValidChiral(t.text)?e:null},markChirality:function(t,e,i){return!1},findBestPostion:function(t,e){var i=t._parent.getNeighborAtoms(t),s=t.p.clone();return null!=i&&0<i.length?(i=i[0].p.angleTo(t.p),s.offset(.37*e,0),s.rotateAround(t.p,i-60),s.x-=.25*e,s.y-=.25*e):(s.x-=.25*e,s.y-=.75*e),s},readRxnCenter:function(t,e){switch(null==e?null:parseInt(e)){case-1:t.rcenter=JSDraw2.RXNCENTER.NOTCENTER;break;case 1:t.rcenter=JSDraw2.RXNCENTER.CENTER;break;case 12:case 13:t.rcenter=JSDraw2.RXNCENTER.BREAKANDCHANGE;break;case 4:case 5:t.rcenter=JSDraw2.RXNCENTER.BREAK;break;case 8:case 9:t.rcenter=JSDraw2.RXNCENTER.CHANGE}},readV30Atoms:function(t,e,i,s){},readV30Counts:function(t,e,i){},parseV30Attributes:function(t,e){return null},getDataGroup:function(t,e,i,s,l,n){},containsWord:function(t){t=t.toLowerCase();for(var e=0;e<this.graphics.length;++e){var i=JSDraw2.Text.cast(this.graphics[e]);if(null!=i&&scil.Utils.containsWord(i.text,t,!0))return!0}return!1},containsText:function(t){t=t.toLowerCase();for(var e=0;e<this.graphics.length;++e){var i=JSDraw2.Text.cast(this.graphics[e]);if(null!=i&&null!=i.text&&0<=i.text.toLowerCase().indexOf(t))return!0}return!1},getProp:function(t){return null==this.props?null:this.props[t]},setProp:function(t,e){null==e?null!=this.props&&delete this.props[t]:(null==this.props&&(this.props={}),this.props[t]=e+"")},setRgfile:function(t){return null},_setParent:function(t){for(var e=0;e<this.atoms.length;++e)this.atoms[e]._parent=t;for(e=0;e<this.bonds.length;++e)this.bonds[e]._parent=t;for(e=0;e<this.graphics.length;++e)this.graphics[e]._parent=t},_setGroup:function(t){for(var e=0;e<this.atoms.length;++e)this.atoms[e].group=t;for(e=0;e<this.bonds.length;++e)this.bonds[e].group=t},toggleAtom:function(t,e){for(var i=0;i<this.atoms.length;++i){var s=this.atoms[i];if(s.toggle(t,e))return s;if(null!=s.rgroup)for(var l=s.rgroup.mols,n=0;n<l.length;++n){var r=l[n].toggleAtom(t,e);if(null!=r)return r}}return null},toggle:function(t,e){for(var i=0;i<this.atoms.length;++i){var s=this.atoms[i];if(s.toggle(t,e))return s;if(null!=s.rgroup){if(s.rgroup.toggle(t,e))return s.rgroup;for(var l=s.rgroup.mols,n=0;n<l.length;++n){var r=l[n].toggle(t,e);if(null!=r)return r}}}for(i=0;i<this.bonds.length;++i)if(this.bonds[i].toggle(t,e))return this.bonds[i];for(i=this.graphics.length-1;0<=i;--i)if(this.graphics[i].toggle(t,e))return this.graphics[i];return null},setRxnfile:function(t){return this},setRxnV3000:function(t){return this},readCtabs:function(t,e,i,s,l){for(var n=0;n<i;++n){var r=new JSDraw2.Mol,o={};r.setMolV3000(t,e,!0,o,l),e=o.i,r.isEmpty()||s.push(r)}return e},setRxnV2000:function(t){return this},setRxn:function(t,e){return this},getRxnfile:function(t,e){t=this.parseRxn(!0,t);return null==t?null:e?this.getRxnV3000(t):this.getRxnV2000(t)},getAllBrackets:function(){for(var t=[],e=0;e<this.graphics.length;++e){var i=this.graphics[e];null!=JSDraw2.Bracket.cast(i)&&t.push(i)}return t},getAllTexts:function(){for(var t=[],e=0;e<this.graphics.length;++e){var i=this.graphics[e];null!=JSDraw2.Text.cast(i)&&t.push(i)}return t},getRxnV2000:function(t){return null},getRxnV3000:function(t,e){return null},getXml:function(t,e,i,s,l){return this._getXml(t,e,i,s,l)},getHtml:function(t,e,i,s,l){return this.getXml(t,e,i,s,l)},_getXml:function(t,e,i,s,l,n){return null},setJdx:function(t,e){return this},setXml:function(t){return this},setHtml:function(t){return this.setXml(t)},toScreen:function(t){var e=this.medBondLength();0<e||(e=1.56);e=t/e;return this.scale(e),e},scale:function(t,e){if(0<t){for(var i=0;i<this.atoms.length;++i){var s=this.atoms[i];if(s.p.scale(t,e),null!=s.rgroup){null!=s.rgroup&&s.rgroup.scale(t,e);for(var l=0;l<s.rgroup.mols.length;++l)s.rgroup.mols[l].scale(t,e)}}for(i=0;i<this.graphics.length;++i)this.graphics[i].scale(t,e)}},flipX:function(t){for(var e=0;e<this.atoms.length;++e){var i=this.atoms[e].p;i.x=t-(i.x-t)}for(e=0;e<this.graphics.length;++e)this.graphics[e].flipX(t)},flipY:function(t){for(var e=0;e<this.atoms.length;++e){var i=this.atoms[e].p;i.y=t-(i.y-t)}for(e=0;e<this.graphics.length;++e)this.graphics[e].flipY(t)},clearFlag:function(){for(var t=0;t<this.atoms.length;++t)this.atoms[t].f=null,this.atoms[t].ringclosures=null;for(t=0;t<this.bonds.length;++t)this.bonds[t].f=null},_connectFragsByPlus:function(t,e){return null},_splitFrags:function(t){for(var e=0;e<t.length;++e){var i=t[e].splitFragments();if(0<i.length){t.splice(e,1);for(var s=0;s<i.length;++s)t.splice(e,0,i[s]);e+=i.length-1}}},_connectNextLine:function(t,e,i,s,l){return null},detectRxn:function(t){return null},_findCloseTexts:function(t,e,i,s){for(var l=0;l<e.length;++l){var n,r,o=e[l];null!=o&&(n=t.rect(),r=o.rect(),(Math.abs(n.top-r.top)<i||Math.abs(n.top-r.bottom())<i||Math.abs(n.bottom()-r.top)<i||Math.abs(n.bottom()-r.bottom())<i)&&Math.min(n.right(),r.right())-Math.max(n.left,r.left)>=Math.min(n.width,r.width)/2&&(s.push(o),e[l]=null))}},parseRxn2:function(){return null},isRxn:function(){return null},_groupByPlus:function(t){if(null==t)return t;for(var e=[],i=0;i<this.graphics.length;++i)"PLUS"==this.graphics[i].T&&e.push(this.graphics[i]);if(0==e.length){if(1<t.reactants.length){for(i=1;i<t.reactants.length;++i)t.reactants[0].mergeMol(t.reactants[i]);t.reactants=[t.reactants[0]]}if(1<t.products.length){for(i=1;i<t.products.length;++i)t.products[0].mergeMol(t.products[i]);t.products=[t.products[0]]}}else{for(var s=[],i=0;i<e.length;++i){for(var l=e[i].p.x,n=s.length,r=0;r<s.length;++r)if(l<s[r]){n=r;break}s.splice(n,0,l)}t.reactants=this._groupByPlus2(s,t.reactants),t.products=this._groupByPlus2(s,t.products)}return t},_groupByPlus2:function(t,e){for(var i=[],s=t.length,l=0;l<e.length;++l){for(var n=e[l],r=e[l].center().x,o=!1,a=0;a<s;++a)if(r<t[a]){null==i[a]?i[a]=n:i[a].mergeMol(n),o=!0;break}o||(null==i[s]?i[s]=n:i[s].mergeMol(n))}for(var h=[],l=0;l<i.length;++l)null!=i[l]&&h.push(i[l]);return h},parseRxn:function(t,e){var i=this._parseRxn();return e&&(i=this._groupByPlus(i)),i},_addGraphicsRxnMol:function(t,e,i){for(var s=0;s<t.length;++s){for(var l=t[s],n=0;n<e.length;++n)null!=(r=e[n])&&r.allAtomsIn(l)&&(l.graphics.push(r),e[n]=null);for(var r,n=0;n<i.length;++n)null!=(r=i[n])&&r.allAnchorsIn(l)&&(l.graphics.push(r),e[n]=null)}},_parseRxn:function(){return null},_hasOverlap:function(t,e,i){var s=i.left,i=i.right();return s<e&&t<i},_sortTextByTop:function(t){if(null==t||0==t.length)return t;for(var e=[],i=[],s=0;s<t.length;++s){for(var l=t[s]._rect.top,n=e.length,r=0;r<e.length;++r)if(l<e[r]){n=r;break}e.splice(n,0,l),i.splice(n,0,t[s])}return i},getFragment:function(t,e){this.setAtomBonds(),this.clearFlag();var i=[];this._getTree(t).tree.list(i,"breadthfirst");for(var s=new JSDraw2.Mol,l=0;l<i.length;++l){var n=i[l];null!=n.a&&null==n.ringclosure&&s._addAtom(n.a,e),null!=n.b&&s._addBond(n.b,e)}return s},splitFragments:function(t){this.clearFlag();for(var e=-1,i=scil.Utils.cloneArray(this.bonds);0<i.length;){var s=i[0];if(t&&(s.a1.hidden||s.a2.hidden))i.splice(0,1);else for(s.f=s.a1.f=s.a2.f=++e,i.splice(0,1);;){for(var l=0,n=i.length-1;0<=n;--n)(s=i[n]).a1.hidden||s.a2.hidden?i.splice(n,1):null!=s.f||s.a1.f!=e&&s.a2.f!=e||(s.f=s.a1.f=s.a2.f=e,i.splice(n,1),++l);if(0==l)break}}for(var r=[],o=0;o<=e;++o){var a=new JSDraw2.Mol;r.push(a);for(n=0;n<this.atoms.length;++n)this.atoms[n].f==o&&a._addAtom(this.atoms[n],this);for(n=0;n<this.bonds.length;++n)this.bonds[n].f==o&&a._addBond(this.bonds[n],this)}for(n=0;n<this.atoms.length;++n)null==this.atoms[n].f&&(t&&this.atoms[n].hidden||(a=new JSDraw2.Mol,r.push(a),a._addAtom(this.atoms[n],this)));for(n=0;n<this.graphics.length;++n){var h=JSDraw2.Bracket.cast(this.graphics[n]);if(null!=h)for(o=0;o<r.length;++o)if(null!=h.atoms&&0!=h.atoms.length&&r[o].containsAllAtoms(h.atoms)){r[o].graphics.push(h);for(var u=0;u<this.graphics.length;++u)null!=(c=JSDraw2.Text.cast(this.graphics[u]))&&null!=c.anchors&&1==c.anchors.length&&c.anchors[0]==h&&r[o].graphics.push(c)}}for(var c,n=0;n<this.graphics.length;++n)if(null!=(c=JSDraw2.Text.cast(this.graphics[n]))&&null!=c.anchors&&0!=c.anchors.length)for(o=0;o<r.length;++o)r[o].containsAllAtoms(c.anchors)&&r[o].graphics.push(c);for(n=0;n<r.length;++n)for(var d=r[n],u=0;u<d.atoms.length;++u){var p=d.atoms[u].group;if(null!=p&&"chiral"==p.type){d.chiral=!0;break}}for(n=0;n<r.length;++n)r[n].bondlength=this.bondlength;return r},containsAllAtoms:function(t){if(null==t||0==t.length)return!1;for(var e=0;e<t.length;++e)if(scil.Utils.indexOf(this.atoms,t[e])<0)return!1;return!0},containsAtom:function(t){for(var e=0;e<this.atoms.length;++e)if(this.atoms[e]==t)return!0;return!1},setAtomBonds:function(t){for(var e=0;e<this.atoms.length;++e)this.atoms[e].bonds=null;if(!t)for(e=0;e<this.bonds.length;++e){var i=this.bonds[e];null==i.a1.bonds&&(i.a1.bonds=[]),i.a1.bonds.push(i),null==i.a2.bonds&&(i.a2.bonds=[]),i.a2.bonds.push(i)}},setBondOrders:function(){for(var t=0;t<this.bonds.length;++t)(e=this.bonds[t]).order=e.valence();if(DEBUG.enable)for(t=0;t<this.bonds.length;++t){var e=this.bonds[t];DEBUG.print(e.a1.id+"-"+e.a2.id+" "+e.order)}for(var i=this._getRings(),s=[];0<i.length;){for(var l=0,t=i.length-1;0<=t;--t){var n=i[t];if(this.isAromaticRing(n)){++l,s.push(n),i.splice(t,1);for(var r=0;r<n.length;++r)n[r].order=1.5}}if(0==l)break}return{arrings:s,rings:i}},isAromaticRing:function(t){if(6==t.length){for(var e=t[0],i=1;i<=t.length;++i){var s=t[i==t.length?0:i];if(!(1==e.order&&2==s.order||2==e.order&&1==s.order||1.5==e.order&&1<=s.order&&s.order<=2||1.5==s.order&&1<=e.order&&e.order<=2))return!1;e=s}return!0}if(5!=t.length)return!1;for(e=t[0],i=1;i<=t.length;++i){s=t[i==t.length?0:i];if(1==e.order&&1==s.order){if(e.a1==s.a1||e.a1==s.a2?v=e.a1:e.a2!=s.a1&&e.a2!=s.a2||(v=e.a2),!(null==v||2!=t[(i+1)%5].order&&1.5!=t[(i+1)%5].order||1!=t[(i+2)%5].order||2!=t[(i+3)%5].order&&1.5!=t[(i+3)%5].order)){if("N"==v.elem||"O"==v.elem||"S"==v.elem||"P"==v.elem)return!0;if("C"==v.elem)for(var l=0;l<v.bonds.length;++l){var n=v.bonds[l].order;if(1.5==n||2==n)return!0}}return!1}e=s}return!1},prepareScreen:function(){for(var t=JSDraw2.FormulaParser.getAtomStats(this).elements,e=this.setBondOrders(),i={0:0,1:0,1.5:0,2:0,3:0},s=0;s<this.bonds.length;++s)++i[this.bonds[s].order];for(var l={n5:0,a5:0,n6:0,a6:0},s=0;s<e.arrings.length;++s)5==e.arrings[s].length?++l.a5:6==e.arrings[s].length&&++l.a6;for(s=0;s<e.rings.length;++s)5==e.rings[s].length?++l.n5:6==e.rings[s].length&&++l.n6;return{atoms:t,bonds:i,rings:l}},clearAtomMap:function(t){var e=0;if(null==t)for(var i=0;i<this.atoms.length;++i)null!=this.atoms[i].atommapid&&(++e,this.atoms[i].atommapid=null);else for(i=0;i<this.atoms.length;++i)t==this.atoms[i].atommapid&&(++e,this.atoms[i].atommapid=null);return e},getMaxMapId:function(){for(var t=0,e=this.atoms,i=0;i<e.length;++i)null!=e[i].atommapid&&e[i].atommapid>=t&&(t=e[i].atommapid);return t+1},screen:function(t,e){null==this.stats&&(this.stats=this.prepareScreen()),null==t.stats&&(t.stats=t.prepareScreen());var i=this.stats.atoms,s=t.stats.atoms,l=null==s["*"]?0:s["*"];for(n in l+=null==s.A?0:s.A,l+=null==s.X?0:s.X,l+=null==s.Q?0:s.Q,l+=null==s.L?0:s.L,i)if("H"!=n&&"*"!=n&&"A"!=n&&"X"!=n&&"Q"!=n&&"L"!=n&&(e&&i[n]!=s[n]||!e&&!(i[n]<=s[n]+l)))return!1;var n,r=this.stats.bonds,o=t.stats.bonds;for(n in r)if(e&&r[n]!=o[n]||!e&&!(r[n]<=o[n]))return!1;return e&&this.stats.rings.a5==t.stats.rings.a5&&this.stats.rings.n5==t.stats.rings.n5&&this.stats.rings.a6==t.stats.rings.a6&&this.stats.rings.n6==t.stats.rings.n6||!e&&this.stats.rings.a5<=t.stats.rings.a5&&this.stats.rings.n5<=t.stats.rings.n5&&this.stats.rings.a6<=t.stats.rings.a6&&this.stats.rings.n6<=t.stats.rings.n6},fullstructureMatch:function(t,e){return null!=t&&this.atoms.length==t.atoms.length&&this.bonds.length==t.bonds.length&&this.getMolWeight()==t.getMolWeight()&&null!=this.aamap(t,!0,null,e)},getBrackets:function(){for(var t=[],e=0;e<this.graphics.length;++e){var i=JSDraw2.Bracket.cast(this.graphics[e]);null!=i&&(t.push(i),i.sgrouptexts=this.getSgroupTexts(i))}return t},matchBrackets:function(t){var e=this.getBrackets(),i=null==t?[]:t.getBrackets();if(e.length!=i.length)return!1;for(var s=0;s<e.length;++s){for(var l=!1,n=0;n<i.length;++n)if(e[s].sgrouptexts==i[n].sgrouptexts){l=!0;break}if(null!=l)return!1}return!0},substructureMatch:function(t){return null!=this.aamap(t,!1)},aamap:function(t,e,i,s){var l=this.aamap2(t,e,s);if(i&&(t.setColor(null==l?null:"black"),null!=l)){for(var n=0;n<l.atoms.length;++n)l.atoms[n].t.color="red";for(n=0;n<l.bonds.length;++n)l.bonds[n].t.color="red"}return l},aamap2:function(t,e,i){if(DEBUG.enable&&DEBUG.clear(),!this.screen(t,e))return DEBUG.enable&&DEBUG.print("screen failed"),null;var s=this._bfPath();t.setAtomBonds(),t.clearFlag(),this.clearFlag();for(var l=0;l<s.length;){var n=!1,r=s[l];if(null==r.b)for(var o=null==r.f?0:r.f+1;o<t.atoms.length;++o){var a=t.atoms[o];if(r.f=o,null==a.f&&JSDraw2.Atom.match(a,r.a)){n=!0,(r.a.f=a).f=r.a;break}}else if(null!=r.ringclosure)null==(c=t.findBond(r.b.a1.f,r.b.a2.f))||r.b.order!=c.order||i&&r.b.type!=c.type||(n=!0,c.f=r.b,r.b.f=c);else for(var h=null==r.f?0:r.f+1,a=r.startAtom().f,u=h;u<a.bonds.length;++u){r.f=u;var c,d=(c=a.bonds[u]).otherAtom(a);if(null==c.f&&null==d.f&&r.b.order==c.order&&(!i||r.b.type==c.type)&&JSDraw2.Atom.match(r.a,d)){n=!0,(r.a.f=d).f=r.a,(r.b.f=c).f=r.b;break}}if(n)++l,DEBUG.enable&&(h="",null!=r.a&&(h+=r.a.id+" -> "+r.a.f.id+" "),null!=r.b&&(h+=r.b.a1.id+"-"+r.b.a2.id+" -> "+r.b.f.a1.id+"-"+r.b.f.a2.id),DEBUG.print(h));else{if(null!=r.b&&null!=r.b.f&&(r.b.f.f=null,r.b.f=null),null!=r.a&&null!=r.a.f&&(r.a.f.f=null,r.a.f=null),r.f=null,--l<0)return DEBUG.enable&&DEBUG.print("failed"),null;null!=(r=s[l]).b&&null!=r.b.f&&(r.b.f.f=null,r.b.f=null),null!=r.a&&null!=r.a.f&&(r.a.f.f=null,r.a.f=null),DEBUG.enable&&DEBUG.print("trace back")}}DEBUG.enable&&DEBUG.print("succeed");for(var p=[],l=0;l<this.atoms.length;++l)p.push({q:this.atoms[l],t:this.atoms[l].f});for(var f=[],l=0;l<this.bonds.length;++l)f.push({q:this.bonds[l],t:this.bonds[l].f});return{atoms:p,bonds:f}},_setAromaticFlag:function(){for(var t=0;t<this.atoms.length;++t)this.atoms[t].aromatic=!1;for(t=0;t<this.bonds.length;++t){var e=this.bonds[t];e.type==JSDraw2.BONDTYPES.DELOCALIZED&&(e.a1.aromatic=e.a2.aromatic=!0)}},getSmiles:function(){return null},_getSmiles:function(){return null},_getRings:function(){var t=[];this.setAtomBonds(),this.clearFlag();for(var e=0;e<this.atoms.length;++e){this.clearFlag();for(var i=0;i<e;++i)this.atoms[i].f="ex";var s=this.atoms[e],l=this._getTree(s);if(0!=l.ri){var n=[];l.tree.list(n,"breadthfirst");for(var r=0;r<n.length;++r){var o=n[r];if(3<o.depth)break;if(null!=o.ringclosure){var a=[o.b];t.push(a);for(var h=o.startAtom(),u=r;h!=s;)for(i=u-1;0<i;--i)if((c=n[i]).a==h){a.push(c.b),h=c.startAtom(),u=i;break}for(h=o.a,u=r;h!=s;)for(var c,i=u-1;0<i;--i)if((c=n[i]).a==h){a.splice(0,0,c.b),h=c.startAtom(),u=i;break}}}}}return t},_bfPath:function(){for(var t=[],e=this._getTrees(),i=0;i<e.length;++i)e[i].list(t,"breadthfirst");return t},_getTrees:function(){this.setAtomBonds(),this.clearFlag();for(var t=[],e=0;;){for(var i=null,s=0;s<this.atoms.length;++s)if(null==(l=this.atoms[s]).f&&!l.isMarkedStereo()){i=l;break}if(null==i)for(var l,s=0;s<this.atoms.length;++s)if(null==(l=this.atoms[s]).f){i=l;break}if(null==i)break;var n=this._getTree(i,e);t.push(n.tree),e=n.ri}return t},_getTree:function(t,e){null==e&&(e=0);t=new JSDraw2.BA(null,t,null);t.depth=0,t.a.f=!0;var i,s=new JSDraw2.Stack;for(s.push(t);null!=(i=s.popHead());){var l=i.a.bonds;if(null!=l)for(var n=0;n<l.length;++n){var r,o,a=l[n];a.f||(a.f=!0,r=null,"ex"!=(o=a.otherAtom(i.a)).f&&(null==o.f?(o.f=!0,r=new JSDraw2.BA(a,o,null),s.push(r)):(++e,1==o.f&&null==o.ringclosures&&(o.ringclosures=[]),o.ringclosures.push({ri:e,next:new JSDraw2.BA(a,i.a,e)}),r=new JSDraw2.BA(a,o,e)),i.addNext(r)))}}return{tree:t,ri:e}},_getPath:function(t){var e=new JSDraw2.Stack;e.push({b:t,a:t.a1.bonds.length>t.a2.bonds.length?t.a1:t.a2}),t.a1.f=!0;for(var i=[];null!=(t=e.pop());)if(!t.b.f){i.push(t),t.a.f&&(t.ringclosure=!0),t.b.f=t.a.f=!0;for(var s=t.a.bonds,l=s.length-1;0<=l;--l)s[l].f||e.push({b:s[l],a:s[l].otherAtom(t.a)})}return i},getFormula:function(t){var e=this.parseRxn();if(null==e)return this._getFormula(t);var i="";if(null!=e.arrow){for(var s=0;s<e.reactants.length;++s)i+=(0<s?" + ":"")+e.reactants[s]._getFormula(t);i+=t?" &rarr; ":" ---\x3e ";for(s=0;s<e.products.length;++s)i+=(0<s?" + ":"")+e.products[s]._getFormula(t);return i}for(s=0;s<e.reactants.length;++s)i+=(0<s?" + ":"")+e.reactants[s]._getFormula(t);return i},_getFormula:function(t){var e=this.expandSuperAtoms(),e=JSDraw2.FormulaParser.getAtomStats(e);return JSDraw2.FormulaParser.stats2mf(e,t)},getMolWeight:function(){var t=this.getMixtureMW();if(0<t)return t;if(this.hasGenericAtom())return null;t=this.expandSuperAtoms(),t=JSDraw2.FormulaParser.getAtomStats(t),t=JSDraw2.FormulaParser.stats2mw(t);return null==t?null:Math.round(1e4*t)/1e4},getMixtureMW:function(){for(var t=0;t<this.graphics.length;++t){var e=JSDraw2.Bracket.cast(this.graphics[t]);if(null!=e&&(""==e.type||null==e.type)){e=this.getSgroupText(e,"POLYMER_MW");if(null!=e){e=scil.Utils.trim(e.text);if(null!=e&&scil.Utils.startswith(e,"mw=")){e=e.substr(3);return parseFloat(e)}}}}return null},getExactMass:function(){if(this.hasGenericAtom())return null;var t=this.expandSuperAtoms(),t=JSDraw2.FormulaParser.getAtomStats(t),t=JSDraw2.FormulaParser.stats2em(t);return null==t?null:Math.round(1e4*t)/1e4},getAllBonds:function(t){for(var e=[],i=this.bonds,s=0;s<i.length;++s)i[s].a1!=t&&i[s].a2!=t||e.push(i[s]);return e},getAllBondAtoms:function(t){for(var e=[],i=this.bonds,s=0;s<i.length;++s)i[s].a1==t?e.push(i[s].a2):i[s].a2==t&&e.push(i[s].a1);return e},countSelected:function(){for(var t=0,e=0;e<this.atoms.length;++e)this.atoms[e].selected&&++t;for(e=0;e<this.bonds.length;++e)this.bonds[e].selected&&++t;for(e=0;e<this.graphics.length;++e)this.graphics[e].selected&&++t;return t},setSgroup:function(t,e,i,s,l){""==i&&(i=null),"BRACKET_TYPE"==e&&"mul"==i&&null!=t.subscript&&""!=t.subscript&&(i=t.subscript,t.subscript=null);var n=this.getSgroupText(t,e);if(null==i){if(null!=n)return this.delGraphics(n),n}else{if(null==n){l=new JSDraw2.Rect(s,l,0,0);return(n=new JSDraw2.Text(l,i)).fieldtype=e,n.anchors.push(t),t._parent.addGraphics(n),n}if(n.text!=i)return n.text=i,n}return null},getSgroupText:function(t,e){for(var i=0;i<this.graphics.length;++i){var s=JSDraw2.Text.cast(this.graphics[i]);if(null!=s&&s.fieldtype==e&&1==s.anchors.length&&s.anchors[0]==t)return s}return null},getSgroupTexts:function(t){for(var e=[],i=0;i<this.graphics.length;++i){var s=JSDraw2.Text.cast(this.graphics[i]);null!=s&&1==s.anchors.length&&s.anchors[0]==t&&e.push(s.text)}return 0==e.length?null:(e.sort(),scil.Utils.array2str(e,"; "))},removeTags:function(t,e){for(var i=0,s=this.graphics.length-1;0<=s;--s){var l=JSDraw2.Text.cast(this.graphics[s]);null!=l&&1==l.anchors.length&&l.anchors[0]==t&&0<=e.indexOf(l.fieldtype+",")&&(this.delGraphics(l),++i)}return i}}),JsMol=JSDraw2.Mol,JSDraw2.Point=scilligence.extend(scilligence._base,{constructor:function(t,e){this.x=isNaN(t)?0:t,this.y=isNaN(e)?0:e},isValid:function(){return!isNaN(this.x)&&!isNaN(this.y)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},distTo:function(t){var e=this.x-t.x,t=this.y-t.y;return Math.sqrt(e*e+t*t)},onLine:function(t,e,i){var s=t.distTo(e),e=t.distTo(this)+e.distTo(this)-s;return Math.abs(e)<=i*(50/s)},inTriangle:function(t,e,i){var s=JSDraw2.Point.sign(this,t,e)<0,e=JSDraw2.Point.sign(this,e,i)<0,t=JSDraw2.Point.sign(this,i,t)<0;return s==e&&e==t},flip:function(t,e){e=e.angleTo(t),e=this.angleTo(t)-e;return this.rotateAround(t,-2*e)},offset:function(t,e){return this.x+=t,this.y+=e,this},offset2:function(t){return this.x+=t.x,this.y+=t.y,this},scale:function(t,e){return null!=e?(this.x=(this.x-e.x)*t+e.x,this.y=(this.y-e.y)*t+e.y):(this.x*=t,this.y*=t),this},reverse:function(){return this.x=-this.x,this.y=-this.y,this},clone:function(){return new JSDraw2.Point(this.x,this.y)},equalsTo:function(t){return null!=t&&this.x==t.x&&this.y==t.y},angle:function(){var t=180*Math.atan2(this.y,this.x)/Math.PI;return t<0?360+t:t},angleTo:function(t){t=180*Math.atan2(this.y-t.y,this.x-t.x)/Math.PI;return t<0?360+t:t},angleAsOrigin:function(t,e){t=t.clone().offset(-this.x,-this.y),t=e.clone().offset(-this.x,-this.y).angle()-t.angle();return t<0?360+t:t},middleAngle:function(t,e){var i=t.angleTo(this),t=e.angleTo(this),e=(i+t)/2;return 180<Math.abs(i-t)&&360<=(e+=180)&&(e-=360),e},rotate:function(t){var e=this.length();if(0==e)return this;var i=this.angle();return this.x=e*Math.cos((i+t)*Math.PI/180),this.y=e*Math.sin((i+t)*Math.PI/180),this},rotateAround:function(t,e,i){return this.offset(-t.x,-t.y).rotate(e).offset(t.x,t.y),0<i&&this.setLength(i,t),this},setLength:function(t,e){return null==e?this.scale(t/this.length()):(this.offset(-e.x,-e.y),this.scale(t/this.length()),this.offset(e.x,e.y))},toString:function(t){return 0<t||(t=1),(this.x*t).toFixed(3)+" "+(-this.y*t).toFixed(3)},shrink:function(t,e){var i=this.distTo(t),i=(i-e)/i;return this.x=(this.x-t.x)*i+t.x,this.y=(this.y-t.y)*i+t.y,this},equalMove:function(t){var e=Math.abs(this.x-t.x);this.y>t.y?this.y=t.y+e:this.y=t.y-e}}),scil.apply(JSDraw2.Point,{fromString:function(t){var e=t.split(" ");if(2!=e.length)return null;t=parseFloat(e[0]),e=-parseFloat(e[1]);return isNaN(t)||isNaN(e)?null:new JSDraw2.Point(t,e)},centerOf:function(t,e){return new JSDraw2.Point((t.x+e.x)/2,(t.y+e.y)/2)},sign:function(t,e,i){return(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y)},_onSegment:function(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)},_orientation:function(t,e,i){e=(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y);return 0==e?0:0<e?1:2},intersect:function(t,e,i,s){var l=this._orientation(t,e,i),n=this._orientation(t,e,s),r=this._orientation(i,s,t),o=this._orientation(i,s,e);return l!=n&&r!=o||(!(0!=l||!this._onSegment(t,i,e))||(!(0!=n||!this._onSegment(t,s,e))||(!(0!=r||!this._onSegment(i,t,s))||!(0!=o||!this._onSegment(i,e,s)))))}}),JSDraw2.Rect=scilligence.extend(scilligence._base,{constructor:function(t,e,i,s){this.left=isNaN(t)?0:t,this.top=isNaN(e)?0:e,this.width=isNaN(i)?0:i,this.height=isNaN(s)?0:s},set:function(t,e){return this.left=Math.min(t.x,e.x),this.top=Math.min(t.y,e.y),this.width=Math.abs(t.x-e.x),this.height=Math.abs(t.y-e.y),this},topleft:function(){return new JSDraw2.Point(this.left,this.top)},topright:function(){return new JSDraw2.Point(this.right(),this.top)},bottomleft:function(){return new JSDraw2.Point(this.left,this.bottom())},bottomright:function(){return new JSDraw2.Point(this.right(),this.bottom())},fourPoints:function(){return[this.topleft(),this.topright(),this.bottomleft(),this.bottomright()]},clone:function(){return new JSDraw2.Rect(this.left,this.top,this.width,this.height)},isEmpty:function(){return!(0<this.width&&0<this.height)},contains:function(t){return t.x>=this.left&&t.x<=this.right()&&t.y>=this.top&&t.y<=this.bottom()},right:function(){return this.left+this.width},bottom:function(){return this.top+this.height},center:function(){return new JSDraw2.Point(this.left+this.width/2,this.top+this.height/2)},centerLeft:function(){return new JSDraw2.Point(this.left,this.top+this.height/2)},centerRight:function(){return new JSDraw2.Point(this.right(),this.top+this.height/2)},centerTop:function(){return new JSDraw2.Point(this.left+this.width/2,this.top)},centerBottom:function(){return new JSDraw2.Point(this.left+this.width/2,this.bottom())},offset:function(t,e){return this.left+=t,this.top+=e,this},scale:function(t,e){return null!=e?(this.left=(this.left-e.x)*t+e.x,this.top=(this.top-e.y)*t+e.y):(this.left*=t,this.top*=t),this.width*=t,this.height*=t,this},unionPoint:function(t){return t.x<this.left?(this.width+=this.left-t.x,this.left=t.x):t.x>this.right()&&(this.width+=t.x-this.right()),t.y<this.top?(this.height+=this.top-t.y,this.top=t.y):t.y>this.bottom()&&(this.height+=t.y-this.bottom()),this},union:function(t){if(null!=t){var e=this.right(),i=this.bottom();return t.left<this.left&&(this.left=t.left),t.top<this.top&&(this.top=t.top),this.width=Math.max(e,t.right())-this.left,this.height=Math.max(i,t.bottom())-this.top,this}},inflate:function(t,e){return null==e&&(t=e),this.width+2*t<0&&(t=-this.width/2),this.height+2*e<0&&(e=-this.height/2),this.offset(-t,-e),this.width+=2*t,this.height+=2*e,this},distance2Point:function(t){var e=this.right(),i=this.bottom(),s=new JSDraw2.Point(this.left,this.top).distTo(t),s=this._minDist(s,t,this.left+this.width/2,this.top);return s=this._minDist(s,t,e,this.top),s=this._minDist(s,t,e,this.top+this.height/2),s=this._minDist(s,t,e,i),s=this._minDist(s,t,this.left+this.width/2,i),s=this._minDist(s,t,this.left,i),this._minDist(s,t,this.left,this.height/2)},_minDist:function(t,e,i,s){return Math.min(t,new JSDraw2.Point(i,s).distTo(e))},cross:function(t,e){var i=this.contains(t),s=this.contains(e);if(i&&s)return 0;if(i&&!s)return-2;if(!i&&s)return 2;var e=e.angleTo(t),l=[];l[0]=new JSDraw2.Point(this.left,this.top).angleTo(t)-e,l[1]=new JSDraw2.Point(this.right(),this.top).angleTo(t)-e,l[2]=new JSDraw2.Point(this.right(),this.bottom()).angleTo(t)-e,l[3]=new JSDraw2.Point(this.left,this.bottom()).angleTo(t)-e;for(var n=0;n<l.length;++n)l[n]<0&&(l[n]+=360);return l.sort(function(t,e){return t-e}),l[0]<90&&270<l[3]?1:90<l[0]&&l[0]<180&&180<l[3]&&l[3]<270?-1:0},toString:function(t){return 0<t||(t=1),(this.left*t).toFixed(3)+" "+(-this.bottom()*t).toFixed(3)+" "+(this.width*t).toFixed(3)+" "+(this.height*t).toFixed(3)},cornerTest:function(t,e){return Math.abs(t.x-this.left)<e&&Math.abs(t.y-this.top)<e?"topleft":Math.abs(t.x-this.right())<e&&Math.abs(t.y-this.top)<e?"topright":Math.abs(t.x-this.left)<e&&Math.abs(t.y-this.bottom())<e?"bottomleft":Math.abs(t.x-this.right())<e&&Math.abs(t.y-this.bottom())<e?"bottomright":null},moveCorner:function(t,e){switch(t){case"topleft":this.set(this.topleft().offset(e.x,e.y),this.bottomright());break;case"topright":this.set(this.topright().offset(e.x,e.y),this.bottomleft());break;case"bottomleft":this.set(this.bottomleft().offset(e.x,e.y),this.topright());break;case"bottomright":this.set(this.bottomright().offset(e.x,e.y),this.topleft())}}}),JSDraw2.Rect.fromString=function(t){if(null==t)return null;var e=t.split(" ");if(4!=e.length)return null;var i=parseFloat(e[0]),s=parseFloat(e[1]),t=parseFloat(e[2]),e=parseFloat(e[3]);return isNaN(i)||isNaN(s)||isNaN(t)||isNaN(e)?null:new JSDraw2.Rect(i,-s-e,t,e)},JSDraw2.Stack=scilligence.extend(scilligence._base,{constructor:function(t){this._items=[],this._capacity=t},item:function(t){return this._items[t]},clear:function(){this._items=[]},length:function(){return this._items.length},isEmpty:function(){return 0==this._items.length},push:function(t){this._items.length>this._capacity&&this._items.splice(0,1),this._items.push(t)},pop:function(){return 0==this._items.length?null:this._items.pop()},popHead:function(){if(0==this._items.length)return null;var t=this._items[0];return this._items.splice(0,1),t}}),scil.Deque=scil.apply(scil._base,{constructor:function(){this.items=[]},pushRange:function(t){if(null!=t)for(var e=0;e<t.length;++e)this.push(t[e])},push:function(t){this.items.push(t)},pop:function(){if(0==this.items.length)return null;var t=this.items[0];return this.items.splice(0,1),t},length:function(){return this.items.length},clear:function(){this.items=[]}}),JSDraw2.SuperAtoms={sdf:"\nMolEngine02241412152D\n\n  6  6  0  0  0  0            999 V2000\n    1.3510    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3510    3.1200    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  2  0  0  0  0\n  2  3  1  0  0  0  0\n  1  4  1  0  0  0  0\n  4  5  2  0  0  0  0\n  5  6  1  0  0  0  0\n  6  3  2  0  0  0  0\nM  END\n> <T>\nBenzene\n\n$$$$\n\nMolEngine02241412152D\n\n  6  6  0  0  0  0            999 V2000\n    1.3510    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.3510    3.1200    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    2.3400    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7020    0.7800    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  6  1  0  0  0  0\n  6  1  1  0  0  0  0\nM  END\n> <T>\nHexane\n\n$$$$\n\nMolEngine02241412152D\n\n  5  5  0  0  0  0            999 V2000\n    0.0000    0.4821    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.4836    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.4006    1.2621    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.4836    2.5242    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.0421    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  1  1  0  0  0  0\nM  END\n> <T>\nPentane\n\n$$$$\n\nMolEngine02241412152D\n\n  3  3  0  0  0  0            999 V2000\n    0.7800    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    1.3510    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5600    1.3510    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  1  3  1  0  0  0  0\n  2  3  1  0  0  0  0\nM  END\n> <T>\nPropane\n\n$$$$\n\nMolEngine02241412152D\n\n  4  4  0  0  0  0            999 V2000\n    0.0000    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    1.5600    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5600    1.5600    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.5600    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  1  1  0  0  0  0\nM  END\n> <T>\nButane\n\n$$$$\n\nMolEngine02241412152D\n\n  7  7  0  0  0  0            999 V2000\n    0.0000    0.9727    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2196    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7405    0.3471    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.4174    1.7527    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.7405    3.1581    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.2196    3.5054    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.5327    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  6  1  0  0  0  0\n  6  7  1  0  0  0  0\n  7  1  1  0  0  0  0\nM  END\n> <T>\nHeptane\n\n$$$$\n\nMolEngine02241412152D\n\n  8  8  0  0  0  0            999 V2000\n    0.0000    1.1031    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.1031    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6631    0.0000    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.7660    1.1031    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    3.7660    2.6631    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    2.6631    3.7662    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    1.1031    3.7662    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n    0.0000    2.6631    0.0000 C   0  0  0  0  0  0  0  0  0  0  0  0\n  1  2  1  0  0  0  0\n  2  3  1  0  0  0  0\n  3  4  1  0  0  0  0\n  4  5  1  0  0  0  0\n  5  6  1  0  0  0  0\n  6  7  1  0  0  0  0\n  7  8  1  0  0  0  0\n  8  1  1  0  0  0  0\nM  END\n> <T>\nOctane\n\n$$$$\n",dict:null,reversible:{},AminoAcids:{},DNAs:{},RNAs:{},templates:{},nterminals:{},cterminals:{},customtemplates:{},listFunctionalGroups:function(t){this.read();var e,t=new JSDraw2.Table(null,{columns:[{key:"name",caption:"Name",width:200},{key:"molfile",type:"structure",caption:"Structure"}],toolbar:["search"]},t),i=[];for(e in this.dict)i.push({name:e,molfile:null==this.dict[e]?null:this.dict[e].getMolfile()});t.setJson({rows:i})},filter:function(t,e){if(null==t||""==t)return null;var i,s=[],l=(t=t.toLowerCase()).length;for(i in this.dict)if(i.length>=l&&i.substr(0,l).toLowerCase()==t&&(s.push(i),s.length>=e))break;return s},get:function(t){this.read();var e=this.dict[t];return null==e&&(e=this.nterminals[t]),null==e&&(e=this.cterminals[t]),null==e?null:e.clone()},getDNA:function(t){return this.read(),this.DNAs[t]},getRNA:function(t){return this.read(),this.RNAs[t]},getAA:function(t){return this.read(),this.AminoAcids[t]},getTemplate:function(t){return this.read(),this.templates[t]},hasCustomTemplates:function(t){for(var e in this.read(),this.customtemplates)return!0;return!1},getCustomTemplate:function(t){return this.read(),this.customtemplates[t]},reverseLabel:function(t){if(this.read(),null!=this.get(t))return this.reverseLabel2(t);var e=t.substr(0,1),i=t.substr(1);return"O"!=e&&"S"!=e||null==this.get(i)?t:this.reverseLabel2(i)+e},reverseLabel2:function(t){if(null==this.reversible[t])return t;for(var e="",i=t.length-1;0<=i;--i){for(var s=1,l=i;0<=l;--l){var n=t.charCodeAt(l);if(65<=n&&n<=90)break;++s}i-=s-1,e+=t.substr(i,s)}return e},guessOne:function(t){for(var e in this.read(),t=t.toLowerCase(),this.dict)if(e.toLowerCase()==t)return e;return null},read:function(){null==this.dict&&(this.dict={},this.addSdf(this.sdf),null!=JSDraw2.defaultoptions&&this.addSdf(JSDraw2.defaultoptions.abbreviations),this.addSdf(JSDraw2.abbreviations),null!=this.onAfterRead&&this.onAfterRead())},addSdf:function(t){if(null!=t&&""!=t)for(var e=t.split("$$$$"),i=0;i<e.length;++i){var s=JSDraw2.Table.readSdfRecord(e[i],!0);if(null==s)break;var l=s.props.T,n=s.props.CT,r=(s.props.Name,new JSDraw2.Mol);r.setMolfile(s.molfile),null!=l?this.templates[l]=r:null!=n&&(this.customtemplates[n]=r)}},_getAttachAtoms:function(t){var e=[];if(null!=t)for(var i=0;i<t.atoms.length;++i)for(var s=t.atoms[i],l=0;l<s.attachpoints.length;++l)e[s.attachpoints[l]-1]={apo:s.attachpoints[l],a:s};return e},_alignMol:function(t,e,i,s,l){0<l&&i.setBondLength(l);t=t.getNeighborBonds(e);if(0==t.length)i.offset(e.p.x-s.p.x,e.p.y-s.p.y);else if(1==t.length){i.offset(e.p.x-s.p.x,e.p.y-s.p.y),b=t[0];var n=b.otherAtom(e).p.angleTo(e.p);1==(r=i.getNeighborBonds(s)).length?i.rotate(e.p,n+60-s.p.angleTo(r[0].otherAtom(s).p)):2==r.length&&i.rotate(e.p,n+180-s.p.middleAngle(r[0].otherAtom(s).p,r[1].otherAtom(s).p))}else{if(2!=t.length)return!1;i.offset(e.p.x-s.p.x,e.p.y-s.p.y);var r,n=e.p.middleAngle(t[0].otherAtom(e).p,t[1].otherAtom(e).p);1==(r=i.getNeighborBonds(s)).length?i.rotate(e.p,n+60-s.p.angleTo(r[0].otherAtom(s).p)):2==r.length&&i.rotate(e.p,n+180-s.p.middleAngle(r[0].otherAtom(s).p,r[1].otherAtom(s).p))}return!0}},JSDraw2.FormulaParser={parse:function(t,e,i){if(scil.Utils.isNullOrEmpty(t))return null;var s=null,l=t.indexOf(".");0<l&&(s=t.substr(l+1),t=t.substr(0,l));i=this._parse(t,e,i);if(null==i&&e&&(i=this.pareFormulaAsSalt(t)),null==i||0==i.atoms.length)return null;if(!scil.Utils.isNullOrEmpty(s)){e=this.pareFormulaAsSalt(s);if(null==e||0==e.atoms.length)return null;t=i.atoms[i.atoms.length-1],s=e.atoms[0];i.mergeMol(e);s=new JSDraw2.Bond(t,s);s.type=JSDraw2.BONDTYPES.DUMMY,i.addBond(s)}return JSDraw2.SuperAtoms.normalize(i),i},pareFormulaAsSalt:function(t){if(scil.Utils.isNullOrEmpty(t))return null;var e=1,i=t.replace(/^[0-9]+/,"");if(i.length<t.length&&(e=parseInt(t.substr(0,t.length-i.length)),t=i),e<1)return null;var s=null,l=t.replace(/[+|-][1-9]?$/,""),n=this.parseCharge(t.substr(l.length)),l=(t=l).replace(/[H][0-9]{0,10}/g,""),s=this.molFromAtom(l,!1,n);if(null==s&&(i=t.replace(/^[A-Z][a-z]?/,"")).length<t.length){if(l=t.substr(0,t.length-i.length),null==(s=this._parse(i)))return null;i=JSDraw2.SuperAtoms._getAttachAtoms(s);if(null==i||1!=i.length)return null;(h=i[0].a).attachpoints=[],"H"!=l&&(c=new JSDraw2.Atom(i[0].a.p.clone(),l),a=new JSDraw2.Bond(h,c),s.addAtom(c),s.addBond(a))}if(null==s||0==s.atoms.length)return null;for(var r=s.clone(),o=1;o<e;++o){var a,h=s.atoms[s.atoms.length-1],u=r.clone(),c=u.atoms[0];s.mergeMol(u),(a=new JSDraw2.Bond(h,c)).type=JSDraw2.BONDTYPES.DUMMY,s.addBond(a)}return s},parseSalt:function(t){if(scil.Utils.isNullOrEmpty(t))return null;var e=t,i=JSDraw2.defaultoptions.salts||JSDraw2.salts;if(null!=i&&null!=i[e]&&""==i[e])return{coef:1,mf:null,mw:0,s:t};var s="";if(!JSDraw2.FormulaParser.ignoresaltcoef)if((s=/^[0-9]{0,10}[\.]?[0-9]{0,9}[ ]?/.exec(t)+"").length==t.length)return null;var l=1;""!=s&&(l=parseFloat(s),isNaN(l)&&(l=1)),e=t=t.substr(s.length);var n=null,s=null;return null==(s=(n=null!=(i=JSDraw2.defaultoptions.salts||JSDraw2.salts)&&null!=i[e]?i[e]:t,this.mf2mw(n,!0)))||0==s?null:{coef:l,mf:1==l?n:l+"("+n+")",mw:Math.round(s*(0<l?l:1)*1e3)/1e3,s:1==l?t:l+t,stats:this.mf2Stats(n,!0)}},parseCharge:function(t){return scil.Utils.isNullOrEmpty(t)?0:"+"==t||"++"==t||"+++"==t?t.length:"-"==t||"--"==t||"---"==t?-t.length:(1<t.length&&("+"==t.substr(t.length-1)||"-"==t.substr(t.length-1))&&(t=t.substr(t.length-1)+t.substr(0,t.length-1)),parseInt(t))},stripHs:function(t){if(null==t||t.length<=1)return t;var e=t.replace(/[+|-][1-9]?$/,""),i=t.substr(e.length);if(/^[A-Z][a-z]?[H][0-9]{0,2}$/.test(e)){var s=/^[A-z][a-z]?/.exec(t);if(null!=(l=JSDraw2.PT[s])&&null!=l.m)return s+i}else if(/^[H][0-9]{0,2}[A-Z][a-z]?$/.test(e)){var l,s=/[A-z][a-z]?$/.exec(t);if(null!=(l=JSDraw2.PT[s])&&null!=l.m)return s+i}return t},mergeStats:function(t,e,i){if(null==t&&(t={elements:{},charges:0,isotopes:{}}),null!=e){for(var s in null==i&&(i=1),e.elements)null==t.elements[s]?t.elements[s]=e.elements[s]*i:t.elements[s]+=e.elements[s]*i;for(var s in e.isotopes){null==t.isotopes[s]&&(t.isotopes[s]={});var l,n=t.isotopes[s],r=e.isotopes[s];for(l in r)null==n[l]?n[l]=r[l]*i:n[l]+=r[l]*i}null!=e.charges&&(t.charges+=e.charges*i)}return t},getAtomStats:function(t){if(null==t)return null;for(var e={elements:{},charges:0,isotopes:{},bios:[]},i=0,s=0,l=0;l<t.atoms.length;++l){var n,r,o,a=t.atoms[l];if("5'"==a.elem)null==e.elements.H?e.elements.H=1:++e.elements.H;else if("3'"==a.elem)null==e.elements.H?e.elements.H=1:++e.elements.H,null==e.elements.O?e.elements.O=1:++e.elements.O;else if(null!=a.bio)switch(a.bio.type){case JSDraw2.BIO.ANTIBODY:case JSDraw2.BIO.PROTEIN:case JSDraw2.BIO.GENE:case JSDraw2.BIO.DNA:case JSDraw2.BIO.RNA:var h=new JSDraw2.SequenceEditor;h.setXml(a.bio.sequences),e.bios.push({mw:h.getMolWeight()})}else if("@"==a.elem){for(var u,c=t.getAllBonds(a),d=0,p=0,f=0;f<c.length;++f)c[f].type==JSDraw2.BONDTYPES.DUMMY?++d:0<(u=c[f].valence())&&(p+=Math.floor(u));0<d&&(s+=p)}else"#"==a.elem?null!=(r=this.parseSalt(a.alias))&&this.mergeStats(e,r.stats,r.coef):(n=a.elem,0<a.isotope?(null==(o=e.isotopes[n])&&(e.isotopes[n]={}),null==(r=e.isotopes[n])[a.isotope]?r[a.isotope]=1:r[a.isotope]=r[a.isotope]+1):(o=e.elements[n],e.elements[n]=null==o?1:o+1),i+=a.hcount);e.charges+=a.charge}return 0<(i-=s)&&(null!=e.elements.H?e.elements.H=i+e.elements.H:e.elements.H=i),e},stats2mw:function(t){if(null==t)return null;var e,i=0;for(e in t.elements)if("D"==e)i+=JSDraw2.PT.H.iso[2]*t.elements[e];else if("T"==e)i+=JSDraw2.PT.H.iso[3]*t.elements[e];else{var s=JSDraw2.PT[e];if(null==s||null==s.m)return null;i+=s.m*t.elements[e]}if(null!=t.bios)for(var l=0;l<t.bios.length;++l)i+=t.bios[l].mw;return 0<(i+=this._isotopemass(t.isotopes))&&(i=scil.Utils.round(i,4)),i},stats2em:function(t){if(null==t)return null;var e,i=0;for(e in t.elements){var s=JSDraw2.PT[e];if(null==s||null==s.em)return null;i+=s.em*t.elements[e]}return i+=this._isotopemass(t.isotopes)},_isotopemass:function(t){if(null==t)return 0;var e,i=0;for(e in t){var s=JSDraw2.PT[e];if(null!=s&&null!=s.m){var l,n=t[e];for(l in n){var r=s.iso[l];i+=(null==r?s.m:r)*n[l]}}}return i},stats2mf:function(t,e){if(null!=t){var i,s="";for(i in null!=t.elements.C&&(s+="C",1<t.elements.C&&(s+=e?"<sub>"+t.elements.C+"</sub>":t.elements.C)),null!=t.elements.H&&(s+="H",1<t.elements.H&&(s+=e?"<sub>"+t.elements.H+"</sub>":t.elements.H)),t.elements)"C"!=i&&"H"!=i&&"R"!=i&&(s+=i,1<t.elements[i]&&(s+=e?"<sub>"+t.elements[i]+"</sub>":t.elements[i]));for(i in t.isotopes){var l,n=t.isotopes[i];for(l in n)s+=e?"<sup>"+l+"</sup>"+i:"{"+l+"}"+i,1<n[l]&&(s+=e?"<sub>"+n[l]+"</sub>":n[l])}var r=t.elements.R;return 0<r&&(s+="R",1<r&&(s+=e?"<sub>"+r+"</sub>":r)),0!=t.charges&&(r=Math.abs(t.charges),r=(0<t.charges?"+":"-")+(1<r?r:""),s+=e?"<sup>"+r+"</sup>":r),s}},mf2mw:function(t,e){e=this.mf2Stats(t,e);return this.stats2mw(e)},normMF:function(t){t=this.mf2Stats(t);return this.stats2mf(t)},mf2Stats:function(t,e){if(null==t||""==t)return null;var i=0,s=t.replace(/(([+|-][0-9]{0,2})|([ ][0-9]{0,2}[+|-]))$/,"");s.length<t.length&&(i=this.parseCharge(t.substr(s.length)));s=this.mf2Stats2(s);return null!=s&&0!=i&&(e&&(i=this.calcSaltCharges(s,i)),s.charges+=i),s},calcSaltCharges:function(t,e){if(1!=JSDraw2.defaultoptions.calcsaltcharges)return e;if(1<=e){if(1<e)for(var i in t.elements)t.elements[i]/=+e;null==t.elements.H&&(t.elements.H=0),--t.elements.H,e=0}return e},mf2Stats2:function(t){var e=JSDraw2.SuperAtoms.get(t);if(null!=e)return this.getAtomStats(e);for(var i,s={elements:{},charges:0},l=/^[0-9]+/;0<=(i=t.indexOf("("));){if(0<i){if(null==(h=this._mf2Stats(t.substr(0,i))))return null;s=this.mergeStats(s,h)}t=t.substr(i);for(var n=!1,r=0,o=1;o<t.length;++o){var a=t.charCodeAt(o);if(40==a)++r;else if(41==a){if(0==r){var h,u=t.substr(1,o-1),c=(t=t.substr(o+1)).match(l),a=1;if(null!=c&&1==c.length&&(t=t.substr(c[0].length),a=parseInt(c[0])),null==(h=this.mf2Stats2(u)))return null;s=this.mergeStats(s,h,a),n=!0;break}--r}}if(!n)return null}return null==(h=this._mf2Stats(t))?null:s=this.mergeStats(s,h)},_mf2Stats:function(t){for(var e=/^[A-Z][a-z]?[0-9]{0,9}/,i=/^[A-Z][a-z]?/,s={elements:{},charges:0};""!=t;){var l=e.exec(t);if(null==l)return null;var n=l[0];if(""==n)return null;var r=i.exec(n)[0],o=JSDraw2.PT["D"==r||"T"==r?"H":r],a=r.length==n.length?1:parseInt(n.substr(r.length)),h={elements:{},charges:0};if(null==o){l=JSDraw2.SuperAtoms.get(r);if(null==l||!(0<l.mw))return null;h=this.getAtomStats(l)}else{if(!(null<o.m))return null;h.elements[r]=1}s=this.mergeStats(s,h,a),t=t.substr(n.length)}return s},molFromAtom:function(t,e,i){var s=t.replace(/[+|-][1-9]?$/,"");s.length<t.length&&(i=this.parseCharge(t.substr(s.length)),t=s);s=JSDraw2.PT[t];if(null!=s&&0<s.a){m=new JSDraw2.Mol;t=new JSDraw2.Atom(new JSDraw2.Point(0,0),t);return null!=i&&(t.charge=i),m.addAtom(t),e&&(t.attachpoints=[1]),m}return null},_parse:function(t,e,i){if(scil.Utils.isNullOrEmpty(t))return null;new RegExp("^[(][^()]+[)]$").test(t)&&(t=t.substr(1,t.length-2));var s=this.stripHs(t);if(null!=(m=this.molFromAtom(s,!0)))return m;var l,n={O:["O"],S:["S"],Se:["Se"],Te:["Te"],Y:["Y"],NH:["N"],PH:["P"],CO:["C","^=O"],CO2:["C","^=O","O"],CH2:["C"],C2H4:["C","C"],C3H6:["C","C","C"],C4H8:["C","C","C","C"],C5H10:["C","C","C","C","C"]};if((e&&(n.H=[]),scil.Utils.startswith(t,"("))&&0<(d=t.indexOf(")"))){var r=t.substr(1,d-1),o=t.substr(d+1),a=1;(s=o.replace(/^[0-9]+/,"")).length<o.length&&(a=parseInt(o.substr(0,o.length-s.length)));var h=this._parseConnectors(r,e);if(null!=h&&""==h.remained){for(var u=[],c=0;c<a;++c)u=u.concat(h.atoms);if(null!=(m=this._connect(u,s)))return m}}if(null!=(m=JSDraw2.SuperAtoms.get(t)))return m;if(null!=(m=this.molFromAtom(t,!0)))return m;for(l in n)if(null!=(m=this._tryFormula(l,n[l],t)))return m;if(3<=t.length){e=t.substr(0,2),s=JSDraw2.PT[e];if(null!=s&&JSDraw2.PT.isMetal(s.a)&&s!=JSDraw2.PT.K&&s!=JSDraw2.PT.Na&&s!=JSDraw2.PT.Rb&&s!=JSDraw2.PT.Cs&&s!=JSDraw2.PT.Fr&&s!=JSDraw2.PT.Sb)return this._tryFormula(e,[e],t)}if(1==i||2==i)if(/^C[0-9]+H[0-9]+$/.test(t)){var d=t.indexOf("H"),p=parseInt(t.substr(1,d-1)),f=parseInt(t.substr(d+1));if(0<p&&(2==i&&2*p==f||1==i&&(2*p+1==f||2*p-1==f||2*p-3==f))){var m=new JSDraw2.Mol,g=new JSDraw2.Atom(new JSDraw2.Point(0,0),"C"),w=null;g.attachpoints=[1],m.addAtom(g);for(c=1;c<p;++c){var b=c%2==1?.5:0,w=new JSDraw2.Atom(new JSDraw2.Point(g.p.x+1,b),"C");m.addAtom(w);b=new JSDraw2.Bond(g,w);c==p-1&&(2*p-1==f?b.type=JSDraw2.BONDTYPES.DOUBLE:2*p-3==f&&(b.type=JSDraw2.BONDTYPES.TRIPLE)),m.addBond(b),g=w}return 2==i&&((null==w?g:w).attachpoints=[2]),m}}return null},_parseConnectors:function(t,e){var i={O:["O"],S:["S"],Se:["Se"],Te:["Te"],Y:["Y"],NH:["N"],PH:["P"],CO:["C","=O"],CO2:["C","=O","O"],CH2:["C"],C2H4:["C","C"],C3H6:["C","C","C"],C4H8:["C","C","C","C"],C5H10:["C","C","C","C","C"]};e&&(i.H=[]);for(var s=[];0<t.length;){var l,n=!1;for(l in i)if(scil.Utils.startswith(t,l)){s=s.concat(i[l]),t=t.substr(l.length),n=!0;break}if(!n)break}return 0==s.length?null:{atoms:s,remained:t}},_tryFormula:function(t,e,i){return scil.Utils.startswith(i,t,!0)?this._connect(e,i.substr(t.length)):null},_connect:function(t,e){var i=JSDraw2.SuperAtoms.get(e);if(null==i&&null==(i=this._parse(e,null,1))&&(i=this.molFromAtom(e,!1)),null!=i){i=i.clone();e=JSDraw2.SuperAtoms._getAttachAtoms(i);if(null==e||1!=e.length)return null;var s=e[0].a,l=null;s.attachpoints=[];for(var n=t.length-1;0<=n;--n){var r=t[n];"^"!=r.substr(0,1)?(s=this._connectAtom(s,r,i),null!=l&&(this._connectAtom(s,l,i),l=null)):l=r.substr(1)}return s.attachpoints=[1],i}},_connectAtom:function(t,e,i){var s=!1;"="==e.substr(0,1)&&(e=e.substr(1),s=!0);var l=t.p.clone();l.offset(1,0);e=new JSDraw2.Atom(l,e),t=new JSDraw2.Bond(t,e);return s&&(t.type=JSDraw2.BONDTYPES.DOUBLE),i.addAtom(e),i.addBond(t),e}},JSDraw2.Toolbar=scil.extend(scil._base,{constructor:function(t){this.toolbar=null,this.editor=t,this.options=t.options,this.toptoolbarTbody=null,this.BORDERSTYLE="solid 1px #ccc",this.toolbarbkcolor="#fcfcfc"},destroy:function(){},getButtons:function(){return this.toolbar.getElementsByTagName("img")},show:function(t){this.toolbarrow.style.display=t?"":"none"},createToolbars:function(t){var e=["H","C","N","O","S","P","F","Cl","Br","..."];this.options.query&&e.push("&#9679;");var i={border:this.BORDERSTYLE,background:JSDraw2.Skin.jsdraw.bkcolor},s=this.editor,l=scil.Utils.createTable(null,0,0,i);this.toolbar=l,dojo.connect(l.parentNode,"onclick",function(t){s.onSelBtn(null==t?window.event:t),t.preventDefault()}),scil.Utils.unselectable(l.parentNode);var n=JSDraw2.Skin.jsdraw.bkcolor;"si"==this.options.skin?n+=" url("+JSDraw2.Skin.jsdraw.toolbarbk+") repeat-x ":null!=JSDraw2.Skin.jsdraw.bkimg&&(n+=" url("+JSDraw2.Skin.jsdraw.bkimg+") repeat-x ");var r=scilligence.Utils.createElement(l,"tr",null,{background:n});this.toolbarrow=r;n=scilligence.Utils.imgTag("jsdraw.gif",null,"title='"+this.res("About JSDraw")+"' style='width:"+this.options.btnsize+"px;height:"+this.options.btnsize+"px;' cmd='jsdraw'");this.isSkinW8()||scilligence.Utils.createElement(r,"td",n,{paddingLeft:"3px"});var o=scilligence.Utils.createTable(scilligence.Utils.createElement(r,"td"),0,0,{marginTop:"si"==this.options.skin?"8px":"2px",marginBottom:"1px"});if(scilligence.Utils.isTouch&&!scilligence.Utils.isIE&&dojo.connect(o.parentNode,"ontouchmove",function(t){t.preventDefault()}),this.isSkinW8()&&(o.parentNode.align=null==this.options.toolbaralign?"center":this.options.toolbaralign,null!=this.options.toolbarleftmargin&&(o.parentNode.style.marginLeft=this.options.toolbarleftmargin)),this.toptoolbarTbody=o,this.recreateTopToolbar(),r=scilligence.Utils.createElement(l,"tr"),!this.isSkinW8()){td=scilligence.Utils.createElement(r,"td",null,{verticalAlign:"top",backgroundPosition:"left"}),o=scilligence.Utils.createTable(td,1,null,{color:"#000"});i={width:this.options.btnsize+"px",height:this.options.btnsize+"px",fontWeight:"bold",cursor:"default",textAlign:"center",verticalAlign:"middle",padding:"2px"};1!=this.options.scale&&(i.fontSize=100*this.options.scale+"%");for(var a=0;a<e.length;++a){var h=scilligence.Utils.createElement(o,"tr"),h=scilligence.Utils.createElement(h,"td",e[a],i,{cmd:e[a]});"..."==e[a]?h.setAttribute("title",this.res("Element Periodic Table")):"&#9679;"==e[a]&&h.setAttribute("title",this.res("Atom Properties")),this.editor.connectHandlers.push(dojo.connect(h,"onmouseover",function(){this.style.backgroundColor=JSDraw2.Skin.jsdraw.hovercolor})),this.editor.connectHandlers.push(dojo.connect(h,"onmouseout",function(){this.style.backgroundColor=""}))}}td=scilligence.Utils.createElement(r,"td",null,{borderTop:this.BORDERSTYLE,borderLeft:this.BORDERSTYLE}),this.isSkinW8()&&(td.colSpan=2,td.style.borderLeft=""),t.parentNode.insertBefore(l.parentNode,t),td.appendChild(t),t.style.border="",this.editor.maintable=l.parentNode},_makePluginFun:function(e){var i=this.editor;return function(t){e(i),(t.srcElement||t.target).setAttribute("jsdrawactivate","false"),t.preventDefault()}},recreateTopToolbar:function(){var t=this.editor.dimension.x,e=this.toptoolbarTbody,i=this.createButtons(t),s="__jsd_tb_"+this.editor.id;scilligence.Utils.removeAll(e);var l=scilligence.Utils.createElement(e,"tr"),n=null;this.isSkinW8()&&(n=scilligence.Utils.createElement(e,"tr",null,{height:"6px",fontsize:"1px"}));for(var r=0;r<i.length;++r){var o=i[r];this.createButton(l,n,o,s)}var a=JSDraw2.defaultoptions.plugins;if(null!=this.options.plugins&&(a=null==a?this.options.plugins:a.concat(this.options.plugins)),null!=a)for(var h=Math.round(2*this.options.btnsize/20),u=0,r=0;r<a.length;++r)"left"==a[r].location?(0==u++&&(td=scilligence.Utils.createElement(null,"td","<img src='"+scil.Utils.imgSrc("img/sep.gif")+"' alt='separator' style='margin:0 "+h+"px 0 "+h+"px;'>"),l.insertBefore(td,l.firstChild),n.insertBefore(scilligence.Utils.createElement(null,"td"),n.firstChild)),td=scilligence.Utils.createElement(null,"td"),l.insertBefore(td,l.firstChild),n.insertBefore(scilligence.Utils.createElement(null,"td"),n.firstChild)):(0==u++&&(td=scilligence.Utils.createElement(l,"td","<img src='"+scil.Utils.imgSrc("img/sep.gif")+"' alt='separator' style='margin:0 "+h+"px 0 "+h+"px;'>"),scilligence.Utils.createElement(n,"td")),td=scilligence.Utils.createElement(l,"td"),scilligence.Utils.createElement(n,"td")),this.createBtnImg(td,a[r].iconurl,null,null,a[r].tooltips,null,a[r].width,a[r].label),this.editor.connectHandlers.push(dojo.connect(td,"onclick",this._makePluginFun(a[r].onclick)))},createButtons:function(t){var e=[],i=[{c:"triple",t:"Triple bond",label:"Triple"},{c:"up",t:"Wedge bond",label:"Up"},{c:"down",t:"Hash bond",label:"Down"},{c:"wiggly",t:"Wiggle bond",label:"Wiggle"},{c:"delocalized",t:"Delocalized bond",label:"Delocalized"},{c:"either",t:"Either double bond",label:"Either"},{c:"boldhash",t:"Hashed bond",label:"Hashed"},{c:"bold",t:"Bold bond",label:"Bold"},{c:"dummy",t:"Ionic bond",label:"Ionic"},{c:"unknown",t:"Dotted bond",label:"Dotted"}];this.options.query&&i.concat([{c:"singledouble",t:"Single or Double",label:"Single"},{c:"singlearomatic",t:"Single or Aromatic"},{c:"doublearomatic",t:"Double or Aromatic"}]);var s=this.isSkinW8()&&t<=400,l=[];0!=this.options.showfilemenu&&(l.push({c:"save",t:"Export",label:"Export"}),l.push({c:"open",t:"Import",label:"Import"}));var n=[{c:"lasso",t:"Lasso Selection",label:"Lasso"},{c:"selfrag",t:"Select Fragment",label:"Fragment"},{c:"selectall",t:"Select All",label:"All"}],r=!1;if(this.options.tlcplate)e.push({c:"new",t:"New",label:"New",sub:l}),e.push({c:"tlctemplate",t:"Template",label:"Template"}),e.push({c:"|"}),e.push({c:"spot-circle",t:"Circle Spot",label:"Circle",sub:[{c:"spot-hellipse",t:"Horizontal Ellipse Spot",label:"Ellipse"},{c:"spot-vellipse",t:"Vertical Ellipse Spot",label:"Ellipse"},{c:"spot-halfellipseup",t:"Half-Ellipse Spot",label:"Ellipse"},{c:"spot-halfellipsedown",t:"Half-Ellipse Spot",label:"Ellipse"},{c:"spot-blowingup",t:"Blowing-up Spot",label:"Blowing"},{c:"spot-blowingdown",t:"Blowing-down Spot",label:"Blowing"},{c:"spot-crescentup",t:"Crescent Spot",label:"Crescent"},{c:"spot-crescentdown",t:"Crescent Spot",label:"Crescent"}]}),e.push({c:"eraser",t:"Eraser",label:"Eraser"}),e.push({c:"|"}),e.push({c:"tlc",t:"TLC Plate",label:"TLC"}),e.push({c:"tlcnumber",t:"Number Plate",label:"Number"}),e.push({c:"electrophoresis",t:"Electrophoresis Gel Plate",label:"Electrophoresis"}),e.push({c:"|"}),e.push({c:"text",t:"Text/Atom Label",label:"Text"}),e.push({c:"|"}),e.push({c:"undo",t:"Undo",label:"Undo"}),e.push({c:"redo",t:"Redo",label:"Redo"}),e.push({c:"|"}),e.push({c:"center",t:"Move to center",label:"Center"}),e.push({c:"zoomin",t:"Zoom in",label:"Zoom"}),e.push({c:"zoomout",t:"Zoom out",label:"Zoom"}),r=!0;else if(this.options.workflow)e.push({c:"new",t:"New",label:"New",sub:l}),e.push({c:"|"}),e.push({c:"select",t:"Box Selection",label:"Box",sub:n}),e.push({c:"moveview",t:"Move/View",label:"Move"}),e.push({c:"zoombox",t:"Zoom Box",label:"Zoom"}),e.push({c:"|"}),e.push({c:"rectangle",t:"Rectangle",label:"Rectangle"}),e.push({c:"diamond",t:"Diamond",label:"Diamond"}),e.push({c:"ellipse",t:"Ellipse",label:"Ellipse"}),e.push({c:"dreversed",t:"D Reversed",label:"D Reversed"}),e.push({c:"dshape",t:"D Shapre",label:"D Shapre"}),e.push({c:"|"}),e.push({c:"arrow",t:"Reaction arrow",label:"Reaction"}),e.push({c:"text",t:"Text/Atom Label",label:"Text"}),e.push({c:"|"}),e.push({c:"eraser",t:"Eraser",label:"Eraser"}),e.push({c:"|"}),e.push({c:"undo",t:"Undo",label:"Undo"}),e.push({c:"redo",t:"Redo",label:"Redo"}),e.push({c:"|"}),e.push({c:"center",t:"Move to center",label:"Center"}),e.push({c:"zoomin",t:"Zoom in",label:"Zoom"}),e.push({c:"zoomout",t:"Zoom out",label:"Zoom"}),r=!0;else if(this.options.helmtoolbar)org.helm.webeditor.Interface.getHelmToolbar(e,l,n,this.options),0!=this.options.showabout&&(r=!0);else{this.options.pastechemdraw&&(l.push({c:"pastechemdraw",t:"Paste ChemDraw, ISIS/Draw...",label:"Paste"}),l.push({c:"copychemdraw",t:"Copy ChemDraw, ISIS/Draw, Word...",label:"Copy"})),this.isSkinW8()?(l.push({c:"about",t:"About JSDraw",label:"About"}),e.push({c:"new",t:"New",label:"New",sub:l})):e.push({c:"new",t:"New",sub:l,label:"New"}),scilligence.Utils.serviceAvailable()&&"Lite"!=JSDraw2.Security.kEdition&&e.push({c:"n2s",t:"Name to Structure",label:"N2S",sub:[{c:"cleanup",t:"Clean up",label:"Clean"}]}),0<e.length&&e.push({c:"|"}),this.options.appmode||n.push({c:"cut",t:"Cut",label:"Cut"}),e.push({c:"select",t:"Box Selection",label:"Box",sub:n}),e.push({c:"center",t:"Move to center",label:"Center",sub:s?null:[{c:"zoomin",t:"Zoom in",label:"Zoom"},{c:"zoomout",t:"Zoom out",label:"Zoom"},{c:"rotate",t:"Rotate",label:"Rotate"},{c:"fliph",t:"Flip Horizontal",label:"Flip"},{c:"flipv",t:"Flip Vertical",label:"Flip"}]}),e.push({c:"moveview",t:"Move/View",label:"Move",sub:[{c:"zoombox",t:"Zoom Box",label:"Zoom"}]}),e.push({c:"|"}),e.push({c:"eraser",t:"Eraser",label:"Eraser"}),this.options.appmode||e.push({c:"undo",t:"Undo",label:"Undo",sub:[{c:"redo",t:"Redo",label:"Redo"}]}),e.push({c:"|"}),e.push({c:"single",t:"Single bond",label:"Single"}),e.push({c:"double",t:"Double bond",label:"Double",sub:i}),e.push({c:"chain",t:"Chain Tool",label:"Chain"}),e.push({c:"|"});var o=0,a=null;JSDraw2.SuperAtoms.read();var h,u={benzene:1,hexane:1,pentane:1,propane:1,butane:1,heptane:1,octane:1};for(h in JSDraw2.SuperAtoms.templates){++o;var c=h,d=u[h.toLowerCase()]?h.toLowerCase():"template";o<=3?(a={c:d,cmd:"template."+h,label:c,t:c},e.push(a)):(null==a.sub&&(a.sub=[]),a.sub.push({c:d,cmd:"template."+h,label:c,t:c}))}JSDraw2.SuperAtoms.hasCustomTemplates()&&0!=this.options.showcustomtemplates&&a.sub.push({c:"templates",cmd:"template.[custom]",label:"Templates",t:"Custom Templates"}),e.push({c:"|"}),this.isSkinW8()&&e.push({c:"e-C",t:"Element C",label:"Carbon",sub:[{c:"e-H",t:"Element H",label:"Hydrogen"},{c:"e-O",t:"Element O",label:"Oxygen"},{c:"e-N",t:"Element N",label:"Nitrogen"},{c:"e-S",t:"Element S",label:"Sulfur"},{c:"e-P",t:"Element P",label:"Phosphorus"},{c:"e-F",t:"Element F",label:"Fluorine"},{c:"e-Cl",t:"Element Cl",label:"Chlorine"},{c:"e-Br",t:"Element Br",label:"Bromine"},{c:"e-more",t:"Element Periodic Table",label:"P.T."}]}),"Lite"!=JSDraw2.Security.kEdition&&(e.push({c:"text",t:"Text/Atom Label",label:"Text",sub:s?null:[{c:"sgroup",t:"SGroup - Tag Atom/Bond/Bracket",label:"SGroup"},{c:"bracket",t:"Bracket",label:"Bracket"},{c:"symbol",t:"Symbol",label:"Symbol"}]}),e.push({c:"rectangle",t:"Rectangle",label:"Rectangle",sub:[{c:"diamond",t:"Diamond",label:"Diamond"},{c:"ellipse",t:"Ellipse",label:"Ellipse"},{c:"dreversed",t:"D Reversed",label:"D Reversed"},{c:"dshape",t:"D Shapre",label:"D Shapre"},{c:"curve",t:"Curve",label:"Curve"},{c:"tlc",t:"TLC Plate",label:"TLC"},{c:"tlctemplate",t:"Template",label:"Template"},{c:"electrophoresis",t:"Electrophoresis Gel Plate",label:"Electrophoresis"},{c:"assaycurve",t:"Assay Curve",label:"Assay"},{c:"spectrum",t:"Spectrum",label:"Spectrum"}]})),e.push({c:"chargep",t:"Increase charges",label:"Charge",sub:[{c:"chargen",t:"Decrease charges",label:"Charge"}]}),this.options.rxn&&"Lite"!=JSDraw2.Security.kEdition&&(e.push({c:"|"}),e.push({c:"arrow",t:"Reaction arrow",label:"Reaction",sub:[{c:"plus",t:"Reaction Plus",label:"Plus"},{c:"rxn",t:"Clean up reaction",label:"Clean"},{c:"copyprod",t:"Copy reactants to products",label:"R->P"},{c:"rxnmap",t:"Map reaction",label:"Map"},{c:"rxnmap2",t:"Clear reaction map",label:"Clear"}]})),this.options.biology&&"Lite"!=JSDraw2.Security.kEdition&&(null!=this.editor.helm&&org.helm.webeditor.Interface.addToolbar(e,null,null,this.options),e.push({c:"seq",t:"Peptide Sequence",label:"Peptide",sub:[{c:"helix",t:"DNA Sequence",label:"DNA"},{c:"rna",t:"RNA Sequence",label:"RNA"},{c:"antibody",t:"Antibody",label:"Antibody"},{c:"protein",t:"Protein",label:"Protein"},{c:"gene",t:"Gene",label:"Gene"}]})),this.isSkinW8()&&this.options.inktools&&!s&&(e.push({c:"|"}),e.push({c:"inkred",t:"Ink - Red",label:"Ink",sub:[{c:"inkblue",t:"Ink - Blue",label:"Ink"},{c:"inkgreen",t:"Ink - Green",label:"Ink"},{c:"inkclear",t:"Clear Ink",label:"Clear1"},{c:"inkclearall",t:"Clear All Inks",label:"Clear"}]})),"Lite"!=JSDraw2.Security.kEdition&&this.options.sendquery&&(e.push({c:"|"}),s=[{c:"chemspider",t:"Search ChemSpider",label:"ChemSpider"}],0!=JSDraw2.defaultoptions.reaxys&&s.push({c:"reaxys",t:"Search Reaxys",label:"Reaxys"}),e.push({c:"pubchem",t:"Search PubChem",label:"PubChem",sub:s})),this.options.usechemdraw&&e.push({c:"chemdraw",t:"ChemDraw Editor",label:"ChemDraw"})}return null!=JSDraw2.Fullscreen&&(this.options.exitfullscreen?(e.push({c:"|"}),e.push({c:"fullscreen2",t:"Regular Size",label:"Fullscreen"})):this.options.fullscreen&&(e.push({c:"|"}),e.push({c:"fullscreen",t:"Fullscreen Size",label:"Fullscreen"}))),r&&(e.push({c:"|"}),e.push({c:"about",t:"About JSDraw",label:"About"})),this.isSkinW8()&&this.relayoutButtonsByWidth(e,t,null==this.options.plugins?0:this.options.plugins.length),e},relayoutButtonsByWidth:function(t,e,i){if((r=Math.round(e/("w8"==this.options.skin?50:60))-t.length-i)<0&&r<-8){for(var s=t.length-1;0<=s;--s)"|"==t[s].c&&t.splice(s,1);r=Math.round(e/("w8"==this.options.skin?50:60))-t.length-i}if(0!=r)if(0<r){for(s=0;s<t.length;++s)if("ring5"==t[s].c){for(var l=t[s].sub,n=0;n<r&&(t.splice(s+n+1,0,l[0]),l.splice(0,1),t[s+n].sub=null,0!=l.length);++n)t[s+n+1].sub=l;break}}else if(r<0)for(var r=-r,o=this.options.workflow?["zoomout","zoombox","redo","zoomin","eraser","moveview"]:this.options.helmtoolbar?["zoombox","zoomout","zoomin","redo","eraser"]:["double","chain","pubchem","pentane","hexane","zoombox","moveview","zoomout","zoomin","redo","n2s","eraser","seq","chemdraw","chargep","rectangle","arrow","text"],s=t.length-1;0<s;--s)if(e<500&&"|"==t[s].c)t.splice(s,1);else{var a=scil.Utils.indexOf(o,t[s].c);if(0<=a&&a+1<=r){for(;0<s&&"|"==t[s-1].c;)t.splice(s-1,1),--s;null==t[s-1].sub&&(t[s-1].sub=[]);l=t[s-1].sub;"si"==this.options.skin&&0<l.length&&l.push("|"),l.push(t[s]);var h=t[s].sub;if((t[s].sub=null)!=h)for(var u=0;u<h.length;++u)l.push(h[u]);t.splice(s,1)}}},res:function(t){return JSDraw2.Language.res(t)},isSkinW8:function(){return"w8"==this.options.skin||"si"==this.options.skin},setHoverable:function(t){this.editor.connectHandlers.push(dojo.connect(t,"onmouseover",function(){this.style.background=JSDraw2.Skin.jsdraw.hovercolor})),this.editor.connectHandlers.push(dojo.connect(t,"onmouseout",function(){this.style.background=null==this.getAttribute("pushed")?"":JSDraw2.Skin.jsdraw.btnselcolor}))},exchangeButton:function(t,e){var i,s,l,n,r,o,a,h;"si"==this.options.skin?(s=(i=t.childNodes[0]).nextSibling,l=(a=e.childNodes[0].getElementsByTagName("td"))[0].childNodes[0],n=a[1].childNodes[0],r=i.src,h=s.innerHTML,o=dojo.attr(t,"cmd"),a=dojo.attr(t,"title"),i.src=l.src,s.innerHTML=n.innerHTML,dojo.attr(t,"cmd",dojo.attr(e,"cmd")),dojo.attr(t,"title",dojo.attr(e,"title")),l.src=r,n.innerHTML=h,dojo.attr(e,"cmd",o),dojo.attr(e,"title",a)):(r=t.src,o=dojo.attr(t,"cmd"),a=dojo.attr(t,"title"),h=null!=t.nextSibling?t.nextSibling.innerHTML:null,t.src=e.src,dojo.attr(t,"cmd",dojo.attr(e,"cmd")),dojo.attr(t,"title",dojo.attr(e,"title")),null!=e.nextSibling&&(t.nextSibling.innerHTML=e.nextSibling.innerHTML),e.src=r,dojo.attr(e,"cmd",o),dojo.attr(e,"title",a),null!=e.nextSibling&&(e.nextSibling.innerHTML=h))},createButton:function(t,e,i,s){var l,n,r=Math.round(2*this.options.btnsize/20),o=s+"_"+i.c;if("|"==i.c?l=scilligence.Utils.createElement(t,"td","<img src='"+scil.Utils.imgSrc("img/sep.gif")+"' style='margin:0 "+2*r+"px 0 "+2*r+"px;width:"+r+"px;vertical-align:middle;'>"):(l=scilligence.Utils.createElement(t,"td"),p=null,p=this.isSkinW8()?"w8/"+i.c+".png":"img/"+i.c+".gif",n=this.createBtnImg(l,null!=i.img?i.img:scil.Utils.imgSrc(p),o,null!=i.cmd?i.cmd:i.c,this.res(i.t),null,null,this.res(i.label))),i.hidden&&(l.style.display="none"),null==i.sub)return null!=e&&scilligence.Utils.createElement(e,"td"),l;"si"==this.options.skin?(h=scil.Utils.createElement(n.parentNode.parentNode,"td","&#9660;",{fontSize:"10px",color:"gray",borderTop:"solid 1px #ccc",borderRight:"solid 1px #ccc",borderBottom:"solid 1px #ccc"}),this.setHoverable(h)):h=null==e?scilligence.Utils.createElement(t,"td","&#9660;",{fontSize:this.options.btnsize/2+"px",verticalAlign:"bottom",color:"gray"}):scilligence.Utils.createElement(e,"td",null,{height:"10px",background:scil.Utils.imgSrc("w8/handle.png",!0)+" no-repeat center center"}),i.hidden&&(h.style.display="none"),scilligence.Utils.isTouch?(dojo.connect(l,"ontouchmove",function(){JSDraw2.Menu.open(o+"_sub")}),dojo.connect(h,"onclick",function(){JSDraw2.Menu.open(o+"_sub")})):(window.navigator.msPointerEnabled&&dojo.connect(l,"onMSPointerMove",function(t){1==t.buttons&&JSDraw2.Menu.open(o+"_sub")},!1),this.isSkinW8()?(dojo.connect(h,"onclick",function(){JSDraw2.Menu.open(o+"_sub")}),h.setAttribute("title",this.res("click to expand")),dojo.connect(h,"onmouseover",function(t){(t.target||t.srcElement).style.backgroundImage=scil.Utils.imgSrc("w8/handle2.png",!0)}),dojo.connect(h,"onmouseout",function(t){(t.target||t.srcElement).style.backgroundImage=scil.Utils.imgSrc("w8/handle.png",!0)})):(dojo.connect(h,"onmouseover",function(){JSDraw2.Menu.open(o+"_sub")}),dojo.connect(h,"onmouseout",function(){JSDraw2.Menu.closetime()}),dojo.connect(h,"onclick",function(){JSDraw2.Menu.close()})));var a=scil.Utils.createTable(l,0,0,{display:"none",zIndex:99999999,borderRadius:Math.round(("si"==this.options.skin?3:4)*this.options.btnsize/40)+"px",position:"absolute",backgroundColor:"si"==this.options.skin?this.toolbarbkcolor:JSDraw2.Skin.jsdraw.bkcolor,border:this.BORDERSTYLE,padding:"2px"}),h=a.parentNode;h.id=o+"_sub",h.onmouseover=JSDraw2.Menu.cancelclosetime,h.onmouseout=JSDraw2.Menu.closetime;var u=i.sub,i=0,c="w8"!=this.options.skin||u.length<=5;c||(i=-(this.options.btnsize/2+4),h.style.marginLeft=i+"px"),scilligence.Utils.isIE&&scilligence.Utils.isIE<8&&!this.isSkinW8()&&(h.style.margin=this.options.btnsize+4+"px 0 0 "+(i-this.options.btnsize-2)+"px");for(var t=null,d=0;d<u.length;++d){var p,f=u[d];!c&&d%2!=0||(t=scilligence.Utils.createElement(a,"tr")),l=scilligence.Utils.createElement(t,"td"),"|"!=f?(0<d&&this.isSkinW8()&&(l.style.paddingTop=r+"px"),p=null,p=this.isSkinW8()?"w8/"+f.c+".png":"img/"+f.c+".gif",this.createBtnImg(l,null!=f.img?f.img:scil.Utils.imgSrc(p),null,null!=f.cmd?f.cmd:f.c,this.res(f.t),o,null,this.res(f.label),!0)):scil.Utils.createElement(l,"hr",null,{margin:"5px 0 0 0",padding:0})}return l},createBtnImg:function(t,e,i,s,l,n,r,o,a){null==r&&(r=this.options.btnsize);Math.round(2*r/20);if("si"==this.options.skin){a&&(t=scil.Utils.createElement(t,"div",null,{height:"32px"}));var h=scil.Utils.createTable(t,0,0,a?null:{margin:"0 2px 0 2px",backgroundColor:this.toolbarbkcolor}),u=scil.Utils.createElement(h,"tr"),c=scil.Utils.createElement(u,"td",null,a?null:{border:"solid 1px "+JSDraw2.Skin.jsdraw.bkcolor}),d=null,p=scilligence.Utils.createElement(c,"img",null,{marginTop:"-5px"},{src:e,alt:l}),h={marginTop:"-11px",width:r+"px",fontSize:"9px",textAlign:"center",color:"gray",whiteSpace:"nowrap",overflow:"hidden"};return a?(d=scil.Utils.createElement(u,"td"),scil.Utils.isIE&&scil.Utils.isIE<8&&(h.fontSize=h.marginTop=h.width=null),h.textAlign="left",scil.Utils.createElement(d,"div",null==o||""==o?"&nbsp;":o,h)):scil.Utils.createElement(c,"div",null==o||""==o?"&nbsp;":o,h),this.setHoverable(a?t:c),null!=l&&(a?t:c).setAttribute("title",l),null!=s&&(a?t:c).setAttribute("cmd",s),null!=n&&(a?t:c).setAttribute("parent",n),null!=i&&((a?t:c).id=i),p}var f,a={textAlign:"center",padding:this.isSkinW8()?"2px 2px 0 2px":"2px",verticalAlign:"middle",width:r+"px",height:this.options.btnsize+"px"};return this.isSkinW8()?(c=this.options.buttonshape+".png",a.background="url("+scil.Utils.imgSrc("w8/"+c)+") center center no-repeat",p=scilligence.Utils.createElement(t,"img",null,a,{src:e,alt:l}),scil.Utils.createElement(t,"div",null==o||""==o?"&nbsp;":o,{width:r+"px",fontSize:"9px",textAlign:"center",color:"gray",whiteSpace:"nowrap",overflow:"hidden"})):p=scilligence.Utils.createElement(t,"img",null,a,{src:e,alt:l}),null!=s&&p.setAttribute("cmd",s),null!=l&&p.setAttribute("title",l),null!=n&&p.setAttribute("parent",n),null!=i&&(p.id=i),this.isSkinW8()?((f=this).editor.connectHandlers.push(dojo.connect(p,"onmouseover",function(){this.style.backgroundImage=scil.Utils.imgSrc("w8/"+f.options.buttonshape+"1.png",!0)})),this.editor.connectHandlers.push(dojo.connect(p,"onmouseout",function(){this.style.backgroundImage=scil.Utils.imgSrc("w8/"+f.options.buttonshape+(null==this.getAttribute("pushed")?"":"0")+".png",!0)}))):this.setHoverable(p),p}}),JSDraw2.Lasso=scilligence.extend(scilligence._base,{constructor:function(t,e,i){this.surface=t,this.linewidth=e,this.list=i?[]:null,this.lasthits=[],this.curhits=[],this.line=null},hit:function(t){0<=scil.Utils.indexOf(this.lasthits,t)||(t.selected=!t.selected,t.selected?t.drawSelect(this):this.remove(t),this.curhits.push(t))},endHits:function(t,e){this.lasthits=this.curhits,this.curhits=[],null!=this.line&&this.surface.remove(this.line),this.line=JSDraw2.Drawer.drawLine(this.surface,t,e,"#aaf",this.linewidth/2)},draw:function(t,e){null!=e.x&&(e=[e]);for(var i=[],s=0;s<e.length;++s){var l=e[s],l=this.surface.createCircle({cx:l.x,cy:l.y,r:2*this.linewidth}).setFill(JSDraw2.Editor.COLORSELECTED);i.push(l)}null!=this.list&&this.list.push({a:t,nodes:i})},remove:function(t){for(var e=null,i=0;i<this.list.length;++i)if(this.list[i].a==t){e=this.list[i].nodes,this.list.splice(i,1);break}if(null!=e)for(i=0;i<e.length;++i)this.surface.remove(e[i])}}),JSDraw2.Drawer={kMinFontSize:4,drawFormula:function(t,e,i,s,l,n){var r;!i||"0"<=(r=s.charAt(0))&&r<="9"&&(i=!1);for(var o=new JSDraw2.Rect,a=this.splitFormula(s),h=0;h<a.length;++h){i&&null!=a[h].num&&(u=this.drawWord(t,o,e,l,n,a[h].num,i,!0),o.isEmpty()?o=u:o.union(u));var u=this.drawWord(t,o,e,l,n,a[h].str,i,!1);o.isEmpty()?o=u:o.union(u),i||null!=a[h].num&&(u=this.drawWord(t,o,e,l,n,a[h].num,i,!0),o.isEmpty()?o=u:o.union(u))}return o},drawWord:function(t,e,i,s,l,n,r,o){o&&(l/=1.4);var a=this.drawLabel(t,i,n,s,l,!1,r?"end-anchor":"start-anchor"),h=a._rect.clone(),t=h.width/2,s=0,o=o?l/4:0;return e.isEmpty()||(r?(s=-(i.x-e.left)-t,"I"!=n&&"i"!=n&&"l"!=n&&"r"!=n&&"f"!=n&&"."!=n||(s-=l/6),scil.Utils.isChrome&&(s-=l/10)):(s=e.right()-i.x+t,"I"!=n&&"i"!=n&&"l"!=n&&"r"!=n&&"f"!=n&&"."!=n||(s+=l/6),scil.Utils.isChrome&&(s+=l/10))),a.setTransform([dojox.gfx.matrix.translate(s,o)]),h.left+=s,h.top+=o,h},splitFormula:function(t){if(/^[A-Z]+$/.test(t)||/^[\(][^\(\)]+[\)]$/.test(t)||/^[\[][^\[\]]+[\]]$/.test(t))return[{str:t}];for(var e=[],i=0,s=!1,l="",n=0;n<t.length;++n){var r=t.charAt(n);0<i||"("==r?("("==r?(0==i&&(""!=l&&(s&&0<e.length?e[e.length-1].num=l:e.push({str:l})),s=!1,l=""),++i):")"==r&&--i,l+=r,0==i&&(e.push({str:l}),l="")):("A"<=r&&r<="Z"?(""!=l&&(s&&0<e.length?e[e.length-1].num=l:e.push({str:l})),s=!1,l=""):"0"<=r&&r<="9"&&!s&&(""!=l&&e.push({str:l}),s=!0,l=""),l+=r)}return""!=l&&(s&&0<e.length?e[e.length-1].num=l:e.push({str:l})),e},drawCurveArrow:function(t,e,i,s,l,n,r){var o;null!=s&&null!=l||(s=(o=JSDraw2.Curve.calcAnchors(e,i)).p1a,l=o.p2a),t.createPath("").moveTo(e.x,e.y).curveTo(s.x,s.y,l.x,l.y,i.x,i.y).setStroke({color:n,width:r,cap:"round"}),JSDraw2.Drawer.drawArrowhead(t,l,i,n,r)},drawCurve:function(t,e,i,s,l,n,r){s=JSDraw2.Curve.calcAnchors(e,i,s,l),l=s.p1a,s=s.p2a;t.createPath("").moveTo(e.x,e.y).curveTo(l.x,l.y,s.x,s.y,i.x,i.y).setStroke({color:n,width:r,cap:"round"})},drawArrow:function(t,e,i,s,l,n,r){var o,a,h,u;"dual"==r?(u=(o=new JSDraw2.Point(i.x-e.x,i.y-e.y)).clone().rotate(90).setLength(l),a=e.clone().offset(o.x+u.x,o.y+u.y),h=i.clone().offset(-o.x+u.x,-o.y+u.y),JSDraw2.Drawer.drawLine(t,a,h,s,l,n),JSDraw2.Drawer.drawArrowhead2(t,a,h,s,l,"top"),u=o.clone().rotate(-90).setLength(l),a=e.clone().offset(o.x+u.x,o.y+u.y),h=i.clone().offset(-o.x+u.x,-o.y+u.y),JSDraw2.Drawer.drawLine(t,a,h,s,l,n),JSDraw2.Drawer.drawArrowhead2(t,h,a,s,l,"top")):"reversible"==r?(u=(o=new JSDraw2.Point(i.x-e.x,i.y-e.y)).clone().rotate(90).setLength(l),a=e.clone().offset(.6*o.x+u.x,.6*o.y+u.y),h=i.clone().offset(-o.x+u.x,-o.y+u.y),JSDraw2.Drawer.drawLine(t,a,h,s,l,n),JSDraw2.Drawer.drawArrowhead2(t,a,h,s,l,"top"),u=o.clone().rotate(-90).setLength(l),a=e.clone().offset(o.x+u.x,o.y+u.y),h=i.clone().offset(-o.x+u.x,-o.y+u.y),JSDraw2.Drawer.drawLine(t,a,h,s,l,n),JSDraw2.Drawer.drawArrowhead2(t,h,a,s,l,"top")):("solid"==r?(u=new JSDraw2.Point(i.x-e.x,i.y-e.y).setLength(4*l),JSDraw2.Drawer.drawLine(t,e,i.clone().offset(-u.x,-u.y),s,l,n)):JSDraw2.Drawer.drawLine(t,e,i,s,l,n),JSDraw2.Drawer.drawArrowhead(t,e,i,s,l,r))},drawArrowhead:function(t,e,i,s,l,n){"solid"==n?this.drawArrowhead2(t,e,i,s,l,n):"double"==n?(this.drawArrowhead2(t,e,i,s,l),this.drawArrowhead2(t,i,e,s,l)):"none"==n||this.drawArrowhead2(t,e,i,s,l)},drawArrowhead2:function(t,e,i,s,l,n){var r=e.clone().offset(-i.x,-i.y).setLength(7*l),e=(r.angle(),r.clone().rotate(25)),r=r.clone().rotate(-25),e=i.clone().offset(e.x,e.y),r=i.clone().offset(r.x,r.y);"solid"==n?JSDraw2.Drawer.drawTriangle(t,e,i,r,s):"top"==n?JSDraw2.Drawer.drawLine(t,e,i,s,l):("bottom"==n||JSDraw2.Drawer.drawLine(t,e,i,s,l),JSDraw2.Drawer.drawLine(t,r,i,s,l))},drawTriangle:function(t,e,i,s,l){e=t.createPath("").moveTo(e.x,e.y).lineTo(i.x,i.y).lineTo(s.x,s.y).lineTo(e.x,e.y);return e.setFill(l),e},drawBracket:function(t,e,i,s,l){var n=3*s,r=s;switch(l){case"round":this.drawCurve(t,e.topleft(),e.bottomleft(),-30,.3,i,s),this.drawCurve(t,e.topright(),e.bottomright(),30,.3,i,s);break;case"curly":break;default:JSDraw2.Drawer.drawLine(t,e.topleft(),e.topleft().offset(n,0),i,r),JSDraw2.Drawer.drawLine(t,e.topleft(),e.bottomleft(),i,r),JSDraw2.Drawer.drawLine(t,e.bottomleft(),e.bottomleft().offset(n,0),i,r),JSDraw2.Drawer.drawLine(t,e.topright(),e.topright().offset(-n,0),i,r),JSDraw2.Drawer.drawLine(t,e.topright(),e.bottomright(),i,r),JSDraw2.Drawer.drawLine(t,e.bottomright(),e.bottomright().offset(-n,0),i,r)}},drawDoubleArrow:function(t,e,i,s){this.drawLine(t,e.topleft(),e.topright(),i,s),this.drawArrow(t,e.topleft(),e.bottomleft(),i,s),this.drawArrow(t,e.topright(),e.bottomright(),i,s)},drawLabel:function(t,e,i,s,l,n,r,o,a){var h,u=l+2;n&&(h=new JSDraw2.Rect(e.x-u/2,e.y-u/2,u,u),t.createRect({x:h.left,y:h.top,width:h.width,height:h.height}).setFill(1==n?"#fff":n));o=e.x+(null==o?0:o),e=e.y+u/2-2;"start-anchor"==r&&(r="start",o-=.4*l),"end-anchor"==r&&(r="end",o+=.4*l);var u={x:o,y:e,text:i,align:null==r?"middle":r},c=null;return"canvas"==dojox.gfx.renderer?((c=t.createText(u)).shape.fontStyle="bold "+(l<this.kMinFontSize?this.kMinFontSize:l)+"px Arial",c.shape.fillStyle=s,c.shape.align="center",c.mwidth=this.getTextWidth(t,c),c.getTextWidth=function(){return c.mwidth}):(c=t.createText(u).setFont({family:"Arial",size:(l<this.kMinFontSize?this.kMinFontSize:l)+"px",weight:"normal"}).setFill(s),0!=a&&c.setStroke(s)),/^[ ]+$/.test(i)?c._rect=new JSDraw2.Rect(o,e,i.length*l/2,l+4):c._rect=new JSDraw2.Rect(o,e,c.getTextWidth(),l+4),c._rect.top-=.8*c._rect.height,"end"==r&&(c._rect.left-=c._rect.width),c},drawText2:function(t,e,i,s,l,n){var r=l+2,o=null;return"canvas"==dojox.gfx.renderer?((o=t.createText({x:e.x,y:e.y+r/2-2,text:i})).shape.fontStyle="bold "+(l<this.kMinFontSize?this.kMinFontSize:l)+"px Arial",o.shape.fillStyle=s,o.shape.align="center",o.mwidth=this.getTextWidth(t,o),o.getTextWidth=function(){return o.mwidth}):o=t.createText({x:e.x,y:e.y+r/2-2,text:i,align:"middle"}).setFont({family:"Arial",size:(l<this.kMinFontSize?this.kMinFontSize:l)+"px",weight:"normal"}).setFill(s),null!=n&&o.setTransform([dojox.gfx.matrix.rotateAt(n,e.x,e.y)]),o},drawText:function(t,e,i,s,l,n,r){null==n&&(n="left");var o,a=null;return"canvas"==dojox.gfx.renderer?((a=t.createText({x:e.x,y:e.y+l+2,text:i})).shape.fontStyle=(l<this.kMinFontSize?this.kMinFontSize:l)+"px Arial",a.shape.fillStyle=s,a.shape.align=n,a.mwidth=this.getTextWidth(t,a),a.getTextWidth=function(){return a.mwidth}):(o={family:"Arial",size:(l<this.kMinFontSize?this.kMinFontSize:l)+"px",weight:"normal"},r&&(o.style="italic"),a=t.createText({x:e.x,y:e.y+l+2,text:i,align:n}).setFont(o).setFill(s)),"right"==n&&(n=a.getTextWidth(),a.setTransform([dojox.gfx.matrix.translate(-n,0)])),a},getTextWidth:function(t,e){t=t.surface.rawNode.getContext("2d");t.save(),t.fillStyle=e.fillStyle,t.strokeStyle=e.fillStyle,t.font=e.fontStyle,t.textAlign="center";e=t.measureText(e.text).width/6;return t.restore(),e},drawBasis:function(t,e,i,s,l){this.drawLine(t,e,i,s,l);for(var n=new JSDraw2.Point(i.x-e.x,i.y-e.y).scale(1/6),r=e.clone().offset(.5*-n.x,.5*-n.y),o=0;o<5;++o){r.offset(n.x,n.y);var a=r.clone().offset(1.25*n.x,1.25*n.y);a.rotateAround(r,-45),this.drawLine(t,r,a,s,l)}},drawCurves:function(t,e,i,s,l){var n=t.createPath();n.moveTo(e.x,e.y);for(var t=e.distTo(i),r=Math.floor(t/l),o=new JSDraw2.Point(i.x-e.x,i.y-e.y).scale(1/r),a=new JSDraw2.Point(i.x-e.x,i.y-e.y).rotate(90).setLength(2*l),h=1;h<=r;h+=2){var u=e.clone().offset(o.x*h,o.y*h),c=u.clone().offset(o.x,o.y);(h-1)/2%2==1?u.offset(a.x,a.y):u.offset(-a.x,-a.y),n.qCurveTo(u.x,u.y,c.x,c.y)}n.setStroke({color:s,width:l})},drawLine:function(t,e,i,s,l,n,r){if(null==l&&(l=1),null==n||n<=1)return t.createLine({x1:e.x,y1:e.y,x2:i.x,y2:i.y}).setStroke({color:s,width:l,cap:null==r?"round":r});var o=e.distTo(i),a=Math.floor(o/n);a%2==0&&--a;for(var h=i.clone().offset(-e.x,-e.y).scale(1/a),u=h.clone().scale(.3),c=new JSDraw2.Point((i.x-e.x-h.x*a)/2,(i.y-e.y-h.y*a)/2),d=0;d<a;d+=2){var p=e.clone().offset(c.x+h.x*d+u.x,c.y+h.y*d+u.y),f=p.clone().offset(h.x-u.x,h.y-u.y);t.createLine({x1:p.x,y1:p.y,x2:f.x,y2:f.y}).setStroke({color:s,width:l,cap:null==r?"round":r})}},drawRect:function(t,e,i,s,l,n){if(null!=e&&!e.isEmpty()){e={x:e.left,y:e.top,width:e.width,height:e.height};return null!=l&&(e.r=l),null!=n&&(e.style=n),t.createRect(e).setStroke({color:i,width:s})}},drawDShape:function(t,e,i,s,l){var n=e.height/2,r=e.right()-n,o=e.center().y,s=t.createPath().moveTo({x:r,y:e.top}).arcTo(n,n,0,!1,!0,this._calcPoint(r,o,n,90)).arcTo(n,n,0,!1,!0,this._calcPoint(r,o,n,180)).lineTo({x:e.left,y:e.bottom()}).lineTo({x:e.left,y:e.top}).lineTo({x:r,y:e.top}).closePath().setStroke({color:i,width:s});return l&&s.setTransform([dojox.gfx.matrix.rotateAt(Math.PI,e.center().x,o)]),s},_calcPoint:function(t,e,i,s){return s=Math.PI/180*(360-s),{x:Math.round(i*-Math.sin(s)+t),y:Math.round(e-i*Math.cos(s))}},drawEllipse:function(t,e,i,s){var l=e.center();return t.createEllipse({cx:l.x,cy:l.y,rx:e.width/2,ry:e.height/2}).setStroke({color:i,width:s})},drawPie:function(t,i,s,l,e,n){function r(t,e){return t=Math.PI/180*(360-t),{x:Math.round(l*-Math.sin(t)+i),y:Math.round(s-l*Math.cos(t))}}return t.createPath().moveTo({x:i,y:s}).lineTo(r(e)).arcTo(l,l,0,!1,!0,r(n/2)).arcTo(l,l,0,!1,!0,r(n)).lineTo({x:i,y:s}).closePath().setFill("#535353")},drawDiamond:function(t,e,i,s){var l=e.center(),e=[{x:l.x,y:e.top},{x:e.right(),y:l.y},{x:l.x,y:e.bottom()},{x:e.left,y:l.y},{x:l.x,y:e.top}];return t.createPolyline(e).setStroke({color:i,width:s})},drawHexgon:function(t,e,i,s){var l=e.center(),n=new JSDraw2.Point(0,e.width/2);n.rotate(-30);l=[{x:e.right(),y:l.y},{x:l.x+n.x,y:l.y-n.y},{x:l.x-n.x,y:l.y-n.y},{x:e.left,y:l.y},{x:l.x-n.x,y:l.y+n.y},{x:l.x+n.x,y:l.y+n.y},{x:e.right(),y:l.y}];return t.createPolyline(l).setStroke({color:i,width:s})},drawPentagon:function(t,e,i,s){var l=e.center(),n=l.clone().offset(0,-e.width/2),r=n.clone().rotateAround(l,72),o=r.clone().rotateAround(l,72),e=o.clone().rotateAround(l,72),l=e.clone().rotateAround(l,72),n=[{x:n.x,y:n.y},{x:r.x,y:r.y},{x:o.x,y:o.y},{x:e.x,y:e.y},{x:l.x,y:l.y},{x:n.x,y:n.y}];return t.createPolyline(n).setStroke({color:i,width:s})}},JSDraw2.Language={current:null,use:function(t){},res:function(t){return t}},JSDraw2.IDGenerator=scil.extend(scil._base,{constructor:function(t){this.i=0<t?t:0,this.used=0==this.i?null:{}},next:function(t){if(null==this.used)return++this.i;if(0<t&&!this.used[t])return this.used[t]=!0,t;for(t=++this.i;this.used[t];)t=++this.i;return this.used[t]=!0,t}}),JSDraw2.Skin={jsdraw:null,jssdf:null,dialog:null,reset:function(){this.jsdraw={bkcolor:"#e1e1e1",bkimg:scil.Utils.imgSrc("img/hbg.gif"),toolbarbk:scil.Utils.imgSrc("img/toolbarbk.jpg"),hovercolor:"#eef",btnselcolor:"#bbf"},this.jssdf={bgcolor:"#eee",headerimg:scil.Utils.imgSrc("img/header-bg.gif"),headercolor:"#eee",rowcolor:"#f96",oddcolor:"",evencolor:"#eee",border:"solid 1px #ccc"},scilligence.apply(this.jssdf,this.jsdraw),this.dialog={bkimg:scil.Utils.imgSrc("img/dlgheader.gif"),bkcolor:"#6badf6",border:"1px solid #4f6d81"}},red:function(){this.jsdraw={bkcolor:"#ECCDDC",bkimg:scil.Utils.imgSrc("img/hbg-red.gif"),toolbarbk:scil.Utils.imgSrc("img/toolbarbk-red.jpg"),hovercolor:"#fCdDeC"},this.jssdf={bgcolor:"#F8CEE8",headerimg:scil.Utils.imgSrc("img/header-bgred.gif"),headercolor:"#F8CEE8",rowcolor:"#FfeEf8",oddcolor:"",evencolor:"#eee",border:"solid 1px #ccc"},scilligence.apply(this.jssdf,this.jsdraw),this.dialog={bkimg:scil.Utils.imgSrc("img/dlgheader-red.gif"),bkcolor:"#E7A6DF",border:"1px solid #4f6d81"}},green:function(){this.jsdraw={bkcolor:"#C7EEDF",bkimg:scil.Utils.imgSrc("img/hbg-green.gif"),toolbarbk:scil.Utils.imgSrc("img/toolbarbk-green.jpg"),hovercolor:"#d7fEeF"},this.jssdf={bgcolor:"#CCF8E8",headerimg:scil.Utils.imgSrc("img/header-bggreen.gif"),headercolor:"#CCF8E8",rowcolor:"#dCFff8",oddcolor:"",evencolor:"#eee",border:"solid 1px #ccc"},scilligence.apply(this.jssdf,this.jsdraw),this.dialog={bkimg:scil.Utils.imgSrc("img/dlgheader-green.gif"),bkcolor:"#95D09C",border:"1px solid #4f6d81"}},blue:function(){this.jsdraw={bkcolor:"#CDD0EC",bkimg:scil.Utils.imgSrc("img/hbg-blue.gif"),toolbarbk:scil.Utils.imgSrc("img/toolbarbk-blue.jpg"),hovercolor:"#dDe0fC"},this.jssdf={bgcolor:"#DCDFF6",headerimg:scil.Utils.imgSrc("img/header-bgblue.gif"),headercolor:"#DCDFF6",rowcolor:"#eCeFFf",oddcolor:"",evencolor:"#eee",border:"solid 1px #ccc"},scilligence.apply(this.jssdf,this.jsdraw),this.dialog={bkimg:scil.Utils.imgSrc("img/dlgheader-blue.gif"),bkcolor:"#8BB6CC",border:"1px solid #4f6d81"}},yellow:function(){this.jsdraw={bkcolor:"#ECECCD",bkimg:scil.Utils.imgSrc("img/hbg-yellow.gif"),toolbarbk:scil.Utils.imgSrc("img/toolbarbk-yellow.jpg"),hovercolor:"#fCfCdD"},this.jssdf={bgcolor:"#F4F4E1",headerimg:scil.Utils.imgSrc("img/header-bgyellow.gif"),headercolor:"#F4F4E1",rowcolor:"#F4F4B8",oddcolor:"",evencolor:"#eee",border:"solid 1px #ccc"},scilligence.apply(this.jssdf,this.jsdraw),this.dialog={bkimg:scil.Utils.imgSrc("img/dlgheader-yellow.gif"),bkcolor:"#C8BA8F",border:"1px solid #4f6d81"}},menu:{highlightcolor:"#c60",color:"blue"},form:{labelstyles:{backgroundColor:"#eef",border:"solid 1px #dde",textAlign:"left",verticalAlign:"top",whiteSpace:"nowrap"},fieldcolor:"blue",rowselectcolor:"#aaf"}},JSDraw2.Skin.reset(),JSDraw2.Editor=scilligence.extend(scilligence._base,{constructor:function(t,e){if(this.disableundo=JSDraw2.speedup.disableundo,this.T="DRAW",JSDraw2.Editor.COLORCURRENT=[0,255,0,.5],JSDraw2.Editor.COLORSELECTED=[0,0,255,.5],this.options=null==e?{}:e,(this.chiral=null)==JSDraw2.Editor._id&&(JSDraw2.Editor._id=0,JSDraw2.Editor._allitems={}),++JSDraw2.Editor._id,"string"==typeof t&&(t=dojo.byId(t)),null!=t){this.ptElement=null,this.connectHandlers=[],this.maintable=null,this.div=t,null!=this.div.id&&0!=this.div.id.length||(this.div.id="__JSDraw_"+JSDraw2.Editor._id),this.id=this.div.id,JSDraw2.Editor._allitems[this.id]=this,null==JSDraw2.defaultoptions&&(JSDraw2.defaultoptions={}),null==this.options.popup&&(this.options.popup=scil.Utils.isAttTrue(this.div,"popup")),null==this.options.viewonly&&(this.options.viewonly=scil.Utils.isAttTrue(this.div,"viewonly")),null==this.options.removehydrogens&&(this.options.removehydrogens=null!=JSDraw2.defaultoptions.removehydrogens?JSDraw2.defaultoptions.removehydrogens:scil.Utils.isAttTrue(this.div,"removehydrogens")),null==this.options.query&&(this.options.query=null!=JSDraw2.defaultoptions.query?JSDraw2.defaultoptions.query:!scil.Utils.isAttFalse(this.div,"query")),null==this.options.rxn&&(this.options.rxn=null!=JSDraw2.defaultoptions.rxn?JSDraw2.defaultoptions.rxn:!scil.Utils.isAttFalse(this.div,"rxn")),null==this.options.biology&&(this.options.biology=null!=JSDraw2.defaultoptions.biology?JSDraw2.defaultoptions.biology:!scil.Utils.isAttFalse(this.div,"biology")),null==this.options.sendquery&&(this.options.sendquery=null!=JSDraw2.defaultoptions.sendquery?JSDraw2.defaultoptions.sendquery:!scil.Utils.isAttFalse(this.div,"sendquery")),null==this.options.showtoolbar&&(this.options.showtoolbar=null!=JSDraw2.defaultoptions.showtoolbar?JSDraw2.defaultoptions.showtoolbar:!scil.Utils.isAttFalse(this.div,"showtoolbar")),null==this.options.showcustomtemplates&&(this.options.showcustomtemplates=null!=JSDraw2.defaultoptions.showcustomtemplates?JSDraw2.defaultoptions.showcustomtemplates:!scil.Utils.isAttFalse(this.div,"showcustomtemplates")),null==this.options.usechemdraw&&(this.options.usechemdraw=null!=JSDraw2.defaultoptions.usechemdraw?JSDraw2.defaultoptions.usechemdraw:scil.Utils.isAttTrue(this.div,"usechemdraw")),null==this.options.showcarbon&&(this.options.showcarbon=JSDraw2.defaultoptions.showcarbon),null==this.options.pastechemdraw&&(this.options.pastechemdraw=JSDraw2.defaultoptions.pastechemdraw),0<this.options.width&&(this.div.style.width=this.options.width+"px"),0<this.options.height&&(this.div.style.height=this.options.height+"px"),null==this.options.ondatachange&&(this.options.ondatachange=dojo.attr(this.div,"ondatachange")),null==this.options.data&&(this.options.data=dojo.attr(this.div,"data")),null==this.options.dataformat&&(this.options.dataformat=dojo.attr(this.div,"dataformat")),null==this.options.showimplicithydrogens&&(this.options.showimplicithydrogens=null!=JSDraw2.defaultoptions.showimplicithydrogens?JSDraw2.defaultoptions.showimplicithydrogens:!scil.Utils.isAttFalse(this.div,"showimplicithydrogens")),null==this.options.inktools&&(this.options.inktools=null!=JSDraw2.defaultoptions.inktools?JSDraw2.defaultoptions.inktools:!scil.Utils.isAttFalse(this.div,"inktools")),null==this.options.highlighterrors&&(this.options.highlighterrors=null!=JSDraw2.defaultoptions.highlighterrors?JSDraw2.defaultoptions.highlighterrors:!scil.Utils.isAttFalse(this.div,"highlighterrors")),null==this.options.skin&&(this.options.skin=null!=JSDraw2.defaultoptions.skin?JSDraw2.defaultoptions.skin:dojo.attr(this.div,"skin"),null==this.options.skin&&(this.options.skin="w8")),null==this.options.monocolor&&(this.options.monocolor=scil.Utils.isAttTrue(this.div,"monocolor")),null==this.options.fullscreen&&(this.options.fullscreen=null!=JSDraw2.defaultoptions.fullscreen?JSDraw2.defaultoptions.fullscreen:scil.Utils.isAttTrue(this.div,"fullscreen")),null==this.options.buttonshape&&(this.options.buttonshape=null!=JSDraw2.defaultoptions.buttonshape?JSDraw2.defaultoptions.buttonshape:dojo.attr(this.div,"buttonshape")),null!=this.options.buttonshape&&""!=this.options.buttonshape||(this.options.buttonshape=scil.Utils.isIE?"circle":"square"),"square"==this.options.buttonshape?this.options.buttonshape="btnrec":"circle"==this.options.buttonshape&&(this.options.buttonshape="btncir"),0<this.options.scale||(null!=JSDraw2.defaultoptions.scale?this.options.scale=JSDraw2.defaultoptions.scale:(n=dojo.attr(this.div,"scale"),isNaN(n)||(this.options.scale=parseFloat(n)))),this.options.btnsize=this.isSkinW8()?42:20*this.options.scale,null!=this.options.data||null!=(i=dojo.attr(this.div,"molfile"))&&(this.options.data=i,this.options.dataformat="molfile"),null!=this.options.data||null!=(s=dojo.attr(this.div,"rxnfile"))&&(this.options.data=s,this.options.dataformat="rxnfile"),"w8"==this.options.skin&&(JSDraw2.Skin.jsdraw={bkcolor:"#fff"}),this.movingresolution=0<this.options.movingresolution?this.options.movingresolution:6,this.bondlength=JSDraw2.Editor.BONDLENGTH,this.tor=JSDraw2.Editor.TOR,this.linewidth=JSDraw2.Editor.LINEWIDTH,this.fontsize=JSDraw2.Editor.FONTSIZE,this.angleStop=JSDraw2.Editor.ANGLESTOP;var i=scil.Utils.styleRect(this.div);if(this.dimension=new JSDraw2.Point(i.width,i.height),0<this.dimension.x||(this.dimension.x=0==this.div.offsetWidth?650:this.div.offsetWidth),0<this.dimension.y||(this.dimension.y=0==this.div.offsetHeight?320:this.div.offsetHeight),this.div.style.textAlign="left",this.div.style.cursor="default",this.div.style.width=this.dimension.x+"px",this.div.style.height=this.dimension.y+"px",null!=scil.helm&&0!=this.options.helm&&(this.helm=new scil.helm.Plugin(this)),this.m=new JSDraw2.Mol(this.options.showimplicithydrogens),this.status=null,this.modified=!1,this.toolbar=null,this.touching=null,this.start=null,this.lastmove=null,this.end=null,this.curObject=null,this.curButton=null,this.movingClone=null,this.resizing=null,this.texteditor={input:null,text:null,atom:null},this.rotating=null,this.mousedownPoint=null,this._lastMousedownTm=null,this.lassolast=null,this.chaintool=null,this.activated=!1,this.ink=null,JSDraw2.Security._check(),this.undocapacity=10,this._undostack=new JSDraw2.Stack(this.undocapacity),this._redostack=new JSDraw2.Stack(this.undocapacity),!this.setMol(this.options.data))switch((this.options.dataformat+"").toLowerCase()){case"mol":case"molfile":this.setMolfile(this.options.data);break;case"molbase64":this.setMolbase64(this.options.data);break;case"rxn":case"rxnfile":this.setRxnfile(this.options.data);break;case"rxnbase64":this.setRxnbase64(this.options.data);break;case"jdx":this.setJdx(this.options.data);break;case"html":case"xml":case"jsdraw":this.setXml(null==this.options.data?this.div:this.options.data);break;case"helm":this.setHelm(null==this.options.data?this.div:this.options.data);break;case"molurl":this.download(this.options.data,"mol");break;case"rxnurl":this.download(this.options.data,"rxn");break;case"xmlurl":this.download(this.options.data,"xml");break;case"jdxurl":this.download(this.options.data,"jdx");break;default:this.setXml(this.div)}var s=!this.options.popup&&!this.options.viewonly;this.div.innerHTML="",null!=this.options.background?this.div.style.background=this.options.background:this.div.style.background="#fff",s&&this.options.showtoolbar&&(this.isSkinW8()?this.dimension.y-=70:(this.dimension.x-=28,this.dimension.y-=24)),dojo.style(this.div,{width:this.dimension.x+"px",height:this.dimension.y+"px"});var l=this;this.options.viewonly&&1!=this.options.popup||scil.Utils.serviceAvailable()&&null!=scil.DnDFile&&new scil.DnDFile(this.div,{url:JSDrawServices.url+"?cmd=openjsd",onupload:function(t){if(!scil.Utils.isChemFile(scil.Utils.getFileExt(t.filename)))return!1},callback:function(t){l.activate(!0),JSDraw2.JSDrawIO.jsdFileOpen2(l,t)}}),s?(this.toolbar=new JSDraw2.Toolbar(this),this.toolbar.createToolbars(this.div),this.options.showtoolbar||this.toolbar.show(!1),window.navigator.msPointerEnabled&&(dojo.connect(this.div,"onselectstart",function(t){t.preventDefault()}),dojo.connect(this.div,"onMSPointerDown",function(t){null!=(t=scilligence.mstouch.down(t))&&1<t.touches.length?l.touchStart(t):l.resetGesture()}),dojo.connect(this.div,"onMSPointerMove",function(t){null!=(t=scilligence.mstouch.move(t))&&1<t.touches.length&&l.touchMove(t)}),dojo.connect(this.div,"onMSPointerUp",function(t){null!=(t=scilligence.mstouch.up(t))&&1<t.touches.length&&l.touchEnd(t)}),dojo.connect(this.div,"onMSGestureHold",function(t){l.showContextMenu(t),t.preventDefault()})),scil.Utils.isTouch?(this.activate(!1,!1),this.connectHandlers.push(dojo.connect(document.body,"ontouchstart",function(t){return l.bodyTouchStart(t)})),this.connectHandlers.push(dojo.connect(this.maintable,"onclick",function(t){return l.touchClick(t)})),this.connectHandlers.push(dojo.connect(this.div,"ontouchstart",function(t){return l.touchStart(t)})),this.connectHandlers.push(dojo.connect(this.div,"ontouchmove",function(t){return l.touchMove(t)})),this.connectHandlers.push(dojo.connect(this.div,"ontouchend",function(t){return l.touchEnd(t)}))):(this.activate(!1,!1),this.connectHandlers.push(dojo.connect(document,"onmousedown",function(t){return l.bodyMouseDown(t)})),this.connectHandlers.push(dojo.connect(document,"onkeydown",function(t){l.keydown(t)})),this.connectHandlers.push(dojo.connect(this.div,"onmousedown",function(t){l.mousedown(t)})),this.connectHandlers.push(dojo.connect(this.div,"onmousemove",function(t){l.mousemove(t)})),this.connectHandlers.push(dojo.connect(this.div,"onmouseup",function(t){l.mouseup(t)})),scil.Utils.isFirefox?this.connectHandlers.push(dojo.connect(this.div,"onwheel",function(t){l.mousewheel(t)})):this.connectHandlers.push(dojo.connect(this.div,"onmousewheel",function(t){l.mousewheel(t)}))),dojo.attr(this.div,"__ajaxform","1")):(this.options.popup&&(scil.Utils.isTouch?this.connectHandlers.push(dojo.connect(this.div,"ontouchstart",function(t){if(scil.Utils.isTouchDblClick(t))return l.dblclick(),t.preventDefault(),!1})):this.connectHandlers.push(dojo.connect(this.div,"ondblclick",function(t){l.dblclick()}))),scil.Utils.isTouch||(this.connectHandlers.push(dojo.connect(this.div,"onmousedown",function(t){l.mousedown(t,!0)})),this.connectHandlers.push(dojo.connect(this.div,"onmousemove",function(t){l.mousemove(t,!0)})),this.connectHandlers.push(dojo.connect(this.div,"onmouseup",function(t){l.mouseup(t,!0)})),scil.Utils.isFirefox?this.connectHandlers.push(dojo.connect(this.div,"DOMMouseScroll",function(t){l.mousewheel(t)})):this.connectHandlers.push(dojo.connect(this.div,"onmousewheel",function(t){l.mousewheel(t,!0)})))),this.connectHandlers.push(dojo.connect(this.div,"onresize",function(){l._clearing||l.onResize()})),dojo.style(this.div,{userSelect:"none",oUserSelect:"none",MozUserSelect:"none",khtmlUserSelect:"none",webkitUserSelect:"none"});var n,i=null;scil.Utils.isIE&&(scil.Utils.isIE<9||"svg"!=dojox.gfx.renderer)&&(i=this._showAllParents(this.div)),this.surface=dojox.gfx.createSurface(this.div,this.dimension.x,this.dimension.y),null!=i&&this._hideElements(i),null==scil.Utils.isSilverlight&&(scil.Utils.isSilverlight=null!=this.div.firstChild&&"application/x-silverlight"==this.div.firstChild.type),scil.Utils.isSilverlight&&(this.options.popup?(this.div.style.position="relative",i=parseInt(this.div.zIndex+""),isNaN(i)&&(i=0),scil.Utils.createElement(this.div,"div",null,{position:"absolute",left:0,top:0,background:"white",filter:"alpha(opacity=1)",width:this.dimension.x+"px",height:this.dimension.y+"px",zIndex:i+1})):s&&this.surface.connect("onkeydown",function(t){l.keydown(t)})),0!=this.options.showcontextmenu&&scil.Utils.disableContextMenu(this.div),this.modified=!1,0<this.options.scale&&(1!=(n=30/this.bondlength*this.options.scale)&&this.scale(this.options.scale),this.fitToWindow()),this.redraw(),this.loaded=!0,s?(this.options.tlcplate?this.doCmd("tlc"):this.doCmd("select"),this.options.appmode||scil.Utils.isIE||scil.connect(document,"onpaste",function(t){l.doPaste(t)&&t.preventDefault()})):this.doCmd("moveview")}},doPaste:function(t){if(!this.activated)return!1;if(null!=this.texteditor.ed&&null!=this.texteditor.ed.input&&"none"!=this.texteditor.ed.input.style.display)return!1;var e=scil.Utils.getMaxZindex();if(scil.Utils.getZindex(this.div)<e)return!1;var i=t;null!=i&&null!=i.clipboardData&&(t=i.clipboardData.getData("text/plain"));var s,e=null;return scil.Utils.isNullOrEmpty(t)||((e=new JSDraw2.Mol).setXml(t),e.isEmpty()&&(e=null)),null==e&&(e=JSDraw2.Editor.getClipboard()),null==e?(null!=i&&null!=i.clipboardData&&null!=JSDrawServices&&null!=JSDrawServices.url&&(i=i.clipboardData.getData("text/rtf"),scil.Utils.isNullOrEmpty(i)||(s=this,scil.Utils.ajax(JSDrawServices.url+"?cmd=paste.rtf2jsdraw",function(t){var e;null==t&&null==t.jsdraw||null!=(e=new JSDraw2.Mol).setXml(t.jsdraw)&&s.pasteMol(e)&&s.refresh()},{rtf:i}))),!1):(this.pasteMol(e)&&this.refresh(),!0)},_showAllParents:function(t){for(var e={display:[],visibility:[],visvalues:[]};null!=t&&null!=t.style;)"none"==t.style.display&&(e.display.push(t),t.style.display=""),""!=t.style.visibility&&null!=t.style.visibility&&"visible"!=t.style.visibility&&(e.visibility.push(t),e.visvalues.push(t.style.visibility),t.style.visibility="visible"),t=t.parentNode;return e},_hideElements:function(t){if(null!=t){for(var e=0;e<t.display.length;++e)t.display[e].style.display="none";for(e=0;e<t.visibility.length;++e)t.visibility[e].style.visibility=t.visvalues[e]}},reset:function(){this.clear(!0),this._undostack.clear(),this._redostack.clear(),this.options.tlcplate?this.doCmd("tlc"):this.doCmd("select")},pushundo:function(t,e){this.disableundo||null==t&&null!=e&&this.lastaction==e||(this.lastaction=e,this._redostack.clear(),this._undostack.push(null==t?this.clone():t))},undo:function(){if(!this.disableundo){var t=this._undostack.pop();return null==t?!1:(this._redostack.push(this.clone()),this.restoreClone(t),this.setModified(!0),!0)}},restoreClone:function(t){this._setmol(t.mol),this.resetScale(t)},redo:function(){if(!this.disableundo){var t=this._redostack.pop();return null==t?!1:(this._undostack.push(this.clone()),this._setmol(t.mol),this.resetScale(t),this.setModified(!0),!0)}},copy:function(t){return null==t&&((t=this.m.clone(!0)).bondlength=this.bondlength),JSDraw2.Editor.setClipboard(t,this.bondlength),null!=scil.Clipboard&&null!=t&&!t.isEmpty()&&(scil.Clipboard.copy(t.getXml(null,null,null,null,this.bondlength)),!0)},cut:function(){return!!this.copy()&&(this.pushundo(),0<this.delSelected())},paste:function(t){var e=JSDraw2.Editor.getClipboard();return this.pasteMol(e)},pasteMol:function(t,e,i){if(null==t)return!1;"string"==typeof t&&((l=new JSDraw2.Mol(this.options.showimplicithydrogens)).setMolfile(t),t=l);var s=this.m.isEmpty();this.pushundo(),1==i&&this.clear(null,!0);var l=null;0<t.bondlength?(l=this.bondlength,t.scale(this.bondlength/t.bondlength)):(0<(n=t.medBondLength())||(n=1.56),0<(l=this.m.medBondLength())||(l=this.bondlength),t.scale(l/n)),null==e?(t.moveCenter(this.dimension.x,this.dimension.y),t.offset(10,10)):(r=t.center(),t.offset(e.x-r.x,e.y-r.y)),t.showimplicithydrogens=this.options.showimplicithydrogens,this.m.setSelected(),t.setSelected(!0),t.calcHCount(!0);var n=null,e=this.m.parseRxn(!0),r=t.parseRxn(!0);if("reactant"!=i&&"product"!=i||null==r||null!=r.arrow?null!=e&&(0<e.reactants.length||0<e.products.length)&&(null!=e.arrow?null==r.arrow&&(0==e.reactants.length?e.reactants=r.reactants:scil.Utils.mergeArray(e.products,r.reactants),n=e):null!=r.arrow&&(null==e.arrow&&(0==r.reactants.length?r.reactants=e.reactants:scil.Utils.mergeArray(r.products,e.reactants)),n=r)):("reactant"==i?scil.Utils.mergeArray(e.reactants,r.reactants):scil.Utils.mergeArray(e.products,r.reactants),n=e),null!=n)this.m.setRxn(n,l),this.fitToWindow();else{for(var o=[],a=t.graphics.length-1;0<=a;--a){var h=JSDraw2.TLC.cast(t.graphics[a]);null!=h&&(t.graphics.splice(a,1),o.splice(0,0,h))}this.m.mergeMol(t);for(a=0;a<o.length;++a)this.addTlcPlate(o[a]);null!=t.chiral&&(this.m.chiral=t.chiral),s&&this.fitToWindow()}return this.setModified(!0),!0},resetScale:function(t){this.bondlength=null==t?JSDraw2.Editor.BONDLENGTH:t.bondlength,this.tor=null==t?JSDraw2.Editor.TOR:t.tor,this.linewidth=null==t?JSDraw2.Editor.LINEWIDTH:t.linewidth,this.fontsize=null==t?JSDraw2.Editor.FONTSIZE:t.fontsize,this.angleStop=null==t?JSDraw2.Editor.ANGLESTOP:t.angleStop},clone:function(){return{mol:this.m.clone(),bondlength:this.bondlength,tor:this.tor,linewidth:this.linewidth,fontsize:this.fontsize,angleStop:this.angleStop}},showTextEditor:function(t,e,i){var s=this.texteditor.text=JSDraw2.Text.cast(t);if(null==s||!s.readonly){if(null!=this.texteditor.hidetime){var l=this.texteditor.hidetime;if(this.texteditor.hidetime=null,(new Date).getTime()-l<500)return}var n=this.texteditor.atom=JSDraw2.Atom.cast(t),r=JSDraw2.Text.cast(t),l=this.texteditor.shape=JSDraw2.Shape.cast(t),t=null!=r&&null!=r.anchors&&1==r.anchors.length?JSDraw2.Bracket.cast(r.anchors[0]):null;null!=n?(e.x-=6*this.bondlength/30,e.y-=9*this.bondlength/30):null!=l&&(e.x=l._rect.left+l._rect.width/10,e.y=l._rect.center().y-9*this.bondlength/30);var o=this;null==this.texteditor.ed&&(a=scil.Utils.createElement(document.body,"input"),this.texteditor.ed=new scil.DropdownInput(a,{onclickitem:function(t){return o.clickTextItem(t)}}),dojo.style(this.texteditor.ed.input,{position:"absolute",display:"none",zIndex:999}),this.connectHandlers.push(dojo.connect(this.texteditor.ed.input,"onkeydown",function(t){return o.txtKeypress(t)})));var a,h=this.texteditor.ed.options;null!=n?(a=(a=null)!=n.bio&&null!=this.helm?scil.helm.Monomers.getMonomerList(n):null!=JSDraw2.defaultoptions.atomlist?JSDraw2.defaultoptions.atomlist:JSDraw2.PT.getCommonUsedElements("list"),this.texteditor.ed.setItems(a),h.onSetValue=function(t,e){t.value=e},h.minautowidth=0<JSDraw2.defaultoptions.minautowidth1?JSDraw2.defaultoptions.minautowidth1:100,null!=n.bio?h.onFilter=null:h.onFilter=function(t){return o.filterAtomType(t)}):null!=l?this.texteditor.ed.setItems(null):null!=t?"BRACKET_TYPE"==r.fieldtype?(this.texteditor.ed.setItems(null==JSDraw2.SGroup?null:JSDraw2.SGroup.getDisplayTypes()),h.onSetValue=function(t,e){var i,s="";!scil.Utils.endswith(e,")")||0<(i=e.lastIndexOf("("))&&(s=e.substr(i+1,e.length-i-2)),t.value=s},h.minautowidth=0<JSDraw2.defaultoptions.minautowidth2?JSDraw2.defaultoptions.minautowidth2:150,h.onFilter=null):"MOL_TYPE"==r.fieldtype&&(this.texteditor.ed.setItems(JSDraw2.MOLECULETYPES),h.onSetValue=function(t,e){scil.Utils.isNullOrEmpty(e)?this.mol.delGraphics(r):t.value=e},h.minautowidth=0<JSDraw2.defaultoptions.minautowidth2?JSDraw2.defaultoptions.minautowidth2:150,h.onFilter=null):(this.texteditor.ed.setItems(null!=JSDraw2.defaultoptions.textlist?JSDraw2.defaultoptions.textlist:JSDraw2.TEXTKEYWORDS),h.onSetValue=function(t,e){0<=scil.Utils.indexOf(h.items,e)?t.value+=e:t.value=e},h.minautowidth=0<JSDraw2.defaultoptions.minautowidth3?JSDraw2.defaultoptions.minautowidth3:300,h.autosuggest=this.options.reagentsuggest,h.onFilter=null!=h.autosuggest?null:function(){});t=scil.Utils.getZindex(this.div);this.texteditor.ed.input.style.zIndex=0<t?t+1:1,null!=s?e=new JSDraw2.Point(s._rect.left,s._rect.top):e.offset(-2,-2);t=scil.Utils.getOffset(this.div,!1);dojo.style(this.texteditor.ed.input,{fontSize:this.fontsize+"px"}),dojo.style(this.texteditor.ed.input,{left:e.x+t.x+"px",top:e.y+t.y+"px",display:""});t=!0;null!=s?this.texteditor.ed.input.value=null==i?s.text:i:null!=n?(s=n.getLabel(),0<n.charge?1<n.charge?s+=n.charge:s+="+":n.charge<0&&(1<n.charge?s+=n.charge:s+="-"),this.texteditor.ed.input.value=s):null!=l?this.texteditor.ed.input.value=l.text:null!=i&&(this.texteditor.ed.input.value=i,t=!1),this.txtAutosize(),t&&this.texteditor.ed.input.select(),this.texteditor.ed.input.style.display="",this.texteditor.ed.input.focus(),this.texteditor.showtime=(new Date).getTime()}},filterAtomType:function(t){if(null!=this.texteditor.atom)return JSDraw2.SuperAtoms.filter(t,0<JSDraw2.defaultoptions.suggestcount?JSDraw2.defaultoptions.suggestcount:10)},createImageTo:function(e){var i;scil.Utils.serviceAvailable()&&null!=e&&("string"==typeof e&&(e=scil.byId(e)),i=this.getXml(),scil.Utils.ajax(JSDrawServices.url+"?cmd=jsdraw2img",function(t){scil.Utils.createElement(e,"img",null,null,{src:t.src,jsdraw:JSDraw2.Base64.encode(i)})},{jsdraw:i}))},clickTextItem:function(t){var e;null!=this.texteditor.atom?"..."==t?(this.hideTextEditor(!0),this.m.setSelected(!1),this.texteditor.atom.selected=!0,this.refresh(!1),(e=this).showPT(function(t){e.menuSetAtomType2(t)})):this.hideTextEditor():this.txtAutosize()},insertSymbol:function(t){if(null==this.texteditor.ed||"none"==this.texteditor.ed.input.style.display)return!1;this.texteditor.ed.input.focus();var e=JSDraw2.Symbol.getCaretPosition(this.texteditor.ed.input),i=this.texteditor.ed.input.value;return 0<e&&e<i.length?(this.texteditor.ed.input.value=i.substr(0,e)+t+i.substr(e),++e,JSDraw2.Symbol.setCaretPosition(this.texteditor.ed.input,e)):this.texteditor.ed.input.value+=t,this.txtAutosize(),!1},hideTextEditor:function(t){if(null!=this.texteditor.ed&&"none"!=this.texteditor.ed.input.style.display){if(null!=this.texteditor.showtime){var e=this.texteditor.showtime;if(this.texteditor.showtime=null,(new Date).getTime()-e<500)return}this.texteditor.ed.hide(),this.texteditor.ed.input.style.display="none",this.texteditor.ed.input.style.display="none",this.texteditor.hidetime=(new Date).getTime();var i,s,e=scil.Utils.trim(this.texteditor.ed.input.value);this.texteditor.ed.input.value="",1!=t&&(null!=this.options.onvalidatetext&&0==this.options.onvalidatetext(e,this.texteditor,this)||(null!=JSDraw2.Symbol&&JSDraw2.Symbol.hide(),null!=this.texteditor.atom?(""==e&&(e="C"),s=this.clone(),null!=this.texteditor.atom.bio?null!=this.helm&&scil.helm.isHelmNode(this.texteditor.atom)&&(i=this.helm.setNodeTypeFromGui(this.texteditor.atom,e)):(e=JSDraw2.FormulaParser.stripHs(e),i=this.m.setAtomAlias(this.texteditor.atom,e)||this.m.setAtomType(this.texteditor.atom,e,!0)),i&&(this.pushundo(s),this.refresh(!0))):null!=this.texteditor.shape?this.texteditor.shape.text!=e&&(this.pushundo(),this.texteditor.shape.text=e,this.refresh(!0)):null==this.texteditor.text?0!=e.length&&(i=scil.Utils.getOffset(this.div,!1),(s=scil.Utils.styleRect(this.texteditor.ed.input)).offset(-i.x,-i.y),s=new JSDraw2.Text(s,e),this.pushundo(),this.m.addGraphics(s),this.refresh(!0)):e!=this.texteditor.text.text&&(this.pushundo(),0==e.length?this.texteditor.text._parent.delObject(this.texteditor.text):this.texteditor.text.text=e,"BRACKET_TYPE"==this.texteditor.text.fieldtype&&1==this.texteditor.text.anchors.length&&null!=JSDraw2.Bracket.cast(this.texteditor.text.anchors[0])&&(scil.Utils.isNumber(e)?this.texteditor.text.anchors[0].type="mul":this.texteditor.text.anchors[0].type=e),this.texteditor.text=null,this.refresh(!0))))}},showTemplatesDlg:function(){JSDraw2.CustomTemplates.show(!1,this)},showSymbolDlg:function(){var t=null==this.texteditor||null==this.texteditor.ed?null:this.texteditor.ed.input,t=null==t||"none"==t.style.display?null:{x:t.offsetLeft,y:t.offsetTop+t.offsetHeight+5},e=this;JSDraw2.Symbol.show(!1,function(t){return e.insertSymbol(t)},t)},txtKeypress:function(t){return 40!=t.keyCode&&38!=t.keyCode||!t.ctrlKey&&!t.metaKey||null==JSDraw2.Symbol?27==t.keyCode||13==t.keyCode?(this.hideTextEditor(27==t.keyCode),t.time2=903,t.preventDefault(),!1):void this.txtAutosize():(40==t.keyCode?this.showSymbolDlg():JSDraw2.Symbol.hide(),t.preventDefault(),!1)},txtAutosize:function(){var t=scil.Utils.textWidth(this.texteditor.ed.input.value)*this.fontsize*.6+3*this.fontsize;this.texteditor.ed.input.style.width=(t<100?100:t)+"px",this.texteditor.ed.updateDropdownSize()},_setmol:function(t){this.m=t,this.m.showimplicithydrogens=this.options.showimplicithydrogens,this.start=null,this.end=null,this.status=null,this.curObject=null},scale:function(t,e){t<=0||1==t||(this.bondlength*t<JSDraw2.speedup.minbondlength&&(t=JSDraw2.speedup.minbondlength/this.bondlength),this.m.scale(t,e),this.bondlength*=t,this.tor*=t,this.linewidth*=t,this.fontsize*=t,null==e&&this.moveCenter())},setModified:function(f){if(this.modified=f,0!=f&&(null!=this.options.ondatachange&&this.loaded))if("function"==typeof this.options.ondatachange)this.options.ondatachange(this);else try{eval(this.options.ondatachange)(this)}catch(e){}},refresh:function(t){this.m.stats=null,1!=t&&0!=t||this.setModified(t),this.redraw()},calcTextRect:function(){var t;null==this.surface||scil.Utils.isIE8Lower&&null==this.surface.rawNode||(t=this.createGroup(),this.m.draw(t,this.linewidth,this.fontsize,!0,null,null,!0),this.surface.remove(t))},createGroup:function(t){t=(null==t?this.surface:t).createGroup();return"svg"==dojox.gfx.renderer&&t.rawNode.setAttribute("__surface_parentid",this.id),t},moveview:function(t){this.viewoffset=t,null!=this.viewoffset?this.surface.rootgroup.setTransform([dojox.gfx.matrix.translate(this.viewoffset.x,this.viewoffset.y)]):this.surface.rootgroup.setTransform([dojox.gfx.matrix.translate(0,0)])},redraw:function(t){if(!(null==this.surface||scil.Utils.isIE8Lower&&null==this.surface.rawNode)){null==this.surface.rootgroup&&(this.surface.rootgroup=this.createGroup(),null!=JSDraw2.Security.error&&this.surface.createText({x:5,y:25,text:JSDraw2.Security.error,align:"start"}).setFont({family:"Arial",size:"20px",weight:"normal"}).setFill("#ffe0e0")),null!=this.viewoffset?this.surface.rootgroup.setTransform([dojox.gfx.matrix.translate(this.viewoffset.x,this.viewoffset.y)]):this.surface.rootgroup.setTransform(null),this._clearing=!0,t?null!=this.surface.extra&&(this.surface.extra.clear(),this.surface.extra.lasso=null):(this.surface.rootgroup.clear(),this.surface.extra=null,this._clearing=!1,(i=this.createGroup(this.surface.rootgroup)).monocolor=this.options.monocolor||JSDraw2.defaultoptions.monocolor,this.simpledraw=this.fontsize<=JSDraw2.speedup.fontsize,this.updateGroupRect(),this.m.draw(i,this.linewidth,this.fontsize,null,this.dimension,this.options.highlighterrors,this.options.showcarbon,this.simpledraw));var e=this.getCmd();null==this.surface.extra&&(this.surface.extra=this.createGroup(this.surface.rootgroup));var i,s=this.surface.extra;if(null!=this.curObject&&this.curObject.drawCur(s,this.fontsize/2+1,JSDraw2.Editor.COLORCURRENT,this.m,e),null!=this.start&&null!=this.end)switch(e){case"arrow":null!=this.arrowtool&&"rejector"==this.arrowtool.connector?JSDraw2.Drawer.drawArrow(s,this.start,this.end,"gray",this.linewidth,2*this.linewidth):JSDraw2.Drawer.drawArrow(s,this.start,this.end,"gray",this.linewidth);break;case"curve":JSDraw2.Drawer.drawCurveArrow(s,this.start,this.end,null,null,"gray",this.linewidth/2);break;case"rectangle":JSDraw2.Drawer.drawRect(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth/2,5);break;case"assaycurve":case"spectrum":JSDraw2.Drawer.drawRect(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth/4);break;case"ellipse":JSDraw2.Drawer.drawEllipse(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth/2);break;case"diamond":JSDraw2.Drawer.drawDiamond(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth/2);break;case"dreversed":JSDraw2.Drawer.drawDShape(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth/2,!0);break;case"dshape":JSDraw2.Drawer.drawDShape(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth/2);break;case"doublearrow":JSDraw2.Drawer.drawDoubleArrow(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth);break;case"tlc":case"electrophoresis":null==this.movingClone&&new JSDraw2.TLC.create(e,this.start,this.end,this.fontsize/2).draw(s,this.linewidth,null,this.fontsize);break;case"select":case"lasso":case"selfrag":case"zoombox":null==this.movingClone&&JSDraw2.Drawer.drawRect(s,(new JSDraw2.Rect).set(this.start,this.end),"#aaaaff",1);break;case"bracket":JSDraw2.Drawer.drawBracket(s,(new JSDraw2.Rect).set(this.start,this.end),"gray",this.linewidth);break;case"chain":if(null!=this.chaintool)for(var l=this.chaintool.points,n=1;n<l.length;++n)JSDraw2.Drawer.drawLine(s,l[n-1],l[n],"gray",this.linewidth);scil.Utils.isIE&&scil.Utils.isIE<9&&this.options.appmode||JSDraw2.Drawer.drawText(s,l[l.length-1],l.length-1,"gray",this.fontsize);break;default:"sgroup"==e?JSDraw2.Drawer.drawArrow(s,this.start,this.end,"red",this.linewidth/2):"rotate"!=e&&"eraser"!=e&&"plus"!=e&&"rxnmap"!=e&&"text"!=e&&"undo"!=e&&"redo"!=e&&"zoomin"!=e&&"zoomout"!=e&&JSDraw2.Drawer.drawLine(s,this.start,this.end,"gray",this.linewidth)}null!=this.status&&0<this.status.length&&(i=this.dimension.y-10,s.createText({x:5,y:i,text:this.status,align:"bottom"}).setFont({family:"Arial",size:"14px",weight:"normal"}).setFill("#000"))}},fitToWindow:function(t){var e,i=this.m.rect();null!=i&&(null==t&&(t=JSDraw2.Editor.BONDLENGTH,0<this.options.scale&&(t*=this.options.scale)),i.inflate(this.bondlength,this.bondlength),e=i.width/this.dimension.x,i=i.height/this.dimension.y,e=0==e?i:0==i?e:Math.max(i,e),0<t&&this.bondlength/e>t&&(e=this.bondlength/t),1==e?this.moveCenter():this.scale(1/e))},moveCenter:function(){this.m.moveCenter(this.dimension.x,this.dimension.y)},updateGroupRect:function(){for(var t=0;t<this.m.graphics.length;++t){var e=JSDraw2.Group.cast(this.m.graphics[t]);null!=e&&e._updateRect(this.m,this.bondlength)}},cleanupRxn:function(){var t=this.m.cleanupRxn(this.bondlength);return t&&this.fitToWindow(this.bondlength),t},setRxn:function(t,e,i,s){if(this.pushundo(),null!=i&&(this.bondlength=i),s){for(var l=0;l<t.reactants.length;++l)t.reactants[l].removeTextByFieldType("RXNLABEL");for(l=0;l<t.products.length;++l)t.products[l].removeTextByFieldType("RXNLABEL")}if(this.m.setRxn(t,this.bondlength),this.calcTextRect(),this.m._layoutRxn(t,this.bondlength),s){for(l=0;l<t.reactants.length;++l)this.m._addRxnLabel(t.reactants[l],this.bondlength/2);for(l=0;l<t.products.length;++l)this.m._addRxnLabel(t.products[l],this.bondlength/2)}this.fitToWindow(this.bondlength),0!=e&&this.redraw()},clear:function(t,e){var i=this.m.isEmpty();this.m.clear(),this.curObject=null,t&&this.redraw(),this.resetScale(),0<this.options.scale&&this.scale(this.options.scale),null!=this.ink&&this.ink.clear(),i||e&&null!=this.options.onClear&&this.options.onClear()},toggleAtom:function(t){return this.m.toggleAtom(t,this.simpledraw?JSDraw2.Editor.TOR:this.tor)},toggle:function(t){return this.m.toggle(t,this.simpledraw?JSDraw2.Editor.TOR:this.tor)},fixWedgeDir:function(t){var e=this.m.getNeighborAtoms(t.a1,t.a2),i=this.m.getNeighborAtoms(t.a2,t.a1);(0==e.length||1==e.length)&&e.length<i.length&&t.reverse()},getFragment:function(t){for(var e=this.m.splitFragments(),i=0;i<e.length;++i)if(e[i].containsAtom(t))return e[i];return null},getCenter:function(t){var e=0,i=0;if(null==t&&(t=this.m.atoms),0==t.length)return null;for(var s=0;s<t.length;++s){var l=t[s];e+=l.p.x,i+=l.p.y}return new JSDraw2.Point(e/t.length,i/t.length)},rotate:function(t,e,i){if(null==t&&(t=this.m.atoms),Math.abs(i)<.1||0==t.length)return!1;for(var s=0;s<t.length;++s)t[s].p.rotateAround(e,i);return!0},startResize:function(t,e,i,s){null==t.resize||null!=(s=t.cornerTest(e,this.tor,i,s))&&(this.resizing={corner:s,obj:t,start:e,list:[]},null!=(t=JSDraw2.Bracket.cast(t))&&(this.resizing.texts=t.getTexts(this.m)))},getConnectingAtomBonds:function(t){var e=[];if(null!=t&&0<t.length){var i=t[0]._parent;i.clearFlag();for(var s=0;s<t.length;++s)t[s].f=!0;for(s=0;s<i.bonds.length;++s){var l=i.bonds[s];l.a1.f!=l.a2.f&&e.push({a:l.a1.f?l.a1:l.a2,b:l})}}return e},mousewheel:function(t,e){var i,s;(this.activated||e)&&"moveview"==this.getCmd()&&(i=t.wheelDelta||-t.detail||(Math.abs(t.deltaY)>Math.abs(t.deltaX)?t.deltaY:t.deltaX),scil.Utils.isFirefox&&(i*=20),(0<i||i<0)&&(s=this.eventPoint(t),this.scale(1+i/500,s),e?this.redraw():(this.pushundo(null,"moveview"),this.refresh(!0))),scil.Utils.isFirefox&&(t.stopImmediatePropagation(),t.stopPropagation()),t.preventDefault())},mousedown:function(t,e){if(!this.activated)return this.mousedownPoint=new JSDraw2.Point(t.clientX,t.clientY),void(e&&0==t.button&&(this.start=this.eventPoint(t)));if((null==this.contextmenu||!this.contextmenu.hide())&&(JSDraw2.Menu.close(),this.holding.start(t,this),scil.Utils.isTouch||t.button==(scil.Utils.isIE8Lower?1:0))){this.start=null,this.end=null,this.movingClone=null,this.resizing=null,this.lassolast=null;var i=this.getCmd(),s=(new Date).getTime(),l=this._lastMousedownTm;if((this._lastMousedownTm=s)-l<JSDraw2.Editor.dblclickdelay&&("select"==i||"lasso"==i||"selfrag"==i))return null!=this.surface.extra&&(this.surface.extra.lasso=null),this.mousedblclick(t),void t.preventDefault();e=this.eventPoint(t);if("moveview"==i)return this.start=e,void(this.viewoffset=null);if(scil.Utils.startswith(i,"spot-"))this.start=e;else{if("inkred"==i||"inkblue"==i||"inkgreen"==i)return null==this.ink&&(this.surface.ink=this.createGroup(),this.ink=new JSDraw2.Ink(this.surface.ink)),void this.ink.start(i.substr(3),e);s=this.toggle(e);if("eraser"==i)return this.start=e,this.erasercache={count:0,cloned:this.clone(),singleton:!1},null!=s&&(null!=JSDraw2.TLC.cast(s)&&(s.cornerTest(e,this.tor,!1,"eraser"),null!=s.curspot&&(this.erasercache.singleton=!0)),this.delObject(s),++this.erasercache.count,this.redraw()),void(this.div.style.cursor="pointer");if(this.curObject=s,this.div.style.cursor="crosshair",null!=s&&("select"==i||"lasso"==i||"selfrag"==i||("tlc"==i||"electrophoresis"==i)&&null!=JSDraw2.TLC.cast(s))){if(s.selected&&null!=s.resize&&1==this.m.countSelected()&&this.startResize(s,e,t.ctrlKey||t.metaKey,i),null==this.resizing&&!s.selected){var n,l=null,r=null;if("selfrag"==i&&(l=JSDraw2.Atom.cast(s),h=JSDraw2.Bond.cast(s),r=JSDraw2.Group.cast(s),n=JSDraw2.Bracket.cast(s),null!=h&&(l=h.a1)),t.shiftKey||this.m.setSelected(!1),null!=l){if(null!=l){for(var o=l._parent.getFragment(l,l._parent),a=0;a<o.atoms.length;++a)o.atoms[a].selected=!0;for(a=0;a<o.bonds.length;++a)o.bonds[a].selected=!0}null!=this.options.onselectionchanged&&this.options.onselectionchanged(this),this.redraw()}else if(null!=r)for(a=0;a<r._parent.atoms.length;++a)r._parent.atoms[a].group==r&&(r._parent.atoms[a].selected=!0);else if(null!=n)for(a=0;a<n.atoms.length;++a)n.atoms[a].group==r&&(n.atoms[a].selected=!0);else s.selected=!0,null!=(h=JSDraw2.Bond.cast(s))?h.a1.selected=h.a2.selected=!0:this.startResize(s,e,t.ctrlKey||t.metaKey,"tlc"==i||"electrophoresis"==i)}return("tlc"!=i&&"electrophoresis"!=i||null!=this.resizing)&&(this.start=e,this.movingClone=this.clone(),this.movingClone.startPt=e.clone(),this.div.style.cursor="moveview"),void("tlc"!=i&&"electrophoresis"!=i||this.redraw())}var h=JSDraw2.Atom.cast(s);if(null!=h&&(e.x=h.p.x,e.y=h.p.y,e.atom=h),this.lastmove=this.start=e,null==this.start.tm&&(this.start.tm=(new Date).getTime()),"lasso"==i&&null==s)return!t.shiftKey&&0<this.m.setSelected(!1)&&this.redraw(),void(this.lassolast=e);if("chain"!=i){if("rotate"==i&&null==h&&!this.m.isEmpty()){for(var u,c=this.m.atoms,d=[],a=0;a<c.length;++a)c[a].selected&&d.push(c[a]);return 0==d.length?null!=(u=this.getCenter(null))&&(this.rotating={atoms:null,center:u}):1==d.length?(u=d[0].p.clone(),1!=d.length||null!=(e=this.getFragment(d[0]))&&(d=e.atoms),this.rotating={atoms:1==d.length?null:d,center:u}):1==(u=this.getConnectingAtomBonds(d,!1)).length?this.rotating={atoms:d,center:u[0].a.p.clone()}:this.rotating={atoms:d,center:this.getCenter(d)},null!=this.rotating&&(this.rotating.cloned=this.clone()),void(null!=h&&(this.m.setSelected(),h.selected=!0,this.redraw()))}"arrow"==i&&(this.arrowtool={from:s},null!=JSDraw2.Shape.cast(s)&&(s=s.bestConnectPoint(this.start,this.tor),this.start=s.p,this.arrowtool.connector=s.connector)),"rxnmap"==i||t.ctrlKey||t.metaKey||!t.shiftKey&&0<this.m.setSelected()&&this.redraw()}else this.chaintool={a:h,start:this.start,p2:null,end:null,points:[]}}}},selectCurrent:function(t,e){return this.curObject!=t&&(this.curObject=t,null!=this.options.onselectcurrent&&this.options.onselectcurrent(e,t,this),this.options.showhelmpopup&&this.onHelmSelectCurrent(e,t),!0)},onHelmSelectCurrent:function(t,e){var i,s,l=JSDraw2.Atom.cast(e);null==l||null!=this.start||null!=this.contextmenu&&this.contextmenu.isVisible()?org.helm.webeditor.MolViewer.hide():null!=(i=null==l?null:l.biotype())&&(s=org.helm.webeditor.Monomers.getMonomerSet(i),e=null==l?null:l.elem,s=null==s?null:s[e.toLowerCase()],org.helm.webeditor.MolViewer.show(t,i,s,e,this,l))},mousemove:function(t,e){var i,s,l,n,r,o;this.activated?(this.holding.move(t),i=this.getCmd(),o=this.eventPoint(t),"moveview"!=i?"inkblue"!=i&&"inkred"!=i&&"inkgreen"!=i?(this.lastmove=o,n=!1,((s=null)==this.start||"select"!=i&&"lasso"!=i&&"selfrag"!=i)&&(s=this.toggle(o),n=this.selectCurrent(s,t)),null!=this.start&&("arrow"==i?null!=this.start&&(this.end=this.guessArrow(this.start,o),n=!0):"zoombox"==i||"curve"==i?null!=this.start&&(this.end=o,n=!0):"rotate"==i?null!=this.rotating&&(null==this.rotating.a1?this.rotating.a0=this.rotating.a1=o.angleTo(this.rotating.center):(l=o.angleTo(this.rotating.center),n=(n=this.rotate(this.rotating.atoms,this.rotating.center,l-this.rotating.a1))&&"all",this.rotating.a1=l)):"select"==i||"lasso"==i||"selfrag"==i||"tlc"==i||"electrophoresis"==i?null!=this.start&&(this.lassolast?(this.end=o,this.lassoSelect(this.lassolast),this.lassolast=o):null!=this.resizing?this.resizing.start.equalsTo(o)||(r=o.clone().offset(-this.resizing.start.x,-this.resizing.start.y),this.resizing.obj.resize(this.resizing.corner,r,this.resizing.texts),t.shiftKey&&null!=JSDraw2.Shape.cast(this.resizing.obj)&&(this.resizing.obj._rect.height=this.resizing.obj._rect.width),this.resizing.start=o,this.resizing.changed=!0,n="all"):n=null!=this.movingClone?(null==this.end&&(this.end=this.start,(t.ctrlKey||t.metaKey)&&((r=this.m.clone(!0)).showimplicithydrogens=this.options.showimplicithydrogens,r.isEmpty()||(this.m.setSelected(),r.setSelected(!0),r.calcHCount(!0),this.m.mergeMol(r)))),this.end.equalsTo(o)||(this.m.offset(o.x-this.end.x,o.y-this.end.y,!0),this.end=o),"all"):(this.end=o,!0)):"rectangle"==i||"ellipse"==i||"diamond"==i||"dshape"==i||"dreversed"==i?(t.shiftKey&&o.equalMove(this.start),this.end=o,n=!0):"bracket"==i||"sgroup"==i||"assaycurve"==i||"spectrum"==i||"doublearrow"==i||"tlc"==i||"electrophoresis"==i?(this.end=o,n=!0):"chain"==i?(this.end=o,n=this._makeChain(this.chaintool,o)):"eraser"==i?null==this.erasercache||this.erasercache.singleton||null!=(s=this.toggle(o))&&(this.delObject(s),++this.erasercache.count,n="all"):scil.Utils.startswith(i,"spot-")||(null!=JSDraw2.Atom.cast(this.curObject)?this.end=this.curObject.p.clone():this.end=this._guessBond(this.start,o),n=!0)),0==n||null!=this.start&&o.tm-this.start.tm<JSDraw2.Editor.undoGestureTime||this.redraw("all"!=n)):null!=this.ink&&this.ink.add(o):null!=this.start&&0==t.button&&(this.moveview(new JSDraw2.Point(o.x-this.start.x,o.y-this.start.y)),t.preventDefault())):e&&null!=this.start&&!this.frozen&&(o=this.eventPoint(t),this.moveview(new JSDraw2.Point(o.x-this.start.x,o.y-this.start.y)),t.preventDefault())},mouseup:function(t,e){if(this.holding.end(),!scil.Utils.isTouch&&2==t.button)return e||this.activated||this.activate(!0),null==this.touch.start1&&this.showContextMenu(t,e),void t.preventDefault();if(!this.activated)return null!=this.mousedownPoint&&this.mousedownPoint.x==t.clientX&&this.mousedownPoint.y==t.clientY&&this.activate(!0),void(e&&0==t.button&&(this.endMove(t,e),t.preventDefault()));var i=this.getCmd();if("moveview"==i)return this.endMove(t,e),void t.preventDefault();if("inkred"!=i&&"inkblue"!=i&&"inkgreen"!=i){if(null!=this.start){this.div.style.cursor="default";var s=this.start,l=null==this.lastmove?s.clone():this.lastmove;this.lastmove=null,this.start=null;var n=Math.abs(s.x-l.x);if(l.tm-s.tm<JSDraw2.Editor.undoGestureTime&&20<Math.abs(n)&&n>5*Math.abs(s.y-l.y)&&null==this.toggle(s)&&null==this.toggle(l))return s.x>l.x?this.undo():this.redo(),void this.refresh(!1);var r=null;if("text"!=i)if("sgroup"!=i)if("eraser"!=i)if("plus"!=i)if("rxnmap"!=i){var o=s.distTo(l);if("arrow"==i||"curve"==i){if(null!=this.arrowtool&&null!=this.arrowtool.from){var a,h=JSDraw2.Shape.cast(this.arrowtool.from),u=JSDraw2.Shape.cast(this.curObject),e=this.arrowtool.connector;if((this.arrowtool=null)!=h&&h!=u){if("rejector"==e){if(h.reject!=h)return this.pushundo(),h.reject==u?h.reject=null:h.reject=u,void this.refresh(!0)}else if(this.pushundo(),null==u&&(D=h.rect(),a=n=0,e=l.clone(),l.x<s.x&&(e.x-=D.width),l.y<s.y&&(e.y-=D.height),u=this.m.addGraphics(new JSDraw2.Shape(new JSDraw2.Rect(e.x,e.y,D.width,D.height),"rectangle"))),null!=u)return this.pushundo(),this.isShapeConnected(h,u)?scil.Utils.delFromArray(u.froms,h):(this.isShapeConnected(u,h)&&scil.Utils.delFromArray(h.froms,u),Math.abs(s.y-l.y)<this.tor?this.isIsolatedShape(u)?(a=h._rect.center().y-u._rect.center().y,u._rect.offset(0,a)):this.isIsolatedShape(h)&&(a=u._rect.center().y-h._rect.center().y,h._rect.offset(0,a)):Math.abs(s.x-l.x)<this.tor&&(this.isIsolatedShape(u)?(n=h._rect.center().x-u._rect.center().x,u._rect.offset(n,0)):this.isIsolatedShape(h)&&(n=u._rect.center().x-h._rect.center().x,h._rect.offset(n,0))),u.froms.push(h)),void this.refresh(!0);return void this.refresh()}}return this.pushundo(),l=o>=this.bondlength?this.guessArrow(s,l):s.clone().offset(3*this.bondlength,0),"arrow"==i?this.m.addGraphics(new JSDraw2.Arrow(s,l)):this.m.addGraphics(new JSDraw2.Curve(s,l)),void this.refresh(!0)}if("rectangle"==i||"ellipse"==i||"doublearrow"==i||"diamond"==i||"dshape"==i||"dreversed"==i){if(o<this.bondlength/8)l=new JSDraw2.Point(s.x+this.bondlength,s.y+this.bondlength);else if(o<this.bondlength/2)return;return this.pushundo(),"rectangle"==i?this.m.addGraphics(new JSDraw2.Shape((new JSDraw2.Rect).set(s,l),"rectangle")):"ellipse"==i?this.m.addGraphics(new JSDraw2.Shape((new JSDraw2.Rect).set(s,l),"ellipse")):"diamond"==i?this.m.addGraphics(new JSDraw2.Shape((new JSDraw2.Rect).set(s,l),"diamond")):"dshape"==i?this.m.addGraphics(new JSDraw2.Shape((new JSDraw2.Rect).set(s,l),"dshape")):"dreversed"==i?this.m.addGraphics(new JSDraw2.Shape((new JSDraw2.Rect).set(s,l),"dreversed")):"doublearrow"==i&&this.m.addGraphics(new JSDraw2.Shape((new JSDraw2.Rect).set(s,l),"doublearrow")),void this.refresh(!0)}if("assaycurve"==i){if(o<this.bondlength/8&&this.m.isEmpty())l=new JSDraw2.Point(s.x+8*this.bondlength,s.y+6*this.bondlength);else if(Math.abs(s.x-l.x)<2*this.bondlength||Math.abs(s.y-l.y)<2*this.bondlength)return;return this.pushundo(),this.m.addGraphics(new JSDraw2.AssayCurve((new JSDraw2.Rect).set(s,l))),void this.refresh(!0)}if("spectrum"==i){if(o<this.bondlength/8&&this.m.isEmpty())l=new JSDraw2.Point(s.x+14*this.bondlength,s.y+6*this.bondlength);else if(Math.abs(s.x-l.x)<2*this.bondlength||Math.abs(s.y-l.y)<2*this.bondlength)return;return this.pushundo(),this.m.addGraphics(new JSDraw2.Spectrum((new JSDraw2.Rect).set(s,l))),void this.refresh(!0)}if("tlc"==i||"electrophoresis"==i){var c=!1;if(null==this.movingClone)return o<this.bondlength/2?void 0:(this.pushundo(),(d=new JSDraw2.TLC.create(i,s,l,this.fontsize/2)).rect().height>2*this.bondlength&&0<d.spots.length&&(this.addTlcPlate(d),c=!0),void this.refresh(c))}if(scil.Utils.startswith(i,"spot-")){var d=JSDraw2.TLC.cast(this.curObject),c=this.clone();null!=d&&d.addSpot(i.substr(5),l,this.tor)&&(this.pushundo(c),this.refresh(!0))}else{if("rotate"==i&&null!=this.rotating)return this.rotating.a1!=this.rotating.a0&&(this.pushundo(this.rotating.cloned),this.refresh(!0)),void(this.rotating=null);if("select"==i||"lasso"==i||"selfrag"==i||"rotate"==i||"tlc"==i||"electrophoresis"==i)return null!=this.lassolast?this.lassolast=null:null!=this.resizing?this.resizing.changed&&(this._bracketReselectAtoms(),this.pushundo(this.movingClone),this.movingClone=null,r=!(this.resizing=null)):null!=this.movingClone?this.movingClone.startPt.equalsTo(l)||(this._bracketReselectAtoms(),this.pushundo(this.movingClone),this.mergeOverlaps(),r=!(this.movingClone=null)):o<this.bondlength?null!=this.curObject&&(this.curObject.selected=!0):this.selectInRect((new JSDraw2.Rect).set(s,l)),this.refresh(r),void(null!=this.options.onselectionchanged&&this.options.onselectionchanged(this));if("zoombox"==i)return 10<(D=(new JSDraw2.Rect).set(s,l)).width&&10<D.height?(k=Math.min(this.dimension.x/D.width,this.dimension.y/D.height),y=D.center(),this.pushundo(),this.scale(.9*k,y),this.m.offset(this.dimension.x/2-y.x,this.dimension.y/2-y.y)):D.width<5&&D.height<5&&this.fitToWindow(),void this.redraw();if("chain"==i&&null!=this.chaintool&&0<this.chaintool.points.length){r=!1;for(var p=this.clone(),f=this.chaintool.points,m=null,g=1;g<f.length;++g){var w=this.toggleAtom(f[g-1]),b=this.toggleAtom(f[g]);null==m&&(m=null!=w?w._parent:null!=b?b._parent:this.m),null!=w&&w._parent!=m&&(w=null),null!=b&&b._parent!=m&&(b=null),null==w&&(w=new JSDraw2.Atom(f[g-1]),m.addAtom(w),this._addNewAtomInExistingGroup(b,[w]),r=!0),null==b&&(b=new JSDraw2.Atom(f[g]),m.addAtom(b),this._addNewAtomInExistingGroup(w,[b]),r=!0),null==m.findBond(w,b)&&(m.addBond(new JSDraw2.Bond(w,b),null,!0),r=!0)}return this.chaintool=null,r&&this.pushundo(p),void this.refresh(r)}if("bracket"==i){this.m.setSelected(!1);var S,v,y=(new JSDraw2.Rect).set(s,l),D=this.m.bracketSelect(y);return 0<D.length&&(this.pushundo(),((S=new JSDraw2.Bracket(null,y)).atoms=D)[0]._parent.addGraphics(S),r=!0),this.refresh(r),void(null!=S?null!=(v=S.createSubscript(this.m,"#"))&&this.showTextEditor(v,null,""):null!=(v=JSDraw2.Text.cast(this.curObject))&&"BRACKET_TYPE"==v.fieldtype&&1==v.anchors.length&&null!=JSDraw2.Bracket.cast(v.anchors[0])&&this.showTextEditor(v,null,v.text))}if("&#9679;"!=i){if("undo"!=i&&"redo"!=i&&"zoomin"!=i&&"zoomout"!=i){var x,p=this.clone();if(o<=this.tor){if(scil.Utils.startswith(i,"template."))return this.pushundo(p),this.addTemplate(i.substr(9),this.curObject,l),void this.refresh(!0);if(null!=(x=JSDraw2.Atom.cast(this.curObject))&&(t=JSDraw2.PT[i],"antibody"==i||"protein"==i||"gene"==i||null!=t?r=this.m.setAtomType(x,i):"..."==i||"more"==i?r=this.m.setAtomType(x,this.ptElement):"chargep"==i||"chargen"==i?r=this.increaseNum(x,"chargep"==i?1:-1):null!=this.helm&&null!=this.helm&&this.helm.isHelmCmd(i)?scil.helm.isHelmNode(x)&&this.helm.changeMonomer(x,p):null!=this.helm&&scil.helm.isHelmNode(x)?this.helm.changeMonomer(x,p):r=this._addAutoBond(x,i)),null!=(A=JSDraw2.Bond.cast(this.curObject)))switch(i){case"double":r=this.m.setBondType(A,JSDraw2.BONDTYPES.DOUBLE);break;case"triple":r=this.m.setBondType(A,JSDraw2.BONDTYPES.TRIPLE);break;case"unknown":r=this.m.setBondType(A,JSDraw2.BONDTYPES.UNKNOWN);break;case"dummy":r=this.m.setBondType(A,JSDraw2.BONDTYPES.DUMMY);break;case"either":r=this.m.setBondType(A,JSDraw2.BONDTYPES.EITHER);break;case"wiggly":r=this.m.setBondType(A,JSDraw2.BONDTYPES.WIGGLY);break;case"bold":r=this.m.setBondType(A,JSDraw2.BONDTYPES.BOLD);break;case"boldhash":r=this.m.setBondType(A,JSDraw2.BONDTYPES.BOLDHASH);break;case"delocalized":r=this.m.setBondType(A,JSDraw2.BONDTYPES.DELOCALIZED);break;case"singledouble":r=this.m.setBondType(A,JSDraw2.BONDTYPES.SINGLEORDOUBLE);break;case"singlearomatic":r=this.m.setBondType(A,JSDraw2.BONDTYPES.SINGLEORAROMATIC);break;case"doublearomatic":r=this.m.setBondType(A,JSDraw2.BONDTYPES.DOUBLEORAROMATIC);break;case"up":A.type==JSDraw2.BONDTYPES.WEDGE?(A.reverse(),r=!0):(r=this.m.setBondType(A,JSDraw2.BONDTYPES.WEDGE),this.fixWedgeDir(A));break;case"down":A.type==JSDraw2.BONDTYPES.HASH?(A.reverse(),r=!0):(r=this.m.setBondType(A,JSDraw2.BONDTYPES.HASH),this.fixWedgeDir(A));break;default:r=this.m.setBondType(A,A.type==JSDraw2.BONDTYPES.SINGLE?JSDraw2.BONDTYPES.DOUBLE:JSDraw2.BONDTYPES.SINGLE)}if(!r&&null==this.curObject){if(this.options.helmtoolbar&&!this.helm.isHelmCmd(i))return;null!=(J=this.Cmd2BondType(i))&&(w=this.m.addAtom(new JSDraw2.Atom(l)),E=l.clone().offset(this.bondlength,0).rotateAround(l,-30),null==(b=JSDraw2.Atom.cast(this.toggle(E)))&&(b=this.m.addAtom(new JSDraw2.Atom(E))),this.m.addBond(new JSDraw2.Bond(w,b)),r=!0)}return r||null!=this.curObject||(k="more"==i||"..."==i?this.ptElement:i,(null!=(t=JSDraw2.PT[k])&&0<t.a||"antibody"==i||"protein"==i||"gene"==i||null!=this.helm&&this.helm.isHelmCmd(i))&&(x=this.m.addAtom(new JSDraw2.Atom(l)),"antibody"==i?(x.bio={type:JSDraw2.BIO.ANTIBODY},x.elem="X"):"protein"==i?(x.bio={type:JSDraw2.BIO.PROTEIN},x.elem="X"):"gene"==i?(x.bio={type:JSDraw2.BIO.GENE},x.elem="X"):null!=this.helm&&this.helm.createIsolatedMonomer(i,x)||this.m.setAtomType(x,k),r=!0)),void(r&&(this.pushundo(p),this.refresh(r)))}w=JSDraw2.Atom.cast(null!=s.atom?s.atom:this.toggle(s)),b=JSDraw2.Atom.cast(this.toggle(l));if(null==w||null==b||w._parent==b._parent){if(this.options.helmtoolbar){if(this.helm.connnectGroup(s,this.curObject))return this.pushundo(p),void this.redraw();if((null==w||null==b)&&null!=this.helm&&!this.helm.isHelmCmd(i))return"single"==i&&this.helm.connnectGroup(s,this.curObject)&&this.pushundo(p),void this.redraw();if(null!=this.helm&&this.helm.isHelmCmd(i)){if(null!=w&&null==b)return void this.helm.extendChain(w,i,s,l,p);if(null==w&&null==b)return void this.redraw()}}m=null!=w?w._parent:null!=b?b._parent:this.m;this.pushundo(p);var o=this._countAABonds(w),E=w;null==w&&(null!=o?0==o.peptideN&&0==o.others?w=m.addAtom(new JSDraw2.Atom(s,"H")):0==o.peptideC&&0==o.others&&(w=m.addAtom(new JSDraw2.Atom(s,"O"))):w=m.addAtom(new JSDraw2.Atom(s)));var A,J,t=this._countAABonds(b),k=b;null==b&&(l=this._guessBond(s,l),null!=o?0==o.peptideN&&0==o.others?b=m.addAtom(new JSDraw2.Atom(l,"H")):0==o.peptideC&&0==o.others&&(b=m.addAtom(new JSDraw2.Atom(l,"O"))):b=m.addAtom(new JSDraw2.Atom(l))),null!=w&&null!=b&&(this._addNewAtomInExistingGroup(E,[b]),this._addNewAtomInExistingGroup(k,[w]),null==(A=this.m.findBond(w,b))&&(null!=E&&null!=k&&E._parent!=k._parent?scil.Utils.alert("Cannot create bond between the two atoms"):null!=this.helm&&(scil.helm.isHelmNode(w)||scil.helm.isHelmNode(b))?this.helm.connectFragment(w,b,!scil.helm.isHelmNode(w)||!scil.helm.isHelmNode(b)):(null==(J=this.Cmd2BondType(i))&&JSDraw2.BONDTYPES.SINGLE,null!=o&&null!=t?0==o.peptideN&&0==t.peptideC?A=new JSDraw2.Bond(w,b,JSDraw2.BONDTYPES.PEPTIDE):0==t.peptideN&&0==o.peptideC?A=new JSDraw2.Bond(b,w,JSDraw2.BONDTYPES.PEPTIDE):"C"==E.elem&&"C"==k.elem&&0==o.disulfide&&0==t.disulfide?A=new JSDraw2.Bond(w,b,JSDraw2.BONDTYPES.DISULFIDE):"K"==E.elem&&0==o.amide&&0==t.peptideC?A=new JSDraw2.Bond(w,b,JSDraw2.BONDTYPES.AMIDE):"K"==k.elem&&0==t.amide&&0==o.peptideC&&(A=new JSDraw2.Bond(b,w,JSDraw2.BONDTYPES.AMIDE)):null!=o?o.peptideN+o.peptideC+o.others<2?A=new JSDraw2.Bond(w,b,"H"==b.elem?JSDraw2.BONDTYPES.PEPTIDE:JSDraw2.BONDTYPES.SINGLE):"C"==E.elem&&0==o.disulfide?A=new JSDraw2.Bond(w,b,JSDraw2.BONDTYPES.DISULFIDE):"K"==E.elem&&0==o.amide&&(A=new JSDraw2.Bond(w,b,JSDraw2.BONDTYPES.AMIDE)):null!=t?t.peptideN+t.peptideC+t.others<2?A=new JSDraw2.Bond(b,w,"H"==w.elem?JSDraw2.BONDTYPES.PEPTIDE:JSDraw2.BONDTYPES.SINGLE):"C"==k.elem&&0==t.disulfide?A=new JSDraw2.Bond(b,w,JSDraw2.BONDTYPES.DISULFIDE):"K"==k.elem&&0==t.amide&&(A=new JSDraw2.Bond(b,w,JSDraw2.BONDTYPES.AMIDE)):A=new JSDraw2.Bond(w,b,J)),null!=A&&m.addBond(A,J!=JSDraw2.BONDTYPES.DUMMY,!0))),this.start=null,this.refresh(null!=A)}else scil.Utils.alert("Cannot create bond between the two atoms")}}else null!=(x=JSDraw2.Atom.cast(this.curObject))?this.showAtomDlg(x):null!=(x=JSDraw2.Bond.cast(this.curObject))&&this.showBondDlg(x)}}else this.doRxnMap(this.curObject);else null==this.curObject&&(this.pushundo(),this.m.addGraphics(new JSDraw2.Plus(l)),this.refresh(!0));else null!=this.erasercache&&(0<this.erasercache.count&&(this.pushundo(this.erasercache.cloned),(this.curObject=null)!=this.helm&&this.helm.resetIDs(),this.refresh(!0)),this.erasercache=null);else s.equalsTo(l)?this.showTextEditor(this.curObject,new JSDraw2.Point(l.x,l.y)):(x=null!=s.atom?s.atom:this.toggle(s),s=this.toggle(l),null!=JSDraw2.Text.cast(x)&&(p=this.clone(),x.attach(s)&&this.pushundo(p)),this.refresh(!0));else this.showTextEditor(this.curObject,new JSDraw2.Point(l.x,l.y))}}else null!=this.ink&&this.ink.end()},_bracketReselectAtoms:function(){var t,e=JSDraw2.Bracket.cast(this.curObject);null==e||null!=(t=this.m.bracketSelect(e.rect()))&&0<t.length&&(e.atoms=t)},_addNewAtomInExistingGroup:function(t,e){if(null!=t)for(var i=0;i<e.length;++i){var s=e[i];if(null!=s){null!=t.group&&null==s.group&&(s.group=t.group);for(var l=0;l<this.m.graphics.length;++l){var n=JSDraw2.Bracket.cast(this.m.graphics[l]);null!=n&&null!=n.atoms&&0<=scil.Utils.indexOf(n.atoms,t)&&scil.Utils.indexOf(n.atoms,s)<0&&n.atoms.push(s)}}}},mousedblclick:function(t){if(!this.options.viewonly){var e=this.eventPoint(t),t=this.toggle(e);if(null!=t){e=JSDraw2.Atom.cast(t);if(null!=e||null!=(t=JSDraw2.Bond.cast(t))&&(e=t.a1),null!=e){this.m.setSelected(!1);for(var i=e._parent.getFragment(e,e._parent),s=0;s<i.atoms.length;++s)i.atoms[s].selected=!0;for(s=0;s<i.bonds.length;++s)i.bonds[s].selected=!0;this.refresh(!1)}}}},endMove:function(t,e){null!=this.start&&(t=this.eventPoint(t),t=new JSDraw2.Point(t.x-this.start.x,t.y-this.start.y),this.start=null,this.moveview(null),0==t.x&&0==t.y||(e||this.pushundo(),this.m.offset(t.x,t.y),e?this.redraw():this.refresh(!0)))},isIsolatedShape:function(t){if(0<t.froms.length)return!1;for(var e=0;e<this.m.graphics.length;++e){var i=JSDraw2.Shape.cast(this.m.graphics[e]);if(null!=i&&0<=scil.Utils.indexOf(i.froms,t))return!1}return!0},isShapeConnected:function(t,e){if(null==t||null==e)return!1;for(var i=0;i<e.froms.length;++i)if(e.froms[i]==t)return!0;return!1},_countAABonds:function(t){if(null==t||t.biotype()!=JSDraw2.BIO.AA)return null;for(var e={peptideN:0,peptideC:0,disulfide:0,amide:0,others:0},i=this.m.getAllBonds(t),s=0;s<i.length;++s)i[s].type==JSDraw2.BONDTYPES.PEPTIDE?i[s].a1==t?++e.peptideN:++e.peptideC:i[s].type==JSDraw2.BONDTYPES.DISULFIDE?++e.disulfide:i[s].type==JSDraw2.BONDTYPES.AMIDE?++e.amide:i[s].type==JSDraw2.BONDTYPES.SINGLE&&null==i[s].otherAtom(t).bio&&++e.others;return e},addTlcPlate:function(t){var e,i,s;null!=t&&0<t.spots.length&&((e=null)!=JSDraw2.defaultoptions&&null!=JSDraw2.defaultoptions.tlc&&"electrophoresis"!=t.type&&(e=JSDraw2.defaultoptions.tlc,i=t.spotsize/(JSDraw2.Editor.FONTSIZE/2),0<e.width&&(t._rect.width=e.width*i),0<e.height&&(t._rect.height=e.height*i),null!=(s=this.getAllTlcPlates(!0))&&0<s.length&&(i=s[s.length-1],s=0<e.gap?e.gap:e.width/5,t._rect.left=i._rect.right()+s,t._rect.top=i._rect.top)),this.m.addGraphics(t),null!=e&&e.autonumbering&&this.numberTlcPlates(),null!=this.options.onAddTLC&&this.options.onAddTLC(t),this.moveCenter())},hideChirarlities:function(t){for(var e=[],i=0;i<this.m.graphics.length;++i){var s,l=JSDraw2.Text.cast(this.m.graphics[i]);null!=l&&null!=l.anchors&&1==l.anchors.length&&"CHIRAL"==l.fieldtype&&(s=JSDraw2.Atom.cast(l.anchors[0]),t&&!s.selected||e.push(l))}if(0<e.length){for(i=0;i<e.length;++i)this.m.delGraphics(e[i]);this.pushundo(),this.refresh(!0)}},detectChiralities:function(n){var r=this;JSDraw2.JSDrawIO.callWebservice("mol.getchiralatoms",{mol:this.getXml(),format:"xml"},function(t){var e,i=0,s=r.clone();for(e in t){var l=parseInt(e),l=r.m.getObjectById(l);n&&!l.selected||!r.m.markChirality(l,t[e],r.bondlength)||++i}0<i&&(r.pushundo(s),r.refresh(!0))})},increaseNum:function(t,e){if(1!=e&&-1!=e)return!1;var i,s=!1;return"R"==t.elem?null==(i=scil.Utils.parseIndex(t.alias))||null==i.index?s=t._parent.setAtomAlias(t,(null==i||null==i.prefix?"R":i.prefix)+"1"):0<e?s=t._parent.setAtomAlias(t,i.prefix+(i.index+1)):1<i.index&&(s=t._parent.setAtomAlias(t,i.prefix+(i.index-1))):s=t._parent.setAtomCharge(t,t.charge+e),s},mergeOverlaps:function(){for(var t=[],e=0;e<this.m.atoms.length;++e)if(this.m.atoms[e].selected)for(var i=this.m.atoms[e],s=0;s<this.m.atoms.length;++s)if(!(n=this.m.atoms[s]).selected&&n.toggle(i.p,this.tor)){t.push({a1:i,a2:n});break}for(var l=[],s=0;s<t.length;++s){var i=t[s].a1,n=t[s].a2,r=this.m.findBond(i,n);if(null==r)for(var o,e=0;e<this.m.bonds.length;++e)(r=this.m.bonds[e]).a1==i?r.a2!=n&&(o=this.m.findBond(r.a2,n),r.a1=n,null!=o&&l.push(r)):r.a2==i&&r.a1!=n&&(o=this.m.findBond(r.a1,n),r.a2=n,null!=o&&l.push(r));else l.push(r)}for(e=0;e<l.length;++e)this.m.delBond(l[e],!1);for(e=0;e<t.length;++e)this.m.delAtom(t[e].a1,!1);return l.length+t.length},onDel:function(){if(null!=this.texteditor.ed&&"none"!=this.texteditor.ed.input.style.display)return!1;var t=this.clone();return!!(this.delObject(this.curObject)||0<this.delSelected())&&(this.pushundo(t),null!=this.helm&&this.helm.resetIDs(),this.curObject=null,this.refresh(!0),!0)},showContextMenu:function(t,e){var i,s;0==this.options.showcontextmenu||null!=(i=org.helm.webeditor.Interface.onContextMenu(this,t,e))&&(null==(s=this).contextmenu&&(this.contextmenu=new JSDraw2.ContextMenu(i,function(t,e){s.menuCallback(t,e)})),e=scil.Utils.scrollOffset(),this.contextmenu.show(t.clientX+e.x,t.clientY+e.y,this.curObject,i),this.contextmenu.pos=this.eventPoint(t))},menuSetStereochemistry:function(t){"abs"==t&&(t=null),this.pushundo(),this.m.chiral==t?this.m.chiral=null:this.m.chiral=t,this.refresh(!0)},menuCallback:function(t,e){var i=!1,s=this.clone();switch(t){case"curveline":e.setAssayCurveLine(this);break;case"curveonly":e.setAssayCurveOnly(this);break;case"overlaycurves":this.overlayCurves2(e);break;case"setrawassaydata":e.setAssayCurveRawData(this);break;case"spectrum_setdata":e.setSpectrumData(this);break;case"spectrum_setdatafromfile":e.setSpectrumDataFromFile(this);break;case"spectrum_attributes":e.viewAttributes(this);break;case"maskassaysamplepoint":i=e.maskSamplePoint(e.curspot);break;case"pastechemdraw":JSDraw2.ChemDraw.paste(this);break;case"pastechemdrawasproduct":JSDraw2.ChemDraw.paste(this,"product");break;case"pastechemdrawasreactant":JSDraw2.ChemDraw.paste(this,"reactant");break;case"copychemdraw":JSDraw2.ChemDraw.copy(this);break;case"copymolfile":this.copyAs("molfile");break;case"copymolfile2000":this.copyAs("molfile2000");break;case"copymolfile3000":this.copyAs("molfile3000");break;case"copysmiles":this.copyAs("smiles");break;case"pastemolfile":this.pasteAs("molfile");break;case"about":JSDraw2.Editor.showAbout();break;case"abouthelm":scil.helm.about();break;case"removeatomvalues":this.removeAtomValues();break;case"viewlarge":this.viewLarge();break;case"movecenter":this.moveCenter(),this.redraw();break;case"atom_prop":null!=(n=JSDraw2.Atom.cast(e))&&this.showAtomDlg(n);break;case"atom_tag":var l=null==e.bio?"Atom "+e.elem:e.bio.type;null!=e.bio&&null!=e.bio.subtype&&(l+=" "+e.bio.subtype),this.addTag(e,e.p,l,!0);break;case"helm_set_sense":"5'ss"!=e.bio.annotation&&(e.bio.annotation="5'ss",i=!0);break;case"helm_set_antisense":"5'as"!=e.bio.annotation&&(e.bio.annotation="5'as",i=!0);break;case"helm_set_clear":"5'"!=e.bio.annotation&&(e.bio.annotation="5'",i=!0);break;case"helm_complementary_strand":scil.Utils.startswith(e.bio.annotation,"5'")&&(i=null!=this.helm.makeComplementaryStrand(e));break;case"helm_create_group":i=null!=this.helm.createGroup(e,null,!0);break;case"helm_group_collapse":i=null!=this.helm.collapseGroup(e,!0);break;case"helm_bond_prop":this.helm.setBondProp(e);break;case"helm_atom_prop":this.helm.setAtomProp(e);break;case"group_setproperties":this.setGroupProperties(e);break;case"detectstereochemistry":this.detectChiralities(!0);break;case"hidestereochemistry":this.hideChirarlities(!0);break;case"detectstereochemistry2":this.detectChiralities();break;case"hidestereochemistry2":this.hideChirarlities();break;case"bond_prop":null!=(n=JSDraw2.Bond.cast(e))&&this.showBondDlg(n);break;case"bond_tag":this.addTag(e,e.center(),"[None]",!0);break;case"bond_locant":this.addTag(e,e.center(),"U = Unknown Locant");break;case"bio_showsequence":this.showSequences(e);break;case"rgroup_define":this.rgroupDefine(e);break;case"rgroup_remove":var n=JSDraw2.Atom.cast(e);null!=n&&null!=n.rgroup&&(i=!(n.rgroup=null));break;case"rgroup_addstructure":this.addRgroupStructure(e),i=!0;break;case"setbracketsubscription":this.setBracketSubscription(e);break;case"setbracketratio":this.setBracketRatio(e);break;case"setbracketmw":this.setBracketData(e,"POLYMER_MW","MW=",1);break;case"registrationparent":this.setBracketData(e,"REG_PARENT","Parent=",2);break;case"graphics_bring2front":i=this.m.setZOrder(e,-1);break;case"graphics_set2back":i=this.m.setZOrder(e,0);break;case"tlc_addlane":i=null!=JSDraw2.TLC.cast(e)&&e.addLane();break;case"tlc_duplicatespot":i=null!=JSDraw2.TLC.cast(e)&&e.duplicateSpot(e.curspot);break;case"tlc_duplicatelane":i=null!=JSDraw2.TLC.cast(e)&&e.duplicateLane(e.curspot);break;case"tlc_showlanelabel":i=null!=JSDraw2.TLC.cast(e)&&e.showLaneLabel(!e.showlanelabel);break;case"tlc_removespot":i=null!=JSDraw2.TLC.cast(e)&&e.removeSpot(e.curspot);break;case"tlc_setrfvalue":i=null!=JSDraw2.TLC.cast(e)&&e.setRfValue(e.curspot,this);break;case"tlc_setlanelabels":JSDraw2.TLC.setLaneLabels(this,e);break;case"Copy":this.copy();break;case"Select All":this.selectAll()&&this.refresh(!1);break;case"copy-viewonly":this.copy(null==s?null:s.mol);break;case"Cut":this.cut()&&this.refresh(!1);break;case"edit-popup":this.options.popup&&this.dblclick();break;case"Expand":this.expandSuperatom();break;case"Paste":this.paste(this.contextmenu.pos)&&this.refresh(!1);break;case"Delete":i=0<this.delSelected();break;case"multi-center":i=null!=this.createMulticenter();break;case"Clear":this.clear(!1,!0),i=!0;break;case"Undo":this.undo()&&this.refresh(!1);break;case"Redo":this.redo()&&this.refresh(!1);break;case"workflow_properties":JSDraw2.Shape.showProperties(this,JSDraw2.Shape.cast(e))}i&&(this.pushundo(s),this.refresh(i))},overlayCurves2:function(t){if(null!=(t=JSDraw2.AssayCurve.cast(t))){for(var e=[],i=0;i<this.m.graphics.length;++i){var s=JSDraw2.AssayCurve.cast(this.m.graphics[i]);null!=s&&s.selected&&e.push(s)}this.overlayCurves(e,t)}},overlayCurves:function(t,e){if(!(scil.Utils.indexOf(t,e)<0)){this.pushundo();for(var i=0;i<t.length;++i)t[i].curveline=!1,t[i]==e?t[i].curveonly=!1:(t[i]._rect=e._rect.clone(),t[i].curveonly=!0);this.refresh(!0)}},setGroupProperties:function(t){var e,t=JSDraw2.Group.cast(t);null!=t&&(null==(e=this).groupPropDlg&&((e=this).groupPropDlg=scil.Form.createDlgForm("Group Properties",{ratio:{label:"Ratio",type:"number",accepts:"(and)|(or)|[*|?]",width:100},tag:{label:"Annotation",width:300}},{label:"Save",onclick:function(){e.setGroupProperties2()}})),this.groupPropDlg.show(),this.groupPropDlg.form.setData({ratio:t.ratio,tag:t.tag}),this.groupPropDlg.g=t)},setGroupProperties2:function(){var t=this.groupPropDlg.form.getData(),e=this.groupPropDlg.g;""!=t.ratio&&this.hasGroupBond(e)&&(t.ratio=""),(null==e.ratio?"":e.ratio+"")==t.ratio&&e.tag==t.tag||(this.pushundo(),e.ratio=t.ratio,e.tag=t.tag,this.groupPropDlg.hide(),this.refresh(!0))},hasGroupBond:function(t){t=null==t.a?null:this.m.getAllBonds(t.a);return null!=t&&0<t.length},copyAs:function(t){var e=null;switch(t){case"molfile":e=this.getMolfile();break;case"molfile2000":e=this.getMolfile(!1);break;case"molfile3000":e=this.getMolfile(!0);break;case"smiles":e=this.getSmiles(!0)}scil.Utils.isNullOrEmpty(e)?scil.Utils.alert("Nothing placed on clipboard"):scil.Clipboard.copy(e)},pasteAs:function(t){},rgroupDefine:function(t){JSDraw2.needPro()},createMulticenter:function(){JSDraw2.needPro()},viewLarge:function(){var t=this.options.viewonly?"Dismiss":"Save";JSDraw2.Editor.showPopup("View Structure",t,null,{value:this.clone(),format:"clone"})},removeAtomValues:function(){for(var t=null,e=0;e<this.m.atoms.length;++e){var i=this.m.atoms[e];null!=i.tag&&""!=i.tag&&(null==t&&(t=this.clone()),i.tag=null)}return null!=t&&(this.pushundo(t),this.refresh(!0)),null!=t},selectAll:function(){var t=0<this.m.setSelected(!0);return null!=this.options.onselectionchanged&&this.options.onselectionchanged(this),t},addRgroupStructure:function(t){JSDraw2.needPro()},menuTLCSetSpotShape:function(t,e,i){JSDraw2.needPro()},menuTLCSetSpotSize:function(t,e){JSDraw2.needPro()},menuTLCLabel:function(t,e){JSDraw2.needPro()},menuTLCSetLabel:function(t,e){JSDraw2.needPro()},menuTLCFill:function(t,e){JSDraw2.needPro()},menuShapeType:function(t,e){JSDraw2.needPro()},menuAlignShapes:function(t,e){JSDraw2.needPro()},menuShapeFill:function(t,e){JSDraw2.needPro()},menuAntiboyType:function(t,e){JSDraw2.needPro()},showSequences:function(t){JSDraw2.needPro()},menuSetFontsize:function(t,e){JSDraw2.needPro()},menuSetColor:function(t,e){JSDraw2.needPro()},addTag:function(t,e,i,s){JSDraw2.needPro()},setBracketData:function(t,e,i,s){JSDraw2.needPro()},setBracketSubscription:function(t){var e;null!=t&&(null==(e=this.m.getSgroupText(t,"BRACKET_TYPE"))&&(e=t.createSubscript(this.m,"#")),this.showTextEditor(e,null,e.text))},setBracketRatio:function(t){JSDraw2.needPro()},menuBracket:function(t,e,i,s){JSDraw2.needPro()},menuSetTextField:function(t,e){JSDraw2.needPro()},menuSetAttachPoint:function(t,e){JSDraw2.needPro()},lockAtomConnection:function(t){JSDraw2.needPro()},menuSetAtomQuery:function(t,e,i,s){JSDraw2.needPro()},menuSetAtomQuery2:function(t,e){JSDraw2.needPro()},menuSetAtomType:function(t,e){var i;"..."==t||"more"==t?(i=this).showPT(function(t){i.menuSetAtomType2(t,e)}):this.menuSetAtomType2(t,e)},menuSetAtomType2:function(t,e){var i=0,s=this.clone(),l=JSDraw2.Atom.cast(e);if(null==l||l.selected)for(var n=this.m.allAtoms(),r=0;r<n.length;++r)(l=n[r]).selected&&l._parent.setAtomType(l,t)&&++i;else l._parent.setAtomType(l,t)&&++i;0<i&&(this.pushundo(s),this.refresh(!0))},menuSetAtomCharges:function(t){var e=parseInt(t);if(!isNaN(e)){for(var i=0,t=this.clone(),s=this.m.allAtoms(),l=0;l<s.length;++l){var n=s[l];n.selected&&n._parent.setAtomCharge(n,e)&&++i}0<i&&(this.pushundo(t),this.refresh(!0))}},menuSetAtomIsotope:function(t){JSDraw2.needPro()},menuSetAtomRadical:function(t){JSDraw2.needPro()},menuSetEhnStereochemistry:function(t){JSDraw2.needPro()},menuSetBondTop:function(t){JSDraw2.needPro()},menuSetRxnCenter:function(t){JSDraw2.needPro()},menuSetBondType:function(t){JSDraw2.needPro()},getAllTlcPlates:function(t){JSDraw2.needPro()},numberTlcPlates:function(){JSDraw2.needPro()},expandSuperatom:function(){this.helm.expandSuperAtom(this.curObject)||JSDraw2.needPro()},_setSelectedBondType:function(t){for(var e=0,i=this.m.allBonds(),s=0;s<i.length;++s){var l=i[s];l.selected&&l._parent.setBondType(i[s],t)&&++e}return e},doRxnMap:function(t){JSDraw2.needPro()},Cmd2BondType:function(t){switch(t){case"single":return JSDraw2.BONDTYPES.SINGLE;case"double":return JSDraw2.BONDTYPES.DOUBLE;case"triple":return JSDraw2.BONDTYPES.TRIPLE;case"unknown":return JSDraw2.BONDTYPES.UNKNOWN;case"dummy":return JSDraw2.BONDTYPES.DUMMY;case"either":return JSDraw2.BONDTYPES.EITHER;case"wiggly":return JSDraw2.BONDTYPES.WIGGLY;case"bold":return JSDraw2.BONDTYPES.BOLD;case"boldhash":return JSDraw2.BONDTYPES.BOLDHASH;case"delocalized":return JSDraw2.BONDTYPES.DELOCALIZED;case"up":return JSDraw2.BONDTYPES.WEDGE;case"down":return JSDraw2.BONDTYPES.HASH}return null},delObject:function(t){if(null==t)return!1;var e=JSDraw2.Bracket.cast(t);if(null!=e){for(var i=0;i<this.m.graphics.length;++i){var s=JSDraw2.Text.cast(this.m.graphics[i]);null!=s&&0<=scil.Utils.indexOf(s.anchors,e)&&this.m.delObject(s)}return this.m.delObject(e),!0}var l=JSDraw2.TLC.cast(t);if(null!=l&&l.removeSpot(l.curspot))return!0;if(null!=JSDraw2.RGroup.cast(t))return!1;var n=JSDraw2.Atom.cast(t);if(null!=n){if(this.delAA(n))return!0;if(0!=JSDraw2.defaultoptions.delheteroatom&&null==n.bio&&("C"!=n.elem||null!=n.alias&&""!=n.alias))return n.elem="C",n.alias=null,n._parent.setHCount(n),!0}t=t._parent.delObject(t);return t&&null!=l&&this.numberTlcPlates(),t},delSelected:function(){for(var t=!1,e=0;e<this.m.graphics.length;++e)if(null!=JSDraw2.TLC.cast(this.m.graphics[e])){t=!0;break}var i=this.m.delSelected();return 0<i&&t&&this.numberTlcPlates(),i},hasSelected:function(){var t=this.m.hasSelected();if(0<t)for(var e=0;e<this.m.graphics.length;++e)if(null!=JSDraw2.TLC.cast(this.m.graphics[e])){this.numberTlcPlates();break}return t},lassoSelect:function(t){var e;null!=this.start&&null!=this.end&&(null==(e=this.surface.extra).lasso&&(e.lasso=new JSDraw2.Lasso(e,this.linewidth,!0)),JSDraw2.Drawer.drawLine(e,t,this.end,"#aaf",this.linewidth/2),this.m.lassoSelect(e,this.start,this.end,t,this.linewidth,this.tor/8))},selectInRect:function(t){return this.m.selectInRect(t)},addTemplate:function(t,e,i){var s=JSDraw2.Atom.cast(e),l=JSDraw2.Bond.cast(e),e="[custom]"==t?JSDraw2.CustomTemplates.get(t):JSDraw2.SuperAtoms.getTemplate(t);if(null!=e){var n=e.clone();if(n.setBondLength(null==l?this.bondlength:l.bondLength()),null!=s){this._addNewAtomInExistingGroup(s,n.atoms);var r=n.atoms[0];if(!JSDraw2.SuperAtoms._alignMol(s._parent,s,n,n.atoms[0]))return;n.replaceAtom(r,s)}else if(null!=l){this._addNewAtomInExistingGroup(l.a1,n.atoms),this._addNewAtomInExistingGroup(l.a2,n.atoms);for(var o=null,a=0;a<n.bonds.length;++a)if(n.bonds[a].type!=JSDraw2.BONDTYPES.SINGLE){o=n.bonds[a];break}null==o&&(o=n.bonds[0]),n.offset(l.a1.p.x-o.a1.p.x,l.a1.p.y-o.a1.p.y);t=this._caclBondDir(this.m,l),e=this._caclBondDir(n,o);(0<t&&0<e||t<0&&e<0)&&n.flipX(l.a1.p.x);t=l.angle(),e=o.angle();n.rotate(o.a1.p.clone(),t-e),n.replaceBond(o,l)}else{r=n.atoms[0];n.offset(i.x-r.p.x,i.y-r.p.y)}for(a=0;a<n.atoms.length;++a){var r=n.atoms[a],h=JSDraw2.Atom.cast(this.toggle(r.p));null!=h&&s!=r&&n.replaceAtom(r,h)}var u=null;if(null!=s&&null!=s.group&&(u=s.group),null!=l&&null!=l.a1.group&&null!=l.a2.group&&l.a1.group==l.a2.group&&(u=l.a1.group),null!=u)for(a=0;a<n.atoms.length;++a)n.atoms[a].group=u;l=null!=s?s._parent:null!=l?l._parent:null;(null!=l?l:this.m).mergeMol(n)}},_caclBondDir:function(t,e){for(var i=0,s=t.getNeighborAtoms(e.a1,e.a2),l=0;l<s.length;++l)180<e.a1.p.angleAsOrigin(e.a2.p,s[l].p)?++i:--i;for(s=t.getNeighborAtoms(e.a2,e.a1),l=0;l<s.length;++l)180<e.a2.p.angleAsOrigin(s[l].p,e.a1.p)?++i:--i;return i},keydown:function(t){if(this.activated&&!(null!=this.texteditor.ed&&""==this.texteditor.ed.input.style.display||(null!=this.helm&&(this.helm.cancelDnD(),org.helm.webeditor.MolViewer.hide()),scil.Utils.getZindex(this.div)<scil.Utils.getMaxZindex())))if(this._keypresschar=String.fromCharCode(t.keyCode),null==t.preventDefault&&(t.preventDefault=function(){}),null!=this.contextmenu&&this.contextmenu.hide(),27==t.keyCode&&null!=this.start&&(this.start=null,this.redraw()),t.ctrlKey||t.metaKey)switch(t.keyCode){case 89:case 121:this.options.appmode||this.redo()&&this.refresh(!0);break;case 90:case 122:this.options.appmode||this.undo()&&this.refresh(!0);break;case 67:case 99:this.options.appmode||this.copy();break;case 86:case 118:!this.options.appmode&&scil.Utils.isIE&&this.paste()&&this.refresh(!0);break;case 88:case 120:this.options.appmode||this.cut()&&this.refresh(!0);break;case 65:case 97:this.selectAll()&&this.refresh(!1),t.preventDefault()}else{var e=JSDraw2.Atom.cast(this.curObject);if(8!=t.keyCode&&46!=t.keyCode){if(this.m.hasSelected()){var i=0,s=0;switch(t.keyCode){case 37:i=-1;break;case 38:s=-1;break;case 39:i=1;break;case 40:s=1}if(0!=i||0!=s)return this.pushundo(),this.m.offset(t.shiftKey?i:20*i,t.shiftKey?s:20*s,!0),this.refresh(!0),void t.preventDefault()}if(null!=this.curObject)if(null==e){var l=JSDraw2.Shape.cast(this.curObject);if(null!=l&&13==t.keyCode)return this.showTextEditor(l,l._rect.center()),void t.preventDefault();l=JSDraw2.Bond.cast(this.curObject);if(null==l){var n=JSDraw2.Text.cast(this.curObject);if(null!=n)return this.showTextEditor(n),void t.preventDefault();var r=JSDraw2.TLC.cast(this.curObject);if(null!=r&&null!=r.curspot)switch(t.keyCode){case 187:case 189:var o=this.clone();r.curspot.move((187==t.keyCode?.1:-.1)*(t.shiftKey?.1:1))&&(this.pushundo(o),this.refresh(!0)),t.preventDefault();break;case 190:this.pushundo(),r.changeSize(r.curspot,"110%"),this.refresh(!0);break;case 188:this.pushundo(),r.changeSize(r.curspot,"90%"),this.refresh(!0);break;case 82:case 76:this.pushundo(),r.curspot.rx+=t.shiftKey?-.2:.2,r.curspot.rx<.1&&(r.curspot.rx=.1),this.refresh(!0);break;case 85:this.pushundo(),r.curspot.ry1+=t.shiftKey?-.2:.2,this.refresh(!0);break;case 68:this.pushundo(),r.curspot.ry2+=t.shiftKey?-.2:.2,this.refresh(!0)}}else if(l.isBio()){n=!1,h=null;83==t.keyCode&&l.type==JSDraw2.BONDTYPES.PEPTIDE?(h=this.clone(),n=this.m.setBondType(l,JSDraw2.BONDTYPES.DISULFIDE)):49==t.keyCode&&l.type==JSDraw2.BONDTYPES.DISULFIDE&&(h=this.clone(),n=this.m.setBondType(l,JSDraw2.BONDTYPES.PEPTIDE)),n&&(this.pushundo(h),this.refresh(!0))}else{a=-1;if((a=189==t.keyCode||109==t.keyCode?10:187==t.keyCode||107==t.keyCode?11:192==t.keyCode?13:t.keyCode-48)>=JSDraw2.BONDTYPES.UNKNOWN&&a<=JSDraw2.BONDTYPES.DUMMY&&this.curObject.type!=a){h=this.clone();if(this.m.setBondType(l,a))return this.pushundo(h),l.type!=JSDraw2.BONDTYPES.WEDGE&&l.type!=JSDraw2.BONDTYPES.HASH||this.fixWedgeDir(l),void this.refresh(!0)}else if(9==a&&(l.type==JSDraw2.BONDTYPES.WEDGE||l.type==JSDraw2.BONDTYPES.HASH))return this.pushundo(),l.reverse(),void this.refresh(!0)}}else{if(e.bio)return 13==t.keyCode?(this.showTextEditor(e,e.p.clone()),void t.preventDefault()):void(null!=this.helm&&scil.helm.isHelmNode(e)?(a=String.fromCharCode(t.keyCode),null!=scil.helm.Monomers.getMonomer(e,a)&&(this.pushundo(),e.elem=a,this.refresh(!0))):(e.biotype()==JSDraw2.BIO.AA&&null!=JSDraw2.SuperAtoms.getAA(a)||e.biotype()==JSDraw2.BIO.BASE_DNA&&null!=JSDraw2.SuperAtoms.getDNA(a)||e.biotype()==JSDraw2.BIO.BASE_RNA&&null!=JSDraw2.SuperAtoms.getRNA(a))&&(a=String.fromCharCode(t.keyCode),e.selected?e.elem!=a&&(this.pushundo(),e.elem=a,this._setSuperatom(e),this.refresh(!0)):this.insertAA(e,a)));if("R"==e.elem&&49<=t.keyCode&&t.keyCode<=57){l="R"+(t.keyCode-48);e.alias!=l&&(this.pushundo(),this.m.setAtomAlias(e,l),this.refresh(!0))}else{var a=null;switch(t.keyCode){case 56:a="*";break;case 50:a="@";break;case 187:case 107:a="+";break;case 189:case 109:a="-";break;case 61:scil.Utils.isFirefox&&(a="+");break;case 173:scil.Utils.isFirefox&&(a="-");break;case 65:case 97:a="A";break;case 81:case 113:a="Q";break;case 66:case 98:a="Br";break;case 67:case 99:a="C";break;case 68:case 100:a="D";break;case 70:case 102:a="F";break;case 72:case 104:a="H";break;case 73:case 105:a="I";break;case 76:case 108:a="Cl";break;case 78:case 110:a="N";break;case 79:case 111:a="O";break;case 80:case 112:a="P";break;case 82:case 114:a="R";break;case 83:case 115:a="S";break;case 84:case 116:a="T";break;case 88:case 120:a="X";break;case 77:case 109:a="M";break;case 69:a="Me";break;case 13:return this.showTextEditor(e,e.p.clone()),void t.preventDefault()}if("+"==a||"-"==a){var h=this.clone();if(this.increaseNum(e,"+"==a?1:-1))return this.pushundo(h),void this.refresh(!0)}else if("Me"==a){var h=this.clone();if(this.m.setAtomAlias(e,a))return this.pushundo(h),void this.refresh(!0)}else if(null!=a){var h=this.clone();if(this.m.setAtomType(e,a))return this.pushundo(h),void this.refresh(!0)}}}else"seq"==this.getCmd()?(a=String.fromCharCode(t.keyCode),null!=JSDraw2.SuperAtoms.getAA(a)&&this.createAA(this.lastmove,a,JSDraw2.BIO.AA)):"helix"==this.getCmd()?(a=String.fromCharCode(t.keyCode),null!=JSDraw2.SuperAtoms.getDNA(a)&&this.createAA(this.lastmove,a,JSDraw2.BIO.BASE_DNA)):"rna"==this.getCmd()&&(a=String.fromCharCode(t.keyCode),null!=JSDraw2.SuperAtoms.getRNA(a)&&this.createAA(this.lastmove,a,JSDraw2.BIO.BASE_RNA))}else this.onDel()&&t.preventDefault()}},toCharArray:function(t,e){0<e||(e=1);for(var i=[],s=0;s<t.length;++s)i.push(t.substr(s,e));return i},splitString:function(t,e){for(var i=[],s=new RegExp("^"+e);null!=(l=s.exec(t));){var l=l+"";if(i.push(l),t.length==l.length)return i;t=t.substr(l.length)}return null},createAA2:function(t,e,i,s,l,n,r){if(!scil.Utils.isNullOrEmpty(t)){i&&(t=t.replace(/[>|\^]/g,"")),new RegExp("^[a-z|^|>]+$").test(t)&&(t=scil.Utils.trim(t).toUpperCase());var o=null;if(e==JSDraw2.BIO.BASE_DNA){if(!new RegExp("^[A|G|T|C]+$").test(t))return void scil.Utils.alert2("Invalid DNA sequence.");o=this.toCharArray(t)}if(e==JSDraw2.BIO.BASE_RNA){if(!new RegExp("^[A|G|T|C|U]+$").test(t))return void scil.Utils.alert2("Invalid RNA sequence.");o=this.toCharArray(t)}else if(e==JSDraw2.BIO.AA&&(0<(t=t.replace(/[\.]/g,"-")).indexOf("-")?o=t.split("-"):new RegExp("^([A-Z][a-z|0-9]{2}[\\^]?)+[>]?$").test(t)?o=this.splitString(t,"[A-Z][a-z|0-9]{2}[\\^|>]?"):new RegExp("^([A-Z][\\^]?)+[>]?$").test(t)&&(o=this.splitString(t,"[A-Z][\\^|>]?")),null==o))return void scil.Utils.alert2("Invalid peptide sequence.");if(3<=o.length&&scil.Utils.endswith(o[o.length-1],">")&&t.indexOf("^")<=0&&(o[0]+="^"),null==(e=i&&e==JSDraw2.BIO.AA?this._createExpandedAA(o,e,l,n):this._createCollapsedAA(o,e,l,n)))return!1;null!=l&&""!=l||(l="H"),null!=n&&""!=n||(n="OH");n=(null!=l?l+"-":"")+t+(null!=n?"-"+n:"");return null!=this.options.onAddSequence&&this.options.onAddSequence(e,n,s)?!0:(this.m.setSelected(!1),0!=r&&e.setSelected(!0),this.pushundo(),"reactant"==s||"product"==s?(r=this.m.parseRxn(),("reactant"==s?r.reactants:r.products).push(e),this.setRxn(r,!1,this.bondlength)):this.m.mergeMol(e),this.fitToWindow(),this.refresh(!0),!0)}},_createCollapsedAA:function(t,e,i,s){null!=i&&""!=i||(i="H"),null!=s&&""!=s||(s="OH");for(var l=[],n=null,r=null,o=[],a=0;a<t.length;++a){var h=t[a],u=1<h.length&&("^"==h.substr(h.length-1)||">"==h.substr(h.length-1));u&&(h=h.substr(0,h.length-1));var c=new JSDraw2.Atom(null,h,{type:e});switch(e){case JSDraw2.BIO.AA:c.superatom=JSDraw2.SuperAtoms.getAA(h);break;case JSDraw2.BIO.BASE_DNA:c.superatom=JSDraw2.SuperAtoms.getDNA(h);break;case JSDraw2.BIO.BASE_RNA:c.superatom=JSDraw2.SuperAtoms.getRNA(h)}if(null==c.superatom)return void scil.Utils.alert("It cannot parse: "+h);o.push(c),u?null==n?n=[c]:null==r?(n.push(c),r=[]):r.push(c):(null!=r?r:null!=n?n:l).push(c)}var d=JSDraw2.BONDTYPES.SINGLE;if(e==JSDraw2.BIO.AA?d=JSDraw2.BONDTYPES.PEPTIDE:e!=JSDraw2.BIO.DNA&&e!=JSDraw2.BIO.RNA||(d=JSDraw2.BONDTYPES.NUCLEOTIDE),null!=n&&1==n.length&&(l.push(n[0]),(n=null)!=r)){for(a=0;a<r.length;++a)l.push(r[a]);r=null}var p=null,f=null,m=new JSDraw2.Mol(this.options.showimplicithydrogens);0<l.length&&(p=new JSDraw2.Atom(null,"C"),m.addAtom(p),l.splice(0,0,p),(w=new JSDraw2.Bond(l[1],p,e==JSDraw2.BIO.AA?JSDraw2.BONDTYPES.PEPTIDE:JSDraw2.BONDTYPES.NUCLEOTIDE)).apo1=1,m.addBond(w)),m.addAtom(o[0]);for(var g,w,b,a=1;a<o.length;++a)m.addAtom(o[a]),(w=new JSDraw2.Bond(o[a],o[a-1],d)).apo1=1,w.apo2=2,m.addBond(w);return null==n?(g=new JSDraw2.Atom(null,e==JSDraw2.BIO.AA?"O":"3'"),m.addAtom(g),l.push(g),f=g,(w=new JSDraw2.Bond(g,l[l.length-2],e==JSDraw2.BIO.AA?JSDraw2.BONDTYPES.PEPTIDE:JSDraw2.BONDTYPES.NUCLEOTIDE)).apo2=2,m.addBond(w)):(0!=l.length||null!=r&&0!=r.length?"C"==n[0].elem&&"C"==n[n.length-1].elem?((w=new JSDraw2.Bond(n[0],n[n.length-1],JSDraw2.BONDTYPES.DISULFIDE)).apo1=3,w.apo2=3,m.addBond(w)):"K"!=n[0].elem||null!=r&&0!=r.length||((w=new JSDraw2.Bond(n[0],n[n.length-1],JSDraw2.BONDTYPES.AMIDE)).apo1=3,w.apo2=2,m.addBond(w)):((w=new JSDraw2.Bond(n[0],n[n.length-1],JSDraw2.BONDTYPES.PEPTIDE)).apo1=1,w.apo2=2,m.addBond(w)),null!=r&&0<r.length&&(f=new JSDraw2.Atom(null,"C"),m.addAtom(f),r.push(f),(w=new JSDraw2.Bond(r[r.length-2],f,JSDraw2.BONDTYPES.SINGLE)).apo1=1,m.addBond(w))),null==n||1==n.length?(b=null,this.layoutAtoms(l,"line",this.bondlength,b),0<l.length&&(b=l[l.length-1]),null!=n&&(this.layoutAtoms(n,"line",this.bondlength,b),0<n.length&&(b=n[n.length-1]),null!=r&&this.layoutAtoms(r,"line",this.bondlength,b))):(b=new JSDraw2.Point(0,0),this.layoutAtoms(n,"circle",this.bondlength,b.clone().offset(1,0),b),0<l.length&&(l.push(null),l.reverse(),this.layoutAtoms(l,"line",this.bondlength,n[0].p,b)),null!=r&&0<r.length&&(r.splice(0,0,null),this.layoutAtoms(r,"line",this.bondlength,n[n.length-1].p,b))),null!=p&&(e==JSDraw2.BIO.AA?"H"==i?p.elem="H":m.setAtomAlias(p,i):p.elem="5'"),null!=f&&(e==JSDraw2.BIO.AA?"OH"==s?f.elem="O":"NH2"==s?f.elem="N":m.setAtomAlias(f,s):f.elem="3'"),m},_createExpandedAA:function(t,e,i,s){null!=i&&""!=i||(i="H"),null!=s&&""!=s||(s="OH");for(var l=null,n=null,r=0;r<t.length;++r){var o=t[r],a=JSDraw2.SuperAtoms.getAA(o);if(null==a)return scil.Utils.alert("Unknow Amino Acid: "+o),null;(a=a.clone()).setBondLength(this.bondlength);for(var h=JSDraw2.SuperAtoms._getAttachAtoms(a),u=2;u<h.length;++u)h[u].a.attachpoints=[];if(0!=r){if(r%2==1){for(u=0;u<a.atoms.length;++u)a.atoms[u].p.y*=-1;for(u=0;u<a.bonds.length;++u)a.bonds[u].type==JSDraw2.BONDTYPES.WEDGE?a.bonds[u].type=JSDraw2.BONDTYPES.HASH:a.bonds[u].type==JSDraw2.BONDTYPES.HASH&&(a.bonds[u].type=JSDraw2.BONDTYPES.WEDGE)}var o=h[0].a.p,c=this._guessAutoBond(n);a.offset(c.x-o.x,c.y-o.y),l.mergeMol(a),n.attachpoints=[],h[0].a.attachpoints=[];var d=new JSDraw2.Bond(n,h[0].a,JSDraw2.BONDTYPES.SINGLE);l.addBond(d),n=h[1].a}else{var p,l=a;h[0].a.attachpoints=[],"H"!=i&&(c=this._guessAutoBond(h[0].a),p=new JSDraw2.Atom(c,"C"),d=new JSDraw2.Bond(h[0].a,p,JSDraw2.BONDTYPES.SINGLE),l.addAtom(p),l.addBond(d),l.setAtomAlias(p,i)),n=h[1].a}}return null!=n&&(n.attachpoints=[],"H"!=s&&(c=this._guessAutoBond(n),p=new JSDraw2.Atom(c,"C"),d=new JSDraw2.Bond(n,p,JSDraw2.BONDTYPES.SINGLE),l.addAtom(p),l.addBond(d),"OH"==s?p.elem="O":l.setAtomAlias(p,s))),l},layoutAtoms:function(t,e,i,s,l){if(null!=t&&0!=t.length)switch(null==l&&(l=new JSDraw2.Point(0,0)),null==s&&(s=l.clone().offset(i,0)),e){case"line":null!=t[0]&&(t[0].p=s.clone());for(var n=i/s.distTo(l),r=(s.x-l.x)*n,o=(s.y-l.y)*n,a=1;a<t.length;++a)t[a].p=s.clone().offset(r*a,o*a);break;case"circle":var h=360/t.length,n=i/2/Math.sin(h/2*Math.PI/180)/s.distTo(l);s=new JSDraw2.Point(l.x+(s.x-l.x)*n,l.y+(s.y-l.y)*n),null!=t[0]&&(t[0].p=s.clone());for(a=1;a<t.length;++a)t[a].p=s.clone().rotateAround(l,h*a)}},createAA:function(t,e,i){var s,l;null!=t&&(this.pushundo(),l=new JSDraw2.Atom(t.clone().offset(-this.bondlength,0),i==JSDraw2.BIO.AA?"H":"5'"),(s=new JSDraw2.Atom(t.clone(),e,{type:i})).superatom=null,i==JSDraw2.BIO.AA?s.superatom=JSDraw2.SuperAtoms.getAA(e):i==JSDraw2.BIO.BASE_DNA?s.superatom=JSDraw2.SuperAtoms.getDNA(e):i==JSDraw2.BIO.BASE_RNA&&(s.superatom=JSDraw2.SuperAtoms.getRNA(e)),i=new JSDraw2.Atom(t.clone().offset(this.bondlength,0),i==JSDraw2.BIO.AA?"O":"3'"),this.m.addAtom(l),this.m.addAtom(s),this.m.addAtom(i),l=new JSDraw2.Bond(l,s,JSDraw2.BONDTYPES.SINGLE),s.apo2=2,this.m.addBond(l),l=new JSDraw2.Bond(s,i,JSDraw2.BONDTYPES.SINGLE),s.apo1=1,this.m.addBond(l),this.curObject=s,this.refresh(!0))},delAA:function(t){if(null==t||t.biotype()!=JSDraw2.BIO.AA&&t.biotype()!=JSDraw2.BIO.BASE_DNA&&t.biotype()!=JSDraw2.BIO.BASE_RNA)return!1;var e=this.findNextAA(t,!1);if(null==e)return!1;this.m.delBond(e.b,!1),this.m.getFragment(e.a).offset(t.p.x-e.a.p.x,t.p.y-e.a.p.y);for(var i=this.m.getNeighborBonds(t),s=0;s<i.length;++s){var l=i[s];l.a1==t?l.a1=e.a:l.a2==t&&(l.a2=e.a)}return t._parent.delAtom(t),!0},_setSuperatom:function(t){t.superatom=null;var e=t.elem;switch(t.biotype()){case JSDraw2.BIO.BASE_DNA:t.superatom=JSDraw2.SuperAtoms.getDNA(e);break;case JSDraw2.BIO.BASE_RNA:t.superatom=JSDraw2.SuperAtoms.getRNA(e);break;case JSDraw2.BIO.AA:t.superatom=JSDraw2.SuperAtoms.getAA(e)}},insertAA:function(t,e){var i,s,l;null!=t&&t.bio&&(t.biotype()==JSDraw2.BIO.AA&&null==JSDraw2.SuperAtoms.getAA(e)||t.biotype()==JSDraw2.BIO.BASE_DNA&&null!=JSDraw2.SuperAtoms.getDNA(e)||t.biotype()==JSDraw2.BIO.BASE_RNA&&null!=JSDraw2.SuperAtoms.getRNA(e)||(i=this.bondlength,s=this.findNextAA(t,!0),this.pushundo(),l=new JSDraw2.Atom(t.p.clone().offset(i,0),e,dojo.clone(t.bio)),e=new JSDraw2.Bond(l,t,t.biotype()==JSDraw2.BIO.AA?JSDraw2.BONDTYPES.PEPTIDE:JSDraw2.BONDTYPES.SINGLE),this.m.addAtom(l),this.m.addBond(e),this._setSuperatom(l),e.apo1=1,e.apo2=2,null!=s&&(this.m.delBond(s.b,!1),this.m.getFragment(s.a).offset(i,0),(t=new JSDraw2.Bond(s.a,l,t.biotype()==JSDraw2.BIO.AA?JSDraw2.BONDTYPES.PEPTIDE:JSDraw2.BONDTYPES.SINGLE,!0)).apo1=1,t.apo2=2,this.m.addBond(t)),this.curObject=l,this.refresh(!0)))},findNextAA:function(t,e){var i=this.m.getNeighborBonds(t);if(0==i.length)return null;if(1==i.length)return{a:i[0].otherAtom(t),b:i[0]};for(var s=null,l=i.length-1;0<=l;--l){var n=i[l].otherAtom(t);if(Math.abs(t.p.y-n.p.y)<this.tor/2)if(n.p.x<t.p.x)s=i[l],i.splice(l,1);else if(n.p.x>=t.p.x)return{a:n,b:i[l]}}for(var r=null,l=0;l<i.length;++l){var o=i[l],n=o.otherAtom(t);null!=r&&(e||!o.isBio()||r.b.isBio())?n.p.x<t.p.x&&r.a.p.x<t.p.x||n.p.x>t.p.x&&r.a.p.x>t.p.x?n.p.y>r.a.p.y&&(r={a:n,b:o}):n.p.x>t.p.x&&(r={a:n,b:o}):r={a:n,b:o}}return null==r?{a:s.otherAtom(t),b:s}:e||r.a.bio||!(n=s.otherAtom(t)).bio?r:{a:n,b:s}},findNextAAs:function(t,e){for(var i=[];null!=t;){var s=this._findNextAA(t,e);if(null==s)break;i.push(s),t=s.a}return i},_findNextAA:function(t,e){for(var i=this.m.bonds,s=0;s<i.length;++s){var l=i[s].otherAtom(t);if(null!=l&&Math.abs(l.p.y-t.p.y)<this.tor/2&&(e&&l.p.x>t.p.x||!e&&l.p.x<t.p.x))return{b:i[s],a:l}}return null},setSize:function(t,e){null!=this.maintable?(0<t&&(this.maintable.style.width=t+"px"),0<e&&(this.maintable.style.height=e+"px"),this.isSkinW8()?this.resize(t,e-24):this.resize(t-28,e-24)):this.resize(t,e)},onResize:function(t,e){null!=this.options.onresize&&this.options.onresize()||this.resize(0<t?t:this.div.offsetWidth,0<e?e:this.div.offsetHeight)},resize:function(t,e){scil.Utils.isIpad&&(null!=scil.eln||null!=scil.App&&null!=scil.App.AccountTypes)||this._setSurfaceSize(new JSDraw2.Point(t,e))&&this.isSkinW8()&&null!=this.toolbar&&this.toolbar.recreateTopToolbar()},_setSurfaceSize:function(t){return!(Math.abs(t.x-this.dimension.x)<6&&Math.abs(t.y-this.dimension.y)<6)&&(0<t.x&&(this.dimension.x=t.x),0<t.y&&(this.dimension.y=t.y),this.div.style.width=this.dimension.x+"px",this.div.style.height=this.dimension.y+"px",this.surface.setDimensions(this.dimension.x,this.dimension.y),this.fitToWindow(),this.redraw(),!0)},dblclick:function(){if(this.popuplocked)return scil.Utils.alert("Editing is currently locked"),!1;var e=this;JSDraw2.Editor.showPopup("JSDraw2 Popup Editor","Save",function(t){e.restoreClone(t.clone()),e.fitToWindow(),e.refresh(!0),null!=e.options.onpopupsaved&&e.options.onpopupsaved(e)},{value:this.clone(),format:"clone"})},_makeChain:function(t,e){if(null==t||null!=t.end&&t.end.distTo(e)<this.tor)return!1;e.distTo(t.start)<2*this.bondlength&&(t.p2=e),t.end=e,t.points=[];var i=t.start.distTo(e),s=t.start,l=null==t.a?Math.abs(e.y-s.y)/Math.abs(e.x-s.x)<.1?s.clone().offset(this.bondlength*(e.x>s.x?1:-1),0).rotateAround(s,30):this._guessBond(s,t.p2,!0):this._guessAutoBond(t.a,e);if(null==l)return!1;t.points=[t.start],t.points.push(l);for(var n=t.start.distTo(l);0!=n&&n<i;){var r,o,a=l;2==t.points.length?(r=s.clone().rotateAround(a,120),o=s.clone().rotateAround(a,-120),o=r.distTo(e)<o.distTo(e)?(l=r,120):(l=o,-120)):(o=-o,l=s.clone().rotateAround(a,o)),s=a,t.points.push(l),n=t.start.distTo(l)}return!0},_guessAutoBond:function(t,e){if(null==t)return null;if(null==e)return t._parent.guessBond(t,this.bondlength);var i,s,l,n=null,r=t._parent.getNeighborAtoms(t);return 0==r.length?(n=t.p.clone().offset(this.bondlength,0),null!=e&&(i=30*Math.round(e.angleTo(t.p)/30),n.rotateAround(t.p,i))):1==r.length?(n=(s=r[0]).p.clone().rotateAround(t.p,-120),null==e||(l=s.p.clone().rotateAround(t.p,120)).distTo(e)<n.distTo(e)&&(n=l)):2==r.length&&(s=r[0],l=r[1],r=s.p.angleTo(t.p),l=t.p.middleAngle(s.p,l.p),n=s.p.clone().rotateAround(t.p,l-r+180)),n},_addAutoBond:function(t,e){var i=t._parent,s=this._guessAutoBond(t);if(null==s)return!1;var l=null,n=this._countAABonds(t),e=this.Cmd2BondType(e);if(null!=n)if(0==n.peptideN&&0==n.others)l="H",e=JSDraw2.BONDTYPES.PEPTIDE;else{if(0!=n.peptideC||0!=n.others)return!1;l="O"}n=JSDraw2.Atom.cast(this.toggle(s));if(null!=n&&n._parent!=t._parent&&(n=null),null==n)n=new JSDraw2.Atom(s,l),this._addNewAtomInExistingGroup(t,[n]),i.addAtom(n),null!=t.group&&(n.group=t.group);else if(null!=i.findBond(t,n))return!1;e=new JSDraw2.Bond(t,n,e);return i.addBond(e,null,!0),!0},_guessBond:function(t,e,i){if(!i&&t.distTo(e)<this.tor)return null;i=e.angleTo(t),e=Math.abs(i)%this.angleStop,i=0<i?i-e+(e>this.angleStop/2?this.angleStop:0):-(-i-e+(e>this.angleStop/2?this.angleStop:0));return new JSDraw2.Point(this.bondlength,0).rotate(i).offset(t.x,t.y)},guessArrow:function(t,e){if(t.distTo(e)<this.bondlength)return null;var i=e.angleTo(t)%90;if(0==i)return e;var s=0;if(i<5)s=-i;else{if(!(90-i<5))return e;s=90-i}return e.clone().rotateAround(t,s)},frameoffset:{x:0,y:0},setFrameoffset:function(t,e){this.frameoffset.x=t,this.frameoffset.y=e},eventPoint:function(t){var e=scil.Utils.getOffset(this.div,!0),e=new JSDraw2.Point(t.clientX-e.x-this.frameoffset.x,t.clientY-e.y-this.frameoffset.y);return e.tm=(new Date).getTime(),e.clientX=t.clientX,e.clientY=t.clientY,e},getCmd:function(t){null==t&&(t=this.curButton);t=null==t?"select":t.getAttribute("cmd");return 2<t.length&&"e-"==t.substr(0,2)&&(t=t.substr(2)),t},onSelBtn:function(t){var e=t.target||t.srcElement;if(null==e.getAttribute("cmd"))for(var i=0;i<5;++i){if(null==(e=e.parentNode)||"TD"!=e.tagName)return;if(null!=e.getAttribute("cmd"))return void this.onCmd(e)}else this.onCmd(e)},doCmd:function(t){if(null!=this.toolbar)for(var e=this.toolbar.getButtons(),i=0;i<e.length;++i){var s=e[i];if("si"==this.options.skin&&(s=s.parentNode),s.getAttribute("cmd")==t){this.onCmd(s);break}}},onCmd:function(t){var e=!0;this.start=null;var i,s=this.getCmd(t);switch(JSDraw2.Menu.close(),s){case"about":case"jsdraw":JSDraw2.Editor.showAbout();break;case"inkclearall":null!=this.ink&&this.ink.clear();break;case"inkclear":null!=this.ink&&this.ink.clearLastOne();break;case"center":this.pushundo(),this.fitToWindow(),this.redraw();break;case"zoomin":this.pushundo(),this.scale(1.25,new JSDraw2.Point(this.dimension.x/2,this.dimension.y/2)),this.redraw(),e=!1;break;case"zoomout":this.pushundo(),this.scale(.75,new JSDraw2.Point(this.dimension.x/2,this.dimension.y/2)),this.redraw(),e=!1;break;case"new":this.m.isEmpty()?null!=this.ink&&this.ink.clear():(i=this,scil.Utils.confirmYes("Clear all contents?",function(){i.pushundo(),i.clear(null,!0),i.refresh(!0),null!=i.options.filenew&&i.options.filenew(i)},this));break;case"save":null!=this.options.filesave?this.options.filesave(this):scil.Utils.serviceAvailable()?JSDraw2.JSDrawIO.jsdFileSave(this):this.onShowSaveFileDlg();break;case"open":null!=this.options.fileopen?this.options.fileopen(this):scil.Utils.serviceAvailable()?JSDraw2.JSDrawIO.jsdFileOpen(this):this.onShowOpenFileDlg();break;case"undo":this.undo()&&this.refresh(!0),e=!0;break;case"redo":this.redo()&&this.refresh(!0),e=!0;break;case"rxn":var l=this.clone();this.cleanupRxn(this.bondlength)&&(this.pushundo(l),this.refresh(!0));break;case"copyprod":var n=this.m.parseRxn(!0);if(null!=n&&0<n.reactants.length&&0==n.products.length){this.pushundo();for(var r=0;r<n.reactants.length;++r)n.products.push(n.reactants[r].clone());this.setRxn(n,!1),this.refresh(!0)}else scil.Utils.alert("It's already a reaction");break;case"rxnmap2":l=this.clone();0<this.m.clearAtomMap()?(this.pushundo(l),this.refresh(!0)):scil.Utils.alert("No reaction map found");break;case"seq":JSDraw2.SequenceBuilder.show(this,JSDraw2.BIO.AA,"Peptide");break;case"helix":JSDraw2.SequenceBuilder.show(this,JSDraw2.BIO.BASE_DNA,"DNA");break;case"rna":JSDraw2.SequenceBuilder.show(this,JSDraw2.BIO.BASE_RNA,"RNA");break;case"n2s":JSDraw2.JSDrawIO.name2structure(this);break;case"cleanup":JSDraw2.JSDrawIO.cleanup(this);break;case"selectall":this.selectAll()&&this.redraw();break;case"copy":this.copy();break;case"cut":this.cut()&&this.redraw();break;case"paste":this.paste()&&this.redraw();break;case"fliph":this.flip("hori");break;case"flipv":this.flip("vert");break;case"reaxys":case"scifinder":case"pubchem":case"chemspider":this.sendQuery(s),e=!0;break;case"chemdraw":JSDraw2.ChemdrawPopup.show(this),e=!0;break;case"eraser":this.onDel()||(e=!1);break;case"...":case"more":this.showPT(),e=!1;break;case"pastechemdraw":JSDraw2.ChemDraw.paste(this);break;case"copychemdraw":JSDraw2.ChemDraw.copy(this);break;case"symbol":this.showSymbolDlg();break;case"template.[custom]":this.showTemplatesDlg(),e=!1;break;case"tlctemplate":JSDraw2.TLCTemplates.show(!0,this);break;case"tlcnumber":this.numberTlcPlates();break;case"fullscreen":case"fullscreen2":null!=JSDraw2.Fullscreen&&JSDraw2.Fullscreen.show(this),e=!0;break;case"helm_import":null!=this.helm&&this.helm.showImportDlg(),e=!0;break;case"helm_find":null!=this.helm&&this.helm.showFindReplaceDlg(),e=!0;break;case"helm_mex":null!=this.helm&&scil.helm.MonomerExplorer.showDlg(this),e=!0;break;case"helm_layout":null!=this.helm&&this.helm.clean(null,!0),e=!0;break;default:e=!1}e||this.onCmd2(t)},onCmd2:function(t){if("rxnmap"==this.getCmd(t)){var e=this.m.parseRxn();if(null==e||0==e.reactants.length||0==e.products.length)return void scil.Utils.alert("Please draw a completed reaction first.")}e=dojo.attr(t,"parent"),e=null==e?null:dojo.byId(e);null!=e&&(this.toolbar.exchangeButton(e,t),t=e),this.curButton!=t&&("w8"==this.options.skin?(null!=this.curButton&&(dojo.style(this.curButton,{backgroundImage:scil.Utils.imgSrc("w8/"+this.options.buttonshape+".png",!0)}),this.curButton.removeAttribute("pushed")),t.setAttribute("pushed",1),dojo.style(t,{backgroundImage:scil.Utils.imgSrc("w8/"+this.options.buttonshape+"0.png",!0)})):"si"==this.options.skin?(null!=this.curButton&&(dojo.style(this.curButton,{background:""}),this.curButton.removeAttribute("pushed")),t.setAttribute("pushed",1),dojo.style(t,{background:JSDraw2.Skin.jsdraw.btnselcolor})):(null!=this.curButton&&dojo.style(this.curButton,{border:"none",padding:"2px"}),dojo.style(t,{border:"solid 1px",borderColor:"#c0c0c0 #f5f5f5 #f5f5f5 #c0c0c0",padding:"1px"})),this.curButton=t)},flip:function(t){if(!this.m.isEmpty()){for(var e=[],i=this.m.atoms,s=0;s<i.length;++s)i[s].selected&&e.push(i[s]);if(0==e.length){for(var l=this.m.graphics,s=0;s<l.length;++s)l[s].selected&&null!=JSDraw2.Curve.cast(l[s])&&e.push(l[s]);if(0!=e.length){this.pushundo();for(s=0;s<e.length;++s)e[s].flip();return void this.refresh(!0)}}var n,r=null,o=null,a=null;if(0==e.length?(a=this.getCenter(),e=i):1==e.length?(a=e[0].p.clone(),null!=(n=this.getFragment(e[0]))&&(e=n.atoms)):2==e.length&&null!=(r=this.m.findBond(e[0],e[1]))?(a=r.center(),null!=(n=this.getFragment(e[0]))&&(e=n.atoms)):1==(n=this.getConnectingAtomBonds(e)).length?a=((r=n[0].b).a1.f?r.a1:r.a2).p.clone():2==n.length?o={a1:n[0].a,a2:n[1].a}:a=this.getCenter(e),null!=r&&(o={a1:r.a1,a2:r.a2}),this.pushundo(),null!=o){r=o.a2.p.angleTo(o.a1.p);a=o.a1.p.clone(),this.rotate(e,a,-r);for(s=0;s<e.length;++s)(h=e[s].p).y=a.y-(h.y-a.y);this.rotate(e,a,r)}else if("vert"==t)for(s=0;s<e.length;++s)(h=e[s].p).y=a.y-(h.y-a.y);else for(var h,s=0;s<e.length;++s)(h=e[s].p).x=a.x-(h.x-a.x);this._invertStereoBonds(e),this.refresh(!0)}},_invertStereoBonds:function(t){t.length,this.m.atoms.length;for(var e=0;e<this.m.bonds.length;++e){var i=this.m.bonds[e];i.type!=JSDraw2.BONDTYPES.WEDGE&&i.type!=JSDraw2.BONDTYPES.HASH||(0<=scil.Utils.indexOf(t,i.a1)||0<=scil.Utils.indexOf(t,i.a2))&&(i.type=i.type==JSDraw2.BONDTYPES.WEDGE?JSDraw2.BONDTYPES.HASH:JSDraw2.BONDTYPES.WEDGE)}},sendQuery:function(t){var e,i=this.getSmiles();if(null!=i&&""!=i){switch(t.toLowerCase()){case"pubchem":e="http://pubchem.ncbi.nlm.nih.gov/search/search.cgi?cmd=search&q_type=dt&simp_schtp=fs&q_data=";break;case"chemspider":e="http://www.chemspider.com/Search.aspx?q=";break;case"reaxys":case"scifinder":e="https://www.reaxys.com/reaxys/secured/hopinto.do?context=S&query=";break;default:return}e+=escape(i),window.open(e,"_blank")}else scil.Utils.alert("No query structure drawn")},onShowOpenFileDlg:function(){var t,e=JSDraw2.Editor;null==e.openfiledlg&&(t={filetype:{label:"File Type",type:"select",items:"Lite"==JSDraw2.Security.kEdition?this.options.helmtoolbar?{helm:"HELM",xhelm:"xHELM"}:{mol:"Mol File"}:jsd.options.tlcplate?JSDraw2.JSDrawIO.jsdFiles2:JSDraw2.JSDrawIO.jsdFiles},contents:{label:"Contents",type:"textarea",width:800,height:400}},e.openfiledlg=scil.Form.createDlgForm("Import File",t,{label:"Import",onclick:function(){e.onOpenFile()}})),e.openfiledlg.show(),e.openfiledlg.form.setData({}),e.openfiledlg.jsd=this},onShowSaveFileDlg:function(){var t,e=JSDraw2.Editor;null==e.savefiledlg&&(t={filetype:{label:"File Type",type:"select",items:"Lite"==JSDraw2.Security.kEdition?this.options.helmtoolbar?{helm:"HELM",xhelm:"xHELM"}:{mol:"Mol File"}:jsd.options.tlcplate?JSDraw2.JSDrawIO.jsdFiles2:JSDraw2.JSDrawIO.jsdFiles},contents:{label:"Contents",type:"textarea",width:800,height:400}},e.savefiledlg=scil.Form.createDlgForm("Export File",t,null,{onchange:function(t){t==e.savefiledlg.form.fields.filetype&&e.onSaveFile()}})),e.savefiledlg.show(),e.savefiledlg.form.setData({}),e.savefiledlg.jsd=this},onPT:function(t){JSDraw2.Editor.periodictable.hide(),null!=t&&(this.ptElement=t)},showPT:function(t){JSDraw2.needPro()},showAtomDlg:function(t){JSDraw2.needPro()},setAtomProps:function(t){JSDraw2.needPro()},showBondDlg:function(t){JSDraw2.needPro()},setBondProps:function(t){JSDraw2.needPro()},setJdx:function(t){var e=new JSDraw2.Mol;e.setJdx(t,this.bondlength),this.setMol(e)},getData:function(t){return"mol"==t?this.getMolfile():"mol3000"==t?this.getMolfile(!0):"rxn"==t?this.getRxnfile():"rxn3000"==t?this.getRxnfile(null,!0):"xml"==t?this.getXml():"helm"==t?this.getHelm():"xhelm"==t?this.getXHelm():"smiles"==t?this.m.getSmiles():"helm"==t?this.getHelm():"xhelm"==t?this.getXHelm():null},setData:function(t,e){this.setFile(t,e)},setFile:function(t,e){var i=null;if("mol"==e)i=this.m.setMolfile(t);else if("rxn"==e)i=this.m.setRxnfile(t);else if("xml"==e)i=this.m.setXml(t);else{if("helm"==e)return void this.setHelm(t);if("xhelm"==e)return void this.setXHelm(t);if("jdx"!=e)return;i=this.m.setJdx(t,this.bondlength)}if(null!=i)return this.setMol(i),this.m;this.clear(!0)},setMol:function(t){return null!=t&&"object"==typeof t&&"MOL"==t.T&&(this.m=t,this.m.showimplicithydrogens=this.options.showimplicithydrogens,this.options.removehydrogens&&this.m.removeHydrogens(),this.m.calcHCount(),this.m.toScreen(this.bondlength),this.fitToWindow(),this._setmol(this.m),this.refresh(!0),!0)},setMolfile:function(t){this.setFile(t,"mol")},setRxnfile:function(t){this.setFile(t,"rxn")},getMolfile:function(t,e){return this.m.bondlength=this.bondlength,this.m.getMolfile(!1,t,e)},getSvg:function(){if("svg"!=dojox.gfx.renderer)return null;var t=this.m.rect();t.inflate(20,20);var e=dojox.gfx.utils;this.m.offset(-t.left,-t.top),this.redraw();e=e._cleanSvg(e._innerXML(this.surface.rawNode));return this.m.offset(t.left,t.top),this.redraw(),e=(e=e.replace(/ width="[0-9]+"/,' width="'+Math.round(t.width)+'"')).replace(/ height="[0-9]+"/,' height="'+Math.round(t.height)+'"')},getXml:function(t,e,i,s){var l=null;try{l=s?this.getSvg():null}catch(t){}return this.m.bondlength=this.bondlength,this.m.getXml(0<t?t:this.dimension.x,0<e?e:this.dimension.y,i,l,this.bondlength)},getHtml:function(t,e,i,s){return this.getXml(t,e,i,s)},getSequence:function(t){return null==this.helm?null:this.helm.getSequence(t)},getHelm:function(t){return null==this.helm?null:this.helm.getHelm(t)},setHelm:function(t){return null==this.helm?null:this.helm.setHelm(t)},getXHelm:function(){return null==this.helm?null:this.helm.getXHelm()},setXHelm:function(t){return null==this.helm?null:this.helm.setXHelm(t)},setXml:function(t,e){var i="string"==typeof t?scil.Utils.parseXml(t):t;if(null==i)return"string"==typeof t&&0<t.indexOf("M  END")?this.setMolfile(t):void 0;if(null==this.helm||!this.helm.isXHelm(i)){this.clear();var s=null,s="string"==typeof t?null==i?null:i.documentElement||i.firstElementChild:t;return this.m.setXml(s),this.m.calcHCount(),0<this.m.bondlength?(this.m.scale(JSDraw2.Editor.BONDLENGTH/this.m.bondlength),this.resetScale()):this.m.toScreen(this.bondlength),this.fitToWindow(),this._setmol(this.m),this.refresh(null==e||e),this.m}this.setXHelm(i)},setHtml:function(t){return this.setXml(t)},getRxnfile:function(t,e){return this.m.getRxnfile(t,e)},getSmiles:function(){return this.m.getSmiles()},setMolbase64:function(t){t=JSDraw2.Base64.decode(t);this.setMolfile(t)},setRxnbase64:function(t){t=JSDraw2.Base64.decode(t);this.setRxnfile(t)},getMolbase64:function(){var t=this.m.getMolfile();return JSDraw2.Base64.encode(t)},hasHelmNodes:function(){if(null==this.helm)return!1;for(var t=0;t<this.m.atoms.length;++t)if(scil.helm.isHelmNode(this.m.atoms[t]))return!0;return!1},getFormula:function(t){return this.hasHelmNodes()?this.helm.getMF(t):this.m.getFormula(t)},getMolWeight:function(){return this.hasHelmNodes()?this.helm.getMW():this.m.getMolWeight()},getExtinctionCoefficient:function(){return this.hasHelmNodes()?this.helm.getExtinctionCoefficient():null},getExactMass:function(){return this.m.getExactMass()},setAny:function(t,e){var i;scil.Utils.serviceAvailable()&&null!=t&&0!=t.length&&(i=this,e={url:scil.Utils.scriptUrl()+"Service.aspx?cmd=tomolfile",postData:"input="+escape(t)+"&fmt="+escape(e),handleAs:"json",load:function(t){t.success?(i.pushundo(i.clone()),i.setMolfile(t.result)):scil.Utils.alert(t.error)},error:function(t){scil.Utils.alert(t.message)}},dojo.rawXhrPost(e))},highlight:function(t){var e=null;if(null==(e="string"==typeof t?new JSDraw2.Mol(this.options.showimplicithydrogens).setMolfile(t):"MOL"==t.T?t:t.m))return!1;e=e.aamap(this.m,!1,!0);return this.redraw(),null!=e},sss:function(t){return t.highlight(this)},res:function(t){return JSDraw2.Language.res(t)},isSkinW8:function(){return"w8"==this.options.skin||"si"==this.options.skin},download:function(t,e){var i=this;scil.Utils.download(t,function(t){null!=t.ret?i.setFile(t.ret.molfile,e):i.setFile(t,e)})},writeCookie:function(t,e){null!=t&&0!=t.length||(t="__jsdraw_cookie_structure"),0<e||(e=30);var i=this.getXml();scil.Utils.createCookie(t,i,e)},readCookie:function(t){null!=t&&0!=t.length||(t="__jsdraw_cookie_structure");t=scil.Utils.readCookie(t);this.setXml(t)},destroy:function(){if(this.div=null,this.curObject=null,this.curButton=null,this.texteditor={input:null,text:null,atom:null},(this.maintable=null)!=this.toolbar&&(this.toolbar.destroy(),this.toolbar=null),null!=this.surface){try{this.surface.destroy()}catch(t){}this.surface=null}for(var t=0;t<this.connectHandlers.length;++t)dojo.disconnect(this.connectHandlers[t]);this.connectHandlers=null},bodyMouseDown:function(t){var e,i=t.target||t.srcElement;null==this.texteditor.ed||!this.texteditor.ed.isVisible()||this.texteditor.ed.isChildOf(i)||null!=JSDraw2.Symbol&&JSDraw2.Symbol.isFrom(i)?null!=this.texteditor.ed&&this.texteditor.ed.isChildOf(i)||null!=this.contextmenu&&this.contextmenu.isFrom(i)||(null!=(e=scil.Dialog.getDialog(i))&&e.owner==this||null!=this._testdeactivation&&this._testdeactivation(t,this)||(i=scil.Utils.hasAnsestor(i,this.surface.children[0].rawNode)||this.isFromSvgGroup(i)||scil.Utils.hasAnsestor(i,this.maintable),this.activated?i||this.activate(!1):i&&this.activate(!0))):this.hideTextEditor()},isFromSvgGroup:function(t){if("svg"!=dojox.gfx.renderer)return!1;t=scil.Utils.getParent(t,"g");return null!=t&&t.getAttribute("__surface_parentid")==this.id},bodyTouchStart:function(t){var e;this.activated&&0<t.touches.length&&(e=(e=t.touches[0]).target||e.srcElement,scil.Utils.hasAnsestor(e,this.maintable)||this.activate(!1)),this.bodyMouseDown(t)},touchClick:function(t){if(!this.activated)return this.activate(!0),t.preventDefault(),!1},touch:{reset:function(t){null!=this.cloned&&(t.pushundo(this.cloned),t.setModified(!0)),this.center=null,this.start1=null,this.start2=null,this.end1=null,this.end2=null,this.gesture=null,this.deg=null,this.scale=null,this.cloned=null}},resetGesture:function(){this.touch.reset(this)},holding:{delay:1e3,tor:2,e:null,tm:null,timer:null,jsd:null,start:function(t,e){var i;(scil.Utils.isTouch||window.navigator.msPointerEnabled)&&(this.end(),this.e={clientX:t.clientX,clientY:t.clientY},this.tm=(new Date).getTime(),this.jsd=e,(i=this).timer=setTimeout(function(){i.timeout()},this.delay))},end:function(){null!=this.timer&&(this.e=null,this.tm=null,clearTimeout(this.timer),this.timer=null)},timeout:function(){null!=this.e&&(this.jsd.start=null,this.jsd.showContextMenu(this.e,this.jsd.options.viewonly)),this.end()},move:function(t){null!=this.e&&(Math.abs(t.clientX-this.e.clientX)>this.tor||Math.abs(t.clientY-this.e.clientY)>this.tor)&&this.end()}},touchStart:function(t){if(this.activated)return JSDraw2.Menu.isOpen()?(JSDraw2.Menu.close(),t.preventDefault(),!1):1==t.touches.length?(this.mousedown(t.touches[0]),t.preventDefault(),!1):2==t.touches.length?(this.lastmove=null,this.resetGesture(),this.touch.start1=this.eventPoint(t.touches[0]),this.touch.start2=this.eventPoint(t.touches[1]),this.touch.center=new JSDraw2.Point((this.touch.start1.x+this.touch.start2.x)/2,(this.touch.start1.y+this.touch.start2.y)/2),t.preventDefault(),!1):void 0},touchMove:function(t){if(this.activated){if(1==t.touches.length)return this.mousemove(t.touches[0]),t.preventDefault(),this.resetGesture(),!1;if(this.holding.end(),null!=this.ink&&this.ink.cancel(),this.start=null,2==t.touches.length){var e,i,s,l,n,r=this.eventPoint(t.touches[0]),o=this.eventPoint(t.touches[1]);return null==this.touch.start1?(this.touch.start1=r,void(this.touch.start2=o)):r.equalsTo(this.touch.end1)&&o.equalsTo(this.touch.end2)?void 0:(this.touch.end1=r,this.touch.end2=o,null==this.touch.gesture&&null!=this.touch.start1&&null!=this.touch.start2&&(e=this.touch.end1.distTo(this.touch.start1),r=this.touch.end2.distTo(this.touch.start2),(25<e||25<r)&&(i=this.touch.end1.angleTo(this.touch.start1),s=this.touch.end2.angleTo(this.touch.start2),o=Math.abs(i-s),8<e&&8<r&&(o<30||Math.abs(o-360)<30)?this.touch.gesture="moving":(e=25<e?this.touch.start1.angleAsOrigin(this.touch.end1,this.touch.start2):this.touch.start2.angleAsOrigin(this.touch.end2,this.touch.start1),Math.abs(e-180)<45||Math.abs(e-360)<45?this.touch.gesture="zooming":this.touch.gesture="rotating"))),null==this.touch.gesture||this.touch.end1.equalsTo(this.touch.start1)&&this.touch.end2.equalsTo(this.touch.start2)||("zooming"==this.touch.gesture?(n=this.touch.end1.x-this.touch.start1.x,l=this.touch.end2.y-this.touch.start1.y,(Math.abs(n)>=this.movingresolution||Math.abs(l)>=this.movingresolution)&&(this.touch.scale=this.touch.end1.distTo(this.touch.end2)/this.touch.start1.distTo(this.touch.start2),null==this.touch.cloned&&(this.touch.cloned=this.clone()),this.scale(this.touch.scale,this.touch.center),this.touch.start1=this.touch.end1,this.touch.start2=this.touch.end2,this.redraw())):"moving"==this.touch.gesture?(n=this.touch.end1.x-this.touch.start1.x,l=this.touch.end1.y-this.touch.start1.y,(Math.abs(n)>=this.movingresolution||Math.abs(l)>=this.movingresolution)&&(null==this.touch.cloned&&(this.touch.cloned=this.clone()),this.m.offset(n,l),this.touch.start1=this.touch.end1,this.redraw())):"rotating"==this.touch.gesture&&(180<(i=this.touch.start2.angleAsOrigin(this.touch.start1,this.touch.end1))&&(i-=360),180<(s=this.touch.start1.angleAsOrigin(this.touch.start2,this.touch.end2))&&(s-=360),(1<=Math.abs(i)||1<=Math.abs(s))&&Math.abs(i)<30&&Math.abs(s)<30&&(n=Math.abs(s)/(Math.abs(i)+Math.abs(s)),l=this.touch.start1.x+(this.touch.start2.x-this.touch.start1.x)*n,n=this.touch.start1.y+(this.touch.start2.y-this.touch.start1.y)*n,this.m.rotate(new JSDraw2.Point(l,n),Math.abs(i)>Math.abs(s)?i:s),this.touch.start1=this.touch.end1,this.touch.start2=this.touch.end2,this.redraw()))),t.preventDefault(),!1)}this.resetGesture()}},touchEnd:function(t){if(this.activated)return this.resetGesture(),this.mouseup(t),!1},activate:function(t,e){this.activated!=t&&null!=this.maintable&&((this.activated=t)&&(JSDraw2.__currentactived!=this&&null!=JSDraw2.__currentactived&&JSDraw2.__currentactived.activate(!1),JSDraw2._currentactived=this),window.navigator.msPointerEnabled&&(t?"hidden"!=document.body.style.overflow&&(this._msContentZooming=document.body.style.msContentZooming,this._overflow=document.body.style.overflow,document.body.style.msContentZooming="none",document.body.style.overflow="hidden"):document.body.style.overflow!=this._overflow&&(document.body.style.msContentZooming=this._msContentZooming,document.body.style.overflow=this._overflow)),t||null==this.contextmenu||this.contextmenu.hide(),0!=e&&(0!=this.options.focusbox&&(this.maintable.style.borderColor=t?null==this.options.focuscolor?"#5555ff":this.options.focuscolor:"#cccccc"),t||null==this.curObject||(this.curObject=null,this.redraw()),null!=this.options.onfocus&&this.options.onfocus(t)))}}),scilligence.apply(JSDraw2.Editor,{__xcode:91,undoGestureTime:300,dblclickdelay:300,BONDLENGTH:30,ANGLESTOP:30,LINEWIDTH:2,TOR:10,FONTSIZE:14,get:function(t){return null==JSDraw2.Editor._allitems&&(JSDraw2.Editor._allitems={}),null==t?null:JSDraw2.Editor._allitems[t]},getClipboard:function(){var t=scil.Utils.readCookie("__jsdrawclipboard");if(null==t||""==t)return null;t=JSDraw2.Base64.decode(t);var e=new JSDraw2.Mol;return null==e.setXml(t)||e.isEmpty()?null:e},setClipboard:function(t,e){return null==t||t.isEmpty()?(scil.Utils.alert("Nothing placed on clipboard."),!1):(scil.Utils.createCookie("__jsdrawclipboard",JSDraw2.Base64.encode(t.getXml(null,null,null,null,e))),!0)},showAbout:function(){var t,e,i;null==JSDraw2.Editor.about&&(t=scil.Utils.createElement(null,"div",null,{width:"430px",color:"black"}),scil.Utils.createElement(t,"img",null,null,{src:scil.Utils.imgSrc("img/jsdraw2.jpg")}),"Lite"==JSDraw2.Security.kEdition?i="<span style='color:red'>JSDraw Lite for HELM</span>":(e=null==JSDraw2.Security.lic?null:JSDraw2.Security.lic.expiration,i=null!=JSDraw2.Security.error?JSDraw2.Security.error:"Licensed to <b>"+JSDraw2.Security.lic.licensor+"</b>, expires on "+e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate(),JSDraw2.Security.valid||(i="<span style='color:red'>"+i+"</span>")),scil.Utils.createElement(t,"div",i,{textAlign:"right"}),i=scil.Utils.createTable(t,null,null,{borderTop:"solid 1px gray",width:"100%"}),i=scil.Utils.createElement(i,"tr"),scil.Utils.createElement(i,"td",JSDraw2.version),scil.Utils.createElement(i,"td","<a target='_blank' href='http://www.jsdraw.com'>http://www.jsdraw.com</a>",{textAlign:"right"}),i=scil.Utils.createElement(scil.Utils.createElement(t,"div",null,{textAlign:"center"}),"button","OK",{width:scil.Utils.buttonWidth+"px"}),JSDraw2.Editor.about=new JSDraw2.Dialog(JSDraw2.Language.res("About JSDraw"),t),scil.connect(i,"onclick",function(t){JSDraw2.Editor.about.hide(),t.preventDefault()})),JSDraw2.Editor.about.show()},onClickPT:function(t,e){JSDraw2.Editor.get(e).onPT(t)},onSaveFile:function(){var t=JSDraw2.Editor.savefiledlg.form.fields,e=t.filetype.value,t=t.contents;t.value=JSDraw2.Editor.savefiledlg.jsd.getData(e),t.select(),t.focus()},onOpenFile:function(){var t=JSDraw2.Editor.openfiledlg.form.fields,e=t.contents.value,t=t.filetype.value;JSDraw2.Editor.openfiledlg.jsd.setData(e,t),JSDraw2.Editor.openfiledlg.hide()},initNoDelay:function(){for(var t=document.getElementsByTagName("div"),e=0;e<t.length;e++){var i=t[e];dojo.hasClass(i,"JSDraw")&&(new JSDraw2.Editor(i),dojo.removeClass(i,"JSDraw"))}},init:function(){scil.onload(function(){JSDraw2.Editor.initNoDelay()})},create:function(t,e){dojo.ready(function(){new JSDraw2.Editor(t,e)})},write:function(t,e){document.writeln("<div id='"+t+"'></div>"),scil.onload(function(){new JSDraw2.Editor(t,e)})},showPopupIframe:function(t,e,i,s){scil.Utils.getTopWindow().JSDraw2.Editor.showPopup(t,e,i,s)},getPopupSize:function(t){var e,i,l={width:800,height:400};return null!=JSDraw2.defaultoptions&&(e=JSDraw2.defaultoptions.popupwidth||JSDraw2.defaultoptions.popupWidth,i=JSDraw2.defaultoptions.popupheight||JSDraw2.defaultoptions.popupHeight,t=scil.Utils.getScreenSize(t),"string"==typeof e&&"%"==e.substr(e.length-1,1)?l.width=t.w*parseInt(e.substr(0,e.length-1))/100:0<e&&(l.width=s),"string"==typeof i&&"%"==e.substr(i.length-1,1)?l.height=t.h*parseInt(i.substr(0,i.length-1))/100:0<i&&(l.height=i)),l},showPopup:function(t,e,i,s,l){var n,r,o,a=null;return null==JSDraw2.Editor.popupdlg&&(a=this.getPopupSize(),n=scil.Utils.createTable(),r=scil.Utils.createElement(n,"tr"),o=scil.Utils.createElement(r,"td"),a.div=scil.Utils.createElement(o,"div",null,{width:a.width+"px",height:a.height+"px"}),r=scil.Utils.createElement(n,"tr"),o=scil.Utils.createElement(r,"td",null,{textAlign:"center"}),o=scil.Utils.createElement(o,"button",null,{width:scil.Utils.buttonWidth+"px"}),JSDraw2.Editor.popupdlg=new JSDraw2.Dialog(t,n.parentNode),JSDraw2.Editor.popupdlg.button=o),JSDraw2.Editor.popupdlg.show(t,l),null!=a?(JSDraw2.defaultoptions.popupxdraw?(a.height-=40,a.value=s,JSDraw2.Editor.popupdlg.jsd=new scilligence.XDraw(a.div,a)):(a.div.style.border="solid 1px #ddd",JSDraw2.Editor.popupdlg.jsd=new JSDraw2.Editor(a.div),this._loadPopupData(s)),(!scil.Utils.isIE||8<scil.Utils.isIE)&&JSDraw2.Editor.popupdlg.updateWidth(),dojo.connect(JSDraw2.Editor.popupdlg.button,"onclick",function(t){var e=!0;null!=JSDraw2.Editor.popupdlg.callback&&(e=JSDraw2.Editor.popupdlg.callback(JSDraw2.Editor.popupdlg.jsd),JSDraw2.Editor.popupdlg.callback=null),0!=e&&JSDraw2.Editor.popupdlg.hide(),t.preventDefault()})):this._loadPopupData(s),JSDraw2.Editor.popupdlg.button.innerHTML=scil.Utils.imgTag("tick.gif",e),JSDraw2.Editor.popupdlg.callback=i,JSDraw2.Editor.popupdlg.jsd},_loadPopupData:function(t){null!=t?("jsdraw"==t.format||"html"==t.format||"xml"==t.format?JSDraw2.Editor.popupdlg.jsd.setXml(t.value):"mol"==t.format||"molfile"==t.format?JSDraw2.Editor.popupdlg.jsd.setMolfile(t.value):"jdx"==t.format?JSDraw2.Editor.popupdlg.jsd.setJdx(t.value):"clone"==t.format?(JSDraw2.Editor.popupdlg.jsd.restoreClone(t.value),JSDraw2.Editor.popupdlg.jsd.fitToWindow()):JSDraw2.Editor.popupdlg.jsd.clear(!0),JSDraw2.Editor.popupdlg.jsd.refresh()):JSDraw2.Editor.popupdlg.jsd.clear(!0)}}),scilligence.mstouch={pointers:{},down:function(t){return this.pointers[t.pointerId]={clientX:t.clientX,clientY:t.clientY,target:t.target,button:t.button,pointerId:t.pointerId,_tm:(new Date).getTime()},t.touches=this.toTouches(),t},move:function(t){var e=this.pointers[t.pointerId];if(null!=e)return e.clientX=t.clientX,e.clientY=t.clientY,e._tm=(new Date).getTime(),t.touches=this.toTouches(),t},up:function(t){return delete this.pointers[t.pointerId],t.touches=this.toTouches(),t},toTouches:function(){var t,e=[],i=(new Date).getTime(),s=[];for(t in this.pointers)this.pointers[t]._tm>i-5e3?e.push(this.pointers[t]):s.push(t);for(var l=0;l<s.length;++l)delete this.pointers[s[l]];return e.sort(function(t,e){return t.pointerId-e.pointerId}),e}},JSDraw=JSDraw2.Editor,JSDraw2.Table={splitUnit:function(t){if(null==t||"&nbsp;"==t)return null;if(0==(t=scil.Utils.trim(t)).length)return null;var e=null,i=null,s=t.replace(/[a-z|\/|%|°]+$/i,"");return s!=t&&(i=(e=t.substr(s.length)).toLowerCase(),s=scil.Utils.trim(s)),"w/w"!=i&&"w/v"!=i||!scil.Utils.endswith(s,"%")||(s=s.substr(0,s.length-1),e=i="% "+i),"%w/w"==i?e=i="% w/w":"%w/v"==i&&(e=i="% w/v"),{value:scil.Utils.trim(s),unit:i,unit2:e}},readSdfRecord:function(t,e){"\n"==t.substr(0,1)?t=t.substr(1):"\r\n"==t.substr(0,2)&&(t=t.substr(2));var i=t.indexOf("\nM  END");if(i<0&&(i=t.indexOf("\nM END")),i<0)return null;var s=t.indexOf("\n",i+1),i=s<0?t:t.substr(0,s),s=s<0?null:t.substr(s+1);return{molfile:i,props:e?JSDraw2.Table.readProps(s):null}},readProps:function(t){var e={};if(null==t)return e;for(var i=t.split("\n"),s=0;s<i.length;++s){var l=null,n=null;if(">"==(t=i[s]).substr(0,1)){var r,o=t.indexOf("<",1);for(0<o&&(++o,0<(r=t.indexOf(">",o))&&(l=t.substr(o,r-o))),++s;s<i.length&&(t=i[s],0!=scil.Utils.trim(t).length);++s)null==n?n=t:n+=t}null!=l&&(e[scil.Utils.trim(l)]=scil.Utils.trim(n))}return e}},JSDraw2.Group=scil.extend(scil._base,{constructor:function(t,e){this.T="GROUP",this.type=e,this.name=t,this.id=null,this._rect=null,this.p=null,this.gap=6,this.group=null,this.color=null,this.a=null,this.ratio=null,this.tag=null},clone:function(){var t=new JSDraw2.Group(this.name,this.type);return t.id=this.id,t._rect=null==this._rect?null:this._rect.clone(),t.p=null==this.p?null:this.p.clone(),t.color=this.color,t.gap=this.gap,t.ratio=this.ratio,t.tag=this.tag,t},html:function(t){var e="<i i='"+this.id+"' x='"+this.T+"' t='"+scilligence.Utils.escXmlValue(this.type)+"' n='"+this.name+"'";return null!=this.color&&(e+=" clr='"+this.color+"'"),0<this.gap&&(e+=" gap='"+this.gap+"'"),e+="></i>"},readHtml:function(t){t=parseFloat(t.getAttribute("gap"));0<t&&(this.gap=t)},flipY:function(t){},flipX:function(t){},scale:function(t,e){},offset:function(t,e){},rect:function(){return this._rect},toggle:function(t,e){var i=this._rect;if(null!=i)return t.y>=i.top&&t.y<=i.bottom()&&(Math.abs(t.x-i.left)<e/2||Math.abs(t.x-i.right())<e/2)||t.x>=i.left&&t.x<=i.right()&&(Math.abs(t.y-i.top)<e/2||Math.abs(t.y-i.bottom())<e/2)},drawCur:function(t,e,i,s){var l=this._rect;if(null!=l){var n=l.center();if(t.createCircle({cx:l.left,cy:n.y,r:e}).setFill(i),t.createCircle({cx:l.right(),cy:n.y,r:e}).setFill(i),t.createCircle({cx:n.x,cy:l.top,r:e}).setFill(i),t.createCircle({cx:n.x,cy:l.bottom(),r:e}).setFill(i),null!=s){for(var r=0;r<s.atoms.length;++r)s.atoms[r].group==this&&s.atoms[r].drawCur(t,.75*e,i);for(r=0;r<s.graphics.length;++r)s.graphics[r].group==this&&s.graphics[r].drawCur(t,.75*e,i)}}},_updateRect:function(t,e){e=t.getGroupRect(this,e);return this._rect=e},draw:function(t,e,i,s){var l,n=this._rect;null!=n&&(l=null==this.color?"gray":this.color,"chiral"==this.type?JSDraw2.Drawer.drawLabel(t,new JSDraw2.Point(n.left+n.width/2,n.top-s),this.name,l,s,!1):(JSDraw2.Drawer.drawRect(t,n,l,e/4,3*e),JSDraw2.Drawer.drawLabel(t,new JSDraw2.Point(n.left+n.width/2,n.bottom()+s/2),this.name,l,s,!1)),scil.Utils.isNullOrEmpty(this.tag)||JSDraw2.Drawer.drawLabel(t,new JSDraw2.Point(n.left,n.top-s),this.tag,"black",s,!1,"start"),scil.Utils.isNullOrEmpty(this.ratio)||JSDraw2.Drawer.drawLabel(t,new JSDraw2.Point(n.right(),n.bottom()+s/2),"ratio: "+this.ratio,"black",s,!1,"end"))},drawSelect:function(t){t.draw(this,this._rect.fourPoints())}}),JSDraw2.Group.cast=function(t){return null!=t&&"GROUP"==t.T?t:null},JSDraw2.Text=scilligence.extend(scilligence._base,{constructor:function(t,e){this.T="TEXT",this._rect=t,this.text=e,this.color=null,this.fontsize=1,this.selected=!1,this.fieldtype=null,this.readonly=!1,this.anchors=[],this.italic=null},clone:function(){var t=new JSDraw2.Text(this._rect.clone(),this.text);return t.id=this.id,t.color=this.color,t.fieldtype=this.fieldtype,t.readonly=this.readonly,t.fontsize=this.fontsize,t.italic=this.italic,t},allAnchorsIn:function(t){if(0==this.anchors.length)return!1;for(var e=0;e<this.anchors.length;++e){var i=this.anchors[e];if(null!=JSDraw2.Atom.cast(i)&&t.atoms.indexOf(i)<0||null!=JSDraw2.Bond.cast(i)&&t.bonds.indexOf(i)<0||null!=JSDraw2.Bracket.cast(i)&&t.graphics.indexOf(i)<0)return!1}return!0},attach:function(t){if(null!=JSDraw2.Bracket.cast(t))return this.anchors=[t],!0;if(null==JSDraw2.Atom.cast(t)&&null==JSDraw2.Bond.cast(t))return!1;1==this.anchors.length&&null!=JSDraw2.Bracket.cast(this.anchors[0])&&(this.objects=[]);for(var e=0;e<this.anchors.length;++e)if(this.anchors[e]==t)return this.anchors.splice(e,1),!0;return this.anchors.push(t),!0},html:function(t){for(var e="",i=0;i<this.anchors.length;++i)e+=(""==e?"":",")+this.anchors[i].id;t="<i i='"+this.id+"' x='"+this.T+"' p='"+this._rect.toString(t)+"'";return null!=this.color&&""!=this.color&&(t+=" clr='"+this.color+"'"),0<this.fontsize&&(t+=" fontsize='"+this.fontsize.toFixed(2)+"'"),this.readonly&&(t+=" v='1'"),this.italic&&(t+=" italic='1'"),null!=this.fieldtype&&""!=this.fieldtype&&(t+=" fieldtype='"+scil.Utils.escXmlValue(this.fieldtype)+"'"),""!=e&&(t+=" anchors='"+e+"'"),t+=">"+scilligence.Utils.escXmlValue(this.text)+"</i>"},readHtml:function(t,e){var i=JSDraw2.Rect.fromString(t.getAttribute("p")),s=t.getAttribute("s");if(null==s&&(s=t.text||t.textContent),null==i||scil.Utils.isNullOrEmpty(s))return!1;i.width>100*i.height&&(i.width=5*i.height),i.height>100*i.height&&(i.height=i.width/5),this._rect=i,this.text=s,this.readonly=scil.Utils.isTrue(t.getAttribute("v")),this.italic=scil.Utils.isTrue(t.getAttribute("italic")),this.dummy=scil.Utils.isTrue(t.getAttribute("dum")),this.fieldtype=t.getAttribute("fieldtype");s=parseFloat(t.getAttribute("fontsize"));0<s&&(this.fontsize=s);t=t.getAttribute("anchors");if(null!=t&&""!=t){for(var l=[],n=t.split(","),r=0;r<n.length;++r){var o=e[parseInt(n[r])];null==o||null==JSDraw2.Atom.cast(o)&&null==JSDraw2.Bond.cast(o)&&null==JSDraw2.Bracket.cast(o)||l.push(o)}this.anchors=l}return!0},flipY:function(t){},flipX:function(t){},scale:function(t,e){null!=this._rect&&this._rect.scale(t,e)},offset:function(t,e){null!=this._rect&&this._rect.offset(t,e)},rect:function(){return null==this._rect?null:this._rect.clone()},toggle:function(t,e){return null!=this._rect&&this._rect.contains(t)},removeObject:function(t){for(var e=0;e<this.anchors.length;++e)if(this.anchors[e]==t){this.anchors.splice(e,1);break}},drawCur:function(t,e,i,s){var l=this._rect.center();if(t.createCircle({cx:l.x,cy:l.y,r:e}).setFill(i),null!=s)for(var n=0;n<this.anchors.length;++n)this.anchors[n].drawCur(t,.75*e,i)},draw:function(t,e,i,s){var l,n,r=this.text;null!=r&&(l=this._rect,n=s*(0<this.fontsize?this.fontsize:1),s=null==this.color||0==this.color.length?"black":this.color,s=JSDraw2.Drawer.drawText(t,new JSDraw2.Point(l.left,l.top),r,s,n,null,this.italic),l.width=null==s?0:s.getTextWidth(),l.height=4+n)},drawSelect:function(t){t.draw(this,this._rect.fourPoints())}}),JSDraw2.Text.cast=function(t){return null!=t&&"TEXT"==t.T?t:null},scil.Lang={token:"translate",key:"scil_lang",current:null,language:null,en:{},cn:{},add:function(t,e){var i;null!=t&&(null==(i=null==e?this.en:scil.Lang[e])&&(scil.Lang[e]={}),scil.apply(i,t))},setLang:function(t,e){null==t||""==t?scil.Utils.createCookie(this.key,"",-1,!0):scil.Utils.createCookie(this.key,t,180,!0),e&&window.location.reload()},use:function(t){null!=t&&("zh"==(t=t.toLowerCase())&&(t="cn"),this.language=t,this.current=this[t],null==this.current&&(this.current=this.en,this.language=null),JSDraw2.Language.use(t))},res:function(t,e){if(scil.Utils.isNullOrEmpty(t)||"string"!=typeof t)return t;if(null!=e){var i=this[e];return null==i||null==i[t]?t:i[t]}null==this.current&&(null!=(e=scil.Utils.readCookie(this.key,!0))&&""!=e&&this.use(e),null==this.current&&null!=this.lang&&this.use(this.lang),null==this.current&&(null!=(e=window.navigator.userLanguage)&&2<e.length&&this.use(e.substr(0,2)),null==this.current&&(this.current=this.en)));e=null==this.current?null:this.current[t];return null!=e&&""!=e||(e=JSDraw2.Language.res(t)),e},translate:function(t,e){if(null==e||""==tag)this.translate(t,"span");else for(var i=e.split(","),s=0;s<i.length;++s)this.translate(t,i[s])},translate2:function(t,e){if(null!=e&&""!=e){var i=(null==t?document:t).getElementsByTagName(e);if(null!=i)for(var s=0;s<i.length;++s){var l,n=i[s];null!=n.getAttribute(this.token)&&(l=this.reg(n.innerHTML),scil.Utils.isNullOrEmpty(l)||(n.innerHTML=l))}}}},scil.Menu={timeout:scilligence.Utils.isTouch||window.navigator.msPointerEnabled?2e3:500,closetimer:0,menuitem:null,isOpen:function(){return null!=scil.Menu.menuitem&&"none"!=scil.Menu.menuitem.style.display},open:function(t){scil.Menu.cancelclosetime(),scil.Menu.menuitem&&(scil.Menu.menuitem.style.display="none"),scil.Menu.menuitem=document.getElementById(t),scil.Menu.menuitem.style.display=""},close:function(){scil.Menu.menuitem&&(scil.Menu.menuitem.style.display="none")},openOrClose:function(t){null==scil.Menu.menuitem||"none"==scil.Menu.menuitem.style.display?this.open(t):this.close()},closetime:function(){scil.Menu.closetimer=window.setTimeout(scil.Menu.close,scil.Menu.timeout)},cancelclosetime:function(){scil.Menu.closetimer&&(window.clearTimeout(scil.Menu.closetimer),scil.Menu.closetimer=null)}},JSDraw2.Menu=scil.Menu,scil.ContextMenu=scil.extend(scil._base,{constructor:function(t,e,i,s,l){this.document=null==s?document:s,this.tbody=null,this.callback=e,this.submenus={},this.items=t,this.cur=null,this.parentMenu=i,this.obj=null,this.lang=null!=l?l:scil.Lang},isFrom:function(t){if(null==this.tbody)return!1;if(scil.Utils.isChildOf(t,this.tbody.parentNode))return!0;for(var e in this.submenus)if(this.submenus[e].isFrom(t))return!0;return!1},show:function(t,e,i,s,l){this.hide(),this._create(s),this.obj=i;s=scil.Utils.getMaxZindex(),i=this.tbody.parentNode;i.style.display="",i.style.zIndex=0<s?s+1:100,scil.Utils.moveToScreen(t,e,i,l)},hide:function(t){if(null==this.tbody||"none"==this.tbody.parentNode.style.display)return!1;for(var e in this.tbody.parentNode.style.display="none",this.submenus)this.submenus[e].hide();return this.setCur(null),t&&null!=this.parentMenu&&this.parentMenu.hide(t),!0},isVisible:function(){return null!=this.tbody&&"none"!=this.tbody.parentNode.style.display},_create:function(t){var e;null!=t&&(this.items=t),null==this.tbody?((e=this).tbody=scil.Utils.createTable(this.document.body,0,0,{position:"absolute",display:"none",backgroundColor:"#eee",color:"#000",border:"solid 1px #ddd"}),this.tbody.setAttribute("jspopupmenu","1"),dojo.connect(this.tbody.parentNode,"onmousedown",function(t){2!=t.button&&e.click(t)}),dojo.connect(this.tbody.parentNode,"onmouseover",function(t){e.hilit(t)}),dojo.connect(this.document.body,"onmousedown",function(t){e.clickOut(t)}),this._createItems()):null!=t&&this._createItems()},_createItems:function(){scil.Utils.removeAll(this.tbody);for(var t=0;t<this.items.length;++t){var e,i,s,l,n=this.items[t];"-"==n?0!=t&&"-"!=this.items[t-1]&&t!=this.items.length-1&&(i=scil.Utils.createElement(this.tbody,"tr"),scil.Utils.createElement(i,"td",null,{textAlign:"center",width:"20px",backgroundColor:"#f5f5f5"}),scil.Utils.createElement(i,"td","<hr style='margin:0;padding:0'>",{padding:"0 2px 0 2px"}).colSpan=3):("string"==typeof n&&(n={caption:n}),null==n.key&&(n.key=n.caption),e=null!=n.children&&0<n.children.length,l=null==n.bg?"#eee":n.bg,i=scil.Utils.createElement(this.tbody,"tr",null,{backgroundColor:l},n.disabled?null:{menukey:n.key}),scil.Utils.createElement(i,"td",n.checked?"&#10004;":null,{textAlign:"center",width:"20px",backgroundColor:"#f5f5f5"}),s={padding:"1px 3px 1px 3px",color:n.disabled?"gray":""},l=n.nottranslate?n.caption:this.lang.res(n.caption),null!=n.icon&&(l="<img src='"+n.icon+"'>"+l),scil.Utils.createElement(i,"td",l,s),s.fontSize="75%",s.paddingLeft="10px",scil.Utils.createElement(i,"td",null==n.shortcut?"":n.shortcut,s),scil.Utils.createElement(i,"td",e?"&rsaquo;":null,{textAlign:"right",width:"30px",paddingRight:"5px"}),e?this.submenus[n.key]=new scil.ContextMenu(n.children,(null==n.callback?this:n).callback,this,this.document):delete this.submenus[n.key])}},hilit:function(t){t=scil.Utils.getParent(t.srcElement||t.target,"TR");null!=t&&null!=t.getAttribute("menukey")&&this.setCur(t)},setCur:function(t){var e,i,s;null!=this.cur&&(this.cur.childNodes[0].style.backgroundColor="#f5f5f5",this.cur.childNodes[1].style.backgroundColor="",this.cur.childNodes[2].style.backgroundColor="",this.cur.childNodes[3].style.backgroundColor="",null!=(e=this.submenus[this.cur.getAttribute("menukey")])&&e.hide()),null!=(this.cur=t)&&(t.childNodes[0].style.backgroundColor="#aaf",t.childNodes[1].style.backgroundColor="#aaf",t.childNodes[2].style.backgroundColor="#aaf",t.childNodes[3].style.backgroundColor="#aaf",null!=(e=null==t?null:this.submenus[t.getAttribute("menukey")])&&(i=scil.Utils.getOffset(t.childNodes[3],!1),s=scil.Utils.getOffset(t.childNodes[0],!1),e.show(i.x+t.childNodes[3].offsetWidth+1,i.y,null,null,s.x)))},getCallbackObj:function(){return null==this.parentMenu?this.obj:this.parentMenu.getCallbackObj()},click:function(t){var e=scil.Utils.getParent(t.srcElement||t.target,"TR"),i=null==e?null:e.getAttribute("menukey");null==this.submenus[i]&&(null!=i&&null!=this.callback&&this.callback(i,this.getCallbackObj(),""!=e.childNodes[0].innerHTML),this.hide(!0),t.preventDefault())},clickOut:function(t){t=scil.Utils.getParent(t.srcElement||t.target,"TBODY");null!=t&&"1"==t.getAttribute("jspopupmenu")||this.hide()}}),scil.apply(scil.ContextMenu,{isFromContextMenu:function(t){t=scil.Utils.getParent(t,"TBODY");return null!=t&&"1"==t.getAttribute("jspopupmenu")}}),JSDraw2.ContextMenu=scil.ContextMenu,scil.Dialog=scil.extend(scil._base,{constructor:function(t,e,i){this.options=null==i?{}:i,this.lang=null==this.options.lang?scil.Lang:this.options.lang,this.id=this.options.id,null!=this.id&&""!=this.id||(null==scil.Dialog._idincrease&&(scil.Dialog._idincrease=0),this.id="__jsdialog"+ ++scil.Dialog._idincrease),null==scil.Dialog._allitems&&(scil.Dialog._allitems={}),(scil.Dialog._allitems[this.id]=this).parentWindow=null==this.options.parentWindow?window:this.options.parentWindow,this.body=e,this.title=t,this.WRAPPER="content",this.dialog=null,this.dialogmask=null,this.movingSt=null},isVisible:function(){return null!=this.dialog&&"none"!=this.dialog.style.display},isFrom:function(t){return!!this.isVisible()&&scil.Utils.isChildOf(t,this.dialog)},show2:function(t){null==t&&(t={}),this.show(t.title,t.zindex,t.modal,t.immediately,t.owner)},show:function(t,e,i,s,l){this.owner=l,this.isVisible()?null!=t&&null!=this.dialog.titleElement&&(this.dialog.titleElement.innerHTML=this.lang.res(t)):(null==i&&(i=!0),0<scil.Dialog.kTimer||(s=!0),this._create(),(this.movingSt=null)!=t&&null!=this.dialog.titleElement&&this.setTitle(t),t=scil.Utils.getMaxZindex(),0<JSDraw2.defaultoptions.minDlgZindex&&t<JSDraw2.defaultoptions.minDlgZindex&&(t=JSDraw2.defaultoptions.minDlgZindex),e=null==e?t+10:e,this.dialog.alpha=0,this.dialog.style.display="",this.dialogmask.style.display="",this.dialogmask.style.minHeight="100%",this.dialogmask.style.height="100%",this.dialogmask.style.width="100%",0<e&&(this.dialogmask.style.zIndex=e+1,this.dialog.style.zIndex=e+2),i||(this.dialog.style.zIndex=e+1,this.dialogmask.style.display="none"),this.dialog.style.borderColor=i?"#fff":JSDraw2.Skin.dialog.bkcolor,scilligence.Utils.isTouch||s?dojo.style(this.dialog,{display:"",opacity:1,filter:"alpha(opacity=100)"}):(dojo.style(this.dialog,{display:"",opacity:0,filter:"alpha(opacity=0)"}),this.dialog.timer=setInterval("scil.Dialog.get('"+this.id+"').fade(1)",scil.Dialog.kTimer)),this.moveCenter(),scil.Dialog.stack.push(this),this._scilform&&null!=this.form&&null!=this.form.fields&&this.form.focus())},setTitle:function(t){this.dialog.titleElement.innerHTML=this.lang.res(t)},moveCenter:function(){var t=dojo.window.getBox(),e=t.w,i=t.h,s=t.l,l=t.t,n=this.dialog.offsetWidth,t=this.dialog.offsetHeight,t=Math.round(l+(i-t)/2),n=Math.round(s+(e-n)/2);dojo.style(this.dialog,{top:Math.max(l,t)+"px",left:Math.max(s,n)+"px"}),this.scroll(),this.updateWidth()},_create:function(){var e,t,i,s,l,n,r;null==this.dialog&&(t=(e=this).parentWindow.document.body,l=scilligence.Utils.createTable(t,0,0,{position:"absolute",borderRadius:"3px",width:void 0,height:void 0,zIndex:200,backgroundColor:JSDraw2.Skin.dialog.bkcolor,border:JSDraw2.Skin.dialog.border}),this.dialog=l.parentNode,this.dialog.setAttribute("__scilligence_dlg",this.id),r="0",this.options.notitle?r="5px":(n=scilligence.Utils.createElement(l,"tr",null,{height:"30px"}),s=scilligence.Utils.createElement(n,"td",this.lang.res(this.title),{paddingLeft:"5px",fontWeight:"bold",color:null==scil.App||null==scil.App.config?"":scil.App.config.text}),this.dialog.titleElement=s,s=scilligence.Utils.createElement(n,"td",null,{textAlign:"right",verticalAlign:"top"}),this.options.noclose||(i=scilligence.Utils.createElement(s,"img",null,{cursor:"pointer",marginRight:"5px"},{title:JSDraw2.Language.res("Close"),src:scil.Utils.imgSrc("img/dlgclose.jpg")}),dojo.connect(scilligence.Utils.isIpad?s:i,"onclick",function(t){e.hide(),t.preventDefault()})),0!=this.options.movable&&(scilligence.Utils.isTouch?(dojo.connect(n,"ontouchstart",function(t){1==t.touches.length&&e.startMove(t.touches[0])}),dojo.connect(t,"ontouchmove",function(t){if(1==t.touches.length&&e.move(t.touches[0]))return t.preventDefault(),!1}),dojo.connect(t,"ontouchend",function(){e.endMove()})):(n.style.cursor="move",dojo.connect(n,"onmousedown",function(t){e.startMove(t)}),dojo.connect(t,"onmousemove",function(t){e.move(t)}),dojo.connect(t,"onmouseup",function(){e.endMove()})))),n=scil.Utils.createElement(l,"tr"),(s=scil.Utils.createElement(n,"td",null,{padding:r+" 5px 5px 5px"})).colSpan=2,l=this.options.width,n=this.options.height,r={background:"#fff",padding:"5px"},(0<l||0<n)&&scil.apply(r,{width:0<l?l:null,height:0<n?n:null,overflow:"scroll"}),null!=this.options.bodystyle&&scil.apply(r,this.options.bodystyle),r=scil.Utils.createElement(s,"div",null,r),"string"==typeof this.body?r.innerHTML="<div>"+this.body+"</div>":r.appendChild(this.body),r=0<this.options.opacity?this.options.opacity:75,this.dialogmask=scilligence.Utils.createElement(t,"div",null,{position:"absolute",top:"0",left:"0",minHeight:"100%",height:"100%",width:"100%",background:"#999",opacity:r/100,filter:"alpha(opacity="+r+")",zIndex:199}),dojo.connect(window,"onresize",function(){e.resize()}),dojo.connect(window,"onscroll",function(){e.scroll()}),this.options.fixtransparentissue&&"silverlight"==dojox.gfx.renderer&&(this.dialogmask.style.backgroundColor="white",this.dialogmask.style.opacity="1.0",this.dialogmask.style.filter="alpha(opacity=100)"))},scroll:function(){var t,e;this.isVisible()&&null!=this.dialogmask&&"none"!=this.dialogmask.style.display&&(e=dojo.window.getBox(),t=Math.max(e.w+e.l,this.dialog.offsetLeft+this.dialog.offsetWidth),e=Math.max(e.h+e.t,this.dialog.offsetTop+this.dialog.offsetHeight),this.dialogmask.offsetWidth<=t&&(this.dialogmask.style.width=t+"px"),this.dialogmask.offsetHeight<=e&&(this.dialogmask.style.height=e+"px"))},resize:function(){this.scroll()},moveTo:function(t,e){scil.Utils.moveToScreen(t,e,this.dialog)},startMove:function(t){this.movingSt=null,"IMG"!=(t.srcElement||t.target).tagName&&(this.movingSt=new JSDraw2.Point(t.clientX,t.clientY))},move:function(t){if(null==this.movingSt||1!=(t.which||t.button))return!1;var e=new JSDraw2.Point(t.clientX-this.movingSt.x,t.clientY-this.movingSt.y),i=scilligence.Utils.parsePixel(this.dialog.style.top)+e.y,e=scilligence.Utils.parsePixel(this.dialog.style.left)+e.x;return this.moveTo(e,i),this.movingSt=new JSDraw2.Point(t.clientX,t.clientY),!0},endMove:function(){this.movingSt=null},updateWidth:function(t){this.dialog.style.width=this.dialog.firstChild.firstChild.offsetWidth+2+"px"},hide:function(t){null!=this.options.onhide&&this.options.onhide(),0<scil.Dialog.kTimer||(t=!0),t||scilligence.Utils.isTouch?this.close():null!=this.dialog&&(clearInterval(this.dialog.timer),this.dialog.timer=setInterval("scil.Dialog.get('"+this.id+"').fade(0)",scil.Dialog.kTimer)),scil.Dialog.stack.pop(),scil.AutoComplete.hideAll()},close:function(){null!=this.dialog&&(clearInterval(this.dialog.timer),this.dialog.timer=null,this.dialog.style.display="none",this.dialogmask.style.display="none",this.dialogmask.style.width="0px",this.dialogmask.style.height="0px")},fade:function(t){null==t&&(t=1);t=1==t?this.dialog.alpha+scil.Dialog.kSpeed:this.dialog.alpha-scil.Dialog.kSpeed;this.dialog.alpha=t,dojo.style(this.dialog,{opacity:t/100,filter:"alpha(opacity="+t+")"}),99<=t?(clearInterval(this.dialog.timer),this.dialog.timer=null):t<=1&&this.close()}}),scil.apply(scil.Dialog,{stack:[],kTimer:10,kSpeed:40,keydown:function(t){27==t.keyCode&&0<this.stack.length&&this.stack[this.stack.length-1].hide()},get:function(t){return null==scil.Dialog._allitems&&(scil.Dialog._allitems={}),scil.Dialog._allitems[t]},getDialog:function(t){for(;null!=t;){var e=scil.Utils.getParent(t,"TABLE");if(null==e)return null;var i=e.getAttribute("__scilligence_dlg");if(null!=i)return this.get(i);t=e.parentNode}return null}}),scil.onload(function(){dojo.connect(document.body,"onkeydown",function(t){scil.Dialog.keydown(t)})}),JsDialog=JSDraw2.Dialog=scil.Dialog,scil.Form=scil.extend(scil._base,{constructor:function(t){this.options="boolean"==typeof t?{viewonly:t}:null==t?{}:t,this.lang=null==this.options.lang?scil.Lang:this.options.lang,this.viewonly=this.options.viewonly,this.items=null,this.tbody=null,this.fields=null,this.buttons=null},destory:function(){this.items=null,scil.Utils.removeAll(this.tbody),this.tbody=null,this.fields=null,this.buttons=null},getXml:function(t){var e,i=t?"":"<data>\n";for(e in this.fields){var s=this.fields[e],l=scil.Form.getFieldData(s,this.items[e]);null!=l&&""!=l&&(i+="<i n='"+scil.Utils.escXmlValue(e)+"'>","jsdraw"==s.stype||"xdraw"==s.stype||"jsdraw.table"==s.stype||"jsdraw.se"==s.stype||"jsdraw.fm"==s.stype||"table"==s.stype||"plate"==s.stype||"plates"==s.stype?i+=l:i+=scil.Utils.escXmlValue(l),i+="</i>\n")}return t||(i+="</data>"),i},setXml:function(t){try{var e=scil.Form.xml2Json(t);this.setData(e)}catch(t){alert("Error raised when setting form data: "+t.message)}},getData:function(t){var e,i={};for(e in this.fields){var s=this.fields[e];null!=s&&(s=scil.Form.getFieldData(s,this.items[e]),!t&&scil.Utils.isNullOrEmpty(s)||(i[e]=s))}return i},setData:function(t,e){for(var i in this.setDirty(!1),this.fields){var s,l,n=this.fields[i];null!=n&&((s=null)!=t&&(s=t[i],l=this.items[i],null==s&&null!=l&&(null!=l.alternativekey&&(s=t[l.alternativekey]),null==s&&null!=l.was&&(s=t[l.was]))),e&&null==s||scil.Form.setFieldData(n,this.items[i],this.viewonly,s,t))}this.setDirty(!1)},setFieldValue:function(t,e,i){this.fields[t];scil.Form.setFieldData(this.fields[t],this.items[t],this.viewonly,e,i)},clear:function(){this.setData({})},onchange:function(t,e){this.dirty=!0,null!=this.options.onchange&&this.options.onchange(t,this,e)},setDirty:function(t){this.dirty=null==t||1==t},preventUnsaved:function(i){var s=this;scil.connect(window,"onbeforeunload",function(t){if(s.dirty){null==i&&(i="WARNING: Form data are not saved yet.");var e=scil.Lang.res(i);return null!=t&&(t.returnValue=e),e}})},switchForm:function(t){if(null==this.options.alternativeforms)return!1;null==this.alternativeforms&&(this.alternativeforms={},this.alternativeforms[""]={tbody:this.tbody,fields:this.fields,items:this.items}),null!=this.alternativeforms[t]||null!=(i=this.options.alternativeforms[t])&&(this.render2(i,this.parent,this.renderoptions),this.alternativeforms[t]={tbody:this.tbody,fields:this.fields,items:this.items});var e,i=this.alternativeforms[t];for(e in null==i&&(i=this.alternativeforms[""]),this.tbody=i.tbody,this.fields=i.fields,this.items=i.items,this.alternativeforms)this.alternativeforms[e].tbody.parentNode.style.display=e==t?"":"none";return!0},selectrow:function(t){this.highlightrow(this.items[t])},onselectrow:function(t){var e,t=t.target||t.srcElement,i=scil.Utils.getParent(t,"TD"),s=null;for(e in this.items)if(null!=this.items[e]&&(this.items[e].td1==i||this.items[e].td2==i)){s=this.items[e];break}this.highlightrow(s)},highlightrow:function(t){this.currentrow!=t&&(null!=this.currentrow&&(this.currentrow.td1.style.backgroundColor=this.currentrowbckcolor,null!=this.currentrow.td2&&(this.currentrow.td2.style.backgroundColor="")),null!=t&&(this.currentrowbckcolor=t.td1.style.backgroundColor,t.td1.style.backgroundColor=JSDraw2.Skin.form.rowselectcolor,null!=t.td2&&(t.td2.style.backgroundColor=JSDraw2.Skin.form.rowselectcolor)),this.currentrow=t,null!=this.options.onselectrow&&this.options.onselectrow(t))},render:function(t,e,i){this.parent=t,this.renderoptions=i,this.render2(e,this.parent,this.renderoptions)},render2:function(t,e,i){var s,l,n=null==i?null:i.align,r=null==i?null:i.buttons,o="boolean"==typeof i?i:null==i||0!=i.immediately;for(s in this.tbody=null,this.fields={},this.items={},this.buttons=[],t)null!=(d=t[s])&&(null==(this.items[s]=d).label&&null!=d.caption&&(d.label=d.caption),null!=JSDraw2.Table&&0<=scil.Utils.indexOf(JSDraw2.Table.kNumberColumns,d.type)&&(d.type="number",null==d.unit&&(d.unit=JSDraw2.Table.kDefaultUnits[d.type])));this.options.usepostform&&(l=JsUtils.createElement(e,"div","<form method='post' enctype='multipart/form-data'></form>"),this.postform=l.firstChild,e=this.postform);var a=this.options.cols;if(!(0<a))for(var h in 1<a||(a=1),this.items)(d=this.items[h]).colspan>a&&(a=d.colspan);var u=null,c=a;this.tbody=scil.Utils.createTable(e);var d,p,f;for(h in this.items)"function"!=typeof(d=this.items[h])&&("group"==d.type?(u=scil.Utils.createElement(this.tbody,"tr"),c=a):null!=u&&1<a&&c<a?c+=0<d.colspan?d.colspan:1:(u=scil.Utils.createElement(this.tbody,"tr"),c=0<d.colspan?d.colspan:1),null!=(p=this.newField(d,u,o,null==i?null:i.hidelabel,null==i?null:i.vertical))&&(d.field=this.fields[h]=p),"group"==d.type&&1<a?d.td1.colSpan=2*a:1<d.colspan&&(d.td2.colSpan=(0<d.td2.colSpan?d.td2.colSpan:1)+2*(d.colspan-1)),null!=p&&null!=this.options.onenter&&"INPUT"==p.tagName&&this.connectKeyEnter(p,this.options.onenter));if(null!=this.options.onselectrow&&(f=this,dojo.connect(this.tbody.parentNode,"onclick",function(t){f.onselectrow(t)})),null!=n&&this.tbody.parentNode.setAttribute("align",n),null!=r){u=scil.Utils.createElement(this.tbody,"tr");scil.Utils.createElement(u,"td","&nbsp;"),u=scil.Utils.createElement(this.tbody,"tr"),this.buttonTR=u,null!=i&&i.vertical||scil.Utils.createElement(u,"td");var m=scil.Utils.createElement(u,"td",null,{whiteSpace:"nowrap"});if(i.centerbuttons&&(m.style.textAlign="center"),0<r.length)for(var g=0;g<r.length;++g){var w=r[g];" "==w?scil.Utils.createElement(m,"span","&nbsp;"):this.buttons.push(scil.Utils.createButton(m,w,this.lang))}else this.buttons.push(scil.Utils.createButton(m,r,this.lang))}},post:function(t,e,i){null!=this.postform&&(null==e&&(e={}),scil.apply(e,this.getData()),scil.Utils.ajaxUploadFile(this.postform,t,e,i))},postForm:function(t,e,i){null!=this.postform&&scil.Utils.ajaxUploadFile(this.postform,t,e,i)},checkRequiredFields:function(){var t,e=this.fields,i=0;for(t in this.items){var s=this.items[t],l=e[t];null!=s&&null!=l&&(s.td1.style.backgroundColor=JSDraw2.Skin.form.labelstyles.backgroundColor,"jsdraw.table"==s.type&&(i+=l.jsd.checkRequiredFields(0)),s.required&&(l=scil.Form.getFieldData(l),scil.Utils.isNullOrEmpty(l)&&(s.td1.style.backgroundColor="red",++i)))}return i},resetRequiredFields:function(){var t,e=this.fields;for(t in this.items){var i=this.items[t],s=e[t];null!=i&&null!=s&&(i.td1.style.backgroundColor=JSDraw2.Skin.form.labelstyles.backgroundColor)}},connectKeyEnter:function(e,i){dojo.connect(e,"onkeydown",function(t){13==t.keyCode&&(i(e),t.preventDefault())})},newField:function(t,e,i,s,l){var n=this;this.viewonly||("jsdraw"==t.type||"xdraw"==t.type?(null!=JSDraw2.defaultoptions&&JSDraw2.defaultoptions.usexdraw&&(t.type="xdraw"),null!=t.options?t.options.ondatachange=function(){n.onchange(r)}:t.ondatachange=function(){n.onchange(r)}):"jsdraw.table"!=t.type&&"jsdraw.se"!=t.type&&"jsdraw.fm"!=t.type&&"table"!=t.type&&"plate"!=t.type&&"plates"!=t.type&&"tabtext"!=t.type&&"richtext"!=t.type&&"plaintext"!=t.type||(null!=t.options?t.options.onchange=function(t,e){n.onchange(r,e)}:t.onchange=function(t,e){n.onchange(r,e)}));var r=this.newField2(t,e,i,s,l);return null==r?null:(this.viewonly||("INPUT"==r.tagName||"TEXTAREA"==r.tagName?scil.connect(r,"onchange",function(){n.onchange(r)}):"SELECT"!=r.tagName||JSDraw2.__touchmolapp||scil.connect(r,scil.Utils.isIE&&scil.Utils.isIE<9?"onclick":"onchange",function(){n.onchange(r)}),"INPUT"==r.tagName&&null!=t.mobiledata&&"number"!=t.type&&new scil.MobileData(r,{category:t.mobiledata,url:scil.MobileData.getDefaultUrl(!1)})),r)},newField2:function(t,e,i,s,l){var n=null==t.label?"&nbsp;":this.lang.res(t.label)+":";if("group"==t.type){0<this.tbody.childNodes.length&&(scil.Utils.createElement(scil.Utils.createElement(this.tbody,"tr"),"td","&nbsp;",{fontSize:"50%"},{colSpan:2}),e=scil.Utils.createElement(this.tbody,"tr")),e.style.backgroundImage=scil.Utils.imgSrc("img/header-bg.gif",!0),e.style.backgroundRepeat="repeat-x";var r=dojo.clone(JSDraw2.Skin.form.labelstyles);scil.apply(r,{fontWeight:"bold",color:"#555",background:""}),0!=t.collapsible&&scil.apply(r,{backgroundImage:scil.Utils.imgSrc("img/collapse.gif",!0),backgroundPosition:"right",backgroundRepeat:"no-repeat"});var o=scil.Utils.createElement(e,"td",n,r,{colSpan:2});return 0!=t.collapsible&&dojo.connect(o,"onclick",function(t){scil.Form.expand(t)}),t.group=o,t.td1=o,null}if("note"==t.type){o=scil.Utils.createElement(e,"td",null,null,{colSpan:2}),r=scil.Utils.createElement(o,"div",this.lang.res(t.label||t.str),t.style);return null!=t.color&&(r.style.color=t.color),t.td1=o,null}s?t.td1=scil.Utils.createElement(e,"td"):(t.required&&(n+="<span style='color:red' title='"+this.lang.res("Required")+"'>*</span>"),scil.Utils.isNullOrEmpty(t.icon)?t.td1=scil.Utils.createElement(e,"td",n,JSDraw2.Skin.form.labelstyles):(t.td1=scil.Utils.createElement(e,"td"),scil.Utils.createElement(t.td1,"img",null,null,{src:t.icon}),scil.Utils.createElement(t.td1,"span",n)),null!=t.labelstyle&&scil.apply(t.td1.style,t.labelstyle)),l&&(e=scil.Utils.createElement(this.tbody,"tr"));o=scil.Utils.createElement(e,"td",t.leading,null,{valign:"top"});t.td2=o;i=scil.Form.createField(o,t,this.viewonly,t.value,null,i,null,this);return"hidden"==t.type&&(e.style.display="none",e.setAttribute("hidden","1")),i},getFieldValue:function(t){return scil.Form.getFieldData(this.fields[t])},focus:function(t){scil.Form.focus(this.fields,t)}}),scil.apply(scil.Form,{focus:function(t,e){if(null!=t){var i=null;if(null==e)for(var s in t){var l=t[s];if(!(null==l||"INPUT"!=l.tagName&&"TEXTAREA"!=l.tagName&&"SELECT"!=l.tagName||l.disabled||l.readOnly)){var n=scil.Utils.getParent(l,"TR");if(null!=n&&"none"!=n.style.display&&!l.disabled){i=l;break}}}else i=t[e];if(null!=i&&"none"!=i.style.dislay&&null!=i.focus)try{i.focus()}catch(t){}}},mergeForm:function(t,e){if(null==t&&null==e)return null;var i={};if(null==t){for(var s in e)null!=e[s]&&(i[s]=e[s]);return i}if(null==e){for(var s in t)null!=t[s]&&(i[s]=t[s]);return i}for(s in t)null==e[s]&&null!=t[s]&&(i[s]=t[s]);for(s in e)null!=e[s]?i[s]=e[s]:delete i[s];return i},createElement:function(t,e,i,s,l,n){return null!=l&&null!=l.title&&(l.title=scil.Lang.res(l.title)),scil.Utils.createElement(t,e,i,s,l,n)},expand:function(t){t=t.target||t.srcElement;if("TD"==t.tagName){var e=0<t.style.backgroundImage.indexOf("expand.gif");t.style.backgroundImage=e?scil.Utils.imgSrc("img/collapse.gif",!0):scil.Utils.imgSrc("img/expand.gif",!0);for(var i=t.parentNode.nextSibling;null!=i&&1!=i.childNodes.length&&"1"!=i.getAttribute("buttonrow");)"1"!=i.getAttribute("hidden")&&(i.style.display=e?"":"none"),i=i.nextSibling}},_isAllString:function(t){if(null==t||"object"!=typeof t)return!1;if(0<t.length)return!0;var e,i=0;for(e in t){if("string"!=typeof t[e])return!1;++i}return 0<i},_getListItems:function(t){"function"==typeof t.items&&(t.items=t.items());var e=t.items;return null==e&&null!=t.options&&null!=t.options.items&&(e=t.options.items,t.items=e,t.options.items=null),null==e&&this._isAllString(t.options)&&(e=t.options,t.items=e,t.options=null),e},createField:function(t,e,i,s,l,n,r,o){var a,h,u="input",c=e.type;switch(null==t||"input"!=c&&"select"!=c&&"date"!=c&&"color"!=c&&"radio"!=c&&"checkbox"!=c&&null!=c||(t.style.whiteSpace="nowrap"),!i||null!=c&&"input"!=c&&"select"!=c&&"editableselect"!=c&&"htmltext"!=c&&"multiselect"!=c&&"dropdowninput"!=c&&"dropdowncheck"!=c&&"date"!=c||null!=e.template||!r&&null!=e.unit||(c="html"),c){case"":case"hidden":case"date":case"color":case"editableselect":case"dropdowninput":case"dropdowncheck":case"multiselect":u="input";break;case"password":u="password";break;case"rawfile":u="file";break;case"number":u="input";break;case"htmltext":u="texarea";break;case"jsdraw":case"xdraw":case"jsdraw.fm":case"jsdraw.se":case"jsdraw.table":case"plate":case"plates":case"table":case"tabtext":case"richtext":case"plaintext":case"html":case"fileshelf":case"file":case"filepath":case"filelink":case"filedblink":case"subform":case"image":case"curve":case"sketches":case"code":case"signature":u="div";break;case"button":u="button";break;case"postfile":u="file";break;case"user":u="input",null==e.autosuggesturl&&(e.autosuggesturl="Ajax.ashx?cmd=user.suggest");break;default:null!=c&&(u=c)}if(e.viewonly&&(i=e.viewonly),i&&"textarea"==u&&(u="div"),"string"==typeof t&&(t=dojo.byId(t)),"checkbox"==c?(a=scil.Utils.createElement(t,"label",null,{whiteSpace:"nowrap"}),h=scil.Utils.createElement(a,u,null,e.style,e.attributes),null!=e.str&&scil.Utils.createElement(a,"span",o.lang.res(e.str))):(h=scil.Utils.createElement(t,u,null,e.style,e.attributes),!i||"div"!=u||"htmltext"!=e.type&&"textarea"!=e.type||null==e.width||null!=e.style&&null!=e.style.maxWidth||("number"==typeof e.width?h.style.maxWidth=e.width+"px":h.style.maxWidth=e.width,h.style.wordWrap="break-word")),"select"==e.type&&this._getListItems(e),"select"==u){var d=this._getListItems(e);if(null!=d){var p=e.addblank;if(null==p)if(null==d.length){for(var f in p=!0,d)if(null==d[f]||""==d[f]){p=!1;break}}else(0==d.length||null!=d[0]&&""!=d[0])&&(p=!0);p&&scil.Utils.listOptions(h,[""]),scil.Utils.listOptions(h,d,s,null,0!=e.sort)}else null!=e.url&&scil.Form.listOptions(h,e.url)}if(!i&&null!=e.button)if(0<e.button.length)for(var m=0;m<e.button.length;++m)this.createFieldButton(t,e.button[m],o,h);else this.createFieldButton(t,e.button,o,h);null!=e.button2&&scil.Utils.createButton(t,e.button2),r||null==e.str&&null==e.unit||"checkbox"==c||scil.Utils.createElement(t,"span","&nbsp;"+(e.str||e.unit),{whiteSpace:"nowrap"});r=r&&null!=e.listwidth?e.listwidth:e.width;null!=r&&0<r&&(h.style.width=r+"px"),0<e.height&&(!i||"div"!=u||"htmltext"!=e.type&&"textarea"!=e.type)&&(h.style.height=e.height+"px"),null!=e.align&&(h.style.textAlign=e.align),i?"input"==u||"password"==u?(h.readOnly=!0,h.style.border="none"):"checkbox"!=u&&"select"!=u||(h.disabled=!0):(e.readonly||e.viewonly)&&("input"==u?h.readOnly=!0:"checkbox"!=u&&"radio"!=u&&"select"!=u||(h.disabled=!0)),"div"==u&&"textarea"!=c&&"html"!=c||(h.style.color=JSDraw2.Skin.form.fieldcolor),h.stype=c;var g,w=scil.clone(e);null!=e.options&&scil.apply(w,e.options),i&&(w.viewonly=i),"jsdraw"==c||"xdraw"==c?(g=function(){"xdraw"==c&&(h.style.height=""),h.jsd=new("jsdraw"==c||i?JSDraw2.Editor:scil.XDraw)(h,w),scil.Utils.isNullOrEmpty(s)||scil.Form.setFieldData(h,e,i,s)},n?g():scil.ready(g)):"jsdraw.table"==c?(g=function(){if(h.jsd=new JSDraw2.Table(null,w,h),null!=s&&h.jsd.setXml(s),0<e.rows)for(var t=h.jsd.getRowCount();t<e.rows;++t)h.jsd.insert()},n?g():scil.ready(g)):"plate"==c||"plates"==c?(g=function(){null==w.hidetable&&(w.hidetable=!0),h.jsd=new("plate"==c?JSDraw2.Plate:JSDraw2.Plates)(h,w),null!=s&&h.jsd.setXml(s)},n?g():scil.ready(g)):"jsdraw.se"==c?(g=function(){h.jsd=new JSDraw2.SequenceEditor(h,w),null!=s&&h.jsd.setXml(s)},n?g():scil.ready(g)):"jsdraw.fm"==c?(g=function(){h.jsd=new JSDraw2.Formulation(h,w),null!=s&&h.jsd.setXml(s)},n?g():scil.ready(g)):"table"==c?(h.jsd=new scil.Table(w),h.jsd.render(h,e.columns),null!=s&&h.jsd.setXml(s)):"tabtext"==c?(h.jsd=new scil.FieldTabText(h,w),null!=s&&h.jsd.setXml(s)):"code"==c?(h.style.marginBottom="4px",h.jsd=new scil.FieldCode(h,w),null!=s&&h.jsd.setValue(s)):"signature"==c?(h.jsd=new scil.FieldSignature(h,w),null!=s&&h.jsd.setValue(s)):"richtext"==c?(h.jsd=new scil.FieldRichText(h,w),null!=s&&h.jsd.setXml(s)):"plaintext"==c?(h.jsd=new scil.FieldPlainText(h,w),null!=s&&h.jsd.setXml(s)):"subform"==c?(h.jsd=new scil.FieldSubform(h,w),null!=s&&h.jsd.setXml(s)):"file"==c||"filelink"==c||"filedblink"==c||"filepath"==c||"image"==c?("file"==c?h.jsd=new scil.FieldFile(h,w):"image"==c?h.jsd=new scil.FieldImage(h,w):"filelink"!=c&&"filedblink"!=c&&"filepath"!=c||(w.cmd=c,h.jsd=new scil.FieldFileLink(h,w)),null!=e.render&&(s=e.render(s,l)),null!=s&&h.jsd.setXml(s)):"sketches"==c?(h.jsd=new scil.FieldSketches(h,w),null!=e.render&&(s=e.render(s,l)),null!=s&&h.jsd.setXml(s)):"fileshelf"==c?(h.jsd=new scil.FileShelf(h,w),null!=s&&h.jsd.list(s)):"curve"==c?(h.jsd=new scil.FieldCurve(h,w),null!=s&&h.jsd.setXml(s)):"number"==c?(h.jsd=new scil.FieldNumber(h,w),this.setFieldData(h,e,i,s,l)):"date"==c?(i||e.viewonly||new scil.DatePicker(h,e.options),null!=s&&"{today}"==s&&(s=scil.Utils.dateStr(new Date,!0,"yyyy-mm-dd")),this.setFieldData(h,e,i,s,l)):"color"==c?(h.jsd=new scil.ColorPicker2(h,{viewonly:i}),this.setFieldData(h,e,i,s,l)):"button"==c?h.innerHTML=e.text:null==s&&("html"!=c||null==e.template&&null==e.render)||this.setFieldData(h,e,i,s,l),"img"==c&&null!=e.src&&(h.src=e.src),null!=e.title&&h.setAttribute("title",e.title),null!=e.onclick&&dojo.connect(h,"onclick",function(){e.onclick(h,e,o)}),"INPUT"==h.tagName&&(null!=e.onenter?dojo.connect(h,"onkeydown",function(t){13==t.keyCode&&(e.onenter(h),t.preventDefault())}):scil.Utils.isIE&&scil.Utils.isIE<9&&dojo.connect(h,"onkeydown",function(t){13==t.keyCode&&t.preventDefault()})),null!=e.autosuggest&&""!=e.autosuggest&&"INPUT"==h.tagName?h.jsd=new scil.AutoComplete(h,e.autosuggest,e.options,o):null!=e.autosuggesturl&&""!=e.autosuggesturl&&"INPUT"==h.tagName&&(h.jsd=new scil.AutoComplete(h,e.autosuggesturl,e.options,o));l=e.options;return null==l&&(l={}),null!=e.items&&(l.items=e.items),i||"editableselect"!=c?i||"dropdowninput"!=c?(i||"dropdowncheck"!=c)&&(i||"multiselect"!=c)?i||"htmltext"!=c||(null==w.buttons?w.buttons=[]:"string"==typeof w.buttons&&(w.buttons=[w.buttons]),w.buttons.push({iconurl:scil.Utils.imgSrc("img/uploadimg.gif"),tooltips:"Insert Image",onclick:function(t){scil.Richtext.insertImage(t)}}),w.buttons.push({iconurl:scil.Utils.imgSrc("img/benzene.gif"),tooltips:"Insert Structure",onclick:function(t){scil.Richtext.insertStructure(t)}}),null!=w.extrabuttons&&w.buttons.push(w.extrabuttons),null!=s&&""==s&&(h.value=s),scil.Richtext.initTinyMCE(h,w)):h.jsd=new scil.DropdownCheck(h,l):h.jsd=new scil.DropdownInput(h,l):h.jsd=new scil.EditableSelect(h,l),"INPUT"!=h.tagName&&"SELECT"!=h.tagName&&"TEXTAREA"!=h.tagName||(null!=e.onchange&&dojo.connect(h,"onchange",function(){e.onchange(h,o)}),null!=e.onfocus&&dojo.connect(h,"onfocus",function(){e.onfocus(h,o)}),null!=e.onblur&&dojo.connect(h,"onblur",function(){e.onblur(h,o)})),0<=e.padding&&("INPUT"==h.tagName||"DIV"==h.tagName)&&(h.style.paddingLeft=h.style.paddingRight=e.padding+"px"),"INPUT"==h.tagName&&1!=h.disabled&&"checkbox"!=e.type&&"radio"!=e.type&&dojo.connect(h,"onfocus",function(){h.select()}),null!=h.jsd&&(h.jsd.parentform=o),h},createFieldButton:function(t,e,i,s){t=scil.Utils.createButton(t,e);null!=t&&(null!=e.onclick2?dojo.connect(t,"onclick",function(){e.onclick2(s,i)}):null!=e.ajaxurl&&dojo.connect(t,"onclick",function(){scil.Utils.ajax(e.ajaxurl,function(t){null!=e.append?s.value+=t+e.append:s.value=t},{q:s.value})}))},getFieldData:function(t,e){if(null==t)return null;if("jsdraw"==t.stype)return null!=e&&null!=e.dataformat?t.jsd.getData(e.dataformat):t.jsd.getXml();if("xdraw"==t.stype||"jsdraw.se"==t.stype||"jsdraw.fm"==t.stype||"table"==t.stype||"plate"==t.stype||"plates"==t.stype)return t.jsd.getXml();if("jsdraw.table"==t.stype)return 0==t.jsd.getRowCount()?null:t.jsd.getXml();if("checkbox"==t.type||"radio"==t.type)return t.checked;if("htmltext"!=t.stype)return"file"==t.stype||"filelink"==t.stype||"filedblink"==t.stype||"filepath"==t.stype||"image"==t.stype||"curve"==t.stype||"sketches"==t.stype||"tabtext"==t.stype||"richtext"==t.stype||"plaintext"==t.stype||"subform"==t.stype?t.jsd.getXml():"code"==t.stype||"signature"==t.stype||"number"==t.stype?t.jsd.getValue():"password"==t.type?""==t.value?"":0!=e.encrypt&&null!=JSDraw2.password&&JSDraw2.password.encrypt&&null!=scil.Form.encryptpassword?scil.Form.encryptpassword(t.value):t.value:"postfile"==t.stype||"button"==t.stype?null:null==t.value?t.getAttribute("originalvalue"):""==t.value?null:t.value;e=scil.Form.getEd(t);return null==e?t.innerHTML:scil.Richtext.getHtml(e)},setFieldData:function(t,e,i,s,l){if(null!=e){var n,r=s;if(null!=e.render&&(s=e.render(s,l)),i&&0<e.maxlength&&"string"==typeof s&&s.length>e.maxlength&&(s=s.substr(0,e.maxlength-3)+"..."),"jsdraw"==t.stype||"xdraw"==t.stype||"jsdraw.table"==t.stype||"jsdraw.se"==t.stype||"jsdraw.fm"==t.stype||"plate"==t.stype||"plates"==t.stype){if("jsdraw"==t.stype||"xdraw"==t.stype||"jsdraw.table"==t.stype&&null!=e.options&&e.options.spreadsheet?t.jsd.clear(!0):t.jsd.clear(),"jsdraw"==e.type)null!=e.dataformat?t.jsd.setData(s,e.dataformat):null==s||"string"==typeof s&&""==s||t.jsd.setXml(s);else if(null!=s&&null!=s.rows&&"jsdraw.table"==t.stype?t.jsd.setJson(s):null==s||"string"==typeof s&&""==s||t.jsd.setXml(s),"jsdraw.table"==t.stype&&null!=e.options&&e.options.spreadsheet&&t.jsd.createTable(),"jsdraw.table"==t.stype&&0<e.rows)for(var o=t.jsd.getRowCount();o<e.rows;++o)t.jsd.insert()}else if("table"==t.stype)null!=s&&("string"==typeof s||"object"==typeof s&&"table"==s.tagName)?t.jsd.setXml(s):null!=s&&0<s.length?t.jsd.setData(s):t.jsd.setData([]);else if("tabtext"==e.type||"richtext"==e.type||"plaintext"==e.type)t.jsd.setXml(s);else if("checkbox"==e.type||"radio"==e.type)t.checked=scil.Utils.isTrue(s);else if("select"==e.type)i?(null!=(n=this._getListItems(e))&&null==n.length&&(s=n[s]),this._setInnerHTML(t,s,r)):scil.Utils.selectOption(t,s);else if("date"==e.type){"string"!=typeof s||scil.Utils.isNullOrEmpty(s)||isNaN(s)||(s=parseFloat(s),isNaN(s)&&(s=null));var a=null==e.timeformat?scil.Utils.dateStr(s,!0,e.dateformat):scil.Utils.timeStr(s,!0,e.timeformat);!i||"INPUT"==t.tagName?t.value=a:this._setInnerHTML(t,a,r)}else if("color"==e.type)t.jsd.setValue(s);else if("code"==t.stype)t.jsd.setValue(s);else if("signature"==t.stype)t.jsd.setValue(s);else{if("number"==t.stype)return t.jsd.setValue(s);"html"==t.stype?(a=null==s?"":s,null!=e&&null!=e.template?a=this.renderTemplate(e.template,s,l):"string"==typeof a&&null!=a.match(/^((http[s]?)|(ftp)):[\/]{2}.+$/i)&&(a="<a target=_blank href='"+a+"'>"+a+"</a>"),this._setInnerHTML(t,a,r)):"file"==t.stype||"filelink"==t.stype||"filedblink"==t.stype||"filepath"==t.stype||"image"==t.stype||"curve"==t.stype||"sketches"==t.stype||"subform"==t.stype?t.jsd.setXml(s):"fileshelf"==t.stype?t.jsd.list(s):"htmltext"==e.type?i?this._setInnerHTML(t,t.innerHTML=null==s?"":s,r,!0):null!=(i=scil.Form.getEd(t))&&null!=i.dom?i.setContent(null==s?"":s):t.value=null==s?"":s:"textarea"==t.stype?"TEXTAREA"==t.tagName?t.value=null==s?"":s:this._setInnerHTML(t,this.wrapTextarea(s),r,!0):"div"!=t.stype&&"button"!=t.stype&&("hidden"==t.stype&&null!=s&&"object"==typeof s&&null!=s.tagName&&(s=scil.Utils.getOuterXml(s)),"INPUT"==t.tagName||"TEXTAREA"==t.tagName?t.value=null==s?"":s:"DIV"==t.tagName&&this._setInnerHTML(t,null==s?"":s,r))}null!=e.onrendered&&e.onrendered(t,s)}},wrapTextarea:function(t){return null==t?"":"<pre style='margin:0;padding:0;white-space: -moz-pre-wrap; white-space: -pre-wrap; white-space: -o-pre-wrap; white-space: pre-wrap; word-wrap: break-word;'>"+scil.Utils.escapeHtml(t)+"</pre>"},_setInnerHTML:function(t,e,i,s){null==e?e="":s&&(e+="<div style='clear:both'></div>"),t.innerHTML=e,null!=i&&i+""!=""&&t.setAttribute("originalvalue",i)},renderTemplate:function(t,e,i){if(s=t.replace(/\{\?\}/g,null==e?"":e),null==i)return s;var l=s.match(/\{\{[a-z|0-9]+\}\}/gi);if(null==l)return s;for(var n=0;n<l.length;++n){var r=l[n],o=i[r.substr(2,r.length-4)];s=s.replace(r,null==o?"":o)}return s},listOptions:function(e,t){scil.Utils.ajax(t,function(t){scil.Utils.listOptions(e,t)})},create:function(t,e,i,s,l){"string"==typeof e&&(e=dojo.byId(e));e=scil.Utils.createElement(e,"div"),l=new scil.Form(l);if(l.render(e,i),null!=s){var i=scil.Utils.createElement(l.tbody,"tr"),n=scil.Utils.createElement(i,"td"),n=scil.Utils.createElement(i,"td");if(null==s.length)scil.Utils.createButton(n,s);else for(var r=0;r<s.length;++r)scil.Utils.createButton(n,s[r])}return null!=t.load&&scil.onload(function(){t.load()}),l},createForm2:function(t,e,i,s){null==s&&(s={});var l=null;if(null!=i&&(s.buttons=i),null!=s.tabs)l=new scil.TabbedForm(s).render(t);else for(var n in(l=new scil.Form(s)).render(t,e,s),e)null!=e[n]&&"group"==e[n].type&&null!=e[n].group&&e[n].collapsed&&this.expand({target:e[n].group});return l},_connetOnClick:function(t,e){dojo.connect(t,"onclick",function(){e()})},createDlgForm:function(t,e,i,s){var l={};"number"==typeof s?(l.width=s+"px",s=null):null!=s&&0<s.width&&(l.width=s.width+"px");l=scil.Utils.createElement(null,"div",null,l),t=new JSDraw2.Dialog(t,l,s);return t.show(),t.form=this.createForm2(l,e,i,s),t._scilform=!0,t.hide(!0),t.show2({owner:this}),null!=s&&s.oncreated&&s.oncreated(t.form),t},createFormDlg:function(t,e,i,s){return this.createDlgForm(t,e,i,s)},createTabDlgForm:function(t,e){return this.createDlgForm(t,null,null,e)},createForm:function(t,e,i,s,l,n){var r={verticalAlign:"top",whiteSpace:"nowrap"},o={textAlign:"left"};s&&(r.border="solid 1px #f0f0f0",r.backgroundColor="#f5f5f5");for(var a=scil.Utils.createTable(),h=!1,u=0;u<t.length;++u)if(t[u].required){h=!0;break}h&&(p=scil.Utils.createElement(a,"tr"),scil.Utils.createElement(p,"td"),scil.Utils.createElement(p,"td","<span style='color:red;font-weight:bold'>* indicates required field</span>",o));for(u=0;u<t.length;++u){var c,d=t[u],p=scil.Utils.createElement(a,"tr"),f=scil.Utils.createElement(p,"td",d.label+(d.required?"<b style='color:red'>*</b>":""),r);d.colspan?f.colSpan=2:(f=scil.Utils.createElement(p,"td",null,o),null!=d.tag&&(c=scil.Utils.createElement(f,d.tag),"select"==d.tag&&scil.Utils.listOptions(c,d.options),null!=d.width&&(c.style.width=d.width+"px"),null!=d.height&&(c.style.height=d.height+"px"),null!=d.id&&(c.id=d.id),"hidden"==d.tag&&(p.style.display="none"),null!=d.align&&(c.style.textAlign=d.align),d.id==n&&dojo.connect(c,"onkeydown",function(t){13==t.keyCode&&(i(),t.preventDefault())})),null!=d.span&&scil.Utils.createElement(f,"span",d.span))}p=scil.Utils.createElement(a,"tr");scil.Utils.createElement(p,"td","&nbsp;"),p=scil.Utils.createElement(a,"tr"),scil.Utils.createElement(p,"td");f=scil.Utils.createElement(p,"td");if(null!=e)if("string"==typeof e){var m=scil.Utils.createElement(f,"button",e);dojo.connect(m,"onclick",i)}else if(null!=e&&"object"==typeof e&&0<e.length)for(u=0;u<e.length;++u){var g=e[u],m=scil.Utils.createElement(f,"button",g.caption);null!=g.id&&(m.id=g.id),this._connetOnClick(m,g.onclick)}return null!=l&&scil.Utils.createElement(f,"span",l),a.parentNode},fillForm:function(t,e){for(k in t){var i=dojo.byId((null==e?"":e)+k);null!=i&&("SELECT"==i.tagName?JsUtils.selectOption(i,t[k]):i.value=null==t[k]?"":t[k])}},collectFormData:function(t){for(var e={},i=t.getElementsByTagName("input"),s=0;s<i.length;++s)switch(((n=i[s]).getAttribute("type")+"").toLowerCase()){case"radio":case"checkbox":n.checked&&this._addValue(e,n.id,null==n.value||0==n.value.length?"true":n.value);break;case"button":break;default:this._addValue(e,n.id,n.value)}for(var l=t.getElementsByTagName("textarea"),s=0;s<l.length;++s){var n=l[s];this._addValue(e,n.id,n.value)}for(var r=t.getElementsByTagName("select"),s=0;s<r.length;++s){n=r[s];this._addValue(e,n.id,n.value)}return e},_addValue:function(t,e,i){var s;null!=e&&0!=e.length&&(0<(s=e.lastIndexOf("."))&&(e=e.substr(s+1)),t[e]=i)},toAmount:function(t,e){return null==t||0==t?"-":1e3<=t?t/1e3+(e?"L":"kg"):t<.001&&e?1e6*t+"ug":t<1?1e3*t+(e?"uL":"mg"):t+(e?"mL":"g")},processAmount:function(t){0<t.amount||(t.amount=null),0<t.amountleft||(t.amountleft=null);var e=null==t.amount?t.amountleft:t.amount;e<=0&&(e=null),null===e?t.unit=t.isliquid?"L":"kg":1e3<=e?(t.amount/=1e3,t.amountleft/=1e3,t.unit=t.isliquid?"L":"kg"):e<.001&&!t.isliquid?(t.amount*=1e6,t.amountleft*=1e6,t.unit="ug"):e<1?(t.amount*=1e3,t.amountleft*=1e3,t.unit=t.isliquid?"uL":"mg"):t.unit=t.isliquid?"mL":"g"},setButtonValueByKey:function(t,e,i){if(null!=t&&!scil.Utils.isNullOrEmpty(e)&&!scil.Utils.isNullOrEmpty(i))for(var s=0;s<t.length;++s)if(t[s].key==e){t[s].b.value=i;break}},getButtonValueByKey:function(t,e){if(null==t)return null;for(var i=0;i<t.length;++i)if(t[i].key==e)return t[i].b.value;return null},getButtonValuesByKey:function(t,e,i){null==i&&(i={});for(var s=0;s<e.length;++s)i[e[s]]=this.getButtonValueByKey(t,e[s]);return i},createToolbarButtons:function(t,e,i,s){if(null!=t&&null!=e){var l=null;null!=s&&(l=scil.Utils.createElement(scil.Utils.createTable2(t,null,{cellSpacing:0,cellPadding:0,align:s}),"tr"));for(var n=0;n<e.length;++n)(0!=n&&"-"!=e[n-1]&&"|"!=e[n-1]||"-"!=e[n]&&"|"!=e[n])&&(null!=s&&(t=scil.Utils.createElement(l,"td")),this._createButton(t,e[n],i))}},_createButton:function(t,e,i){var s;null!=e&&(("number"!=typeof i||i<=0)&&(i=3),"-"!=e&&"|"!=e?(e.label=scil.Lang.res(e.label),e.caption=scil.Lang.res(e.caption),e.title=scil.Lang.res(e.title),s=null,"select"==e.type?(null!=e.label&&(scil.Utils.createElement(t,"span",e.label+":",e.labelstyle).style.marginLeft=i+"px"),s=scil.Utils.createElement(t,"select",null,e.styles,e.attributes),scil.Utils.listOptions(s,e.items||e.options,e.value,null,e.sort),null!=e.onchange&&dojo.connect(s,"onchange",function(t){e.onchange(t)}),s.style.marginRight=i+"px"):"input"==e.type||"date"==e.type||"color"==e.type?(null!=e.label&&(scil.Utils.createElement(t,"span",e.label+":",e.labelstyle).style.marginLeft=i+"px"),s=scil.Utils.createElement(t,"input",null,e.styles,e.attributes),null!=e.onenter&&dojo.connect(s,"onkeydown",function(t){13==t.keyCode&&e.onenter(s)}),null!=e.onchange&&dojo.connect(s,"onchange",function(t){e.onchange(t)}),null!=e.autosuggesturl&&new scil.AutoComplete(s,e.autosuggesturl,{onsuggest:e.onsuggest}),s.style.marginRight=i+"px","date"==e.type?new scil.DatePicker(s):"color"==e.type&&new scil.ColorPicker2(s),null!=e.value&&(s.value=e.value)):(s=scil.Utils.createButton(t,e)).style.margin=i+"px",e.b=s):scil.Utils.createElement(t,"span","|",{margin:"0 "+2*i+"px 0 "+2*i+"px"}))},getEd:function(t){return tinymce.get(t.id)},dict2formxml:function(t){return this.json2xml(t)},json2xml:function(t,e){if(null==t)return null;var i,s=e?"":"<data>\n";for(i in t){var l=t[i];null!=l&&""!=l&&(s+="<i n='"+scil.Utils.escXmlValue(i)+"'>",s+=scil.Utils.escXmlValue(l),s+="</i>\n")}return e||(s+="</data>"),s},encryptpassword:function(t){if(scil.Utils.isNullOrEmpty(t))return null;var e=CryptoJS.enc.Utf8.parse(null!=JSDraw2.password&&null!=JSDraw2.password.key?JSDraw2.password.key:"PSVJQRk9qTEp!6U1dWUZ%RVFG=1VVT0="),i=CryptoJS.enc.Utf8.parse(null!=JSDraw2.password&&null!=JSDraw2.password.iv?JSDraw2.password.iv:"!WlSLVE2ZU+NaW?=");return"(?|"+CryptoJS.AES.encrypt(t,e,{iv:i,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7})+")"},xml2Json:function(t){var e=null;if("object"==typeof t?e=t:"string"!=typeof t||null!=(t=scil.Utils.parseXml(t))&&(e=t.documentElement||t.firstElementChild),null==e||null==e.childNodes)return null;for(var i={},s=0;s<e.childNodes.length;++s){var l,n,r=e.childNodes[s];"i"==r.tagName&&(null==(l=r.getAttribute("id"))&&(l=r.getAttribute("n")),null!=(n=scil.Utils.getFirstElement(r))&&scil.Utils.isIE&&scil.Utils.isIE<9&&(n=n.xml),i[l]=null!=n?n:r.text||r.textContent)}return i},ext2Icon:function(t){if(null==t)return"unknown";var e=t.lastIndexOf(".");if(e<0)return"unknown";var i=t.substr(e+1).toLowerCase();switch(i){case"avi":case"bmp":case"c":case"cab":case"cdx":case"cer":case"chm":case"dll":case"doc":case"eps":case"exe":case"fasta":case"fdf":case"gif":case"hlp":case"htm":case"iso":case"jar":case"java":case"jdx":case"jpg":case"js":case"jsdraw":case"mdb":case"mht":case"molengine":case"mov":case"mp3":case"mrv":case"msg":case"msi":case"pdb":case"pdf":case"pic":case"ppt":case"ps":case"py":case"pyc":case"rm":case"sdf":case"skc":case"sql":case"swf":case"txt":case"vbs":case"vsd":case"xls":case"xml":case"xps":case"zip":return i;case"docx":case"rtf":return"doc";case"dx":return"jdx";case"oxps":return"xps";case"pptx":return"ppt";case"xlsx":case"csv":return"xls";case"jpeg":return"jpg";case"svg":case"tif":case"tiff":return"pic";case"mp4":return"mp3";case"wav":return"avi";case"png":case"wmf":case"emf":return"bmp";case"html":case"shtml":case"xhtml":return"htm";case"gz":return"zip";case"cdxml":return"cdx";case"tgf":return"skc";case"mol":case"rxn":case"jsd":case"jssdf":return"jsdraw";case"cs":case"vb":case"cpp":case"c":case"aspx":case"asp":return"script";case"config":return"xml";default:return"unknown"}}}),scil.AutoComplete=scil.extend(scilligence._base,{constructor:function(t,e,i,s){this.input=null,this.auto=null,this.url=e,this.sugid=0,this.disabled=!1,this.options=null==i?{}:i,this.form=s;var l=this;this.input="string"==typeof t?document.getElementById(t):t,"INPUT"==this.input.tagName&&(scil.connect(this.input,"onkeyup",function(t){l.keydown(t)}),this.auto=scil.Utils.createElement(document.body,"div",null,{display:"none",backgroundColor:"white",border:"solid 1px gray",position:"absolute"}),scil.connect(document.body,"onmousedown",function(t){t=t.srcElement||t.target;t==l.q||scil.Utils.isChildOf(t,l.auto)||l.clickout()}),this.options.listedonly&&scil.connect(this.input,"onblur",function(t){l.validateList()})),scil.AutoComplete._all.push(this)},validateList:function(){var t=this.input.value;(null==this.items||scil.Utils.indexOf(this.items,t)<0)&&(this.input.value="")},isVisible:function(){return null!=this.auto&&""==this.auto.style.display},hide:function(){null!=this.auto&&(this.auto.style.display="none")},keydown:function(t){var e,i,s,l;this.disabled||null==this.input||null==this.url||""==this.url||(this.input.value.length<1||27==t.keyCode||t.ctrlKey||t.metaKey?this.auto.style.display="none":!this.isVisible()&&13==t.keyCode||(38!=t.keyCode&&40!=t.keyCode&&13!=t.keyCode?(e=++this.sugid,scil.Utils.startswith(this.url,"data:")?(l=this.filterlist(this.url.substr(5).split(","),this.input.value),this.list(l,e)):scil.Utils.startswith(this.url,"javascript:")?(i=this.url.substr(11),scil.Utils.eval(i),i=fun(this),l=this.filterlist(i,this.input.value),this.list(l,e)):(l={q:(s=this).input.value},null!=this.options.onsuggest&&this.options.onsuggest(l,this.form,this),scil.Utils.jsonp(this.url,function(t){s.list(null==t.items?t:t.items,e)},l))):this.highlight(t)))},filterlist:function(t,e){var i=[];if(null!=e&&""!=e&&null!=t){e=e.toLowerCase();for(var s=0;s<t.length;++s)0<=t[s].toLowerCase().indexOf(e)&&i.push(scil.Utils.trim(t[s]))}return i},isParentHidden:function(t){for(var e=t;null!=e&&null!=e.style;){if("none"==e.style.display||"hidden"==e.style.visibility)return!0;e=e.parentNode}return!1},list:function(t,e){if(null==t||0==t.length||e!=this.sugid||this.isParentHidden(this.input))return this.items=null,void(this.auto.style.display="none");var i,s,l,n;""!=this.auto.style.display&&(i=scilligence.Utils.getOffset(this.input),s=scilligence.Utils.scrollOffset(),l=scil.Utils.getZindex(this.input)+1,scil.Utils.isIE&&(n=JsUtils.getScrollOffset(this.e),s.offset(-n.x,-n.y)),e=this.input.offsetWidth,0<this.options.minautowidth&&this.options.minautowidth>e&&(e=this.options.minautowidth),e<100&&(e=100),n=scil.Utils.isFixedPosition(this.input)?"fixed":"absolute",dojo.style(this.auto,{zIndex:l,position:n,display:"",width:e-2+"px",left:i.x+s.x+"px",top:i.y+s.y+this.input.offsetHeight+"px"})),this.items=t,scilligence.Utils.removeAll(this.auto);for(var r=this,o=0;o<t.length;++o){var a=scilligence.Utils.createElement(this.auto,"div",t[o]);dojo.connect(a,"onclick",function(t){r.click(t)}),dojo.connect(a,"onmouseover",function(t){r.mouseover(t)}),dojo.connect(a,"onmouseout",function(t){r.mouseout(t)})}},highlight:function(t){if(null!=this.auto&&"none"!=this.auto.style.display)if(t.preventDefault(),27!=t.keyCode){for(var e,i=this.auto.childNodes,s=null,l=0;l<i.length;++l)if("1"==i[l].getAttribute("sel")){s=l;break}13!=t.keyCode?(e=null,38!=t.keyCode&&40!=t.keyCode||(null==s?e=0:38==t.keyCode?(e=s-1)<0&&(e=i.length-1):(e=s+1)>=i.length&&(e=0),t.preventDefault()),null!=e&&e!=s&&(null!=s&&this._hilitItem(i[s],!1),this._hilitItem(i[e],!0))):null!=s&&this.clickItem(i[s])}else this.hide()},mouseover:function(t){this._hilitItem(t.srcElement||t.target,!0)},mouseout:function(t){this._hilitItem(t.srcElement||t.target,!1)},_hilitItem:function(t,e){e?(t.style.backgroundColor="#ddf",t.setAttribute("sel","1")):(t.style.backgroundColor="white",t.removeAttribute("sel"))},getItemValue:function(t){t=unescape(t.innerHTML);return"&nbsp;"==t&&(t=""),t},click:function(t){t=t.srcElement||t.target;this.clickItem(t)},clickItem:function(t){t=this.getItemValue(t);null!=this.options.onSetValue?this.options.onSetValue(this.input,t):"unit"==this.options.overwrite?this.input.value=this.changeUnit(this.input.value,t):0==this.options.overwrite?this.input.value+=t:this.input.value=t,this.hide(),this.options.overwrite&&this.input.select(),this.input.focus(),null!=this.options.onclickitem&&this.options.onclickitem(t),scil.Utils.fireEvent(this.input,"change",!1,!0)},clickout:function(t){""==this.auto.style.display&&(this.auto.style.display="none")}}),scil.apply(scil.AutoComplete,{_all:[],hideAll:function(){for(var t=0;t<this._all.length;++t)this._all[t].hide()}}),scilligence.Progress={dlg:null,bar:null,msg:null,oncancel:null,show:function(t,e,i,s){this.create(),0==e?(this.cancelbtn.style.display="none",this.oncancel=null):"function"==typeof e&&(this.cancelbtn.style.display="",this.oncancel=e),this.msg.innerHTML=null==i?"":i,this.frame.style.display=0==s?"none":"",this.dlg.show(t)},hide:function(){null!=this.dlg&&this.dlg.hide()},cancel:function(){null!=this.oncancel&&this.oncancel(),this.hide()},update:function(t,e){100<t?t=100:0<t||(t=0);t=Math.round(300*t/100);t<0&&(t=0),this.bar.style.width=t+"px",this.msg.innerHTML=null==e?"":e},create:function(t){if(null!=this.dlg)return!1;var e=scilligence.Utils.createElement(null,"div",null,{margin:"5px",width:"320px",textAlign:"center"});return this.animator=scilligence.Utils.createElement(e,"div",scil.Utils.imgTag("animator.gif"),{textAlign:"center"}),this.msg=scilligence.Utils.createElement(e,"div","&nbsp;",{textAlign:"center"}),this.frame=scilligence.Utils.createElement(e,"div",null,{width:"300px",height:"20px",border:"solid 1px #e0e0e0",textAlign:"left"}),this.bar=scilligence.Utils.createElement(this.frame,"div","&nbsp;",{width:"1px",height:"20px",backgroundColor:"blue"}),this.cancelbtn=scilligence.Utils.createElement(e,"button",scil.Utils.imgTag("cancel.gif")+"Cancel",{marginTop:"10px"}),dojo.connect(this.cancelbtn,"onclick",function(){scilligence.Progress.cancel()}),this.dlg=new JSDraw2.Dialog("Progress",e),!0}},scil.Table=scil.extend(scil._base,{constructor:function(t,e,i){null!=t&&"object"==typeof t?(this.options=t,this.viewonly=this.options.viewonly,this.header=this.options.header):(this.viewonly=t,this.header=e,null==scil.Table._tableincrease&&(scil.Table._tableincrease=0),this._tableid=++scil.Table._tableincrease,this.options="function"==typeof i?{onAdd:i}:null==i?{}:i),this.groupIndex=0,this.checkIndex=1,this.dataIndex=2,this._startrow=2,this.tbody=null,this.items=null,this.key=null,this._lastcheck=null},getXml:function(){var t=this.tbody.childNodes.length-this._startrow;if(0==t)return"";for(var e="<table>\n",i=0;i<t;++i){var s=this.tbody.childNodes[i+this._startrow],l=!1,n={},r=this.dataIndex;for(a in this.items){var o=scil.Form.getFieldData(s.childNodes[r++].field);n[a]=o,l||null==o||""==o||(l=!0)}if(l){for(var a in e+="<r","1"==s.getAttribute("isnew")&&(e+=" isnew='1'"),e+=">\n",n)null!=(o=n[a])&&""!=o&&(e+="<i n='"+scil.Utils.escXmlValue(a)+"'>"+scil.Utils.escXmlValue(o)+"</i>\n");e+="</r>\n"}}return e+="</table>"},setXml:function(t,e){var i=null;"object"==typeof t?i=t:"string"!=typeof t||null!=(t=scil.Utils.parseXml(t))&&(i=t.documentElement||t.firstElementChild);var s=[];try{null!=i&&null==i.getElementsByTagName&&(i=null)}catch(h){}if(null!=i)for(var l=i.getElementsByTagName("r"),n=0;n<l.length;++n){for(var r={},o=l[n].getElementsByTagName("i"),a=0;a<o.length;++a){var h=o[a];r[h.getAttribute("n")]=h.text||h.textContent}s.push(r)}this.setData(s)},getCsv:function(){var t="",e=0;for(l in this.items)1<++e&&(t+=","),t+=scil.Utils.escCsvValue(this.items[l].label);t+="\n";for(var i=this.tbody.childNodes.length-this._startrow,s=0;s<i;++s){var l,n=this.tbody.childNodes[s+this._startrow],r=this.getRowData(n,!0),e=0;for(l in this.items)1<++e&&(t+=","),t+=scil.Utils.escCsvValue(r[l]);t+="\n"}return t},getData:function(t,e,i){if(null==t){for(var s=[],l=this.tbody.childNodes.length-this._startrow,n=0;n<l;++n){var r=this.tbody.childNodes[n+this._startrow],o=this.getRowData(r,i);s.push(o)}return s}l=this.tbody.childNodes.length-this._startrow;t[e+".n"]=l;for(n=0;n<l;++n){var a=e+"."+n+".";"1"==(r=this.tbody.childNodes[n+this._startrow]).getAttribute("isnew")&&(t[a+"isnew"]=1);var h,u=this.dataIndex;for(h in this.items)t[a+h]=scil.Form.getFieldData(r.childNodes[u++].field)}},getRowData:function(t,e){if(null==t)return null;if("number"==typeof t&&null==(t=this.tbody.childNodes[t+this._startrow]))return null;var i={};"1"==t.getAttribute("isnew")&&(i.isnew=1);var s,l=this.dataIndex;for(s in this.items){var n=t.childNodes[l++],n=null==n?null:scil.Form.getFieldData(n.field);null!=n&&""!=n&&(i[s]=n)}return e&&t.childNodes[this.checkIndex].firstChild.checked&&(i.rowchecked=!0),i},getRowTexts:function(t){if(null==t)return null;if("number"==typeof t&&null==(t=this.tbody.childNodes[t+this._startrow]))return null;var e={};"1"==t.getAttribute("isnew")&&(e.isnew=1);var i,s=this.dataIndex;for(i in this.items){var l=t.childNodes[s++],l=l.text||l.textContent;null!=l&&""!=l&&(e[i]=l)}return e},getCurrentRowData:function(){return this.getRowData(this.currow)},setData:function(t,e){if(this.clear(),null!=t)for(var i=0;i<t.length;++i)this.addRow(t[i],e);this.viewonly||0==this.options.addrow||this.addRow()},clear:function(){this.dirty=!1;for(var t=this.tbody.childNodes.length-1;t>=this._startrow;--t)this.tbody.removeChild(this.tbody.childNodes[t]);this.currow=null},render:function(t,e){for(var i in this.items={},e)null!=e[i]&&(this.items[i]=e[i],e[i].iskey&&(this.key=i));this._hideCookieCols(this.items),"string"==typeof t&&(t=dojo.byId(t));var s=this,t=scil.Utils.createElement(t,"div");this.tbody=scilligence.Utils.createTable(t,0,3,{borderRight:JSDraw2.Skin.jssdf.border,borderBottom:JSDraw2.Skin.jssdf.border,borderTop:JSDraw2.Skin.jssdf.border}),this.tbody.parentNode.setAttribute("class","scil_table"),this.viewonly||0==this.options.addrow||(t=scil.Utils.createElement(scil.Utils.createElement(t,"div"),"img",null,null,{src:scil.Utils.imgSrc("img/add.gif"),title:scil.Lang.res("Add")}),dojo.connect(t,"onclick",function(){null!=s.options.onAdd?s.options.onAdd(s):s.addRow()}));var l=scil.Utils.createElement(this.tbody,"tr"),n=this.options.header0,r=scil.Utils.createElement(this.tbody,"tr");if(null!=n){scil.Utils.createElement(l,"td",null,{display:this.options.grouping?"":"none"}),scil.Utils.createElement(l,"td",null,{display:this.options.rowcheck?"":"none"});for(var o=0;o<n.length;++o)null==(u=n[o])?scil.Utils.createElement(l,"td"):(a=scil.Utils.createElement(l,"td",scil.Lang.res(u.label),scil.Table.headerstyles,{colSpan:u.colspan})).style.textAlign="center"}var a=scil.Utils.createElement(r,"td",null,scil.Table.headerstyles);this.options.grouping?(a.style.width="5px",scil.Utils.createElement(a,"img",null,null,{src:scil.Utils.imgSrc("img/minus.gif")},function(t){s.groupExpandAll(t)})):a.style.display="none";a=scil.Utils.createElement(r,"td",null,scil.Table.headerstyles);this.options.rowcheck?(a.style.width="5px","radio"!=this.options.rowcheck&&scil.Utils.createElement(a,"checkbox",null,null,null,function(t){s.checkAll((t.srcElement||t.target).checked)})):a.style.display="none";var h=scil.clone(scil.Table.headerstyles);for(i in h.borderBottom=JSDraw2.Skin.jssdf.border,h.borderLeft=JSDraw2.Skin.jssdf.border,this.items){var u=this.items[i],c=scil.Lang.res(u.label);null!=u.unit&&""!=u.unit&&(c+=" ("+scil.Lang.res(u.unit)+")");a=scil.Utils.createElement(r,"td",c,h,{key:i});null!=u.width&&(a.style.width=u.width+"px"),"hidden"!=u.type&&!u.ishidden||(a.style.display="none"),"checkbox"!=u.type||0==u.headercheckbox||this.viewonly||u.viewonly||(c=scil.Utils.createElement(a,"checkbox"),this.connectCheckAll(c,i))}0==this.header&&(r.style.display="none"),this.viewonly||(0!=this.options.delrow&&scil.Utils.createElement(r,"td","&nbsp;",h),this.addRow()),this.options.selectrow&&dojo.connect(this.tbody,"onclick",function(t){s.clickRow(t)})},connectCheckAll:function(t,e){var i=this;dojo.connect(t,"onclick",function(t){i.checkAll((t.srcElement||t.target).checked,e)})},hidColumn:function(t){return this.showColumn(t,!1)},showColumn:function(t,e){if(null!=this.options.header0)return!1;null==e&&(e=!0);var i=this.items[t];if(null==i||"hidden"==i.type)return!1;if(i.ishidden=!e,null==this.tbody||this.tbody.childNodes.length<=1)return!1;var s=this.getColIndex(t);if(-1==s)return!1;for(var l=1;l<this.tbody.childNodes.length;++l)this.tbody.childNodes[l].childNodes[s].style.display=e?"":"none";return!0},getColIndex:function(t){for(var e=this.tbody.childNodes[1],i=0;i<e.childNodes.length;++i)if(e.childNodes[i].getAttribute("key")==t)return i;return-1},checkAll:function(t,e){var i=this.tbody.childNodes;if(null==e)for(var s=this._startrow;s<i.length;++s)"none"==i[s].style.display?i[s].childNodes[this.checkIndex].firstChild.checked=!1:i[s].childNodes[this.checkIndex].firstChild.checked=t;else{var l=this.getColIndex(e);if(-1==l)return!1;for(var n,s=this._startrow;s<i.length;++s)"none"==i[s].style.display?i[s].childNodes[this.checkIndex].firstChild.checked=!1:null!=(n=i[s].childNodes[l].getElementsByTagName("input"))&&1==n.length&&(n[0].checked=t)}},getCheckedRows:function(){for(var t=[],e=this.tbody.childNodes,i=this._startrow;i<e.length;++i)e[i].childNodes[this.checkIndex].firstChild.checked&&t.push(i-this._startrow);return t},getCheckedRowData:function(){for(var t=[],e=this.tbody.childNodes,i=this._startrow;i<e.length;++i)e[i].childNodes[this.checkIndex].firstChild.checked&&t.push(this.getRowData(e[i]));return t},getCheckedRowData2:function(){for(var t=[],e=this.tbody.childNodes,i=this._startrow;i<e.length;++i)e[i].childNodes[this.checkIndex].firstChild.checked&&t.push(this.getRowData(e[i]));return 0==t.length&&null!=this.cur&&t.push(this.getCurrentRowData()),t},getKey:function(t){return null==t?null:t.getAttribute("key")},checkRow:function(t){if(this.options.rowcheck)if("string"==typeof t)for(var e=this.tbody.childNodes,i=this._startrow;i<e.length;++i)e[i].getAttribute("key")==t&&(e[i].childNodes[this.checkIndex].firstChild.checked=!0);else"object"==typeof t&&"TR"==t.tagName&&(t.childNodes[this.checkIndex].firstChild.checked=!0)},getCheckedKeys:function(){for(var t=[],e=this.tbody.childNodes,i=this._startrow;i<e.length;++i)e[i].childNodes[this.checkIndex].firstChild.checked&&t.push(e[i].getAttribute("key"));return t},getCheckedKeys2:function(){var t,e=this.getCheckedKeys();return 0!=e.length||null!=(t=this.getCurrentKey())&&e.push(t),e},getCheckedRows2:function(){var t=this.getCheckedRows();return 0==t.length&&null!=this.currow&&t.push(this.currow),t},getCurrentKey:function(){if(null==this.currow)return null;var t=this.currow.getAttribute("key");return""==t?null:t},clickRow:function(t){t=t.srcElement||t.target;if("TR"==t.tagName)tr=t;else{if("A"==t.tagName)return;tr=scil.Utils.getParent(t,"TR")}null!=tr&&this.tbody!=tr.parentNode&&(tr=null),this.selectRow(tr)},selectFirstRow:function(){var t=this.tbody.childNodes[this._startrow];this.selectRow(t)},findRow:function(t){for(var e=this.tbody.childNodes,i=this._startrow;i<e.length;++i)if(e[i].getAttribute("key")==t)return e[i];return null},selectRow:function(t){"string"==typeof t&&(t=this.findRow(t));var e=this.currow;null!=this.currow&&(this.currow.style.backgroundColor=this.currow.getAttribute("bgcolor")),this.currow=t,null!=this.currow&&(this.currow.style.backgroundColor=JSDraw2.Skin.jssdf.rowcolor),null!=this.options.onselectrow&&this.options.onselectrow(this.currow,e)},delRow:function(t){for(var e=this.tbody.childNodes,i=0;i<e.length;++i)if(e[i].getAttribute("key")==t)return this.tbody.removeChild(e[i]),null!=this.options.onchange&&this.options.onchange(this),this.dirty=!0;return!1},updateRow:function(t,e){for(var i=this.tbody.childNodes,s=this._startrow;s<i.length;++s)if(i[s].getAttribute("key")==t){var l=i[s];null==e&&(e={}),e.rowchecked=this.options.rowcheck&&l.childNodes[this.checkIndex].firstChild.checked;var n=this.addRow(e,null,l);return this.tbody.removeChild(l),this.currow==l&&this.selectRow(n),!0}return!1},setCellValue2:function(t,e,i){if(null==this.items[e])return!1;var s=null;if("number"==typeof t)s=this.tbody.childNodes[this._startrow+t];else if("object"==typeof t&&"TR"==t.tagName)s=t;else for(var l=this.tbody.childNodes,n=this._startrow;n<l.length;++n)if(l[n].getAttribute("key")==t){s=l[n];break}if(null==s)return!1;for(n=0;n<s.childNodes.length;++n){var r=s.childNodes[n];if(r.getAttribute("__tid")==e&&null!=r.field)return scil.Form.setFieldData(r.field,this.items[e],this.viewonly,i),!0}return!1},getCellValue2:function(t,e){if(null==this.items[e])return null;var i=null;if("number"==typeof t)i=this.tbody.childNodes[this._startrow+t];else for(var s=this.tbody.childNodes,l=this._startrow;l<s.length;++l)if(s[l].getAttribute("key")==t){i=s[l];break}if(null==i)return null;for(l=0;l<i.childNodes.length;++l){var n=i.childNodes[l];if(n.getAttribute("__tid")==e&&null!=n.field)return scil.Form.getFieldData(n.field)}return null},_hilitRow:function(t,e){t=t.target||t.srcElement;"TR"!=t.tagName&&(t=scil.Utils.getParent(t,"TR")),null!=t&&"1"==t.getAttribute("sciltable")&&(e||t==this.currow?t.style.backgroundColor=JSDraw2.Skin.jssdf.rowcolor:t.style.backgroundColor=t.getAttribute("bgcolor"))},groupExpandAll:function(t){var t=t.target||t.srcElement,e=scil.Utils.endswith(t.src,"minus.gif");t.src=scil.Utils.imgSrc("img/"+(e?"plus":"minus")+".gif");for(var i=this.tbody.childNodes[this._startrow];null!=i;)i=this.groupExpand(i,e)},groupExpand:function(t,e){var i=this.getCellValue(t,this.options.grouping);if(scil.Utils.isNullOrEmpty(i))return null;var s=t.childNodes[this.groupIndex].firstChild;if("IMG"!=s.tagName)return null;null==e&&(e=scil.Utils.endswith(s.src,"minus.gif"));for(var l=0;null!=(t=t.nextSibling);){if(i!=this.getCellValue(t,this.options.grouping))break;++l,t.style.display=e?"none":""}return s.src=scil.Utils.imgSrc("img/"+(e?0<l?"plus":"plus0":"minus")+".gif"),t},addRow:function(t,e,i){if(null==t&&null!=this.options.onAdd)return null;null!=this.options.onBeforeAddRow&&(t=this.options.onBeforeAddRow(t));var s=this,l=this.tbody.childNodes.length%2==1?JSDraw2.Skin.jssdf.oddcolor:JSDraw2.Skin.jssdf.evencolor,n=scil.Utils.createElement(null,"tr",null,{backgroundColor:l},{sciltable:"1",bgcolor:l});null==i?this.tbody.appendChild(n):this.tbody.insertBefore(n,i),dojo.connect(this.tbody.parentNode,"onmouseover",function(t){s._hilitRow(t,!0)}),dojo.connect(this.tbody.parentNode,"onmouseout",function(t){s._hilitRow(t,!1)});var r,o=!1,a=scil.Utils.createElement(n,"td");this.options.grouping?(r=null==t?null:t[this.options.grouping],l=this.getCellValue(n.previousSibling,this.options.grouping),!scil.Utils.isNullOrEmpty(r)&&r==l||(o=!0,h=scil.Utils.createElement(a,"img",null,null,{title:"Expand/Collapse All",src:scil.Utils.imgSrc("img/minus.gif")}),scil.connect(h,"onclick",function(t){s.groupExpand(n)}))):a.style.display="none";var h,u,c,d,a=scil.Utils.createElement(n,"td");for(c in this.options.rowcheck?(h="radio"==this.options.rowcheck?"__scil_table_"+this._tableid+"_radio":null,d="radio"==this.options.rowcheck?"radio":"checkbox",(u=scil.Utils.createElement(a,d,null,null,{name:h})).checked=null!=t&&t.rowchecked,null!=this.options.onrowcheck&&dojo.connect(u,"onchange",function(){s.options.onrowcheck(n,u.checked)}),"checkbox"==d&&scil.connect(u,"onclick",function(t){s.checkedClick(t)})):a.style.display="none",null==t?n.setAttribute("isnew","1"):null!=this.key&&null!=t[this.key]&&n.setAttribute("key",t[this.key]),this.items){var p=this.items[c];(a=scil.Utils.createElement(n,"td",null,p.styles,p.attributes)).style.borderLeft=JSDraw2.Skin.jssdf.border,"hidden"!=p.type&&!p.ishidden||(a.style.display="none");var f=this.viewonly||p.viewonly||null!=e&&e[c];a.field=scil.Form.createField(a,p,f,null==t?p.value:t[c],t,!0,!0),f&&"img"!=p.type?a.field.style.width="100%":"INPUT"!=a.field.tagName&&"SELECT"!=a.field.tagName&&"TEXTAREA"!=a.field.tagName||(this._connectOnchange(a.field,p),p.addrowonenter&&null==i&&a.field.focus()),a.setAttribute("__tid",c),this.connectKeydown(a,p)}if(this.viewonly||null!=e||0==this.options.delrow||((a=scil.Utils.createElement(n,"td")).style.borderLeft=JSDraw2.Skin.jssdf.border,d=scil.Utils.createElement(a,"img",null,null,{src:scil.Utils.imgSrc("img/del.gif"),title:scil.Lang.res("Delete")}),dojo.connect(d,"onclick",function(){s.removeRow(this)})),null!=this.options.onAddRow&&this.options.onAddRow(n,t),o&&null!=this.options.grouplinestyle)for(var m=0;m<n.childNodes.length;++m)n.childNodes[m].style.borderTop=this.options.grouplinestyle;return n},checkedClick:function(t){var e=t.srcElement||t.target;if(e.checked){if(t.shiftKey){var i=this.tbody.childNodes,s=scil.Utils.indexOf(i,scil.Utils.getParent(this._lastcheck,"TR")),t=scil.Utils.indexOf(i,scil.Utils.getParent(e,"TR"));if(-1!=l&&-1!=n)for(var l=Math.min(s,t),n=Math.max(s,t),r=l;r<=n;++r)"none"==i[r].style.display?i[r].childNodes[this.checkIndex].firstChild.checked=!1:i[r].childNodes[this.checkIndex].firstChild.checked=!0}this._lastcheck=e}},_connectOnchange:function(t,e){var i=this;dojo.connect(t,"onchange",function(t){i.onchange(t,e)})},setCellValue:function(t,e,i){for(var s=0;s<t.childNodes.length;++s){var l=t.childNodes[s];if(null!=l.field&&l.getAttribute("__tid")==e){scil.Form.setFieldData(l.field,this.items[e],this.viewonly,i);break}}},getCellValue:function(t,e){for(var i=0;i<t.childNodes.length;++i){var s=t.childNodes[i];if(null!=s.field&&s.getAttribute("__tid")==e)return scil.Form.getFieldData(s.field)}return null},connectKeydown:function(e,i){var s;!this.viewonly&&"INPUT"==e.field.tagName&&i.addrowonenter&&(s=this,dojo.connect(e.field,"onkeydown",function(t){13==t.keyCode&&(t=scil.Utils.getParent(e,"TR"),"function"==typeof i.addrowonenter&&i.addrowonenter(e,i,s),s.tbody.childNodes[s.tbody.childNodes.length-1]==t&&s.addRow())}))},onchange:function(t,e){this.dirty=!0,null!=this.options.onchange&&this.options.onchange(this,t,e)},removeRow:function(e){var i=this;scil.Utils.confirmYes("Delete this row?",function(){var t=scilligence.Utils.getParent(e,"TR");t.parentNode.removeChild(t),null!=i.options.onchange&&i.options.onchange(this),i.dirty=!0})},showHideColumns:function(){var t,e;null==this.showhideDlg&&(e={table:{type:"table",columns:{caption:{label:"Caption",width:400},key:{label:"Key",width:100,iskey:!0}},options:{rowcheck:!0,viewonly:!0}}},(t=this).showhideDlg=scil.Form.createDlgForm("Show/Hide Columns",e,{label:"OK",onclick:function(){t.showHideColumns2()}},{hidelabel:!0})),this.showhideDlg.show();var i,s=[];for(i in this.items)"hidden"!=this.items[i].type&&s.push({caption:this.items[i].label,key:i,rowchecked:!this.items[i].ishidden});this.showhideDlg.form.setData({table:s}),this.showhideDlg.moveCenter()},showHideColumns2:function(){for(var t="",e=this.showhideDlg.form.fields.table.jsd.getData(null,null,!0),i=0;i<e.length;++i){var s=1==e[i].rowchecked;this.showColumn(e[i].key,s),s||(t+=e[i].key+",")}this.showhideDlg.hide(),scil.Utils.isNullOrEmpty(this.options.hidecolumncookiekey)||scil.Utils.createCookie(this.options.hidecolumncookiekey+"_scil_table_hidecols",t,3650)},_hideCookieCols:function(t){if(!scil.Utils.isNullOrEmpty(this.options.hidecolumncookiekey)){var e=scil.Utils.readCookie(this.options.hidecolumncookiekey+"_scil_table_hidecols");if(!scil.Utils.isNullOrEmpty(e))for(var i=e.split(","),s=0;s<i.length;++s)null!=t[i[s]]&&(t[i[s]].ishidden=!0)}}}),scilligence.apply(scilligence.Table,{headerstyles:{whiteSpace:"nowrap",textAlign:"center",verticalAlign:"top",backgroundColor:"#bbb"},create:function(t,e,i,s,l){"string"==typeof e&&(e=dojo.byId(e));e=scil.Utils.createElement(e,"div"),s=new scil.Table(s);return s.render(e,i),0!=l&&null!=t.load&&scil.onload(function(){t.load()}),s},listPages:function(t,e,i,s){if(scil.Utils.removeAll(t),1<=e&&1<i){var l,n;--e,i<=11?(l=0,n=i):((l=e-5)<0&&(l=0),i<(n=l+11)&&(n=i),n-l<11&&(l=n-11)<0&&(l=0)),this.createPage(t,scil.Lang.res("Previous Page"),0<e?e:null,s),0<l&&(this.createPage(t,1,1,s),1<l&&this.createPage(t,"...",null,s));for(var r=l;r<e;++r)this.createPage(t,r+1,r+1,s);this.createPage(t,e+1,null,s);for(r=e+1;r<n;++r)this.createPage(t,r+1,r+1,s);n<i&&(n+1<i&&this.createPage(t,"...",null,s),this.createPage(t,i,i,s)),this.createPage(t,scil.Lang.res("Next Page"),e+1<i?e+2:null,s)}},createPage:function(t,e,i,s){null==i?scil.Utils.createElement(t,"span",e):scil.Utils.createButton(t,{label:e,type:"a",onclick:function(){s(i)}}),scil.Utils.createElement(t,"span","&nbsp;")},rows2xml:function(t){if(null==t)return null;for(var e="<table>",i=0;i<t.length;++i){var s,l=t[i];for(s in e+="<r>",l){var n=l[s];scil.Utils.isNullOrEmpty(n)||(e+="<i n='"+scil.Utils.escXmlValue(s)+"'>"+scil.Utils.escXmlValue(n)+"</i>")}e+="</r>"}return e+="</table>"}}),scil.Tree=scil.extend(scil._base,{constructor:function(t,e,i,s){this.container=t,this.options=null==e?{}:e,this.solo=null!=i?i:this.options.solo,this.dropdown=null!=s?s:this.options.dropdown,this.onAddItem=null,this.onSelectItem=null,this.onExpandItem=null,this.cur=null,this.margin=28,this.idname="id";scil.Utils.removeAll(t)},clear:function(){scil.Utils.removeAll(this.container)},reloadCur:function(){null!=this.cur&&this.reload(this.cur)},reload:function(t){if(null==t)return!1;t.removeAttribute("loaded"),null!=t.firstChild.nextSibling&&t.removeChild(t.firstChild.nextSibling);t=this._expand(t);return this.onExpand(t),!0},getCurRoot:function(){return this.getRoot(this.cur)},getRoot:function(t){if(null==t)return null;for(var e=this.getParent(t),i=t;null!=e;)i=e,e=this.getParent(i);return i},getParent:function(t){return t.parentNode.parentNode},add:function(t,e){if(null==e)return null;if(null!=e.length){for(var i=0;i<e.length;++i)this.add(t,e[i]);return null}e._more&&(e.leaf=!0),null!=this.options.onAddItem?e=this.options.onAddItem(e):null!=this.onAddItem&&(e=this.onAddItem(e));var s=null;(s=null==t?scilligence.Utils.createElement(this.container,"div"):(null==(n=t.firstChild.nextSibling)&&(n=scil.Utils.createElement(t,"div",null,{marginLeft:this.margin+"px"})),scil.Utils.createElement(n,"div"))).item=e;var l=scilligence.Utils.createElement(s,"div",null,{padding:"3px 0 3px 0",whiteSpace:"nowrap"}),n=scilligence.Utils.createElement(l,"img",null,{width:"16px"},e.leaf||e.disabled?{src:scil.Utils.imgSrc("img/blank.gif")}:{src:scil.Utils.imgSrc("img/plus.gif"),title:"Expand"}),r=this;return dojo.connect(n,"onclick",function(t){r.onExpand(t.srcElement||t.target)}),this.dropdown&&scilligence.Utils.createElement(l,"img",null,null,{src:e.shortcut?"img/status_shortcut.gif":"img/status_"+(null==e.status||""==e.status?"open":e.status)+".gif"}),null!=e.icon&&(e.icon.indexOf("/")<0&&(e.icon="img/icons/"+e.icon+".gif"),scilligence.Utils.createElement(l,"img",null,{paddingRight:this.options.icongap},{src:e.icon})),scil.Utils.createElement(l,"span",e._more?"<u style='color:blue;cursor:pointer'>more...</u>":e.name),l.className="tbar",e.disabled?(l.style.color="gray",l.setAttribute("disabled","on")):(l.style.cursor="pointer",dojo.connect(l,"onclick",function(t){(t.target||t.srcElement)!=l.firstChild&&r.select(l.parentNode)})),this.add(s,e.children),null!=t&&this.expand(t,!0),0==e.expand&&this.expand(s,!1),e.selected&&this.select(s),s},expand:function(t,e){var i=t.firstChild,s=i.firstChild;null==i.nextSibling?(s.src="img/blank.gif",s.removeAttribute("title")):(i.nextSibling.style.display=e?"":"none",this._expand(t,e))},_expand:function(t,e){t=t.firstChild.firstChild;return t.src=scil.Utils.imgSrc(e?"img/minus.gif":"img/plus.gif"),t.setAttribute("title",e?"Shrink":"Expand"),t},shrinkSiblings:function(t){for(var e=t.parentNode.childNodes,i=0;i<e.length;++i)e[i]!=t&&this.expand(e[i],!1)},onExpand:function(t){var e=t.parentNode;if("DIV"==e.tagName&&"tbar"==e.className){var i=null,t=e.parentNode;if(null==t||null==t.item||!t.item.leaf)return null==this.options.url||"1"==t.getAttribute("loaded")||null!=e.nextSibling?(i=null==e.nextSibling||"none"==e.nextSibling.style.display,this.expand(t,i),void(i&&this.solo&&this.shrinkSiblings(t))):void(null!=this.onExpandItem&&this.onExpandItem(t,i)||this.loadNodes(t))}},loadNodes:function(i){function t(t){if(i.item._more){var e=i.parentNode;e.removeChild(i),i=e.parentNode}else{if("1"==i.getAttribute("loaded"))return;i.setAttribute("loaded","1")}null!=t.rows&&0<t.rows.length?s.add(i,t.rows):0<t.length&&s.add(i,t),s.expand(i,!0)}var e,s=this;null==i.item.children?(e=i.item,null!=this.onAjaxData&&(e=this.onAjaxData(i)),null!=this.options.url&&""!=this.options.url&&scil.Utils.ajax(this.options.url,t,e,{popup:!1,beforeload:function(){i.firstChild.firstChild.src=scil.Utils.imgSrc("img/animatorsmall.gif")},afterload:function(){i.firstChild.firstChild.src=scil.Utils.imgSrc("img/plus.gif")}})):t(i.item.children)},select:function(t){"string"==typeof t&&(t=this.find(null,t)),null==t||null!=t.item&&0==t.item.selectable||(null!=t.item&&t.item._more?this.loadNodes(t):(null!=this.cur&&(this.cur.firstChild.style.background=""),this.cur=t,this.dropdown&&null!=this.cur&&(this.cur.firstChild.style.background="#f6f4b9"),this.cur.firstChild.style.background="#ddf",null!=this.onSelectItem&&((t=null)!=this.cur&&(t=null==this.cur.firstChild.nextSibling),this.onSelectItem(this.cur,t))))},getIconText:function(t){if(null==t)return null;t=t.firstChild.childNodes[2];return"SPAN"==t.tagName?t.innerHTML:"<img src='"+t.src+"'>"+t.nextSibling.innerHTML},setCurrent:function(t,e){e=this.find(null,t,e);return null!=e&&this.select(e),e},find:function(t,e,i){t=null==t?this.container:t.firstChild.nextSibling;if(null==t)return null;null==i&&(i="id");for(var s=t.childNodes,l=0;l<s.length;++l){var n=s[l];if(null!=n.item&&n.item[i]==e)return n;n=this.find(n,e,i);if(null!=n)return n}return null},getChildren:function(t){t=null==t?this.container:t.firstChild.nextSibling;return null==t?null:t.childNodes}}),document.write('<style type="text/css">input._scil_dropdown::-ms-clear {display: none;}</style>'),scil.DropdownInput=scil.extend(scilligence._base,{constructor:function(t,e){this.auto=null,this.options=null==e?{}:e,this.input="string"==typeof t?document.getElementById(t):t,this.itemschanged=!0,this.sugid=0,this.suggestlength=0<this.options.suggestlength?this.options.suggestlength:1,""==this.options.autosuggest&&(this.options.autosuggest=null);var i=this;this.input.style.background="#fff "+scil.Utils.imgSrc("img/dropdown.gif",!0)+" no-repeat right center",this.input.style.border="solid 1px #999",this.input.style.padding="2px",this.input.className="_scil_dropdown",this.updateReadonly(),dojo.connect(this.input,"onkeyup",function(t){i.keyup(t)}),dojo.connect(this.input,"onclick",function(t){i.clickMe(t)})},updateDropdown:function(t){null!=t&&(this.options.readonly=t,this.updateReadonly()),this.input.style.backgroundImage=null==this.options.items?"":scil.Utils.imgSrc("img/dropdown.gif",!0)},updateReadonly:function(){this.input.readOnly=this.options.readonly,this.input.style.backgroundColor=this.options.readonly?"#eee":"#fff"},keyup:function(t){var e,i,s;this.disabled||null==this.input||null==this.options.autosuggest&&null==this.options.onFilter&&null==this.options.items||(this.options.readonly?null!=this.options.items&&this.highlight(t):this.input.value.length<this.suggestlength||9==t.keyCode||13==t.keyCode?null!=this.auto&&(this.auto.style.display="none"):(e=++this.sugid,null!=this.options.onFilter?(s=this.options.onFilter(this.input.value),this.list(s,e),this.itemschanged=!0):scil.Utils.startswith(this.options.autosuggest,"data:")?(s=this.filterlist(this.options.autosuggest.substr(5).split(","),this.input.value),this.list(s,e),this.itemschanged=!0):scil.Utils.startswith(this.options.autosuggest,"javascript:")?(t=this.options.autosuggest.substr(11),t=scil.Utils.eval(t)(this),s=this.filterlist(t,this.input.value),this.list(s,e),this.itemschanged=!0):null!=this.options.items&&null==this.options.autosuggest?(s=this.filterlist(this.options.items,this.input.value),this.list(s,e),this.itemschanged=!0):null!=this.options.autosuggest&&(s={q:(i=this).input.value},null!=this.options.onsuggest&&this.options.onsuggest(s),scil.Utils.jsonp(this.options.autosuggest,function(t){i.list(null==t.items?t:t.items,e),i.itemschanged=!0},s))))},filterlist:function(t,e){var i=[];if(null!=e&&""!=e&&null!=t){e=e.toLowerCase();for(var s=0;s<t.length;++s)0<=t[s].toLowerCase().indexOf(e)&&i.push(scil.Utils.trim(t[s]))}return i},clickMe:function(t){null!=this.options.items&&(t.srcElement||t.target).offsetWidth-(null==t.offsetX?t.layerX:t.offsetX)<16&&this.show()},setItems:function(t){null!=t&&(this.options.items=t,this.itemschanged=!0)},isChildOf:function(t){return t==this.input||JsUtils.isChildOf(t,this.auto)},isDropdownVisible:function(){return null!=this.auto&&""==this.auto.style.display},isVisible:function(){return null!=this.input&&""==this.input.style.display},show:function(){var e,t;null==this.auto&&(e=this,t=scil.Utils.isFixedPosition(this.input)?"fixed":"absolute",this.auto=scil.Utils.createElement(document.body,"div",null,{display:"none",backgroundColor:"white",overflow:"hidden",border:"solid 1px gray",position:t,zIndex:99999}),dojo.connect(document.body,"onmousedown",function(t){t=t.srcElement||t.target;t!=e.q&&t.parentNode!=e.auto&&e.clickout()})),this.itemschanged&&this.list(this.options.items,++this.sugid),this.auto.style.display="",this.auto.style.zIndex=scil.Utils.getZindex(this.input)+1,this.updateDropdownSize()},highlight:function(t){if(null!=this.auto&&"none"!=this.auto.style.display)if(t.preventDefault(),27!=t.keyCode){for(var e,i,s=this.auto.childNodes,l=null,n=0;n<s.length;++n)if("1"==s[n].getAttribute("sel")){l=n;break}13!=t.keyCode?(i=null,38==t.keyCode||40==t.keyCode?(null==l?i=0:38==t.keyCode?(i=l-1)<0&&(i=s.length-1):(i=l+1)>=s.length&&(i=0),t.preventDefault()):null!=t.char&&(e=t.char.toLowerCase(),null==(i=this.findNextMatch(e,null==l?0:l+1,s.length))&&null!=l&&(i=this.findNextMatch(e,0,l))),null!=i&&i!=l&&(null!=l&&this._hilitItem(s[l],!1),this._hilitItem(s[i],!0))):null!=l&&this.clickItem(s[l])}else this.hide();else 13!=t.keyCode&&40!=t.keyCode||(this.show(),t.preventDefault())},findNextMatch:function(t,e,i){for(var s=e;s<i;++s){var l=this.auto.childNodes[s];if(l.innerHTML){l=this.getItemValue(l);if(0<l.length&&l.substr(0,1).toLowerCase()==t)return s}}return null},updateDropdownSize:function(){var t,e,i;this.isDropdownVisible()&&(t=scil.Utils.getOffset(this.input),e=scilligence.Utils.scrollOffset(),scil.Utils.isIE&&(i=JsUtils.getScrollOffset(this.e),e.offset(-i.x,-i.y)),i=this.input.offsetWidth,0<this.options.minautowidth&&this.options.minautowidth>i&&(i=this.options.minautowidth),i<100&&(i=100),dojo.style(this.auto,{left:t.x+e.x+"px",top:t.y+e.y+this.input.offsetHeight+"px",width:i-2+"px"}))},hide:function(){null!=this.auto&&"none"!=this.auto.style.display&&(this.auto.style.display="none")},isParentHidden:function(t){for(var e=t;null!=e&&null!=e.style;){if("none"==e.style.display||"hidden"==e.style.visibility)return!0;e=e.parentNode}return!1},list:function(t,e){if(null==t||0==t.length||e!=this.sugid||this.isParentHidden(this.input))null!=this.auto&&(scilligence.Utils.removeAll(this.auto),this.auto.style.display="none");else if(null!=this.auto&&"none"!=this.auto.style.display||(this.itemschanged=!1,this.show()),this.itemschanged=!1,scilligence.Utils.removeAll(this.auto),null!=t&&0!=t.length)for(var i=this,s=0;s<t.length;++s){var l=t[s],l=scilligence.Utils.createElement(this.auto,"div",scil.Utils.isNullOrEmpty(l)?"&nbsp;":l,{padding:"2px",textAlign:this.options.align});dojo.connect(l,"onclick",function(t){i.click(t)}),dojo.connect(l,"onmouseover",function(t){i.mouseover(t)}),dojo.connect(l,"onmouseout",function(t){i.mouseout(t)})}},mouseover:function(t){this._hilitItem(t.srcElement||t.target,!0)},mouseout:function(t){this._hilitItem(t.srcElement||t.target,!1)},_hilitItem:function(t,e){e?(t.style.backgroundColor="#ddf",t.setAttribute("sel","1")):(t.style.backgroundColor="white",t.removeAttribute("sel"))},clickout:function(t){this.hide()},click:function(t){t=t.srcElement||t.target;this.clickItem(t)},getItemValue:function(t){t=scil.Utils.htmlDecode(t.innerHTML);return"&nbsp;"==t&&(t=""),t},clickItem:function(t){t=this.getItemValue(t);null!=this.options.onSetValue?this.options.onSetValue(this.input,t):"unit"==this.options.overwrite?this.input.value=this.changeUnit(this.input.value,t):0==this.options.overwrite?this.input.value+=t:this.input.value=t,this.hide(),this.options.overwrite&&this.input.select(),this.input.focus(),null!=this.options.onclickitem&&this.options.onclickitem(t),scil.Utils.fireEvent(this.input,"change",!1,!0)},changeUnit:function(t,e){t=JSDraw2.Table.parseValueUnit(t);return null==t||null==t.value?"":t.value+(null==e?"":e)}}),scil.Popup=scil.extend(scil._base,{constructor:function(t,e){var i;this.a="string"==typeof t?scil.byId(t):t,this.options=null==e?{}:e,null!=this.a&&(i=this,dojo.connect(this.a,"onmouseout",function(){scil.Popup.hide()}),dojo.connect(this.a,"onmouseover",function(t){scil.Popup.show(i,t)})),scil.Popup.init()},getHtml:function(t){return null!=this.options.ongethtml2?this.options.ongethtml2(this,t):(null==this.options.html&&null!=this.options.ongethtml&&(this.options.html=this.options.ongethtml(this)),this.options.html)},getCaption:function(t){return null!=this.options.ongetcaption2?this.options.ongetcaption2(this,t):this.options.caption}}),scil.apply(scil.Popup,{current:null,inited:null,show:function(t,i){this.hide(),this.current=t,e=new scil.Popup.Event(i);t=this.current.getCaption(i),i=this.current.getHtml(i);scil.Utils.isNullOrEmpty(i)?this.hide():(this.create(),this.area.innerHTML="",this.title.innerHTML="",this.div.style.display="",this.title.innerHTML=null==t?"":t,this.area.innerHTML=i,null!=e&&this.move(e))},hide:function(){(this.current=null)!=this.div&&(this.title.innerHTML="",this.area.innerHTML="",this.div.style.display="none")},move:function(t){var e;null!=this.current&&null!=this.div&&"none"!=this.div.style.display&&(e=null==t.srcElement?t.target:t.srcElement,this.current.a==e||this.isChildOf(e,this.current.a)?this.moveto(t):this.isChildOf(e,this.div)||this.hide())},moveto:function(t){this.create();var e=this.scrollLeft(),i=this.scrollTop(),s=0,l=0,l=null==document.all?(s=window.innerWidth,window.innerHeight):(s=document.documentElement.clientWidth,document.documentElement.clientHeight),n=this.div.offsetWidth,r=this.div.offsetHeight,o=t.clientX+e+10,t=t.clientY+i+20;s<o-e+n&&0<o-e-n&&(o-=n+15),l<t-i+r&&0<t-i-r&&(t-=r+25),this.div.style.left=o+"px",this.div.style.top=t+"px"},isChildOf:function(t,e){for(;null!=t;){if(t==e)return!0;t=t.parentNode}return!1},scrollLeft:function(t){return this.filterResults(window.pageXOffset||0,document.documentElement?document.documentElement.scrollLeft:0,document.body?document.body.scrollLeft:0)},scrollTop:function(t){return this.filterResults(window.pageYOffset||0,document.documentElement?document.documentElement.scrollTop:0,document.body?document.body.scrollTop:0)},filterResults:function(t,e,i){t=t||0;return e&&(!t||e<t)&&(t=e),i&&(!t||i<t)?i:t},init:function(){1!=this.inited&&(this.inited=!0,dojo.connect(document,"onmousemove",function(t){scil.Popup.move(t)}))},create:function(){var t;null==this.div&&(this.div=document.createElement("div"),this.div.style.display="none",this.div.style.whiteSpace="nowrap",this.div.style.backgroundColor="white",this.div.style.borderStyle="solid",this.div.style.borderColor="#f0f0f0 #a0a0a0 #a0a0a0 #f0f0f0",this.div.style.borderWidth="2px",this.div.style.position="absolute",this.div.style.zIndex=scil.Utils.getMaxZindex(),this.div.style.textAlign="left",document.body.appendChild(this.div),(t=document.createElement("div")).style.border="1px solid highlight",t.style.padding="1px",this.div.appendChild(t),this.title=document.createElement("div"),this.title.style.textAlign="center",this.title.style.border=JSDraw2.Skin.dialog.border,this.title.style.backgroundColor=JSDraw2.Skin.dialog.bkcolor,this.title.style.color="white",t.appendChild(this.title),this.area=document.createElement("div"),this.area.style.padding="2px",this.area.style.backgroundColor="white",t.appendChild(this.area))}}),scil.Popup.Event=scil.extend(scil._base,{constructor:function(t){this.clientX=t.clientX,this.clientY=t.clientY,this.srcElement=t.target||t.srcElement}}),scil.UploadFile={dlg:null,form:null,msg:null,files:[],filetypes:[],kIframe:"__scil_uploadfile_iframe",show:function(t){this.create(),this.dlg.show(),this.form.reset(),this.options=null==t?{}:t,null!=t.msg&&(this.msg.innerHTML=t.msg);for(var e=0;e<this.files.length;++e)this.files[e].value="";for(e=0;e<this.filetypes.length;++e)scil.Utils.removeAll(this.filetypes[e]),this.filetypes[e].style.display=null!=this.options.filetypes?"":"none",null!=this.options.filetypes&&scil.Utils.listOptions(this.filetypes[e],this.options.filetypes)},upload:function(){var e=this,t=this.options.params;scil.Utils.ajaxUploadFile(this.form,this.options.url,null==t?{}:t,function(t){e.dlg.hide(),e.options.callback(t)})},create:function(t){if(null==this.dlg){var e=this,i=JsUtils.createElement(null,"div","<form method='post' enctype='multipart/form-data'></form>",{padding:"15px"});this.form=i.firstChild,this.msg=scil.Utils.createElement(this.form,"div","Please specify files to be uploaded");for(var s=scil.Utils.createTable(this.form),l=0;l<5;++l){var n=scil.Utils.createElement(s,"tr"),r=scil.Utils.createElement(n,"td"),o=scil.Utils.createElement(r,"file",null,null,{name:"f"+l});r=scil.Utils.createElement(n,"td");var a=scil.Utils.createElement(r,"select",null,null,{name:"filetype.f"+l});this.files.push(o),this.filetypes.push(a)}n=scil.Utils.createElement(s,"tr"),r=scil.Utils.createElement(n,"td",null,{paddingTop:"10px",textAlign:"center"},{colSpan:2});scil.Utils.createButton(r,{src:scil.App.imgSmall("submit.png"),label:"Upload",onclick:function(){e.upload()}}),this.dlg=new scil.Dialog("Upload File",i)}}},scil.Tabs=scil.extend(scil._base,{constructor:function(t,e){this.options=null==e?{}:e,this.currenttab=null,this.area=null,"string"==typeof t&&(t=dojo.byId(t));var i=scil.Utils.createTable(t,0,0,{width:"100%",marginBottom:null==this.options.marginBottom?"20px":this.options.marginBottom});this.dom=this.table=i.parentNode,this.vertical=!0;var s=this.options.border?null:scil.Tabs.kBorderStyle,l=this.options.border?"5px":0,n=this.options.border?scil.Tabs.kBorderStyle:null,r=null==this.options.tabgap?"4px":this.options.tabgap;switch(this.options.tablocation){case"left":var o=scil.Utils.createElement(i,"tr"),a=scil.Utils.createElement(o,"td",null,{borderRight:s,width:"1%",verticalAlign:"top",borderRightWidth:r});this.area=scil.Utils.createElement(o,"td",null,{padding:l,border:n,width:"99%",verticalAlign:"top"}),this.vertical=!1;break;case"right":o=scil.Utils.createElement(i,"tr");this.area=scil.Utils.createElement(o,"td",null,{padding:l,border:n,width:"1%",verticalAlign:"top"}),a=scil.Utils.createElement(o,"td",null,{borderLeft:s,width:"99%",verticalAlign:"top",borderLeftWidth:r}),this.vertical=!1;break;case"bottom":this.area=scil.Utils.createElement(scil.Utils.createElement(i,"tr"),"td",null,{padding:l,border:n}),a=scil.Utils.createElement(scil.Utils.createElement(i,"tr"),"td",null,{borderTop:s,borderTopWidth:r});break;default:a=scil.Utils.createElement(scil.Utils.createElement(i,"tr"),"td",null,{borderBottom:s,borderBottomWidth:r}),this.area=scil.Utils.createElement(scil.Utils.createElement(i,"tr"),"td",null,{padding:l,border:n})}this.tabcontainer=scil.Utils.createTable(a,0,0),this.vertical&&(this.tr=scil.Utils.createElement(this.tabcontainer,"tr")),0==this.options.showtabs&&(this.tr.style.display="none");var h=this.options.tabs;if(null!=h)if(0<h.length)for(var u=0;u<h.length;++u)this.addTab(h[u]);else for(var c in h)this.addTab(h[c],c)},resizeClientarea:function(t,e){for(var i=(this.vertical?this.tr:this.tabcontainer).childNodes,s=0;s<i.length;++s){var l=this.vertical?i[s]:i[s].childNodes[0];null!=l.clientarea&&(0<t&&(l.clientarea.style.width=t+"px",this.options.clientareawidth=t),0<e&&(l.clientarea.style.height=e+"px",this.options.clientareaheight=e))}null!=this.options.onresizeclientarea&&this.options.onresizeclientarea(t,e,this)},addTab:function(e,t){this.vertical?0<this.tr.childNodes.length&&scil.Utils.createElement(this.tr,"td","&nbsp;"):0<this.tabcontainer.childNodes.length&&scil.Utils.createElement(scil.Utils.createElement(scil.Utils.createElement(this.tabcontainer,"tr"),"td"),"div",null,{height:5});var i=this,s=e.caption,l=e.icon,n=null==this.options.tabpadding?"5px 10px 1px 10px":this.options.tabpadding,r=this.vertical?this.tr:scil.Utils.createElement(this.tabcontainer,"tr"),o={border:"solid 1px #ddd",padding:n,backgroundColor:"#eee"};switch(this.options.tablocation){case"left":o.borderRight="none",o.borderTopLeftRadius="5px",o.borderBottomLeftRadius="5px";break;case"right":o.borderLeft="none",o.borderTopRightRadius="5px",o.borderBottomRightRadius="5px";break;case"bottom":o.borderTop="none",o.borderBottomLeftRadius="5px",o.borderBottomRightRadius="5px";break;default:o.borderBottom="none",o.borderTopLeftRadius="5px",o.borderTopRightRadius="5px"}var a,h=scil.Utils.createElement(r,"td",null,o,{key:t||e.tabkey,sciltab:"1"}),u=scil.Utils.createTable2(h,null,{cellSpacing:0,cellPadding:0}),c=(null!=l?"<img src='"+l+"'>":"")+(null==s?"Tab":scil.Lang.res(s)),d=null;switch(this.options.tablocation){case"left":case"right":h._label=scil.Utils.createElement(scil.Utils.createElement(u,"tr"),"td",c,null,null,function(t){i.showTab(h)}),d=scil.Utils.createElement(scil.Utils.createElement(u,"tr"),"td");break;case"bottom":default:var p=scil.Utils.createElement(u,"tr");h._label=scil.Utils.createElement(p,"td",c,null,null,function(t){i.showTab(h)}),d=scil.Utils.createElement(p,"td")}return e.closable&&((a=scil.Utils.createButton(d,{src:scil.Utils.imgSrc("img/del2.gif"),title:"Close",style:{},onclick:function(t){i.closeTab(h)}})).style.marginLeft="10px",h.style.paddingRight="2px",scil.connect(d,"onmouseover",function(){a.style.background="#fff"}),scil.connect(d,"onmouseout",function(){a.style.background=""})),null!=e.onmenu&&(scil.connect(h,"onmouseup",function(t){scil.Utils.isRightButton(t)&&e.onmenu(t),t.preventDefault()}),scil.Utils.disableContextMenu(h)),e.caption=null,e.visible=null==this.currenttab,e.marginBottom=0,e.caption=s,h.clientarea=scil.Utils.createElement(this.area,"div",null,{display:"none",width:this.options.clientareawidth,height:this.options.clientareaheight,overflowY:0<this.options.clientareaheight?"scroll":null}),null!=e.style&&dojo.style(h.clientarea,e.style),null==this.currenttab&&this.showTab(h),null!=e.html&&(h.clientarea.innerHTML=e.html),null!=this.options.onCreateTab&&this.options.onCreateTab(h,h.clientarea,this),h},updateTabLabel:function(t,e){t="string"==typeof t?this.findTab(t):t;null!=t&&null!=t._label&&(t._label.innerHTML=e)},closeTab:function(t){var e=this;scil.Utils.confirmYes("Close this tab?",function(){e.removeTab(t)})},currentTabKey:function(){return null==this.currenttab?null:this.currenttab.getAttribute("key")},findTab:function(t){for(var e=(this.vertical?this.tr:this.tabcontainer).childNodes,i=0;i<e.length;++i){var s=this.vertical?e[i]:e[i].childNodes[0];if(s.getAttribute("key")==t)return s}return null},removeTab:function(t){var e="string"==typeof t?this.findTab(t):t;if(null==e)return null;null!=this.options.onRemoveTab&&this.options.onRemoveTab(e,this);var i,s=this.allTabsAsArray(),t=scil.Utils.indexOf(s,e);0<t?this.showTab(s[t-1]):this.showTab(s[t+1]),e.clientarea.parentNode.removeChild(e.clientarea),delete e.clientarea,this.vertical?(null!=(i=e.previousSibling)&&null==i.clientarea&&i.parentNode.removeChild(i),e.parentNode.removeChild(e)):(null!=(e=(i=e.parentNode).previousSibling)&&e.parentNode.removeChild(e),i.parentNode.removeChild(i))},allTabsAsArray:function(){for(var t=[],e=(this.vertical?this.tr:this.tabcontainer).childNodes,i=0;i<e.length;++i){var s=this.vertical?e[i]:e[i].childNodes[0];"1"==s.getAttribute("sciltab")&&t.push(s)}return t},allTabs:function(){for(var t={},e=(this.vertical?this.tr:this.tabcontainer).childNodes,i=0;i<e.length;++i){var s,l=this.vertical?e[i]:e[i].childNodes[0];"1"!=l.getAttribute("sciltab")||null!=(s=l.getAttribute("key"))&&""!=s&&(t[s]=l)}return t},showTab:function(t){var e;"string"==typeof t?t=this.findTab(t):"number"==typeof t&&(t=this.allTabsAsArray()[t]),null!=t&&"TD"!=t.tagName&&(t=scil.Utils.getParent(t,"td")),null!=t&&(e=this.currenttab,null!=this.options.onBeforeShowTab&&0==this.options.onBeforeShowTab(t,e)||(null!=this.currenttab&&(this.currenttab.style.backgroundColor="#eee",this.currenttab.style.color=""),null!=e&&null!=e.clientarea&&(e.clientarea.style.display="none"),t.style.backgroundColor=scil.Tabs.kHighlightColor,t.style.color="#fff",null!=(this.currenttab=t).clientarea&&(t.clientarea.style.display=""),null!=this.options.onShowTab&&this.options.onShowTab(t,e,this)))},show:function(){this.table.style.display=""},hide:function(){this.table.style.display="none"}}),scil.apply(scil.Tabs,{kHighlightColor:"#88f",kBorderStyle:"solid 1px #88f"}),scil.TabbedForm=scil.extend(scil._base,{constructor:function(t){this.form=null,this.options=t,this.buttons=[],this.fields={}},render:function(t){"string"==typeof t&&(t=dojo.byId(t));var i=this;this.options.onShowTab=function(t,e){t.rendered||null==e||i.renderTabForm(t)},this.options.onBeforeShowTab=function(t,e){if(null!=i.options.onbeforeshowtab&&t!=e)return i.options.onbeforeshowtab(t,e)};var e,s=!0;for(e in this.options.tabs)this.options.tabs[e].tabkey=e;for(e in this.tabs=new scil.Tabs(t,this.options),this.options.tabs){this.options.tabs[e].tabkey=e;var l=this.tabs.findTab(e);l.form=new scil.Form(this.options),this.options.delayrender&&!s||(this.renderTabForm(l),s=!1)}var n=this.options.buttons;if(null!=n){var r=scil.Utils.createElement(t,"div",null,{marginTop:"10px",textAlign:"center"});if(0<n.length)for(var o=0;o<n.length;++o)this.buttons.push(scil.Utils.createButton(r,n[o]));else this.buttons.push(scil.Utils.createButton(r,n))}return this},setFieldValue:function(t,e,i){this.fields[t];scil.Form.setFieldData(this.fields[t],this.items[t],this.viewonly,e,i)},focus:function(t){scil.Form.focus(this.fields,t)},checkRequiredFields:function(){var t,e=0,i=this.tabs.allTabs();for(t in i){var s=i[t].form;null!=s&&(e+=s.checkRequiredFields())}return e},resetRequiredFields:function(){var t,e=this.tabs.allTabs();for(t in e){var i=e[t].form;null!=i&&i.resetRequiredFields()}},renderTabForm:function(t){var e,i,s;t.rendered||(e=t.getAttribute("key"),(i=null)!=this.options.tabs&&null!=this.options.tabs[e]&&(i=this.options.tabs[e].fields),s=t.clientarea.style.display,t.clientarea.style.display="",t.form.render(t.clientarea,i,this.options.tabs[e]),t.clientarea.style.display=s,scil.apply(this.fields,t.form.fields),t.rendered=!0)},getCurTabData:function(t){return null==this.tabs.currenttab||null==this.tabs.currenttab.form?null:this.tabs.currenttab.form.getData(t)},getXml:function(t){var e,i=t?"":"<data>\n",s=this.tabs.allTabs();for(e in s){var l=s[e].form;null!=l&&(i+=l.getXml(!0))}return t||(i+="</data>"),i},setXml:function(t){try{var e=scil.Form.xml2Json(t);this.setData(e)}catch(t){alert("Error raised when setting form data: "+t.message)}},getData:function(t){if("tab"==this.options.getdata)return this.getCurTabData(t);var e,i={},s=this.tabs.allTabs();for(e in s){var l=s[e].form;null!=l&&(l=l.getData(t),scil.apply(i,l))}return i},setData:function(t,e){if("tab"==this.options.setdata)null!=this.tabs.currenttab&&null!=this.tabs.currenttab.form&&this.tabs.currenttab.form.setData(t,e);else{var i,s=this.tabs.allTabs();for(i in s){var l=s[i].form;null!=l&&l.setData(t,e)}}}}),scil.FieldNumber=scil.extend(scil._base,{constructor:function(i,t){"string"==typeof i&&(i=scil.byId(i)),this.options=null==t?{}:t,this.input=i,this.unit=null;var s=this;this.options.allowoperator&&(this.auto=new scil.DropdownInput(i,{items:null==this.options.items?["","≥","≤","&lt;","&gt;","±"]:this.options.items,onSetValue:function(t,e){s.onSetOperator(t,e)}}));var e,t=this.options.viewonly||this.input.disabled||this.input.readOnly;null==this.options.units||t||(e=scil.Utils.createTable(null,0,0,{border:"solid 1px #ccc"}),this.input.parentNode.insertBefore(e.parentNode,this.input),e=scil.Utils.createElement(e,"tr"),scil.Utils.createElement(e,"td").appendChild(this.input),this.unit=scil.Utils.createElement(scil.Utils.createElement(e,"td",null,{borderLeft:"solid 1px #ccc"}),"select",null,{width:this.options.unitwidth}),scil.Utils.listOptions(this.unit,this.options.units,null,!0,!1),scil.connect(this.unit,"onchange",function(){scil.Utils.fireEvent(s.input,"change")}),this.input.style.border="none",this.unit.style.border="none");s=this;scil.connect(i,"onchange",function(t){var e=i.value;""==e||null==e||null!=s.options.accepts&&new RegExp(s.options.accepts).test(e)||scil.Utils.isNumber(e,s.options.allowoperator)?(null!=s.unit&&(e+=s.unit.value),s.setValue(e)):(i.value="",scil.Utils.alert("A number is required!"))}),t||null==this.options.mobiledata||(s=this,new scil.MobileData(i,{weighstation:!0,url:scil.MobileData.getDefaultUrl(!0),onresult:function(t){return s.setValue(t.barcode),scil.MobileData.markRecieved(i),!0}}),scil.Utils.createButton(scil.Utils.createElement(e,"td"),{label:"&#9878;",title:"Select Weigh Station",type:"a",onclick:function(){scil.MobileData.selectWeighstation()}}))},onSetOperator:function(t,e){var i,s;""!=e&&(i=scil.Utils.trim(t.value),"±"==e?0<=i.indexOf("±")||(t.value=i+" ±"):("≥"!=(s=0<i.length?i.substr(0,1):null)&&"≤"!=s&&">"!=s&&"<"!=s||(i=i.substr(1)),t.value=e+i))},clear:function(){this.input.value=""},setValue:function(t){null!=(t=null==t?null:null==JSDraw2.Table?{value:t}:JSDraw2.Table.splitUnit(t+""))?(0<this.options.scale&&!isNaN(t.value)&&(t.value*=this.options.scale),0<this.options.decimal&&(t.value=scil.Utils.round(t.value,this.options.decimal)),null==t.unit2&&(t.unit2=this.options.defaultunit),null!=this.unit?(this.input.value=t.value,scil.Utils.selectOption(this.unit,t.unit2,!0)):(this.input.value=t.value+(null==t.unit2?"":t.unit2),null!=JSDraw2.ColorCoding&&JSDraw2.ColorCoding.show(this.input,t.value,this.options))):this.input.value=""},getValue:function(){var t=scil.Utils.trim(this.input.value);return scil.Utils.isNullOrEmpty(t)||isNaN(t)||(0<this.options.scale&&(t/=this.options.scale),null!=this.unit&&(t+=this.unit.value)),t}}),"undefined"==typeof __JSDraw2_TouchMol&&(dojo.require("dojox.charting.Chart"),dojo.require("dojox.charting.plot2d.Areas"),dojo.require("dojox.charting.plot2d.StackedAreas"),dojo.require("dojox.charting.plot2d.Bars"),dojo.require("dojox.charting.plot2d.ClusteredBars"),dojo.require("dojox.charting.plot2d.Columns"),dojo.require("dojox.charting.plot2d.ClusteredColumns"),dojo.require("dojox.charting.plot2d.StackedColumns"),dojo.require("dojox.charting.plot2d.Lines"),dojo.require("dojox.charting.plot2d.StackedLines"),dojo.require("dojox.charting.plot2d.Markers"),dojo.require("dojox.charting.plot2d.MarkersOnly"),dojo.require("dojox.charting.plot2d.Pie"),dojo.require("dojox.charting.plot2d.Scatter"),dojo.require("dojox.charting.plot2d.Grid"),dojo.require("dojox.charting.plot2d.Spider"),dojo.require("dojox.charting.plot2d.Bubble"),dojo.require("dojox.charting.axis2d.Default"),dojo.require("dojox.charting.action2d.Highlight"),dojo.require("dojox.charting.action2d.Tooltip"),dojo.require("dojox.charting.action2d.MoveSlice"),dojo.require("dojox.charting.action2d.Magnify"),dojo.require("dojox.charting.widget.Legend"),dojo.require("dojox.charting.themes.Claro")),scil.Chart=scil.extend(scil._base,{constructor:function(t,e){scil.Chart.addStylesheet(),"string"==typeof t&&(t=scil.byId(t)),this.parent=t,this.loadData(e)},loadData:function(t){this.options=null==t?{}:t,null!=this.options.series?this.render():this.loadDataFromUrl(null==this.options.ajax?null:this.options.ajax.url)},loadDataFromUrl:function(t){if(scil.Utils.isNullOrEmpty(t))return!1;this.options.series=null;var o=this;scil.Utils.jsonp(t,function(t){if(null!=t&&null!=t.length&&0!=t.length){if("object"!=typeof t[0])o.options.series=[{data:t}];else{var e=[];for(n in t[0])e.push(n);for(var i=e[0],s=[],l=0;l<t.length;++l)s.push(t[l][i]);if(o.options.series=[],1==e.length)o.options.series.push({label:i,data:s});else{o.options.xlabels=s;for(var n=1;n<e.length;++n){for(var s=[],r=e[n],l=0;l<t.length;++l)s.push(t[l][r]);o.options.series.push({label:r,data:s})}}}o.render()}})},downloadImage:function(){var t;null!=JSDrawServices.url&&""!=JSDrawServices.url?(t="<div style='width:"+this.parent.offsetWidth+"px'>"+this.parent.innerHTML+"</div>",scil.Utils.post(JSDrawServices.url+"?cmd=html2image",{html:t,css:scil.Chart.getCss(),width:this.parent.offsetWidth})):scil.Utils.alert("JSDraw web service is not available")},render:function(){scil.Utils.removeAll(this.parent);var t=null;switch(this.options.type){case"column":t=dojox.charting.plot2d.Columns;break;case"clusteredcolumn":t=dojox.charting.plot2d.ClusteredColumns;break;case"stackedcolumn":t=dojox.charting.plot2d.StackedColumns;break;case"bar":t=dojox.charting.plot2d.Bars;break;case"clusteredbar":t=dojox.charting.plot2d.ClusteredBars;break;case"line":t=dojox.charting.plot2d.Lines;break;case"stackedline":t=dojox.charting.plot2d.StackedLines;break;case"area":t=dojox.charting.plot2d.Areas;break;case"stackedarea":t=dojox.charting.plot2d.StackedAreas;break;case"scatter":t=dojox.charting.plot2d.Scatter;break;case"grid":t=dojox.charting.plot2d.Grid;break;case"spider":t=dojox.charting.plot2d.Spider;break;case"bubble":t=dojox.charting.plot2d.Bubble;break;case"pie":t=dojox.charting.plot2d.Pie,0<this.options.radius||(this.options.radius=100)}scil.Utils.isNullOrEmpty(this.options.title)||scil.Utils.createElement(this.parent,"h3",scil.Lang.res(this.options.title),{margin:0,textAlign:"center",fontSize:0<this.options.titlesize?this.options.titlesize+"px":null});var e=scil.Utils.createElement(this.parent,"div");0<this.options.width&&(this.parent.style.width=this.options.width+"px"),0<this.options.height&&(e.style.height=this.options.height+"px");var i=new dojox.charting.Chart(e);null!=this.options.theme?i.setTheme(dojox.charting.themes[this.options.theme]):i.setTheme(dojox.charting.themes.Claro),null==this.options.fontcolor&&(this.options.fontcolor="blue");var s={type:t,markers:!0,gap:0<this.options.gap?this.options.gap:5,radius:0<this.options.radius?this.options.radius:null,htmlLabels:!0,fontColor:this.options.fontcolor,labelWiring:this.options.fontcolor,animate:this.options.animate};if(0<this.options.linewidth&&(s.stroke={width:this.options.linewidth}),null!=this.options.labelstyle&&(s.labelStyle=this.options.labelstyle),0!=this.options.shadow&&(s.shadow={dx:2,dy:2,width:2,color:[0,0,0,.3]}),i.addPlot("default",s),null!=this.options.plots)for(var l in this.options.plots)i.addPlot(l,this.options.plots[l]);e={},s={vertical:!0,fixLower:"major",fixUpper:"major"};null!=this.options.xmin&&(e.min=this.options.xmin),null!=this.options.xmax&&(e.max=this.options.xmax),null!=this.options.xtitle&&(e.title=this.options.xtitle,e.titleOrientation="away",e.titleGap=1),null!=this.options.ymin&&(s.min=this.options.ymin),null!=this.options.ymax&&(s.max=this.options.ymax),null!=this.options.ytitle&&(s.title=scil.Lang.res(this.options.ytitle),s.titleGap=5);var n=this.options.series,r=this.options.xlabels;if(null!=n[0].data&&null==n[0].data.length){r=[];var o=[],a=n[0].data;for(l in a)r.push(l),o.push(a[l]);for(var h=[],u=0;u<n.length;++u){if(0<u){o=[],a=n[u].data;for(l=0;l<r.length;++l){var c=a[r[l]];o.push(null==c?0:c)}}h.push({label:scil.Lang.res(n[u].label),data:o,args:n[u].args,additup:n[u].additup})}n=h}if("pie"==this.options.type)i.addSeries(n[0].label,null!=n[0].xydata?n[0].xydata:this.array2data(n[0].data,null,r,this.options.showpercentage));else if(null!=r&&(e.labels=this.array2data(r,!0)),i.addAxis("x",e),i.addAxis("y",s),"bubble"==this.options.type)i.addSeries(n[0].label,n[0].xydata||n[0].data);else for(u=0;u<n.length;++u)i.addSeries(null==n[u].label?"Series-"+(u+1):n[u].label,null!=n[u].xydata?n[u].xydata:this.array2data(n[u].data,null,r,null,n[u].additup),n[u].args);switch(0!=this.options.tooltips&&new dojox.charting.action2d.Tooltip(i,"default"),this.options.type){case"pie":case"scatter":case"grid":new dojox.charting.action2d.MoveSlice(i,"default");break;case"bar":case"clusteredbar":new dojox.charting.action2d.Highlight(i,"default");break;case"column":case"clusteredcolumn":new dojox.charting.action2d.Highlight(i,"default");break;case"line":case"stackedline":new dojox.charting.action2d.Magnify(i,"default");break;case"area":case"stackedarea":new dojox.charting.action2d.Magnify(i,"default")}i.render(),this.options.legend&&(s=scil.Utils.createElement(this.parent,"div"),new dojox.charting.widget.Legend({chart:i},s));var d=this;i.connectToPlot("default",function(t){"onclick"==t.type?null!=d.options.onclick&&d.options.onclick(t):"onmouseover"==t.type?null!=d.options.onmouseover&&d.options.onmouseover(t):"onmouseout"==t.type&&null!=d.options.onmouseout&&d.options.onmouseout(t)})},array2data:function(t,e,i,s,l){var n=0;if(s)for(var r=0;r<t.length;++r)isNaN(t[r])||(n+=t[r]);for(var o,a,h,u=null,c=[],r=0;r<t.length;++r)e?c.push({value:r+1,text:t[r]}):(o=null,h=a=o=l?(null==u?u=t[r]:null==t[r]||isNaN(t[r])||(u+=t[r]),null==t[r]?null:u):t[r],null!=i&&null!=i[r]&&(s&&!isNaN(a)&&0<n&&(a=Math.round(a/n*1e3)/10+"%"),a=i[r]+" ("+a+")",h=i[r]),c.push({x:r+1,y:o,text:h,tooltip:a}));return c}}),scil.apply(scil.Chart,{stylesheetAdded:!1,addStylesheet:function(){this.stylesheetAdded||(this.stylesheetAdded=!0,scil.Utils.addCss(this.getCss()))},getCss:function(){return".dijitTooltip { position: absolute; z-index: 2000; display: block; left: 0; overflow: visible; }\r\n.dijitTooltipContainer { border: solid #aaf 1px; background: #fff; color: blue; padding: 2px; border-radius: 3px; }\r\n.dijitTooltipConnector { position: absolute; }\r\n.dojoxLegendIcon { float: left; }\r\n"}}),scil.Clipboard={copy:function(t){if(scil.Utils.isNullOrEmpty(t))return!1;var e=scil.Utils.createElement(document.body,"textarea",null,{position:"fixed",top:0,left:0,width:"2px",height:"2px",padding:0,border:"none",outline:"none",boxShadow:"none",background:"transparent"});e.value=t,e.select();var i=!1;try{i=document.execCommand("copy")}catch(t){}return document.body.removeChild(e),i}},"undefined"==typeof __JSDraw2_TouchMol&&(dojo.require("dijit.layout.AccordionContainer"),dojo.require("dijit.layout.ContentPane")),scil.Accordion=scil.extend(scil._base,{constructor:function(t,e){scil.Accordion.addStylesheet(),"string"==typeof t&&(t=scil.byId(t)),this.options=null==e?{}:e;e="";0<this.options.width&&(e+="width:"+this.options.width+"px;"),0<this.options.height&&(e+="height:"+this.options.height+"px;"),this.container=new dijit.layout.AccordionContainer({style:e},t);for(var i=0;i<this.options.items.length;++i){var s=this.options.items[i];this.container.addChild(new dijit.layout.ContentPane({title:s.title,content:s.html}))}this.container.startup(),null!=this.options.onafterrender&&this.options.onafterrender(this)}}),scil.apply(scil.Accordion,{stylesheetAdded:!1,addStylesheet:function(){this.stylesheetAdded||(this.stylesheetAdded=!0,scil.Utils.addCss(this.getCss()))},getCss:function(){return".dijitAccordionInnerContainer{background-color: #efefef;border: solid 1px #b5bcc7;}\r\n.dijitAccordionContainer .dijitAccordionChildWrapper{background-color: #ffffff;border: 1px solid #759dc0;margin: 0 2px 2px;}\r\n.dijitAccordionTitle .arrowTextUp, .dijitAccordionTitle .arrowTextDown {display: none;font-size: 0.65em;font-weight: normal !important;}\r\n.dijitAccordionTitle{padding: 5px 7px 2px 7px;min-height: 17px;}\r\n"}}),scil.DnD=scil.extend(scil._base,{constructor:function(t,e){this.src=null,this.copy=null,this.dragging=!1,this.disabled=!1,this.options=e,"string"==typeof t&&(t=scil.byId(t));var i=this;dojo.connect(t,"onmousedown",function(t){i.disabled||i.mousedown(t)}),dojo.connect(document.body,"onmousemove",function(t){i.disabled||i.mousemove(t)}),dojo.connect(document.body,"onmouseup",function(t){i.disabled||i.mouseup(t)})},isDragging:function(){return this.dragging},cancel:function(){null!=this.src&&null!=this.options.oncancel&&this.options.oncancel(this),this.src=null,this.copy=null,this.dragging=!1},mousedown:function(t,e){null!=this.options.onstartdrag&&(this.src=this.options.onstartdrag(t,this),this.startpos={x:t.clientX,y:t.clientY})},mousemove:function(t){var e;null!=this.src&&(null==this.copy&&(10<Math.abs(t.clientX-this.startpos.x)||10<Math.abs(t.clientY-this.startpos.y))&&null!=this.options.oncreatecopy&&(this.copy=this.options.oncreatecopy(t,this)),null!=this.copy&&(e=scil.Utils.scrollOffset(),this.copy.style.left=t.clientX+e.x+2+"px",this.copy.style.top=t.clientY+e.y+2+"px",this.dragging=!0),null!=this.options.ondragover&&this.options.ondragover(t,this))},mouseup:function(t){null!=this.src&&null!=this.options.ondrop&&this.options.ondrop(t,this),this.src=null,this.copy=null,this.dragging=!1}}),scil.Resizable=scil.extend(scil._base,{constructor:function(t,e){"string"==typeof t&&(t=scil.byId(t)),this.options=null==e?{}:e,this.resizing=null,this.handle=t,this.bgcolor=this.handle.style.backgroundColor,"y"==this.options.direction?t.style.cursor="ns-resize":"x"==this.options.direction&&(t.style.cursor="ew-resize");var i=this;dojo.connect(t,"onmousedown",function(t){i.start(t)}),scil.connect(document.body,"onmousemove",function(t){i.resize(t)&&t.preventDefault()}),scil.connect(document.body,"onmouseup",function(t){i.resizing=null}),null!=this.options.mouseovercolor&&(scil.connect(t,"onmouseover",function(){i.handle.style.backgroundColor=i.options.mouseovercolor}),scil.connect(t,"onmouseout",function(){i.handle.style.backgroundColor=i.bgcolor}))},resize:function(t){if(null==this.resizing)return!1;var e="y"==this.options.direction?t.clientY-this.resizing.y:t.clientX-this.resizing.x;if(0==e)return!0;var i=!1;return null!=this.options.onresize&&(i=this.options.onresize(e,this)),i&&("y"==this.options.direction?this.resizing.y=t.clientY:this.resizing.x=t.clientX),!0},start:function(t){"y"==this.options.direction?this.resizing={y:t.clientY}:"x"==this.options.direction&&(this.resizing={x:t.clientX})}}),scil.Favorite=scil.extend(scil._base,{constructor:function(t,e){this.key=t,this.items=null,this.onAddFavorite=e,this.changed=!1},getList:function(t){return this._load(),this.items[t]},contains:function(t,e){this._load();e=this.items[e];return null!=e&&0<=scil.Utils.indexOf(e,t)},add:function(t,e,i){this._load();var s,l=this.items[i];null==l?e&&(this.items[i]=[t],this.changed=!0):(s=scil.Utils.indexOf(l,t))<0&&e?(l.push(t),this.changed=!0):0<=s&&!e&&(l.splice(s,1),this.changed=!0),null!=this.onAddFavorite&&this.onAddFavorite(t,e,i),this.changed&&this._save()},_save:function(){var t;null!=this.items&&(t=scil.Utils.json2str(this.items),scil.Utils.createCookie("scil_helm_favorites_"+this.key,t))},_load:function(){var t;null==this.items&&(t=scil.Utils.readCookie("scil_helm_favorites_"+this.key),t=scil.Utils.eval(t),this.items=null==t?{}:t)}}),scilligence.DropdownButton=scilligence.extend(scilligence._base,{constructor:function(t,e){this.auto=null,this.options=null==e?{}:e;var i=this;this.button="string"==typeof t?document.getElementById(t):t,dojo.connect(this.button,"onclick",function(){i.show()});e=null==this.options.dropdown?"&#9660;":this.options.dropdown;"TABLE"==this.button.tagName?(t=(t=this.button.getElementsByTagName("TD"))[t.length-1],scil.Utils.createElement(t,"span",e)):(this.options.expandright,scil.Utils.createElement(this.button,"span",e,{fontSize:"70%"}))},isVisible:function(){return null!=this.auto&&""==this.auto.style.display},show:function(){var e,t,i;null!=this.options.onshowdropdown&&this.options.onshowdropdown(this),null==this.auto&&(!(0<(i=(e=this).options.width))&&scil.Utils.isIE&&scil.Utils.isIE<=8&&(i=200),t=scil.Utils.isFixedPosition(this.button)?"fixed":"absolute",i=scil.Utils.createTable(document.body,0,1,{borderRadius:"2px",border:JSDraw2.Skin.dialog.border,backgroundColor:JSDraw2.Skin.dialog.bkcolor,display:"none",position:t,width:i}),this.auto=i.parentNode,i=JsUtils.createElement(JsUtils.createElement(i,"tr"),"td",null,{padding:"5px"}),this.area=scil.Utils.createElement(i,"div",null,{backgroundColor:"#fff"}),dojo.connect(document.body,"onmousedown",function(t){t=t.srcElement||t.target;t==e.q||scil.Utils.isChildOf(t,e.auto)||e.clickout()}),this.list(this.options.items)),this.auto.style.display="",this.position()},hide:function(){null!=this.auto&&(this.auto.style.display="none")},position:function(){var t,e,i=scilligence.Utils.getOffset(this.button),s=scilligence.Utils.scrollOffset(),l=scil.Utils.getZindex(this.button)+1;scil.Utils.isIE&&(t=JsUtils.getScrollOffset(this.e),s.offset(-t.x,-t.y)),s=this.options.expandright?(e=i.x+s.x+this.button.offsetWidth,i.y+s.y):(e=i.x+s.x,i.y+s.y+this.button.offsetHeight),dojo.style(this.auto,{zIndex:l,display:"",x:0,y:0}),scil.Utils.moveToScreen(e,s,this.auto)},list:function(t){if(null!=t&&0!=t.length){if(""!=this.auto.style.display&&this.position(),null==t.length){var e,i=[];for(e in t)i.push({label:t[e],key:e});t=i}scil.Utils.removeAll(this.area);for(var s=0;s<t.length;++s){var l=t[s];("-"!=l||0!=s&&"-"!=t[s-1]&&s!=t.length-1)&&this.createItem(l)}}},createItem:function(e){var t,i,s,l,n;"-"!=e?("string"==typeof e&&(e={label:e}),t=this.options.translate?scil.Lang.res(e.label):e.label,null==e.key&&t!=e.label&&(e.key=e.label),l=i=scil.Utils.createElement(this.area,"div",null,{padding:"3px 10px 3px 10px",color:JSDraw2.Skin.menu.color,cursor:"pointer"},{url:e.url,key:e.key}),null!=e.items&&0<e.items.length&&(s=scil.Utils.createTable(i,0,0,{width:"100%"}),s=scil.Utils.createElement(s,"tr"),l=scil.Utils.createElement(s,"td",null,{textAlign:"left"}),scil.Utils.createElement(s,"td","&#9658;",{paddingLeft:"10px",textAlign:"right",fontSize:"50%"})),null!=e.icon&&scil.Utils.createElement(l,"img",null,{marginRight:"5px"},{src:e.icon}),null!=t&&scil.Utils.createElement(l,"span",t),n=this,null!=e.items&&0<e.items.length?(e.expandright=!0,e.dropdown="",new scil.DropdownButton(i,e)):(null==e.key&&null!=e.label&&(e.key=e.label),dojo.connect(i,"onclick",function(t){null!=e.onclick&&e.onclick(),n.click(t,i)})),dojo.connect(i,"onmouseover",function(t){n.mouseover(t,i)}),dojo.connect(i,"onmouseout",function(t){n.mouseout(t,i)})):scil.Utils.createElement(this.area,"hr",null,{margin:0,padding:0,borderColor:null==scil.App.config?null:scil.App.config.frame})},getItem:function(t){t=t.srcElement||t.target;return"DIV"!=t.tagName&&(t=scil.Utils.getParent(t,"DIV")),t},mouseover:function(t){this.getItem(t).style.backgroundColor="#ddf",this.getItem(t).style.color=JSDraw2.Skin.menu.highlightcolor},mouseout:function(t){this.getItem(t).style.backgroundColor="#fff",this.getItem(t).style.color=JSDraw2.Skin.menu.color},clickout:function(t){this.hide()},click:function(t){var e=this.getItem(t),i=e.getAttribute("url"),t=e.getAttribute("key");null!=this.options.callback?this.options.callback(null==t||""==t?e.innerText||e.textContent:t,i):null!=this.options.onclick?this.options.onclick(null==t||""==t?e.innerText||e.textContent:t,i):null!=i&&(null==this.options.target?window.location=i:window.open(i,this.options.target)),this.hide()}}),scil.App={imgSmall:function(t,e){t="small/"+t;return e&&(t="url("+t+")"),t}},scil.Page=scil.extend(scil._base,{constructor:function(t,e,i,s,l){var n=null!=i&&0<i.length||null!=s||null!=l?{middle:s,onRefreshReceivers:l,forms:i}:null==i?{}:i;if(null==e&&null==n.left&&(n.left=!1),null!=e&&(n.onresize=e.onresizetree),this.onRefreshReceivers=n.onRefreshReceivers,this.url=null==scil.Page.ajaxurl?"ajax.ashx?cmd=":scil.Page.ajaxurl,this.explorer=new scil.Page.Explorer(t,n),null!=e&&null!=e.root&&null!=e.root.children)for(var r=0;r<e.root.children.length;++r)e.root.children[r].name=scil.Lang.res(e.root.children[r].name);if((this.tree=null)!=e&&("table"==e.type?this.table=new scil.Page.Table(this,e,this.explorer.left):"form"==e.type?this.form=new scil.Page.Form(this,e,this.explorer.left):this.tree=new scil.Page.Tree(this,e,this.explorer.left)),null!=n.forms)for(var o=null==this.tree?this.form:this.tree,r=0;r<n.forms.length;++r)o=this.addForm(n.forms[r],o)},addTabs:function(t){var e=new scil.Page.Tab(this,t,this.explorer.right);return(null!=t&&0==t.visible||0==t)&&e.hide(),e},addDiv:function(t,e){return scil.Utils.createElement(this.explorer.right,"div",t,e)},addForm:function(t,e,i,s){return scil.Page.addForm(this,t,e,i,s)},addResizeHandle:function(t,e){var i=this.addDiv();return i.style.height=(0<e?e:scil.Page.kHandleWidth)+"px",i.style.marginBottom="2px",new scil.Resizable(i,{direction:"y",mouseovercolor:scil.Page.kHandleColor,onresize:t}),i},removeForm:function(t){t=t.form.root;t.parentNode.removeChild(t)},receiverRefresh:function(t,e){null!=this.onRefreshReceivers&&this.onRefreshReceivers(e,t);for(var i=0;i<t.receivers.length;++i)t.receivers[i].refresh(t,e)},receiverClear:function(t){for(var e=0;e<t.receivers.length;++e)t.receivers[e].clear()}}),scil.apply(scil.Page,{kHandleWidth:5,kHandleColor:"#aaf",addForm:function(t,e,i,s,l){null==s&&(s=l?t.explorer.left:t.explorer.right);l=null,l=new("form"==e.type?scil.Page.Form:"custom"==e.type?scil.Page.Custom:"calendar"==e.type?scil.Page.Calendar:scil.Page.Table)(t,e,s);return null!=i&&i.receivers.push(l),scil.Page.setBorder(l.form),e.form=l},setBorder:function(t){t.toolbar.style.borderLeftColor=scil.Tabs.kHighlightColor,t.toolbar.style.borderRightColor=scil.Tabs.kHighlightColor,t.main.style.borderLeftColor=scil.Tabs.kHighlightColor,t.main.style.borderRightColor=scil.Tabs.kHighlightColor,t.main.style.borderBottomColor=scil.Tabs.kHighlightColor}}),scil.Page.Custom=scil.extend(scil._base,{constructor:function(t,e,i){var s=this;this.refreshneeded=!0,this.page=t,this.options=e,this.receivers=[];t=[];0==e.norefresh&&t.push({src:scil.App.imgSmall("refresh.png"),title:"Refresh",onclick:function(){s.refresh()}}),null!=this.options.buttons&&(t=t.concat(this.options.buttons)),this.form=new scil.Page.ExplorerForm(i,{expandable:e.expandable,caption:e.caption,visible:e.visible,buttons:t,marginBottom:e.marginBottom,expanded:this.options.expanded,onexpand:this.options.onexpand}),null!=(this.form.host=this).options.oncreate&&this.options.oncreate(this.form.div,this.options)},show:function(){this.form.show()},hide:function(){this.form.hide()},refresh:function(t,e){null!=e&&(this.args=e),this.form.isVisible()?(this.refreshneeded=!1,null!=this.options.onrefresh&&this.options.onrefresh(t,this.args,this)):this.refreshneeded=!0},clear:function(){null!=this.options.onclear&&this.options.onclear()}}),scil.Page.Explorer=scil.extend(scil._base,{constructor:function(t,e){"string"==typeof t&&(t=scil.byId(t)),this.options=e,(this.resizing=null)==e.resizable&&(e.resizable=!0);var i,s=scil.Utils.createTable(t,0,0,{width:"100%"}),l=scil.Utils.createElement(s,"tr");0==e.left?(this.left=null,this.middle=null):(t=0<e.leftwidth?e.leftwidth:200,s=scil.Utils.createElement(l,"td",null,{width:"1%",paddingRight:"1px"},{vAlign:"top"}),s=scil.Utils.createTable(s,0,0,e.resizable?null:{width:t}),s=scil.Utils.createElement(s,"tr"),s=scil.Utils.createElement(s,"td"),this.left=scil.Utils.createElement(s,"div",null,e.resizable?{width:t,overflow:"hidden"}:null),0!=e.middle&&(this.middle=scil.Utils.createElement(l,"td"),t=scil.Utils.createElement(this.middle,"div",null,{width:scil.Page.kHandleWidth}),scil.Utils.unselectable(this.middle),scil.Utils.unselectable(t)),e.resizable&&(i=this,new scil.Resizable(this.middle,{direction:"x",mouseovercolor:scil.Page.kHandleColor,onresize:function(t){return i.onresize(t)}}))),this.right=0==e.right?null:scil.Utils.createElement(l,"td",null,{width:"99%",paddingLeft:0==e.left?null:"1px"},{vAlign:"top"})},onresize:function(t){t=scil.Utils.parsePixel(this.left.style.width)+t;return 20<t&&(this.left.style.width=t+"px",null!=this.options.onresize&&this.options.onresize(t,this),!0)}}),scil.Page.ExplorerForm=scil.extend(scil._base,{constructor:function(t,e){this.options=null==e?{}:e,"string"==typeof t&&(t=scil.byId(t));var i,t=scil.Utils.createTable(t,0,0,{width:"100%",background:"#fff"});this.dom=this.root=t.parentNode,0==this.options.visible&&(this.root.style.display="none"),null==e.caption?(t.parentNode.style.borderTop="solid 1px "+scil.Page.ExplorerForm.kHeaderStyle.background,this.title=null):this.title=scil.Utils.createElement(scil.Utils.createElement(t,"tr"),"td",scil.Lang.res(e.caption),scil.Page.ExplorerForm.kHeaderStyle),this.toolbar=scil.Utils.createElement(scil.Utils.createElement(t,"tr"),"td",null,scil.Page.ExplorerForm.kToolbarStyle),0==e.toolbarvisible&&(this.toolbar.style.display="none"),this.toolbar.style.whiteSpace="nowrap",this.main=scil.Utils.createElement(scil.Utils.createElement(t,"tr"),"td",null,scil.Page.ExplorerForm.kAreaStyle),this.div=scil.Utils.createElement(this.main,"div"),this.table=t.parentNode,scil.Form.createToolbarButtons(this.toolbar,e.buttons,e.padding),null!=this.title&&0!=e.expandable&&(i=this,dojo.connect(this.title,"onclick",function(){var t=!i.isExpanded();i.expand(t),null!=i.options.onexpand&&i.options.onexpand(t)}),0==e.expanded&&this.expand(!1)),null!=this.options.marginTop&&(this.table.style.marginTop=this.options.marginTop),this.table.style.marginBottom=null==this.options.marginBottom?"25px":this.options.marginBottom},isVisible:function(){return scil.Utils.isAllParentVisible(this.root)},show:function(){this.isVisible()||(this.root.style.display="",null!=this.host&&null!=this.host.refresh&&this.host.refreshneeded&&this.host.refresh())},hide:function(){this.root.style.display="none"},collapse:function(){this.expand(!1)},expand:function(t){null==t&&(t=!0),this.toolbar.style.display=t?"":"none",this.main.style.display=t?"":"none",this.title.style.backgroundImage=scil.App.imgSmall(t?"expand.png":"collapse.png",!0),this.title.style.backgroundRepeat="no-repeat",this.title.style.backgroundPosition="left center",null!=this.host&&null!=this.host.refresh&&this.host.refreshneeded&&this.host.refresh()},isExpanded:function(){return""==this.main.style.display}}),scil.apply(scil.Page.ExplorerForm,{kHeaderStyle:{background:"#88f",color:"white",padding:"3px 10px 3px 16px",whiteSpace:"nowrap",borderTopLeftRadius:"5px",borderTopRightRadius:"5px"},kToolbarStyle:{background:"#f5f5f5",border:"solid 1px #f5f5f5",padding:"0 5px 0 5px"},kAreaStyle:{border:"solid 1px #f5f5f5",padding:"5px"}}),scil.Page.Form=scil.extend(scil._base,{constructor:function(t,e,i){var s=this;this.refreshneeded=!0,this.page=t,this.options=e,this.receivers=[];t=[];0==e.norefresh&&t.push({src:scil.App.imgSmall("refresh.png"),title:"Refresh",onclick:function(){s.refresh()}}),null!=this.options.buttons&&(t=t.concat(this.options.buttons)),null==e.viewonly&&(e.viewonly=!0),this.form=new scil.Page.ExplorerForm(i,{expandable:e.expandable,caption:e.caption,visible:e.visible,buttons:t,marginBottom:e.marginBottom,expanded:this.options.expanded,onexpand:this.options.onexpand}),(this.form.host=this).table=new scil.Form({alternativeforms:this.options.alternativeforms,viewonly:e.viewonly,onchange:this.options.onformchange}),this.table.render(this.form.div,this.options.fields,{immediately:!0,hidelabel:e.hidelabel})},show:function(){this.form.show()},hide:function(){this.form.hide()},refresh:function(t,e){var i;null!=e&&(this.args=e),this.form.isVisible()&&this.form.isExpanded()?scil.Utils.isDictEmpty(this.args)||((i=this).refreshneeded=!1,null==(e=this.args)&&(e={}),null!=i.options.onbeforerefresh&&i.options.onbeforerefresh(e),this.page.receiverClear(this),scil.Utils.ajax(this.page.url+this.options.object+".load",function(t){null!=i.options.onsetdata?i.options.onsetdata(i.table,t):i.options.savedoc&&null!=t.doc&&""!=t.doc?(i.table.setXml(t.doc),i.table.setData(t,!0)):i.table.setData(t)},e)):this.refreshneeded=!0},clear:function(){this.table.setData({}),this.page.receiverClear(this)}}),scil.Page.Tab=scil.extend(scil._base,{constructor:function(t,e,i){this.page=t,this.options=null==e?{}:e,this.onShowTab2=this.options.onShowTab;var s=this;this.options.onShowTab=function(t,e){null!=e&&null!=e.form&&e.form.hide(),null!=t.form&&t.form.show(),null!=s.onShowTab2&&s.onShowTab2(t,e)},this.tabs=new scil.Tabs(i,this.options)},addForm:function(t,e){var i=this.tabs.addTab(t),s=t.captions;return t.caption=null,i.form=scil.Page.addForm(this.page,t,e,i.clientarea),t.caption=s,scil.Page.setBorder(i.form.form),i.form},removeTab:function(t){return this.tabs.removeTab(t)},findTab:function(t){return this.tabs.findTab(t)},showTab:function(t){this.tabs.showTab(t)},show:function(){this.tabs.show()},hide:function(){this.tabs.hide()}}),scil.Page.Table=scil.extend(scil._base,{constructor:function(t,e,i){var s=this;this.refreshneeded=!0,this.page=t,this.options=e,this.receivers=[];t=[];e.norefresh||t.push({src:scil.App.imgSmall("refresh.png"),title:"Refresh",onclick:function(){s.refresh()}}),null!=this.options.fields&&(t.push("-"),0!=this.options.canadd&&t.push({src:scil.App.imgSmall("add.png"),title:"New",onclick:function(){s.add()}}),0!=this.options.canedit&&t.push({src:scil.App.imgSmall("edit.png"),title:"Edit",onclick:function(){s.edit()}})),null!=this.options.buttons&&(t=t.concat(this.options.buttons)),this.options.columnhidable&&(t.push("-"),t.push({src:scil.App.imgSmall("columns.png"),title:"Show/Hide Columns",onclick:function(){s.table.showHideColumns()}})),this.form=new scil.Page.ExplorerForm(i,{expandable:e.expandable,caption:e.caption,visible:e.visible,marginBottom:e.marginBottom,buttons:t,expanded:this.options.expanded,onexpand:this.options.onexpand}),(this.form.host=this).pages=scil.Utils.createElement(this.form.div,"div"),this.tablediv=scil.Utils.createElement(this.form.div,"div"),this.recreateTable()},recreateTable:function(){scil.Utils.removeAll(this.tablediv);var e=this;this.table=new scil.Table(!0,null,{onAddRow:this.options.onAddRow,selectrow:!0,onselectrow:function(t){e.selectrow(t)},rowcheck:this.options.rowcheck,grouping:this.options.grouping,grouplinestyle:this.options.grouplinestyle,hidecolumncookiekey:this.options.hidecolumncookiekey}),this.table.render(this.tablediv,this.options.columns),this.table.tbody.parentNode.style.width="100%",null!=this.options.oncreatetable&&this.options.oncreatetable(this)},selectFirstRow:function(){this.table.selectFirstRow()},show:function(){this.form.show()},hide:function(){this.form.hide()},clear:function(){scil.Utils.removeAll(this.pages),this.table.setData({}),this.page.receiverClear(this)},selectrow:function(t){var e=null==t?null:t.getAttribute("key"),i=null;(i={})[this.options.key]=e;e=this.table.getRowData(t);null!=this.options.name&&null!=e&&(i[this.options.name]=e[this.options.name]),this.page.receiverRefresh(this,i),null!=this.options.onselectrow&&this.options.onselectrow(t,i)},loadPage:function(t){null==this.args&&(this.args={}),null!=this.options.onloadpage&&this.options.onloadpage(this.args,t,this),this.refresh(null,null,null,t)},list:function(t){var e=this;null==t&&(t={}),this.table.setData(null==t.rows?t:t.rows),scil.Table.listPages(this.pages,t.page,t.pages,function(t){e.loadPage(t)})},refresh:function(t,e,i,s){var l;null!=e&&(this.args=e),null==this.args&&(this.args={}),this.args.page=s,this.form.isVisible()&&this.form.isExpanded()?(this.page.receiverClear(this),this.refreshneeded=!1,null==(s=(l=this).args)&&(s={}),null!=l.options.onbeforerefresh&&l.options.onbeforerefresh(s),(this.options.jsonp?scil.Utils.jsonp:scil.Utils.ajax)(this.page.url+this.options.object+".list",function(t){var e;null!=l.options.onbeforelisting&&l.options.onbeforelisting(t,l),i?(l.list(t),l.table.selectFirstRow()):(e=l.table.getCurrentKey(),l.list(t),null!=e&&l.table.selectRow(e)),null!=l.options.onrefreshed&&l.options.onrefreshed(l)},s)):this.refreshneeded=!0},add:function(t){null!=this.options.onAddNew&&0==this.options.onAddNew(this.args)||this.add2(t)},add2:function(t){this.create(),this.dlg.show(),this.options.usetabs&&this.dlg.form.tabs.showTab(0),null!=this.options.onshowform&&this.options.onshowform(this.dlg,this.args);t=null!=t?t:null==this.options.defaultvalues?{}:this.options.defaultvalues;this.applyArgs(t),null!=this.options.key&&(t[this.options.key]=null),this.options.onloaddata&&this.options.onloaddata(t,this.args,this.dlg),this.dlg.form.setData(t),this.dlg.editkey=null,this.showDelButton(!1)},copyNew:function(e){if(null==e)for(var t in this.options.fields)if(this.options.fields[t].iskey){e=t;break}var i;null!=e&&(i=this).edit(function(t){t[e]=" ",i.dlg.editkey=null})},edit:function(e){var i,t;null!=this.table.currow?(this.add2(),this.showDelButton(!0),(t={})[(i=this).options.key]=this.table.currow.getAttribute("key"),this.dlg.editkey=t[this.options.key],null!=this.options.onEdit&&0==this.options.onEdit(t)||scil.Utils.ajax(this.page.url+this.options.object+".load",function(t){i.options.onloaddata&&i.options.onloaddata(t,i.args,i.dlg),null!=e&&e(t,i),i.options.savedoc&&null!=t.doc&&""!=t.doc?(i.dlg.form.setXml(t.doc),i.dlg.form.setData(t,!0)):i.dlg.form.setData(t)},t)):scil.Utils.alert("please select a row first")},applyArgs:function(t){null!=this.args&&scil.apply(t,this.args)},cancel:function(){null!=this.dlg&&this.dlg.hide()},save:function(){if(0<this.dlg.form.checkRequiredFields())scil.Utils.alert("Some required field(s) are blank");else{var i=this,t=this.dlg.form.getData();if(this.options.savedoc&&(t.doc=this.dlg.form.getXml()),this.options.onbeforesave&&0==this.options.onbeforesave(t,this.args,this.dlg.form))return!1;scil.Utils.ajax(this.page.url+this.options.object+".save",function(t){if(i.dlg.hide(),null!=t&&null!=t.rows&&0<t.rows.length)for(var e=0;e<t.rows.length;++e)null!=i.dlg.editkey?i.table.updateRow(i.dlg.editkey,t.rows[e]):i.table.addRow(t.rows[e]);else i.refresh();i.options.onaftersave&&i.options.onaftersave(t,i)},t,{showprogress:!0})}},del:function(){var e=this;scil.Utils.confirmYes("Delete this record?",function(){var t=e.dlg.form.getData();scil.Utils.ajax(e.page.url+e.options.object+".del",function(t){e.dlg.hide(),e.refresh()},t)})},showDelButton:function(t){if(null!=this.dlg)for(var e=0;e<this.dlg.form.buttons.length;++e){var i=this.dlg.form.buttons[e];if(null!=i&&"delete"==i.getAttribute("key")){i.style.display=t?"":"none";break}}},create:function(){var t,e;null==this.dlg&&(t=this,e=[{src:scil.App.imgSmall("submit.png"),label:"Save",key:"save",onclick:function(){t.save()}}],0!=this.options.candelete&&e.push({src:scil.App.imgSmall("del.png"),label:"Delete",key:"delete",onclick:function(){t.del()}}),e.push({src:scil.App.imgSmall("cancel.png"),label:"Cancel",key:"cancel",onclick:function(){t.cancel()}}),null!=this.options.editbuttons&&(null==this.options.editbuttons.length?e.push(this.options.editbuttons):e=e.concat(this.options.editbuttons)),this.options.usetabs?this.dlg=scil.Form.createTabDlgForm(this.options.formcaption,{tabs:this.options.fields,buttons:e,border:!0,onchange:this.options.onformdatachange}):this.dlg=scil.Form.createDlgForm(this.options.formcaption,this.options.fields,e,{alternativeforms:this.options.alternativeforms,hidelabel:this.options.hidelabel,oncreated:this.options.oncreateform,onchange:this.options.onformdatachange}))}}),scil.Page.Tree=scil.extend(scil._base,{constructor:function(t,e,i){var s=this;this.refreshneeded=!0,this.page=t,this.options=null==e?{}:e,this.receivers=[];var l=[];null==this.options.onrender&&(l.push({src:scil.App.imgSmall("refresh.png"),title:"Refresh",onclick:function(){s.refresh()}}),null!=this.options.fields&&(l.push("-",{src:scil.App.imgSmall("add.png"),title:"New",onclick:function(){s.add()}}),l.push({src:scil.App.imgSmall("edit.png"),title:"Edit",onclick:function(){s.edit()}}))),null!=this.options.buttons&&(l=l.concat(this.options.buttons));t=null==this.options.object?null:{url:this.page.url+this.options.object+".tree",icongap:"3px",onAddItem:this.options.onAddItem};this.form=new scil.Page.ExplorerForm(i,{toolbarvisible:e.toolbarvisible,expandable:e.expandable,caption:e.caption,visible:e.visible,marginTop:e.marginTop,marginBottom:e.marginBottom,buttons:l,expanded:this.options.expanded,onexpand:this.options.onexpand}),null!=(this.form.host=this).options.onrender?this.options.onrender(this.form.div,t):(this.tree=new scil.Tree(this.form.div,t),this.tree.onSelectItem=function(t){s.select(t)},this.tree.onExpandItem=function(t,e){if(null!=s.options.onexpand)return s.options.onexpand(t,e)},0!=this.options.startrefresh&&this.refresh()),this.form.main.style.padding=0,scil.Page.setBorder(this.form)},show:function(){this.form.show()},hide:function(){this.form.hide()},select:function(t){var e;null!=this.options.onselectitem&&this.options.onselectitem(t)||(e={},null!=this.options.onBuildArgs?e=this.options.onBuildArgs(t):null!=t&&null!=t.item&&null!=t.item[this.options.key]&&(e[this.options.key]=t.item[this.options.key],null!=this.options.name&&(e[this.options.name]=t.item.name)),this.page.receiverRefresh(this,e))},refresh:function(t){if(this.form.isVisible()){if(null!=this.tree)if(t)this.tree.reloadCur();else{if(this.refreshneeded=!1,this.tree.clear(),null!=this.options.root)if(null==this.options.root.selectable&&(this.options.root.selectable=!1),0==this.options.root.showroot&&null!=this.options.root.children)for(var e=0;e<this.options.root.children.length;++e)this.tree.cur=this.tree.add(null,this.options.root.children[e]);else this.tree.cur=this.tree.add(null,this.options.root);null!=this.options.object&&""!=this.options.object&&this.tree.reloadCur()}}else this.refreshneeded=!0},applyArgs:function(t){null!=this.args&&scil.apply(t,this.args)},add:function(){this.create(),this.dlg.show(),null!=this.options.onshowform&&this.options.onshowform(this.dlg),this.dlg.form.setData(null==this.options.defaultvalues?{}:this.options.defaultvalues)},edit:function(){this.add();var e,t={};t[this.options.key]=null==this.tree.cur||null==this.tree.cur.item?null:this.tree.cur.item[this.options.key],null!=t[this.options.key]&&(e=this,scil.Utils.ajax(this.page.url+this.options.object+".load",function(t){e.options.onloaddata&&e.options.onloaddata(t),e.dlg.form.setData(t)},t))},save:function(){var t=this,e=this.dlg.form.getData();if(this.options.onbeforesave){var i={};if(i[this.options.key]=null==this.tree.cur||null==this.tree.cur.item?null:this.tree.cur.item[this.options.key],0==this.options.onbeforesave(e,i))return!1}scil.Utils.ajax(this.page.url+this.options.object+".save",function(){t.dlg.hide(),null!=t.options.onSaved?t.options.onSaved(t,e):t.refresh(!0)},e)},del:function(){var t=this,e=this.dlg.form.getData();scil.Utils.ajax(this.page.url+this.options.object+".del",function(){t.dlg.hide(),t.refresh()},e)},create:function(){var t,e;null==this.dlg&&(t=this,e=[{src:scil.App.imgSmall("submit.png"),label:"Save",onclick:function(){t.save()}},{src:scil.App.imgSmall("del.png"),label:"Delete",onclick:function(){t.del()}}],this.dlg=scil.Form.createDlgForm(this.options.formcaption,this.options.fields,e),null!=this.options.oncreateform&&this.options.oncreateform(this.dlg.form))}});